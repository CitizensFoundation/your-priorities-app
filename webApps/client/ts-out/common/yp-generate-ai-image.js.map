{"version":3,"file":"yp-generate-ai-image.js","sourceRoot":"","sources":["../../src/common/yp-generate-ai-image.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html } from \"lit\";\nimport { property, customElement, query, queryAll } from \"lit/decorators.js\";\nimport { YpBaseElement } from \"./yp-base-element.js\";\nimport { Layouts } from \"../flexbox-literals/classes.js\";\n\nimport \"@material/web/dialog/dialog.js\";\nimport { MdDialog } from \"@material/web/dialog/dialog.js\";\n\nimport \"@material/web/button/elevated-button.js\";\nimport \"@material/web/button/outlined-button.js\";\nimport \"@material/web/button/text-button.js\";\nimport \"@material/web/progress/circular-progress.js\";\nimport \"@material/web/textfield/filled-text-field.js\";\n\n@customElement(\"yp-generate-ai-image\")\nexport class YpGenerateAiImage extends YpBaseElement {\n  @property({ type: Boolean })\n  submitting = false;\n\n  @property({ type: String })\n  currentError: string | undefined;\n\n  @property({ type: String })\n  name!: string;\n\n  @property({ type: String })\n  description!: string;\n\n  @property({ type: Number })\n  collectionId!: number;\n\n  @property({ type: String })\n  collectionType!: string;\n\n  @property({ type: String })\n  imageType: YpAiGenerateImageTypes = \"logo\";\n\n  @property({ type: Number })\n  jobId: number | undefined;\n\n  @query(\"#styleText\")\n  styleText!: HTMLInputElement;\n  timeout: number | undefined;\n\n  override async connectedCallback() {\n    super.connectedCallback();\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n  }\n\n  get finalPrompt() {\n    return `\n      Name: ${this.name}\n      Description: ${this.description}\n      Image style: ${this.styleText.value}\n\n      Do not include text or labels in the image except if the user asks for it in the image style.\n    `;\n  }\n\n  async pollForImage() {\n    const pollInterval = 5000; // Poll every 5 seconds, adjust as needed\n\n    const poll = async () => {\n      try {\n        let pollingResponse: YpGenerateAiImageResponse =\n          await window.serverApi.pollForGeneratingAiImage(\n            this.collectionType,\n            this.collectionId as number,\n            this.jobId!\n          );\n\n        if (pollingResponse.data?.imageId) {\n          this.fire(\"got-image\", {\n            imageId: pollingResponse.data.imageId,\n            imageUrl: pollingResponse.data.imageUrl,\n          });\n          this.dialog?.close();\n          this.submitting = false;\n\n          window.appGlobals.activity(`Generate AI Image - completed`);\n        } else if (pollingResponse.error) {\n          this.submitting = false;\n\n          this.fire(\"image-generation-error\", {\n            error: pollingResponse.error\n          });\n\n          // Handle any errors\n          this.currentError = this.t(\n            \"An error occurred while generating the image.\"\n          );\n          if (pollingResponse.flagged) {\n            this.currentError = this.t(\n              \"Your idea has been flagged as inappropriate. Please try again.\"\n            );\n            window.appGlobals.activity(`Generate AI Image - moderation flag`);\n          }\n          window.appGlobals.activity(`Generate AI Image - error`);\n        } else {\n          // Continue polling\n          //@ts-ignore\n          this.timeout = setTimeout(poll, pollInterval);\n        }\n      } catch (error) {\n        console.error(error);\n        this.submitting = false;\n        this.currentError = this.t(\"An error occurred. Please try again.\");\n      }\n    };\n\n    poll();\n  }\n\n  async submit() {\n    window.appGlobals.activity(`Generate AI Image - submit`);\n    this.currentError = undefined;\n    this.submitting = true;\n    let generateAiImageStartResponse:\n      | YpGenerateAiImageStartResponse\n      | undefined;\n    try {\n      generateAiImageStartResponse =\n        await window.serverApi.startGeneratingAiImage(\n          this.collectionType,\n          this.collectionId,\n          this.imageType,\n          this.finalPrompt\n        );\n    } catch (error: any) {\n      console.error(error);\n    }\n\n    if (\n      !generateAiImageStartResponse ||\n      generateAiImageStartResponse.error ||\n      !generateAiImageStartResponse.jobId\n    ) {\n      this.currentError = this.t(\"An error occurred. Please try again.\");\n      window.appGlobals.activity(`Generate AI Image - general error`);\n    } else {\n      this.jobId = generateAiImageStartResponse.jobId;\n\n      // Start polling\n      this.pollForImage();\n    }\n  }\n\n  @query(\"#dialog\")\n  dialog!: MdDialog;\n\n  scrollUp() {\n    //await this.updateComplete;\n    setTimeout(() => {\n      //@ts-ignore\n      (this.$$(\"#dialog\") as MdDialog).contentElement.scrollTop = 0;\n    }, 100);\n  }\n\n  open(name: string | undefined = undefined, description: string | undefined = undefined) {\n    if (name) {\n      this.name = name;\n    }\n    if (description) {\n      this.description = description;\n    }\n    this.dialog.show();\n    this.currentError = undefined;\n    window.appGlobals.activity(`Generate AI Image - open`);\n  }\n\n  cancel() {\n    if (this.timeout) {\n      clearTimeout(this.timeout);\n    }\n    this.dialog?.close();\n    window.appGlobals.activity(`Generate AI Image - cancel`);\n  }\n\n  textAreaKeyDown(e: KeyboardEvent) {\n    if (e.keyCode === 13 && !e.shiftKey) {\n      e.preventDefault();\n      return false;\n    } else {\n      return undefined;\n    }\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        :host {\n          --md-dialog-container-color: var(--md-sys-color-surface);\n        }\n        md-dialog[showing-fullscreen] {\n          /* hack: private! */\n          --_container-max-block-size: 100dvh;\n          --md-dialog-container-inset-block-start: 0px;\n        }\n\n        md-circular-progress {\n          margin-right: 16px;\n          --md-circular-progress-size: 40px;\n        }\n\n        .indexNumber {\n          margin-top: 12px;\n          font-size: 20px;\n          margin-left: 8px;\n          margin-right: 8px;\n          color: var(--md-sys-color-on-surface);\n        }\n\n        .cancelButton {\n        }\n\n        .header {\n          text-align: center;\n        }\n\n        #dialog {\n          width: 100%;\n        }\n\n        #styleText {\n          margin-top: 8px;\n          width: 500px;\n        }\n\n        .questionTitle {\n          margin-top: 0;\n          margin-bottom: 16px;\n          margin-left: 12px;\n          margin-right: 12px;\n          padding: 20px;\n          line-height: 1.5;\n        }\n\n        .description {\n          margin-left: 12px;\n          margin-right: 12px;\n          margin-bottom: 12px;\n        }\n\n        .submitButton {\n          margin-left: 8px;\n        }\n\n        .error {\n          color: var(--md-sys-color-error);\n          font-size: 16px;\n          margin: 8px;\n        }\n\n        @media (max-width: 960px) {\n          #dialog {\n            --_fullscreen-header-block-size: 74px;\n          }\n\n          .footer {\n            margin-bottom: 8px;\n          }\n\n          .questionTitle {\n            margin-top: 16px;\n            margin-bottom: 12px;\n          }\n\n          .cancelButton {\n            margin-right: 32px;\n          }\n\n          .header {\n            padding: 8px;\n            font-size: 22px;\n          }\n\n          #styleText {\n            width: 95%;\n          }\n        }\n      `,\n    ];\n  }\n\n  renderContent() {\n    return html`\n      <div class=\"questionTitle\">${this.name}</div>\n      <div class=\"description\">${this.description}</div>\n\n      <div class=\"layout vertical center-center\">\n        <md-filled-text-field\n          type=\"textarea\"\n          id=\"styleText\"\n          type=\"text\"\n          charCounter\n          @keydown=\"${this.textAreaKeyDown}\"\n          maxLength=\"140\"\n          .rows=\"${this.wide ? 3 : 5}\"\n          label=\"${this.t(\"styleOfAiImage\")}\"\n        >\n        </md-filled-text-field>\n        <div class=\"error\" ?hidden=\"${!this.currentError}\">\n          ${this.currentError}\n        </div>\n      </div>\n    `;\n  }\n\n  renderFooter() {\n    return html` <div class=\"layout horizontal footer\">\n      <md-circular-progress\n        ?hidden=\"${!this.submitting}\"\n        indeterminate\n      ></md-circular-progress>\n      <md-text-button class=\"cancelButton\" @click=\"${this.cancel}\">\n        ${this.t(\"Cancel\")}\n      </md-text-button>\n      <md-outlined-button\n        class=\"submitButton\"\n        @click=\"${this.submit}\"\n        ?disabled=\"${this.submitting}\"\n      >\n        ${this.t(\"generateAiImage\")}\n      </md-outlined-button>\n    </div>`;\n  }\n\n  override render() {\n    return html`<md-dialog\n      ?fullscreen=\"${!this.wide}\"\n      id=\"dialog\"\n      scrimClickAction=\"\"\n    >\n      <div slot=\"headline\">${this.t(\"generateImageWithAi\")}</div>\n      <div slot=\"content\">${this.renderContent()}</div>\n      <div slot=\"actions\">${this.renderFooter()}</div>\n    </md-dialog> `;\n  }\n}\n"]}