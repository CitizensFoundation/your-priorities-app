{"version":3,"file":"AoiServerApi.js","sourceRoot":"","sources":["../../../src/allOurIdeas/survey/AoiServerApi.ts"],"names":[],"mappings":"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","sourcesContent":["import { StringUnitLength } from \"luxon\";\nimport { YpServerApi } from \"../../common/YpServerApi.js\";\n\nexport class AoiServerApi extends YpServerApi {\n  constructor(urlPath: string = \"/api/allOurIdeas\") {\n    super();\n    this.baseUrlPath = urlPath;\n  }\n\n  public getEarlData(groupId: number): AoiEarlResponse {\n    return this.fetchWrapper(\n      this.baseUrlPath + `/${groupId}`\n    ) as unknown as AoiEarlResponse;\n  }\n\n  async getPrompt(groupId: number, questionId: number) {\n    return this.fetchWrapper(\n      this.baseUrlPath + `/${groupId}/questions/${questionId}/prompt`\n    ) as unknown as AoiPromptData;\n  }\n\n  public async getSurveyResults(groupId: number): Promise<AoiChoiceData[]> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `/${groupId}/questions/results`\n    ) as unknown as AoiChoiceData[];\n  }\n\n  getSurveyAnalysis(\n    groupId: number,\n    wsClientId: string,\n    analysisIndex: number,\n    analysisTypeIndex: number,\n    languageName: string\n  ): AoiAnalysisResponse {\n    return this.fetchWrapper(\n      this.baseUrlPath +\n        `/${groupId}/questions/${wsClientId}/${analysisIndex}/${analysisTypeIndex}/analysis?languageName=${languageName}`\n    ) as unknown as AoiAnalysisResponse;\n  }\n\n  async checkLogin() {\n    if (window.appUser.loggedIn()) return true;\n\n    if (window.appGlobals.currentAnonymousGroup) {\n      const user = (await window.serverApi.registerAnonymously({\n        groupId: window.appGlobals.currentAnonymousGroup.id,\n        trackingParameters: window.appGlobals.originalQueryParameters,\n      })) as YpUserData;\n      if (user) {\n        window.appUser.setLoggedInUser(user);\n        return true;\n      } else {\n        return false;\n      }\n    } else {\n      return false;\n    }\n  }\n\n  public async submitIdea(\n    groupId: number,\n    questionId: number,\n    newIdea: string\n  ): Promise<AoiAddIdeaResponse | null> {\n    if (await this.checkLogin()) {\n      return this.fetchWrapper(\n        this.baseUrlPath + `/${groupId}/questions/${questionId}/addIdea`,\n        {\n          method: \"POST\",\n          body: JSON.stringify({ newIdea }),\n        },\n        false\n      ) as unknown as AoiAddIdeaResponse;\n    } else {\n      window.appUser.openUserlogin();\n      return null;\n    }\n  }\n\n  public async postVote(\n    groupId: number,\n    questionId: number,\n    promptId: number,\n    locale: string,\n    body: AoiVoteData,\n    direction: \"left\" | \"right\" | \"skip\"\n  ): Promise<AoiVoteResponse | null> {\n    if (await this.checkLogin()) {\n      const url = new URL(\n        `${window.location.protocol}//${window.location.host}${\n          this.baseUrlPath\n        }/${groupId}/questions/${questionId}/prompts/${promptId}/${\n          direction == \"skip\" ? \"skips\" : \"votes\"\n        }?locale=${locale}`\n      );\n\n      Object.keys(window.appGlobals.originalQueryParameters).forEach((key) => {\n        if (key.startsWith(\"utm_\")) {\n          url.searchParams.append(\n            key,\n            window.aoiAppGlobals.originalQueryParameters[key]\n          );\n        }\n      });\n\n      const browserId = window.appUser.getBrowserId();\n      const browserFingerprint = window.appUser.browserFingerprint;\n      const browserFingerprintConfidence =\n        window.appUser.browserFingerprintConfidence;\n\n      url.searchParams.append(\"checksum_a\", browserId!);\n      url.searchParams.append(\"checksum_b\", browserFingerprint!);\n      url.searchParams.append(\n        \"checksum_c\",\n        browserFingerprintConfidence!.toString()\n      );\n\n      return this.fetchWrapper(\n        url.toString(),\n        {\n          method: \"POST\",\n          body: JSON.stringify(body),\n        },\n        false\n      ) as unknown as AoiVoteResponse;\n    } else {\n      window.appUser.openUserlogin();\n      return null;\n    }\n  }\n\n  public async postVoteSkip(\n    groupId: number,\n    questionId: number,\n    promptId: number,\n    locale: string,\n    body: AoiVoteSkipData\n  ): Promise<AoiVoteResponse | null> {\n    if (await this.checkLogin()) {\n      const url = new URL(\n        `${window.location.protocol}//${window.location.host}${this.baseUrlPath}/${groupId}/questions/${questionId}/prompts/${promptId}/skip.js?locale=${locale}`\n      );\n\n      Object.keys(window.appGlobals.originalQueryParameters).forEach((key) => {\n        if (key.startsWith(\"utm_\")) {\n          url.searchParams.append(\n            key,\n            window.aoiAppGlobals.originalQueryParameters[key]\n          );\n        }\n      });\n\n      const browserId = window.appUser.getBrowserId();\n      const browserFingerprint = window.appUser.browserFingerprint;\n      const browserFingerprintConfidence =\n        window.appUser.browserFingerprintConfidence;\n\n      url.searchParams.append(\"checksum_a\", browserId!);\n      url.searchParams.append(\"checksum_b\", browserFingerprint!);\n      url.searchParams.append(\n        \"checksum_c\",\n        browserFingerprintConfidence!.toString()\n      );\n\n      return this.fetchWrapper(\n        url.toString(),\n        {\n          method: \"POST\",\n          body: JSON.stringify(body),\n        },\n        false\n      ) as unknown as AoiVoteResponse;\n    } else {\n      window.appUser.openUserlogin();\n      return null;\n    }\n  }\n\n  public async getResults(\n    groupId: number,\n    questionId: number,\n    showAll = false\n  ): Promise<AoiChoiceData[]> {\n    return this.fetchWrapper(\n      this.baseUrlPath +\n        `/${groupId}/choices/${questionId}/throughGroup${\n          showAll ? \"?showAll=1\" : \"\"\n        }`\n    ) as unknown as AoiChoiceData[];\n  }\n\n  public llmAnswerConverstation(\n    groupId: number,\n    wsClientId: string,\n    chatLog: PsSimpleChatLog[],\n    languageName: string\n  ): Promise<void> {\n    return this.fetchWrapper(\n      this.baseUrlPath + `/${groupId}/llmAnswerExplain`,\n      {\n        method: \"PUT\",\n        body: JSON.stringify({\n          wsClientId,\n          chatLog,\n          languageName,\n        }),\n      },\n      false\n    );\n  }\n}\n"]}