{"version":3,"file":"yp-streaming-llm-base.js","sourceRoot":"","sources":["../../src/yp-chatbots/yp-streaming-llm-base.ts"],"names":[],"mappings":"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","sourcesContent":["import { property } from \"lit/decorators.js\";\nimport { YpBaseElement } from \"../common/yp-base-element.js\";\n\nexport abstract class YpStreamingLlmBase extends YpBaseElement {\n  @property({ type: Array })\n  chatLog: YpAssistantMessage[] = [];\n\n  @property({ type: String })\n  wsClientId!: string;\n\n  @property({ type: Number })\n  webSocketsErrorCount = 0;\n\n  @property({ type: String })\n  wsEndpoint!: string;\n\n\n  @property({ type: String })\n  scrollElementSelector = \"#chat-messages\";\n\n  @property({ type: Boolean })\n  useMainWindowScroll = false;\n\n  @property({ type: Boolean })\n  userScrolled = false;\n\n  @property({ type: String })\n  currentFollowUpQuestions: string = \"\";\n\n  @property({ type: Boolean })\n  programmaticScroll = false;\n\n  @property({ type: Boolean })\n  disableAutoScroll = false;\n\n  @property({ type: Number })\n  scrollStart: number = 0;\n\n  @property({ type: String })\n  serverMemoryId: string | undefined;\n\n  @property({ type: Number })\n  defaultDevWsPort = 4242;\n\n  ws!: WebSocket;\n\n  disableWebsockets = false;\n  wsManuallyClosed = false;\n\n  heartbeatInterval: number | undefined;\n  heartbeatTimeout: number | undefined;\n  heartbeatAcked = false;\n  reconnectDelay = 2000;\n\n  private isConnecting = false;\n  reconnectTimer: number | undefined;\n\n  heartBeatRate = 50000;\n\n  constructor() {\n    super();\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (!this.disableWebsockets) {\n      this.initWebSockets();\n    }\n  }\n\n  initWebSockets() {\n    // Prevent multiple connections:\n    if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {\n      console.info(\"WebSocket is already connected or connecting, skipping new connection.\");\n      return;\n    }\n    if (this.isConnecting) {\n      console.info(\"WebSocket connection is already in progress.\");\n      return;\n    }\n    this.isConnecting = true;\n\n    // Clear heartbeat intervals/timeouts if any\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = undefined;\n    }\n    if (this.heartbeatTimeout) {\n      clearTimeout(this.heartbeatTimeout);\n      this.heartbeatTimeout = undefined;\n    }\n\n    let endpoint: string;\n    if (\n      window.location.hostname === \"localhost\" ||\n      window.location.hostname.startsWith(\"192.168\")\n    ) {\n      endpoint = `ws://${window.location.hostname}:${this.defaultDevWsPort}`;\n    } else {\n      endpoint = `wss://${window.location.hostname}:443`;\n    }\n\n    try {\n      this.ws = new WebSocket(endpoint);\n      console.info(\"WebSocket: Attempting connection to\", endpoint);\n\n      // Setup temporary message handler for handshake\n      this.ws.onmessage = (event) => {\n        const data = JSON.parse(event.data);\n        if (data.clientId) {\n          this.wsClientId = data.clientId;\n          console.info(`Received clientId: ${this.wsClientId}`);\n          this.fire(\"yp-ws-opened\", { clientId: this.wsClientId });\n          // Switch to main message handler and start heartbeat\n          this.ws!.onmessage = this.onMessage.bind(this);\n          this.startHeartbeat();\n          this.isConnecting = false;\n        } else if (data.type === \"heartbeat_ack\") {\n          this.heartbeatAcked = true;\n          console.debug(\"Heartbeat ack received\");\n        } else {\n          // Fallback for other messages before handshake completes\n          this.onMessage(event);\n        }\n      };\n\n      this.ws.onopen = () => {\n        console.info(\"WebSocket connection opened\");\n        // Immediately send a heartbeat to kick things off\n        this.sendHeartbeat();\n      };\n\n      this.ws.onerror = (error) => {\n        console.error(\"WebSocket error:\", error);\n        this.scheduleReconnect();\n        this.fire(\"yp-ws-error\", { error });\n      };\n\n      this.ws.onclose = (event) => {\n        console.warn(\"WebSocket closed:\", event);\n        this.scheduleReconnect();\n        this.fire(\"yp-ws-closed\");\n      };\n    } catch (error) {\n      console.error(\"Error initializing WebSocket:\", error);\n      this.scheduleReconnect();\n      this.fire(\"yp-ws-error\", { error });\n      this.isConnecting = false;\n    }\n  }\n\n  startHeartbeat() {\n    // Clear any previous intervals/timeouts\n    console.info(\"Starting heartbeat\");\n    if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);\n    if (this.heartbeatTimeout) clearTimeout(this.heartbeatTimeout);\n\n    this.heartbeatInterval = window.setInterval(() => {\n      this.heartbeatAcked = false;\n      this.sendHeartbeat();\n\n      if (this.heartbeatTimeout) {\n        clearTimeout(this.heartbeatTimeout);\n      }\n      this.heartbeatTimeout = window.setTimeout(() => {\n        if (!this.heartbeatAcked) {\n          console.error(\"Heartbeat ack not received, reconnecting...\");\n          this.ws && this.ws.close(); // onclose will trigger reconnect\n        }\n      }, this.heartBeatRate * 0.8);\n    }, this.heartBeatRate);\n  }\n\n  sendHeartbeat() {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      console.info(\"Sending heartbeat\");\n      this.ws.send(JSON.stringify({ type: \"heartbeat\" }));\n    } else {\n      console.error(\"Cannot send heartbeat, socket not open\");\n    }\n  }\n\n  scheduleReconnect() {\n    console.info(\"Scheduling reconnect\");\n    if (this.wsManuallyClosed) return;\n\n    console.info(\"Clearing heartbeat intervals and reconnect timer\");\n    // Clear heartbeat intervals and any previous reconnect timer\n    if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);\n    if (this.heartbeatTimeout) clearTimeout(this.heartbeatTimeout);\n    if (this.reconnectTimer) clearTimeout(this.reconnectTimer);\n\n    this.heartbeatInterval = undefined;\n    this.heartbeatTimeout = undefined;\n\n    this.reconnectTimer = window.setTimeout(() => {\n      console.info(\"Reconnecting WebSocket...\");\n      this.initWebSockets();\n      // Increase delay for subsequent attempts (optional max cap can be added)\n      this.reconnectDelay *= 1.5;\n    }, this.reconnectDelay);\n  }\n\n  public sendMessage(action: string, payload: any) {\n    console.info(\"Sending message\");\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(\n        JSON.stringify({\n          clientId: this.wsClientId,\n          action,\n          payload,\n        })\n      );\n    } else {\n      console.error(\"WebSocket not open; cannot send message\");\n    }\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n\n    console.info(\"Disconnected callback called, clearing heartbeat intervals and reconnect timer\");\n\n    if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);\n    if (this.heartbeatTimeout) clearTimeout(this.heartbeatTimeout);\n    if (this.reconnectTimer) clearTimeout(this.reconnectTimer);\n\n    if (this.ws) {\n      this.wsManuallyClosed = true;\n      this.ws.close();\n    }\n    // Reset our connection flag\n    this.isConnecting = false;\n  }\n\n  async onMessage(event: MessageEvent) {\n    const data = JSON.parse(event.data);\n    // Add a small check for heartbeat_ack:\n    if (data.type === \"heartbeat_ack\") {\n      this.heartbeatAcked = true;\n      console.info(\"Heartbeat ack received\");\n      // Possibly return here or break,\n      // but if heartbeat_ack can coincide with other message data, handle that\n      return;\n    }\n\n    // If there's also a chance we get a \"clientId\" again,\n    // you could handle that as well. But probably not needed.\n\n    // Then handle your normal \"assistant\"/\"user\" messages\n    switch (data.sender) {\n      case \"assistant\":\n        this.addChatBotElement(data);\n        break;\n      case \"user\":\n        this.addChatUserElement(data);\n        break;\n    }\n\n    // If it's not any of these streaming or heartbeat messages, scroll\n    if (\n      data.type !== \"stream_followup\" &&\n      data.type !== \"voice_input\" &&\n      data.type !== \"updated_workflow\" &&\n      data.type !== \"heartbeat_ack\" && // you already handled that\n      data.type !== \"hiddenContextMessage\"\n    ) {\n      this.scrollDown();\n    }\n  }\n\n  scrollDown() {\n    if (this.disableAutoScroll) {\n      return;\n    }\n\n    if (\n      !this.userScrolled &&\n      (this.$$(this.scrollElementSelector) || this.useMainWindowScroll)\n    ) {\n      this.programmaticScroll = true;\n      let element;\n      if (this.useMainWindowScroll) {\n        element = window.document.documentElement;\n      } else if (this.$$(this.scrollElementSelector)) {\n        element = this.$$(this.scrollElementSelector)!;\n      }\n\n      if (\n        element?.tagName === \"INPUT\" ||\n        element?.tagName === \"TEXTAREA\" ||\n        element?.tagName === \"MD-OUTLINED-TEXT-FIELD\"\n      ) {\n        // Move the cursor to the end of the text\n        (element as HTMLInputElement).selectionStart = (\n          element as HTMLInputElement\n        ).selectionEnd = (element as HTMLInputElement).value.length;\n        element.scrollTop = element.scrollHeight - 100;\n      } else {\n        // For non-text field elements, use scrollTop and scrollHeight to scroll\n        element!.scrollTop = element!.scrollHeight;\n      }\n\n      setTimeout(() => {\n        this.programmaticScroll = false;\n      }, 100);\n    } else {\n      console.error(\"User scrolled, not scrolling down\");\n    }\n  }\n\n  handleScroll() {\n    if (this.disableAutoScroll) {\n      return;\n    }\n\n    if (\n      this.programmaticScroll ||\n      (!this.$$(this.scrollElementSelector) && !this.useMainWindowScroll)\n    ) {\n      console.error(\n        `handleScroll: programmaticScroll: ${this.programmaticScroll} or scrollElementSelector: ${this.scrollElementSelector} not found`\n      );\n      return;\n    }\n\n    let currentScrollTop = 0;\n    if (this.$$(this.scrollElementSelector)) {\n      currentScrollTop = this.$$(this.scrollElementSelector)!.scrollTop;\n    } else if (this.useMainWindowScroll) {\n      currentScrollTop = window.scrollY;\n    }\n\n    if (this.scrollStart === 0) {\n      // Initial scroll\n      this.scrollStart = currentScrollTop;\n    }\n\n    const threshold = 10;\n\n    let atBottom;\n\n    if (this.useMainWindowScroll) {\n      atBottom =\n        this.$$(this.scrollElementSelector)!.scrollHeight -\n          currentScrollTop -\n          this.$$(this.scrollElementSelector)!.clientHeight <=\n        threshold;\n    } else if (this.$$(this.scrollElementSelector)) {\n      atBottom =\n        document.documentElement.scrollHeight -\n          currentScrollTop -\n          window.innerHeight <=\n        threshold;\n    }\n\n    if (atBottom) {\n      this.userScrolled = false;\n      this.scrollStart = 0; // Reset scroll start\n    } else if (Math.abs(this.scrollStart - currentScrollTop) > threshold) {\n      this.userScrolled = true;\n      // Optionally reset scrollStart here if you want to continuously check for threshold scroll\n      // this.scrollStart = currentScrollTop;\n    }\n  }\n\n  addUserChatBotMessage(userMessage: string) {\n    this.addChatBotElement({\n      sender: \"user\",\n      type: \"start\",\n      message: userMessage,\n    });\n  }\n\n  addThinkingChatBotMessage() {\n    this.addChatBotElement({\n      sender: \"assistant\",\n      type: \"thinking\",\n      message: \"\",\n    });\n  }\n\n  abstract addChatBotElement(wsMessage: YpAssistantMessage): Promise<void>;\n\n  addChatUserElement(data: YpAssistantMessage) {\n    this.chatLog = [...this.chatLog, data];\n  }\n\n  get simplifiedChatLog() {\n    let chatLog = this.chatLog.filter(\n      (chatMessage) =>\n        chatMessage.type != \"thinking\" &&\n        chatMessage.type != \"noStreaming\" &&\n        chatMessage.sender != \"system\"\n    );\n    return chatLog.map((chatMessage) => {\n      return {\n        ...chatMessage,\n        message: chatMessage.rawMessage\n          ? chatMessage.rawMessage\n          : chatMessage.message,\n      };\n    }) as PsSimpleChatLog[];\n  }\n\n\n\n  reset() {\n    this.chatLog = [];\n    if (this.ws) {\n      this.ws.close();\n      this.initWebSockets();\n    }\n    this.serverMemoryId = undefined;\n    this.requestUpdate();\n  }\n}\n"]}