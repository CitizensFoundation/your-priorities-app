{"version":3,"file":"YpOffline.js","sourceRoot":"","sources":["../../src/yp-app/YpOffline.ts"],"names":[],"mappings":"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","sourcesContent":["import { YpCodeBase } from '../common/YpCodeBaseclass.js'\n\nexport class YpOffline extends YpCodeBase {\n\n  sendLaterStoragePrefix = \"yp-send-later-\";\n\n  _onlineEvent() {\n    this.showToast(this.t('youAreOnline'));\n    this._checkContentToSend();\n  }\n\n  _offlineEvent() {\n    this.showToast(this.t('youAreNowOffline'));\n  }\n\n  _urlWithQuery(url: string, params: any) {\n    const query = Object.keys(params)\n      .filter(k => params[k] !== undefined && typeof params[k] !== 'object')\n      .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))\n      .join('&');\n    url += (url.indexOf('?') === -1 ? '?' : '&') + query;\n    return url;\n  }\n\n  _getItemsFromLocalStorage() {\n    const items = [] as YpLocaleStorageItemToSendLater[];\n    for (let i = 0; i < localStorage.length; i++)\n    {\n      const key = localStorage.key(i);\n      if (key && key.indexOf(this.sendLaterStoragePrefix) > -1) {\n        items.push({ key: key, content: JSON.parse(localStorage.getItem(key)!) });\n      }\n    }\n\n    return items;\n  }\n\n  _sendItems(items: YpLocaleStorageItemToSendLater[]) {\n    items.forEach((item) => {\n      const content = item.content;\n      fetch(content.url, {\n        method: content.method,\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(content.body)\n      }).then(() => {\n        this.showToast(this.t('storedDataSent'));\n        localStorage.removeItem(item.key);\n      }).catch((error) => {\n        console.error(error);\n        this.showToast(this.t('errorSendingContentWhenOnline'));\n      })\n    })\n  }\n\n  _checkContentToSend() {\n    setTimeout( () => {\n      const items = this._getItemsFromLocalStorage();\n      if (items.length>0) {\n        if (!navigator.onLine) {\n          this.showToast(this.t('offlineContentSentWhenOnline'));\n        } else if (!window.appUser.user) {\n          this.showToast(this.t('notLoggedInContentSentWhenLoggedIn'));\n        } else {\n          this._sendItems(items);\n        }\n      } else {\n        if (!navigator.onLine) {\n          this.showToast(this.t('youAreOffline'));\n        }\n      }\n    }, 4000);\n  }\n\n  checkContentToSendForLoggedInUser() {\n    this._checkContentToSend();\n  }\n\n  sendWhenOnlineNext(contentToSendLater: YpContentToSendLater) {\n    setTimeout(() => {\n      const key = this.sendLaterStoragePrefix+new Date().getTime();\n      localStorage.setItem(key, JSON.stringify(contentToSendLater));\n      this.showToast(this.t('offlineContentSentWhenOnline'));\n    });\n  }\n\n  constructor() {\n    super();\n    window.addEventListener('online',  this._onlineEvent.bind(this));\n    window.addEventListener('offline', this._offlineEvent.bind(this));\n    this._checkContentToSend();\n  }\n}\n"]}