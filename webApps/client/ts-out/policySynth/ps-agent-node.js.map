{"version":3,"file":"ps-agent-node.js","sourceRoot":"","sources":["../../src/policySynth/ps-agent-node.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, nothing } from \"lit\";\nimport { property, query, customElement, state } from \"lit/decorators.js\";\n\nimport \"@material/web/iconbutton/icon-button.js\";\nimport \"@material/web/progress/circular-progress.js\";\nimport \"@material/web/progress/linear-progress.js\";\nimport \"@material/web/menu/menu.js\";\nimport \"@material/web/menu/menu-item.js\";\n\nimport { PsServerApi } from \"./PsServerApi.js\";\nimport { PsOperationsBaseNode } from \"./ps-operations-base-node.js\";\nimport { MdMenu } from \"@material/web/menu/menu.js\";\n\n@customElement(\"ps-agent-node\")\nexport class PsAgentNode extends PsOperationsBaseNode {\n  @property({ type: Object })\n  agent!: PsAgentAttributes;\n\n  @property({ type: Number })\n  agentId!: number;\n\n  @property({ type: Number }) groupId!: number;\n\n  @state()\n  private agentState: \"running\" | \"paused\" | \"stopped\" | \"error\" | \"completed\" = \"stopped\";\n\n  @state()\n  private latestMessage: string = \"\";\n\n  @state()\n  private progress: number | undefined;\n\n  @state()\n  private menuOpen = false;\n\n  @query(\"#menuAnchor\")\n  menuAnchor!: HTMLElement;\n\n  @query(\"#agentMenu\")\n  agentMenu!: MdMenu;\n\n  override api: PsServerApi;\n  private statusInterval: number | undefined;\n\n  constructor() {\n    super();\n    this.api = new PsServerApi();\n  }\n\n  override firstUpdated() {\n    if (this.agentMenu && this.menuAnchor) {\n      (this.agentMenu as MdMenu).anchorElement = this.menuAnchor;\n    }\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this.agent = window.psAppGlobals.getAgentInstance(this.agentId)!;\n    this.updateAgentStatus(); // Initial status check\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this.stopStatusUpdates();\n  }\n\n  toggleMenu(e: Event) {\n    e.stopPropagation();\n    if (this.agentMenu) {\n      this.agentMenu.open = !this.agentMenu.open;\n    }\n  }\n\n  addInputConnector() {\n    this.fire(\"add-connector\", { agentId: this.agent.id, type: \"input\" });\n    this.menuOpen = false;\n  }\n\n  addOutputConnector() {\n    this.fire(\"add-connector\", { agentId: this.agent.id, type: \"output\" });\n    this.menuOpen = false;\n  }\n\n  startStatusUpdates() {\n    this.statusInterval = window.setInterval(\n      () => this.updateAgentStatus(),\n      1000\n    );\n  }\n\n  stopStatusUpdates() {\n    if (this.statusInterval) {\n      clearInterval(this.statusInterval);\n      this.statusInterval = undefined;\n    }\n  }\n\n  async updateAgentStatus() {\n    try {\n      const status = await this.api.getAgentStatus(this.groupId, this.agent.id);\n      if (status) {\n        this.agentState = status.state as\n          | \"running\"\n          | \"paused\"\n          | \"stopped\"\n          | \"completed\"\n          | \"error\";\n        this.progress = status.progress;\n        this.latestMessage = status.messages[status.messages.length - 1] || \"\";\n\n        if (this.agentState === \"stopped\" || this.agentState === \"error\") {\n          this.stopStatusUpdates();\n        } else if (this.agentState === \"running\" && !this.statusInterval) {\n          console.log(\"Starting status updates from server\");\n          this.startStatusUpdates();\n        }\n\n        this.requestUpdate();\n        this.fire(\"get-costs\");\n      }\n    } catch (error) {\n      console.error(\"Failed to get agent status:\", error);\n    }\n  }\n\n  async startAgent() {\n    try {\n      await this.api.startAgent(this.groupId, this.agent.id);\n      this.agentState = \"running\";\n      window.psAppGlobals.setCurrentRunningAgentId(this.agent.id);\n      this.startStatusUpdates();\n      this.requestUpdate();\n    } catch (error) {\n      console.error(\"Failed to start agent:\", error);\n    }\n  }\n\n  async pauseAgent() {\n    try {\n      await this.api.pauseAgent(this.groupId, this.agent.id);\n      this.agentState = \"paused\";\n      this.requestUpdate();\n    } catch (error) {\n      console.error(\"Failed to pause agent:\", error);\n    }\n  }\n\n  async stopAgent() {\n    try {\n      await this.api.stopAgent(this.groupId, this.agent.id);\n      this.agentState = \"stopped\";\n      window.psAppGlobals.setCurrentRunningAgentId(undefined);\n      this.stopStatusUpdates();\n      this.requestUpdate();\n    } catch (error) {\n      console.error(\"Failed to stop agent:\", error);\n    }\n  }\n\n  override editNode() {\n    this.fire(\"edit-node\", {\n      nodeId: this.nodeId,\n      element: this.agent,\n    });\n  }\n\n  renderActionButtons() {\n    switch (this.agentState) {\n      case \"running\":\n        return html`\n          <md-icon-button @click=\"${this.pauseAgent}\" disabled>\n            <md-icon>pause</md-icon>\n          </md-icon-button>\n          <md-icon-button @click=\"${this.stopAgent}\">\n            <md-icon>stop</md-icon>\n          </md-icon-button>\n        `;\n      case \"paused\":\n        return html`\n          <md-icon-button @click=\"${this.startAgent}\">\n            <md-icon>play_arrow</md-icon>\n          </md-icon-button>\n          <md-icon-button @click=\"${this.stopAgent}\">\n            <md-icon>stop</md-icon>\n          </md-icon-button>\n        `;\n      case \"stopped\":\n      case \"completed\":\n      case \"error\":\n        return html`\n          <md-icon-button @click=\"${this.startAgent}\">\n            <md-icon>play_arrow</md-icon>\n          </md-icon-button>\n        `;\n    }\n  }\n\n  renderProgress() {\n    if (this.progress === undefined) {\n      return html`<md-linear-progress indeterminate></md-linear-progress>`;\n    } else {\n      const progress = Math.min(1, Math.max(0, this.progress / 100));\n      return html`<md-linear-progress\n        value=\"${progress}\"\n      ></md-linear-progress>`;\n    }\n  }\n\n  override render() {\n    if (!this.agent) return nothing;\n\n    return html`\n      <div class=\"mainContainer\">\n        <img\n          class=\"image\"\n          src=\"${this.agent.Class?.configuration.imageUrl}\"\n          alt=\"${this.agent.Class?.name}\"\n        />\n        <div class=\"contentContainer\">\n          <div class=\"agentName\">${this.agent.configuration[\"name\"]}</div>\n          <div class=\"agentClassName\">${this.agent.Class?.name}</div>\n          ${this.agentState === \"running\" ? this.renderProgress() : nothing}\n          <div class=\"statusMessage\">${this.latestMessage}</div>\n        </div>\n        <div class=\"buttonContainer\">\n          <md-icon-button id=\"menuAnchor\" @click=\"${this.toggleMenu}\">\n            <md-icon>more_vert</md-icon>\n          </md-icon-button>\n          <md-menu id=\"agentMenu\" positioning=\"popover\">\n            <md-menu-item @click=\"${this.addInputConnector}\">\n              <div slot=\"headline\">Add Input Connector</div>\n            </md-menu-item>\n            <md-menu-item @click=\"${this.addOutputConnector}\">\n              <div slot=\"headline\">Add Output Connector</div>\n            </md-menu-item>\n          </md-menu>\n\n          ${this.renderActionButtons()}\n\n          <md-icon-button @click=\"${this.editNode}\">\n            <md-icon>settings</md-icon>\n          </md-icon-button>\n        </div>\n      </div>\n    `;\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        :host {\n          display: block;\n        }\n\n        .buttonContainer {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 8px;\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          right: 0;\n        }\n\n        md-icon-button {\n          margin: 0 4px;\n        }\n\n        :host {\n          display: block;\n          position: relative;\n        }\n\n        .mainContainer {\n          position: relative;\n        }\n\n        md-menu {\n          --md-menu-container-color: var(--md-sys-color-surface-container);\n          --md-menu-container-elevation: 2;\n          z-index: 2000;\n        }\n\n        md-linear-progress {\n          margin: 16px;\n          margin-bottom: 8px;\n          margin-top: 8px;\n        }\n\n        .mainContainer {\n          height: 300px;\n          border-radius: 16px;\n          display: flex;\n          flex-direction: column;\n          overflow: hidden;\n          position: relative;\n        }\n\n        .image {\n          width: 100%;\n          height: 113px;\n          object-fit: cover;\n          border-radius: 16px 16px 0 0;\n        }\n\n        .contentContainer {\n          flex-grow: 1;\n          display: flex;\n          flex-direction: column;\n          padding: 8px;\n        }\n\n        .agentClassName {\n          font-size: 9px;\n          text-align: center;\n          margin: 8px;\n        }\n\n        .agentName {\n          font-size: 14px;\n          text-align: center;\n        }\n\n        .statusMessage {\n          font-size: 11px;\n          text-align: center;\n          margin-top: 8px;\n          border-radius: 16px;\n          flex-grow: 1;\n          color: var(--md-sys-color-on-surface-variant);\n        }\n\n        .buttonContainer {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 8px;\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          right: 0;\n        }\n\n        md-circular-progress {\n          --md-circular-progress-size: 28px;\n        }\n\n        md-menu {\n          --md-menu-z-index: 1000;\n          z-index: 1000;\n        }\n\n        [hidden] {\n          display: none !important;\n        }\n      `,\n    ];\n  }\n}\n"]}