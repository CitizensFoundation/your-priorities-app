{"version":3,"file":"ps-edit-node-dialog.js","sourceRoot":"","sources":["../../src/policySynth/ps-edit-node-dialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, css } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\n\nimport '@material/web/dialog/dialog.js';\nimport '@material/web/button/text-button.js';\nimport '@material/web/button/filled-button.js';\nimport '@material/web/select/filled-select.js';\nimport '@material/web/select/select-option.js';\nimport '../yp-survey/yp-structured-question-edit.js';\nimport './ps-ai-model-selector.js';\n\nimport { PsAiModelSize } from '@policysynth/agents/aiModelTypes.js';\nimport { PsServerApi } from './PsServerApi.js';\nimport { YpBaseElement } from '../common/yp-base-element.js';\n\n@customElement('ps-edit-node-dialog')\nexport class PsEditNodeDialog extends YpBaseElement {\n  @property({ type: Boolean }) open = false;\n  @property({ type: Object }) nodeToEditInfo: any;\n\n  @property({ type: Number }) groupId!: number;\n\n  @state() private activeAiModels: PsAiModelAttributes[] = [];\n  @state() private selectedAiModels: {\n    [key in PsAiModelSize]?: number | null;\n  } = {};\n  @state() private currentModels: {\n    [key in PsAiModelSize]?: PsAiModelAttributes;\n  } = {};\n\n  private api = new PsServerApi();\n\n  override async connectedCallback() {\n    super.connectedCallback();\n    await this.fetchActiveAiModels();\n  }\n\n  async fetchActiveAiModels() {\n    try {\n      this.activeAiModels = await this.api.getActiveAiModels(this.groupId);\n    } catch (error) {\n      console.error('Error fetching active AI models:', error);\n    }\n  }\n\n  override updated(changedProperties: Map<string, any>) {\n    if (\n      changedProperties.has('nodeToEditInfo')\n    ) {\n      this.initializeCurrentModels();\n    }\n  }\n\n  initializeCurrentModels() {\n    if (this.nodeToEditInfo && this.nodeToEditInfo.AiModels) {\n      this.currentModels = this._getCurrentModels();\n    }\n  }\n\n  _getCurrentModels() {\n    const currentModels: { [key in PsAiModelSize]?: PsAiModelAttributes } = {};\n    this.nodeToEditInfo.AiModels?.forEach((model: PsAiModelAttributes) => {\n      if (model.configuration && 'modelSize' in model.configuration) {\n        currentModels[model.configuration.modelSize as PsAiModelSize] = model;\n      }\n    });\n    return currentModels;\n  }\n\n  disableScrim(event: CustomEvent) {\n    event.stopPropagation();\n    event.preventDefault();\n  }\n\n  override render() {\n    return html`\n      <md-dialog\n        ?open=\"${this.open}\"\n        @closed=\"${this._handleClose}\"\n        @cancel=\"${this.disableScrim}\"\n      >\n        <div slot=\"headline\">\n          ${this.nodeToEditInfo ? this._renderNodeEditHeadline() : ''}\n        </div>\n        <div slot=\"content\" class=\"dialog-content\">\n          ${this.nodeToEditInfo ? this._renderEditForm() : ''}\n        </div>\n        <div slot=\"actions\">\n          <md-text-button @click=\"${this._handleClose}\"\n            >${this.t('cancel')}</md-text-button\n          >\n          <md-filled-button @click=\"${this._handleSave}\"\n            >${this.t('save')}</md-filled-button\n          >\n        </div>\n      </md-dialog>\n    `;\n  }\n\n  _renderNodeEditHeadline() {\n    return html`\n      <div class=\"layout horizontal\">\n        <div>\n          <img\n            src=\"${this.nodeToEditInfo.Class.configuration.imageUrl}\"\n            class=\"nodeEditHeadlineImage\"\n          />\n        </div>\n        <div class=\"nodeEditHeadlineTitle\">\n          ${this.nodeToEditInfo.Class.name}\n        </div>\n      </div>\n    `;\n  }\n\n  _renderEditForm() {\n    return html`\n      <div id=\"surveyContainer\">\n        ${this.nodeToEditInfo.Class.configuration.questions.map(\n          (question: YpStructuredQuestionData, index: number) => html`\n            <yp-structured-question-edit\n              index=\"${index}\"\n              id=\"structuredQuestion_${question.uniqueId\n                ? index\n                : `noId_${index}`}\"\n              .structuredAnswers=\"${this._getInitialAnswers()}\"\n              .question=\"${question}\"\n            >\n            </yp-structured-question-edit>\n          `\n        )}\n        ${this._renderAiModelSelector()}\n      </div>\n    `;\n  }\n\n  _renderAiModelSelector() {\n    if (!this.nodeToEditInfo.Class.configuration.requestedAiModelSizes) {\n      return '';\n    }\n\n    return html`\n      <ps-ai-model-selector\n        .activeAiModels=\"${this.activeAiModels}\"\n        .requestedAiModelSizes=\"${this.nodeToEditInfo.Class.configuration\n          .requestedAiModelSizes}\"\n        .currentModels=\"${this.currentModels}\"\n        @ai-models-changed=\"${this._handleAiModelsChanged}\"\n      ></ps-ai-model-selector>\n    `;\n  }\n\n  _getInitialAnswers() {\n    return Object.entries(this.nodeToEditInfo.configuration).map(\n      ([key, value]) => ({\n        uniqueId: key,\n        value: value,\n      })\n    );\n  }\n\n  _handleClose() {\n    this.dispatchEvent(new CustomEvent('close'));\n  }\n\n  _handleAiModelsChanged(e: CustomEvent) {\n    this.selectedAiModels = e.detail.selectedAiModelIds;\n  }\n\n  _handleSave() {\n    const updatedConfig = {} as Record<string, any>;\n    this.nodeToEditInfo.Class.configuration.questions.forEach(\n      (question: YpStructuredQuestionData, index: number) => {\n        const questionElement = this.shadowRoot?.querySelector(\n          `#structuredQuestion_${question.uniqueId ? index : `noId_${index}`}`\n        ) as any;\n        if (questionElement && question.uniqueId) {\n          const answer = questionElement.getAnswer();\n          if (answer) {\n            updatedConfig[question.uniqueId] = answer.value;\n          }\n        }\n      }\n    );\n\n    let aiModelUpdates;\n\n    if (this.nodeToEditInfo.Class.configuration.requestedAiModelSizes) {\n      aiModelUpdates = Object.entries(this.selectedAiModels).map(\n        ([size, modelId]) => {\n          return {\n            size: size as PsAiModelSize,\n            modelId: modelId as number | null,\n          };\n        }\n      );\n    }\n\n    this.dispatchEvent(\n      new CustomEvent('save', {\n        detail: {\n          updatedConfig,\n          aiModelUpdates,\n          connectorType:\n            this.nodeToEditInfo.Class.configuration.type === 'input'\n              ? 'input'\n              : 'output',\n        },\n      })\n    );\n\n    this._handleClose();\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        .nodeEditHeadlineImage {\n          max-width: 100px;\n          margin-right: 16px;\n        }\n\n        .nodeEditHeadlineTitle {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          height: 55px;\n        }\n\n        md-dialog {\n          width: 90%;\n          height: 90%;\n        }\n\n        #surveyContainer {\n          margin-bottom: 48px;\n        }\n      `,\n    ];\n  }\n}\n"]}