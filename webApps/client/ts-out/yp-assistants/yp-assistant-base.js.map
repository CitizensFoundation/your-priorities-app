{"version":3,"file":"yp-assistant-base.js","sourceRoot":"","sources":["../../src/yp-assistants/yp-assistant-base.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, nothing, PropertyValueMap } from \"lit\";\nimport { property, customElement, state, query } from \"lit/decorators.js\";\nimport { YpChatbotBase } from \"../yp-chatbots/yp-chatbot-base.js\";\nimport \"./yp-assistant-item-base.js\";\nimport { literal } from \"lit/static-html.js\";\nimport { WavRecorder } from \"../tools/wavTools/wav_recorder.js\";\nimport { WavStreamPlayer } from \"../tools/wavTools/wav_stream_player.js\";\nimport { YpAssistantServerApi } from \"./AssistantServerApi.js\";\nimport { WavRenderer } from \"./wave-renderer.js\";\nimport { YpConfirmationDialog } from \"../yp-dialog-container/yp-confirmation-dialog.js\";\nimport { YpServerApi } from \"../common/YpServerApi.js\";\n\n@customElement(\"yp-assistant-base\")\nexport abstract class YpAssistantBase extends YpChatbotBase {\n  @property({ type: Boolean })\n  voiceEnabled = false;\n\n  @property({ type: Number })\n  domainId!: number;\n\n  @property({ type: String })\n  mainAssistantAvatarUrl: string | undefined;\n\n  @property({ type: String })\n  directAgentAvatarUrl: string | undefined;\n\n  @property({ type: Boolean })\n  override useMainWindowScroll = true;\n\n  @property({ type: String })\n  directAgentName: string | null = null;\n\n  @state()\n  private mediaRecorder: WavRecorder | null = null;\n\n  @state()\n  private wavStreamPlayer: WavStreamPlayer | null = null;\n\n  @state()\n  private isRecording = false;\n\n  @state()\n  userIsSpeaking = false;\n\n  @state()\n  aiIsSpeaking = false;\n\n  @property({ type: Boolean })\n  override onlyUseTextField = true;\n\n  @property({ type: Array })\n  chatLogFromServer: YpAssistantMessage[] | undefined;\n\n  @state()\n  currentMode = \"\";\n\n  @state()\n  isExpanded = false;\n\n  @query(\"#voiceButton\")\n  voiceButton!: HTMLElement;\n\n  @property({ type: String })\n  override textInputLabel = \"Ask me anything with text or...\";\n\n  @property({ type: String })\n  override defaultInfoMessage: string | undefined =\n    \"I'm your friendly chat assistant\";\n\n  override chatbotItemComponentName = literal`yp-assistant-item-base`;\n\n  @query(\"#waveformCanvas\")\n  private waveformCanvas!: HTMLCanvasElement;\n\n  private canvasCtx: CanvasRenderingContext2D | null = null;\n  private renderLoopActive = false;\n\n  private haveLoggedIn = false;\n\n  aiSpeakingTimeout: NodeJS.Timeout | undefined;\n\n  serverApi!: YpAssistantServerApi;\n\n  clientMemoryUuid: string;\n\n  constructor() {\n    super();\n    this.setupVoiceCapabilities();\n    const storageKey = `yp-assistant-${this.domainId}-client-uuid`;\n    const savedUuid = localStorage.getItem(storageKey);\n    if (savedUuid) {\n      this.clientMemoryUuid = savedUuid;\n      window.appGlobals.currentClientMemoryUuid = savedUuid;\n    } else {\n      this.clientMemoryUuid = crypto.randomUUID();\n      localStorage.setItem(storageKey, this.clientMemoryUuid);\n      window.appGlobals.currentClientMemoryUuid = this.clientMemoryUuid;\n    }\n    this.setupServerApi();\n  }\n\n  override async setupServerApi(): Promise<void> {\n    this.serverApi = new YpAssistantServerApi(this.clientMemoryUuid);\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.getMemoryFromServer();\n    this.addGlobalListener(\"yp-logged-in\", this.userLoggedIn.bind(this));\n    this.addGlobalListener(\n      \"agent-configuration-submitted\",\n      this.agentConfigurationSubmitted.bind(this)\n    );\n  }\n\n  async agentConfigurationSubmitted() {\n    const clientSystemMessage: YpAssistantMessage = {\n      type: \"client_system_message\",\n      sender: \"system\",\n      message: \"agent_configuration_submitted\",\n    };\n    this.ws.send(JSON.stringify(clientSystemMessage));\n  }\n\n  async userLoggedIn(event: CustomEvent) {\n    if (!event.detail) {\n      return;\n    }\n\n    if (this.haveLoggedIn) {\n      console.log(\"User already logged in for assistant\");\n      return;\n    }\n    this.haveLoggedIn = true;\n    await this.serverApi.updateAssistantMemoryUserLoginStatus(this.domainId);\n\n    const clientSystemMessage: YpAssistantMessage = {\n      type: \"client_system_message\",\n      sender: \"system\",\n      message: \"user_logged_in\",\n    };\n    this.ws.send(JSON.stringify(clientSystemMessage));\n  }\n\n  override firstUpdated(\n    changedProperties: PropertyValueMap<any> | Map<PropertyKey, unknown>\n  ) {\n    if (changedProperties) {\n      super.firstUpdated(changedProperties);\n    }\n  }\n\n  async getMemoryFromServer() {\n    if (!this.chatLog || this.chatLog.length === 0) {\n      try {\n        const { chatLog, modeData, currentMode } =\n          (await this.serverApi.getMemoryFromServer(\n            this.domainId\n          )) as YpBaseAssistantMemoryData;\n\n        this.currentMode = currentMode;\n\n        if (chatLog && chatLog.length > 0) {\n          this.chatLogFromServer = chatLog.map((chatLogItem: any) => ({\n            ...chatLogItem,\n            date: new Date(chatLogItem.date),\n            sender: chatLogItem.sender as YpSenderType,\n          }));\n          this.chatLog = this.chatLogFromServer;\n          this.requestUpdate();\n        }\n      } catch (error) {\n        console.error(\"Error getting chat log from server:\", error);\n      }\n    }\n  }\n\n  private setupCanvasRendering() {\n    if (this.renderLoopActive) return;\n\n    this.renderLoopActive = true;\n    this.renderLoop();\n  }\n\n  private renderLoop = () => {\n    if (!this.renderLoopActive) return;\n\n    if (this.waveformCanvas) {\n      // Set up canvas if needed\n      if (!this.waveformCanvas.width || !this.waveformCanvas.height) {\n        this.waveformCanvas.width = this.waveformCanvas.offsetWidth;\n        this.waveformCanvas.height = this.waveformCanvas.offsetHeight;\n      }\n      this.canvasCtx = this.canvasCtx || this.waveformCanvas.getContext(\"2d\");\n\n      if (this.canvasCtx) {\n        this.canvasCtx.clearRect(\n          0,\n          0,\n          this.waveformCanvas.width,\n          this.waveformCanvas.height\n        );\n\n        // Get frequencies based on who is speaking\n        let frequencies = new Float32Array([0]);\n        let color = \"#ffdc2f\"; // default color\n\n        try {\n          if (this.userIsSpeaking) {\n            frequencies = this.mediaRecorder?.getFrequencies(\"voice\")?.values!;\n            // GO throught the frequencies and lower them all by 30%\n            for (let i = 0; i < frequencies.length; i++) {\n              frequencies[i] = frequencies[i] * 0.15;\n            }\n            color = \"#ffdc2f\";\n          } else if (this.aiIsSpeaking) {\n            frequencies = this.mediaRecorder?.getFrequencies(\"voice\")?.values!;\n            color = \"#2ecc71\";\n            for (let i = 0; i < frequencies.length; i++) {\n              frequencies[i] = frequencies[i] * 0.75;\n            }\n          }\n\n          WavRenderer.drawBars(\n            this.waveformCanvas,\n            this.canvasCtx,\n            frequencies,\n            color,\n            10,\n            0,\n            8\n          );\n        } catch (e) {\n          console.error(e);\n        }\n      }\n    }\n\n    requestAnimationFrame(this.renderLoop);\n  };\n\n  private stopCanvasRendering() {\n    this.renderLoopActive = false;\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.stopCanvasRendering();\n\n    this.stopRecording();\n    this.removeGlobalListener(\"yp-logged-in\", this.userLoggedIn.bind(this));\n    this.removeGlobalListener(\n      \"agent-configuration-submitted\",\n      this.agentConfigurationSubmitted.bind(this)\n    );\n  }\n\n  async setupVoiceCapabilities() {}\n\n  get talkingHeadImageUrl() {\n    if (this.aiIsSpeaking) {\n      return \"https://assets.evoly.ai/dl/8ddaf573eea398f9042aec7134e5dc37--retina-1.png\";\n    } else if (this.userIsSpeaking) {\n      return \"https://assets.evoly.ai/dl/8ddaf573eea398f9042aec7134e5dc37--retina-1.png\";\n    } else return \"https://assets.evoly.ai/dl/8ddaf573eea398f9042aec7134e5dc37--retina-1.png\";\n  }\n\n  renderVoiceTalkingHead() {\n    return html`\n      <div class=\"layout horizontal\" ?voice-not-enabled=\"${!this.voiceEnabled}\">\n        <img\n          class=\"talking-head-image\"\n          src=\"${this.directAgentAvatarUrl ? this.directAgentAvatarUrl : this.talkingHeadImageUrl}\"\n          alt=\"Voice Assistant\"\n        />\n      </div>\n    `;\n  }\n\n  override render() {\n    return html`\n      <div class=\"chat-window\" id=\"chat-window\" ?expanded=\"${this.isExpanded}\">\n        <div class=\"voice-input-container\">\n          <div class=\"voice-input\">${this.renderVoiceInput()}</div>\n        </div>\n        <div class=\"hybrid-chat-messages\" id=\"chat-messages\">\n          <yp-assistant-item-base\n            ?hidden=\"${true || !this.defaultInfoMessage}\"\n            class=\"chatElement assistant-chat-element\"\n            .detectedLanguage=\"${this.language}\"\n            .message=\"${this.defaultInfoMessage}\"\n            type=\"info\"\n            sender=\"assistant\"\n          ></yp-assistant-item-base>\n          ${this.chatLog\n            .filter(\n              (chatElement) =>\n                !chatElement.hidden &&\n                chatElement.type !== \"hiddenContextMessage\" &&\n                chatElement.type !== \"thinking\" &&\n                (chatElement.message != \"\" || chatElement.html != \"\")\n            )\n            .map(\n              (chatElement) => html`\n                <yp-assistant-item-base\n                  ?thinking=\"${chatElement.type === \"thinking\" ||\n                  chatElement.type === \"noStreaming\"}\"\n                  @followup-question=\"${this.followUpQuestion}\"\n                  .clusterId=\"${this.clusterId}\"\n                  class=\"chatElement ${chatElement.sender}-chat-element\"\n                  .detectedLanguage=\"${this.language}\"\n                  .message=\"${chatElement.message}\"\n                  .htmlToRender=\"${chatElement.html}\"\n                  @scroll-down-enabled=\"${() => (this.userScrolled = false)}\"\n                  .type=\"${chatElement.type}\"\n                  .sender=\"${chatElement.sender}\"\n                ></yp-assistant-item-base>\n              `\n            )}\n        </div>\n        <div class=\"chat-input-container\">\n          <div class=\"chat-input\">${this.renderChatInput()}</div>\n        </div>\n      </div>\n    `;\n  }\n\n  toggleRecording() {\n    if (this.isRecording) {\n      this.stopRecording();\n    } else {\n      this.startRecording();\n    }\n  }\n\n  async startRecording() {\n    await this.serverApi.startVoiceSession(\n      this.domainId,\n      this.wsClientId,\n      this.currentMode\n    );\n    this.mediaRecorder = new WavRecorder({ sampleRate: 24000 }) as WavRecorder;\n    this.isRecording = true;\n\n    await this.mediaRecorder.begin();\n\n    await this.mediaRecorder.record((data: any) => this.handleVoiceInput(data));\n\n    this.wavStreamPlayer = new WavStreamPlayer({ sampleRate: 24000 });\n\n    await this.wavStreamPlayer?.connect();\n  }\n\n  stopRecording() {\n    this.mediaRecorder?.end();\n    this.mediaRecorder = null;\n\n    this.wavStreamPlayer?.interrupt();\n    this.wavStreamPlayer = null;\n    this.isRecording = false;\n  }\n\n  static floatTo16BitPCM(float32Array: Float32Array) {\n    const buffer = new ArrayBuffer(float32Array.length * 2);\n    const view = new DataView(buffer);\n    let offset = 0;\n    for (let i = 0; i < float32Array.length; i++, offset += 2) {\n      let s = Math.max(-1, Math.min(1, float32Array[i]));\n      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);\n    }\n    return buffer;\n  }\n\n  static arrayBufferToBase64(arrayBuffer: ArrayBuffer | Iterable<number>) {\n    if (arrayBuffer instanceof Float32Array) {\n      arrayBuffer = this.floatTo16BitPCM(arrayBuffer);\n    } else if (arrayBuffer instanceof Int16Array) {\n      arrayBuffer = arrayBuffer.buffer;\n    }\n    let binary = \"\";\n    let bytes = new Uint8Array(arrayBuffer as any);\n    const chunkSize = 0x8000; // 32KB chunk size\n    for (let i = 0; i < bytes.length; i += chunkSize) {\n      let chunk = bytes.subarray(i, i + chunkSize);\n      binary += String.fromCharCode.apply(null, chunk as any);\n    }\n    return btoa(binary);\n  }\n\n  async handleVoiceInput(data: { mono: ArrayBuffer; raw: ArrayBuffer }) {\n    // Convert ArrayBuffer to base64 using browser APIs\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(\n        JSON.stringify({\n          type: \"voice_input\",\n          audio: YpAssistantBase.arrayBufferToBase64(data.mono),\n          clientId: this.wsClientId,\n        })\n      );\n    }\n  }\n\n  async resetWaveformPlayer() {\n    await this.wavStreamPlayer?.interrupt();\n    this.wavStreamPlayer = new WavStreamPlayer({ sampleRate: 24000 });\n\n    await this.wavStreamPlayer?.connect();\n  }\n\n  override async onMessage(event: MessageEvent) {\n    const data = JSON.parse(event.data) as YpAssistantMessage;\n\n    // Handle messages with HTML content\n    if (data.sender === \"assistant\" && data.html) {\n      // Add message to chat log with reference to component\n      this.addChatBotElement({\n        sender: \"assistant\",\n        type: \"html\",\n        message: data.message || \"\",\n        html: data.html,\n      });\n      return;\n    }\n\n    switch (data.type) {\n      case \"ui_click\":\n        const type = data.message as YpAssistantUiClickTypes;\n        if (type === \"login-button-main\") {\n          this.fireGlobal(\"assistant-requested-login-main-button-click\");\n        } else if (type === \"login-button-google\") {\n          this.fireGlobal(\"assistant-requested-login-google-button-click\");\n        } else if (type === \"logout\") {\n          this.fireGlobal(\"assistant-requested-logout-button-click\");\n        } else if (type === \"submit-agent-configuration\") {\n          this.fireGlobal(\"assistant-requested-submit-agent-configuration\");\n        } else {\n          console.error(\"No mode received in current_mode message\");\n        }\n        break;\n      case \"current_mode\":\n        if (data.mode) {\n          this.currentMode = data.mode;\n        } else {\n          console.error(\"No mode received in current_mode message\");\n        }\n        break;\n      case \"audio\":\n        if (data.base64Audio) {\n          const audioData = this.base64ToArrayBuffer(data.base64Audio);\n          this.wavStreamPlayer?.add16BitPCM(audioData);\n\n          this.aiIsSpeaking = true;\n\n          clearTimeout(this.aiSpeakingTimeout);\n\n          this.aiSpeakingTimeout = setTimeout(() => {\n            this.aiIsSpeaking = false;\n          }, 2500);\n        }\n        break;\n\n      case \"current_mode\":\n        if (data.mode) {\n          this.currentMode = data.mode;\n        } else {\n          console.error(\"No mode received in current_mode message\");\n        }\n        break;\n      case \"avatar_url_change\":\n        if (data.url == null || data.data == null) {\n          this.directAgentAvatarUrl = undefined;\n          this.directAgentName = null;\n        } else {\n          this.directAgentAvatarUrl = data.url;\n          this.directAgentName = data.data as string;\n        }\n        break;\n\n      case \"clear_audio_buffer\":\n        await this.resetWaveformPlayer();\n        break;\n      case \"listening_start\":\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.isSpeaking = true;\n        }\n        this.userIsSpeaking = true;\n        await this.resetWaveformPlayer();\n        break;\n\n      case \"listening_stop\":\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.isSpeaking = false;\n        }\n        this.userIsSpeaking = false;\n        break;\n\n      case \"ai_speaking_start\":\n        this.aiIsSpeaking = true;\n        break;\n\n      case \"ai_speaking_stop\":\n        this.aiIsSpeaking = false;\n        break;\n\n      default:\n        await super.onMessage(event);\n    }\n  }\n\n  base64ToArrayBuffer(base64: string): ArrayBuffer {\n    const binaryString = window.atob(base64);\n    const length = binaryString.length;\n    const bytes = new Uint8Array(length);\n\n    for (let i = 0; i < length; i++) {\n      bytes[i] = binaryString.charCodeAt(i);\n    }\n\n    return bytes.buffer;\n  }\n\n  async toggleVoiceMode() {\n    this.voiceEnabled = !this.voiceEnabled;\n    this.isExpanded = this.voiceEnabled;\n\n    this.fireGlobal(\"yp-hide-collection-header-status\", this.isExpanded);\n\n    if (!this.voiceEnabled && this.isRecording) {\n      this.stopRecording();\n    } else if (this.voiceEnabled && !this.isRecording) {\n      await this.startRecording();\n    }\n\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(\n        JSON.stringify({\n          type: \"voice_mode\",\n          enabled: this.voiceEnabled,\n          clientId: this.wsClientId,\n        })\n      );\n    }\n\n    if (this.voiceEnabled) {\n      this.setupCanvasRendering();\n    } else {\n      this.stopCanvasRendering();\n    }\n  }\n\n  async reallyClearHistory() {\n    await this.serverApi.clearChatLogFromServer(this.domainId);\n    this.chatLog = [];\n    this.requestUpdate();\n  }\n\n  async clearHistory() {\n    window.appDialogs.getDialogAsync(\n      \"confirmationDialog\",\n      (dialog: YpConfirmationDialog) => {\n        dialog.open(\n          this.t(\"confirmClearHistory\"),\n          this.reallyClearHistory.bind(this)\n        );\n      }\n    );\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        .voice-mode-toggle {\n          margin-top: 16px;\n        }\n\n        .chat-window {\n          display: flex;\n          flex-direction: column;\n          height: 100%;\n          min-height: 45vh;\n          width: 100%;\n          max-width: 1200px;\n          margin: 0 auto;\n          border-radius: 10px;\n          overflow: hidden;\n        }\n\n        .hybrid-chat-messages {\n          display: flex;\n          flex-direction: column;\n          flex: 1;\n          padding: 20px;\n          overflow-y: visible;\n          max-width: 960px;\n        }\n\n        .you-chat-element {\n          align-self: flex-start;\n          justify-content: flex-start;\n        }\n\n        .assistant-chat-element {\n          align-self: flex-start;\n          justify-content: flex-start;\n          width: 100%;\n          max-width: 100%;\n        }\n\n        .chat-input {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          padding: 8px;\n        }\n\n        .chat-window {\n          width: 100%;\n          max-width: 1200px;\n          margin: 0 auto;\n          border-radius: 10px;\n        }\n\n        .voice-input-container {\n          position: fixed;\n          top: 60px;\n          left: 0;\n          z-index: 10;\n          width: 100vw;\n          height: 116px;\n          background: var(--md-sys-color-surface-container-lowest);\n        }\n\n        .voice-input {\n          position: fixed;\n          top: 60px;\n          left: 50%;\n          transform: translateX(-50%);\n          width: 936px;\n          background: var(--md-sys-color-surface-container-lowest);\n        }\n\n        @media (max-width: 820px) {\n          .voice-input {\n            width: 100%;\n          }\n        }\n\n        .chat-input-container {\n          position: fixed;\n          bottom: 0;\n          left: 0;\n          width: 100vw;\n          z-index: 10;\n          height: 120px;\n          background: var(--md-sys-color-surface-container-lowest);\n        }\n\n        .chat-input {\n          position: fixed;\n          bottom: 0;\n          left: 0;\n          right: 0;\n          z-index: 11;\n          left: 50%;\n          height: 102px;\n          transform: translateX(-50%);\n          z-index: 10;\n          width: 780px;\n          background: var(--md-sys-color-surface-container-lowest);\n        }\n\n        .hybrid-chat-messages {\n          padding-top: 140px;\n          padding-bottom: 130px;\n        }\n\n        /* Remove flex properties and height constraints */\n        .chat-window,\n        .hybrid-chat-messages {\n          display: block;\n          height: auto;\n          overflow: visible;\n        }\n\n        .assistantName {\n          font-size: 22px;\n          font-weight: 700;\n          color: var(--md-sys-color-on-surface);\n          line-height: 33px;\n          font-family: var(--md-ref-typeface-brand);\n        }\n\n        .nameAndStartStop {\n          margin-left: 16px;\n        }\n\n        .voiceClose {\n          margin-left: 20px;\n          margin-right: 6px;\n        }\n\n        .voiceAvatar {\n          align-items: left;\n          align-self: flex-start;\n        }\n\n        md-icon.voiceModeToggleIcon {\n          --md-icon-size: 40px;\n          width: 40px;\n          height: 40px;\n        }\n\n        md-fab {\n          --md-fab-container-shape: 4px;\n          --md-fab-label-text-size: 15px !important;\n          --md-fab-label-text-weight: 500 !important;\n          --md-fab-container-elevation: 0;\n          --md-fab-container-shadow-color: transparent;\n        }\n\n        md-fab:not([has-static-theme]) {\n          --md-sys-color-primary-container: var(--md-sys-color-primary);\n          --md-sys-color-on-primary-container: var(--md-sys-color-on-primary);\n        }\n\n        .currentMode {\n          font-size: 17px;\n          font-weight: 700;\n          color: var(--md-sys-color-on-surface);\n          margin-bottom: 16px;\n          font-family: var(--md-ref-typeface-brand);\n        }\n\n        .voice-header {\n          align-items: left;\n        }\n\n        .voice-header[voice-not-enabled] {\n          filter: grayscale(100%);\n        }\n\n        .talking-head-image {\n          width: 100px;\n          height: 100px;\n          border-radius: 50%;\n          object-fit: cover;\n        }\n\n        .waveform-canvas {\n          width: 100%;\n          height: 60px;\n          margin-top: 8px;\n          margin-left: 4px;\n          background: transparent;\n          border-radius: 0;\n          max-width: 100px;\n        }\n\n        .voice-controls {\n        }\n\n        md-filled-tonal-button {\n          border-radius: 4px;\n        }\n\n        .voice-button {\n          --md-icon-button-icon-size: 24px;\n          margin-right: 24px;\n        }\n\n        .voice-button[recording] {\n          --md-icon-button-container-color: var(--md-sys-color-error);\n          --md-icon-button-icon-color: var(--md-sys-color-on-error);\n          /* animation: pulse 2s infinite; */\n        }\n\n        @keyframes pulse {\n          0% {\n            transform: scale(1);\n            opacity: 1;\n          }\n          50% {\n            transform: scale(1.1);\n            opacity: 0.8;\n          }\n          100% {\n            transform: scale(1);\n            opacity: 1;\n          }\n        }\n\n        .infoMessage {\n          margin-top: 8px;\n        }\n\n        .chat-window {\n          display: flex;\n          flex-direction: column;\n          height: calc(100vh - 60px);\n          width: 1000px;\n          max-width: 1000px;\n          margin: 0 auto;\n          border-radius: 10px;\n        }\n\n        /* .chat-window[expanded] {\n          height: calc(100vh - 148px);\n        } */\n\n        .chat-messages {\n          display: flex;\n          flex-direction: column;\n          flex: 1;\n          padding: 20px;\n          overflow-y: scroll;\n        }\n\n        .you-chat-element {\n          align-self: flex-start;\n          max-width: 100%;\n          justify-content: flex-start;\n          margin-right: 32px;\n        }\n\n        .assistant-chat-element {\n          align-self: flex-start;\n          justify-content: flex-start;\n          width: 100%;\n          max-width: 100%;\n        }\n\n        .chat-input {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          padding: 8px;\n        }\n\n        md-filled-text-field {\n          flex: 1;\n          --md-filled-text-field-container-shape: 32px;\n          --md-filled-text-field-focus-active-indicator-color: transparent;\n          --md-filled-field-active-indicator-height: 0;\n          --md-filled-field-focus-active-indicator-height: 0;\n          --md-filled-field-hover-active-indicator-color: transparent;\n          border: none;\n          padding: 10px;\n          margin: 16px;\n          margin-bottom: 16px;\n          margin-left: 8px;\n          margin-right: 8px;\n          width: 650px;\n        }\n\n        .chatElement[thinking] {\n          margin-top: 16px;\n          margin-bottom: 8px;\n        }\n\n        @media (max-width: 450px) {\n          md-filled-text-field {\n            width: 350px;\n          }\n\n          md-filled-text-field[focused] {\n            width: 100%;\n          }\n        }\n\n        @media (max-width: 400px) {\n          md-filled-text-field {\n            width: 320px;\n          }\n\n          md-filled-text-field[focused] {\n            width: 100%;\n          }\n        }\n\n        @media (max-width: 600px) {\n          .chat-window {\n          }\n\n          .you-chat-element {\n            margin-right: 0;\n          }\n        }\n      `,\n    ];\n  }\n\n  renderVoiceStartButton() {\n    return html`<svg\n      width=\"40\"\n      height=\"40\"\n      viewBox=\"0 0 40 40\"\n      fill=\"none\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n    >\n      <circle cx=\"20\" cy=\"20\" r=\"20\" fill=\"#2ECC71\" />\n      <rect width=\"24\" height=\"24\" transform=\"translate(8 8)\" fill=\"#2ECC71\" />\n      <path\n        d=\"M15 29.5H17V31.5H15V29.5ZM20 20.5C21.66 20.5 23 19.16 23 17.5V11.5C23 9.84 21.66 8.5 20 8.5C18.34 8.5 17 9.84 17 11.5V17.5C17 19.16 18.34 20.5 20 20.5ZM19 11.5C19 10.95 19.45 10.5 20 10.5C20.55 10.5 21 10.95 21 11.5V17.5C21 18.06 20.56 18.5 20 18.5C19.45 18.5 19 18.05 19 17.5V11.5ZM19 29.5H21V31.5H19V29.5ZM23 29.5H25V31.5H23V29.5ZM27 17.5H25.3C25.3 20.5 22.76 22.6 20 22.6C17.24 22.6 14.7 20.5 14.7 17.5H13C13 20.91 15.72 23.73 19 24.22V27.5H21V24.22C24.28 23.73 27 20.91 27 17.5Z\"\n        fill=\"white\"\n      />\n    </svg> `;\n  }\n\n  override renderChatInput() {\n    return html`\n      ${this.showCleanupButton\n        ? html`\n            <md-outlined-icon-button\n              class=\"restartButton\"\n              @click=\"${() => this.fire(\"reset-chat\")}\"\n              ><md-icon>refresh</md-icon></md-outlined-icon-button\n            >\n          `\n        : nothing}\n      ${this.showCloseButton\n        ? html`\n            <md-outlined-icon-button\n              class=\"closeButton\"\n              @click=\"${() => this.fire(\"chatbot-close\")}\"\n              ><md-icon>close</md-icon></md-outlined-icon-button\n            >\n          `\n        : nothing}\n      <md-icon-button class=\"\" @click=\"${this.clearHistory}\">\n        <md-icon>delete_history</md-icon>\n      </md-icon-button>\n\n      ${this.onlyUseTextField || this.chatLog.length > 1\n        ? html`\n            <md-filled-text-field\n              class=\"textInput\"\n              type=\"text\"\n              hasTrailingIcon\n              id=\"chatInput\"\n              rows=\"${this.chatLog.length > 1 ? \"1\" : \"3\"}\"\n              @focus=\"${() => (this.inputIsFocused = true)}\"\n              @blur=\"${() => (this.inputIsFocused = true)}\"\n              @keyup=\"${(e: KeyboardEvent) => {\n                if (e.key === \"Enter\") {\n                  this.sendChatMessage();\n                }\n              }}\"\n              .label=\"${this.textInputLabel}\"\n            >\n              <md-icon\n                class=\"sendIcon\"\n                @click=\"${this.sendChatMessage}\"\n                slot=\"trailing-icon\"\n                id=\"sendButton\"\n                ?input-is-focused=\"${this.inputIsFocused}\"\n                >arrow_circle_up</md-icon\n              >\n            </md-filled-text-field>\n          `\n        : html`<md-filled-text-field\n            class=\"textInput\"\n            type=\"textarea\"\n            hasTrailingIcon\n            id=\"chatInput\"\n            rows=\"3\"\n            @focus=\"${() => (this.inputIsFocused = true)}\"\n            @blur=\"${() => (this.inputIsFocused = true)}\"\n            .label=\"${this.textInputLabel}\"\n          >\n            <md-icon\n              class=\"sendIcon\"\n              @click=\"${this.sendChatMessage}\"\n              slot=\"trailing-icon\"\n              id=\"sendButton\"\n              ?input-is-focused=\"${this.inputIsFocused}\"\n              >send</md-icon\n            ></md-filled-text-field\n          >`}\n    `;\n  }\n\n  renderStartStopVoiceButton() {\n    return html`${!this.voiceEnabled\n      ? html`<md-icon-button\n          ?has-static-theme=\"${this.hasStaticTheme}\"\n          class=\"voice-mode-toggle\"\n          @click=\"${this.toggleVoiceMode}\"\n          .label=\"${!this.voiceEnabled\n            ? this.t(\"voiceAssistant\")\n            : this.t(\"closeAssistant\")}\"\n        >\n          <md-icon class=\"voiceModeToggleIcon\">\n            ${this.renderVoiceStartButton()}</md-icon\n          ></md-icon-button\n        > `\n      : html` <md-icon-button\n          class=\"voice-mode-toggle\"\n          @click=\"${this.toggleVoiceMode}\"\n          .label=\"${!this.voiceEnabled\n            ? this.t(\"voiceAssistant\")\n            : this.t(\"closeAssistant\")}\"\n        >\n          <md-icon class=\"voiceModeToggleIcon\"> cancel</md-icon>\n        </md-icon-button>`}`;\n  }\n\n  renderAssistantName() {\n    return html`<div class=\"assistantName\">\n      ${this.directAgentName ? this.directAgentName : this.t(\"mainAssistant\")}\n    </div>`;\n  }\n\n  renderVoiceInput() {\n    return html`\n      <div class=\"layout horizontal voiceAvatar\">\n        ${this.renderVoiceTalkingHead()}\n        <div class=\"nameAndStartStop layout vertical\">\n          ${this.renderAssistantName()}\n          <div class=\"layout horizontal\">\n            ${this.renderStartStopVoiceButton()}\n            <canvas id=\"waveformCanvas\" class=\"waveform-canvas\"></canvas>\n          </div>\n        </div>\n        <div hidden class=\"currentMode\">${this.t(this.currentMode)}</div>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"yp-assistant-base\": YpAssistantBase;\n  }\n}\n"]}