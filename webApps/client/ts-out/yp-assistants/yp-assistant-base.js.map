{"version":3,"file":"yp-assistant-base.js","sourceRoot":"","sources":["../../src/yp-assistants/yp-assistant-base.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, nothing, PropertyValueMap } from \"lit\";\nimport { property, customElement, state, query } from \"lit/decorators.js\";\nimport { YpChatbotBase } from \"../yp-chatbots/yp-chatbot-base.js\";\nimport \"./yp-assistant-item-base.js\";\nimport { literal } from \"lit/static-html.js\";\nimport { WavRecorder } from \"../tools/wavTools/wav_recorder.js\";\nimport { WavStreamPlayer } from \"../tools/wavTools/wav_stream_player.js\";\nimport { YpAssistantServerApi } from \"./AssistantServerApi.js\";\nimport { WavRenderer } from \"./wave-renderer.js\";\nimport { YpConfirmationDialog } from \"../yp-dialog-container/yp-confirmation-dialog.js\";\n\n@customElement(\"yp-assistant-base\")\nexport abstract class YpAssistantBase extends YpChatbotBase {\n  @property({ type: Boolean })\n  voiceEnabled = false;\n\n  @property({ type: Number })\n  domainId!: number;\n\n  @state()\n  private mediaRecorder: WavRecorder | null = null;\n\n  @state()\n  private wavStreamPlayer: WavStreamPlayer | null = null;\n\n  @state()\n  private isRecording = false;\n\n  @state()\n  userIsSpeaking = false;\n\n  @state()\n  aiIsSpeaking = false;\n\n  @property({ type: Boolean })\n  override onlyUseTextField = true;\n\n  @property({ type: Array })\n  chatLogFromServer: YpAssistantMessage[] | undefined;\n\n  @state()\n  currentMode = \"\";\n\n  @query(\"#voiceButton\")\n  voiceButton!: HTMLElement;\n\n  override chatbotItemComponentName = literal`yp-assistant-item-base`;\n\n  @query(\"#waveformCanvas\")\n  private waveformCanvas!: HTMLCanvasElement;\n\n  private canvasCtx: CanvasRenderingContext2D | null = null;\n  private renderLoopActive = false;\n  aiSpeakingTimeout: NodeJS.Timeout | undefined;\n\n  constructor() {\n    super();\n    this.setupVoiceCapabilities();\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.getMemoryFromServer();\n  }\n\n  override firstUpdated(\n    changedProperties: PropertyValueMap<any> | Map<PropertyKey, unknown>\n  ) {\n    if (changedProperties) {\n      super.firstUpdated(changedProperties);\n    }\n  }\n\n  async getMemoryFromServer() {\n    if (!this.chatLog || this.chatLog.length === 0) {\n      try {\n        const serverApi = new YpAssistantServerApi();\n        const { chatLog, modeData, currentMode } =\n          (await serverApi.getMemoryFromServer(\n            this.domainId\n          )) as YpBaseAssistantMemoryData;\n\n        this.currentMode = currentMode;\n\n        if (chatLog && chatLog.length > 0) {\n          this.chatLogFromServer = chatLog.map((chatLogItem: any) => ({\n            ...chatLogItem,\n            date: new Date(chatLogItem.date),\n            sender: chatLogItem.sender as YpSenderType,\n          }));\n          this.chatLog = this.chatLogFromServer;\n          this.requestUpdate();\n        }\n      } catch (error) {\n        console.error(\"Error getting chat log from server:\", error);\n      }\n    }\n  }\n\n  private setupCanvasRendering() {\n    if (this.renderLoopActive) return;\n\n    this.renderLoopActive = true;\n    this.renderLoop();\n  }\n\n  private renderLoop = () => {\n    if (!this.renderLoopActive) return;\n\n    if (this.waveformCanvas) {\n      // Set up canvas if needed\n      if (!this.waveformCanvas.width || !this.waveformCanvas.height) {\n        this.waveformCanvas.width = this.waveformCanvas.offsetWidth;\n        this.waveformCanvas.height = this.waveformCanvas.offsetHeight;\n      }\n      this.canvasCtx = this.canvasCtx || this.waveformCanvas.getContext(\"2d\");\n\n      if (this.canvasCtx) {\n        this.canvasCtx.clearRect(\n          0,\n          0,\n          this.waveformCanvas.width,\n          this.waveformCanvas.height\n        );\n\n        // Get frequencies based on who is speaking\n        let frequencies = new Float32Array([0]);\n        let color = \"#ffdc2f\"; // default color\n\n        try {\n          if (this.userIsSpeaking) {\n            frequencies = this.mediaRecorder?.getFrequencies(\"voice\")?.values!;\n            color = \"#ffdc2f\"; // blue for user\n          } else if (this.aiIsSpeaking) {\n            frequencies = this.mediaRecorder?.getFrequencies(\"voice\")?.values!;\n            color = \"#1e90ff\"; // green for AI\n          }\n\n          WavRenderer.drawBars(\n            this.waveformCanvas,\n            this.canvasCtx,\n            frequencies,\n            color,\n            10,\n            0,\n            8\n          );\n        } catch (e) {\n          console.error(e);\n        }\n      }\n    }\n\n    requestAnimationFrame(this.renderLoop);\n  };\n\n  private stopCanvasRendering() {\n    this.renderLoopActive = false;\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.stopCanvasRendering();\n\n    this.stopRecording();\n  }\n\n  async setupVoiceCapabilities() {}\n\n  get talkingHeadImage() {\n    if (this.aiIsSpeaking) {\n      return \"https://assets.evoly.ai/direct/talkingHead.png\";\n    } else if (this.userIsSpeaking) {\n      return \"https://assets.evoly.ai/direct/listeningHead.png\";\n    } else return \"https://assets.evoly.ai/direct/idleHead.png\";\n  }\n\n  renderVoiceTalkingHead() {\n    return html`\n      <div class=\"voice-header\" ?voice-not-enabled=\"${!this.voiceEnabled}\">\n        <img\n          class=\"talking-head-image\"\n          src=\"${this.talkingHeadImage}\"\n          alt=\"Voice Assistant\"\n        />\n        <canvas id=\"waveformCanvas\" class=\"waveform-canvas\"></canvas>\n      </div>\n    `;\n  }\n\n  override render() {\n    return html`\n      <div class=\"chat-window\" id=\"chat-window\">\n        <div class=\"chat-messages\" id=\"chat-messages\">\n          <yp-assistant-item-base\n            ?hidden=\"${!this.defaultInfoMessage}\"\n            class=\"chatElement bot-chat-element\"\n            .detectedLanguage=\"${this.language}\"\n            .message=\"${this.defaultInfoMessage}\"\n            type=\"info\"\n            sender=\"bot\"\n          ></yp-assistant-item-base>\n          ${this.chatLog\n            .filter(\n              (chatElement) =>\n                !chatElement.hidden &&\n                chatElement.type !== \"hiddenContextMessage\" &&\n                (chatElement.message != \"\" || chatElement.html != \"\")\n            )\n            .map(\n              (chatElement) => html`\n                <yp-assistant-item-base\n                  ?thinking=\"${chatElement.type === \"thinking\" ||\n                  chatElement.type === \"noStreaming\"}\"\n                  @followup-question=\"${this.followUpQuestion}\"\n                  .clusterId=\"${this.clusterId}\"\n                  class=\"chatElement ${chatElement.sender}-chat-element\"\n                  .detectedLanguage=\"${this.language}\"\n                  .message=\"${chatElement.message}\"\n                  .htmlToRender=\"${chatElement.html}\"\n                  @scroll-down-enabled=\"${() => (this.userScrolled = false)}\"\n                  .type=\"${chatElement.type}\"\n                  .sender=\"${chatElement.sender}\"\n                ></yp-assistant-item-base>\n              `\n            )}\n        </div>\n        <div\n          class=\"layout horizontal center-center chat-input\"\n          style=\"position: relative;\"\n        >\n          ${this.renderChatInput()}\n          <div\n            style=\"position: absolute; right:96px;bottom:104px;z-index: 100;\"\n          >\n            ${this.renderVoiceTalkingHead()}\n          </div>\n          <div\n            class=\"currentMode\"\n            style=\"position: absolute;left:82px;bottom:90px;z-index: 100;\"\n          >\n            ${this.t(this.currentMode)}\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  toggleRecording() {\n    if (this.isRecording) {\n      this.stopRecording();\n    } else {\n      this.startRecording();\n    }\n  }\n\n  async startRecording() {\n    const serverApi = new YpAssistantServerApi();\n    await serverApi.startVoiceSession(1790, this.wsClientId, this.currentMode);\n    this.mediaRecorder = new WavRecorder({ sampleRate: 24000 }) as WavRecorder;\n    this.isRecording = true;\n\n    await this.mediaRecorder.begin();\n\n    await this.mediaRecorder.record((data: any) => this.handleVoiceInput(data));\n\n    this.wavStreamPlayer = new WavStreamPlayer({ sampleRate: 24000 });\n\n    await this.wavStreamPlayer?.connect();\n  }\n\n  stopRecording() {\n    this.mediaRecorder?.end();\n    this.mediaRecorder = null;\n\n    this.wavStreamPlayer?.interrupt();\n    this.wavStreamPlayer = null;\n    this.isRecording = false;\n  }\n\n  static floatTo16BitPCM(float32Array: Float32Array) {\n    const buffer = new ArrayBuffer(float32Array.length * 2);\n    const view = new DataView(buffer);\n    let offset = 0;\n    for (let i = 0; i < float32Array.length; i++, offset += 2) {\n      let s = Math.max(-1, Math.min(1, float32Array[i]));\n      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);\n    }\n    return buffer;\n  }\n\n  static arrayBufferToBase64(arrayBuffer: ArrayBuffer | Iterable<number>) {\n    if (arrayBuffer instanceof Float32Array) {\n      arrayBuffer = this.floatTo16BitPCM(arrayBuffer);\n    } else if (arrayBuffer instanceof Int16Array) {\n      arrayBuffer = arrayBuffer.buffer;\n    }\n    let binary = \"\";\n    let bytes = new Uint8Array(arrayBuffer as any);\n    const chunkSize = 0x8000; // 32KB chunk size\n    for (let i = 0; i < bytes.length; i += chunkSize) {\n      let chunk = bytes.subarray(i, i + chunkSize);\n      binary += String.fromCharCode.apply(null, chunk as any);\n    }\n    return btoa(binary);\n  }\n\n  async handleVoiceInput(data: { mono: ArrayBuffer; raw: ArrayBuffer }) {\n    // Convert ArrayBuffer to base64 using browser APIs\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(\n        JSON.stringify({\n          type: \"voice_input\",\n          audio: YpAssistantBase.arrayBufferToBase64(data.mono),\n          clientId: this.wsClientId,\n        })\n      );\n    }\n  }\n\n  override async onMessage(event: MessageEvent) {\n    const data = JSON.parse(event.data) as YpAssistantMessage;\n\n    // Handle messages with HTML content\n    if (data.sender === \"assistant\" && data.html) {\n      // Add message to chat log with reference to component\n      this.addChatBotElement({\n        sender: \"assistant\",\n        type: \"html\",\n        message: data.message || \"\",\n        html: data.html,\n      });\n      return;\n    }\n\n    switch (data.type) {\n      case \"current_mode\":\n        if (data.mode) {\n          this.currentMode = data.mode;\n        } else {\n          console.error(\"No mode received in current_mode message\");\n        }\n        break;\n      case \"audio\":\n        if (data.base64Audio) {\n          const audioData = this.base64ToArrayBuffer(data.base64Audio);\n          this.wavStreamPlayer?.add16BitPCM(audioData);\n\n          this.aiIsSpeaking = true;\n\n          clearTimeout(this.aiSpeakingTimeout);\n\n          this.aiSpeakingTimeout = setTimeout(() => {\n            this.aiIsSpeaking = false;\n          }, 2500);\n        }\n        break;\n\n      case \"current_mode\":\n        if (data.mode) {\n          this.currentMode = data.mode;\n        } else {\n          console.error(\"No mode received in current_mode message\");\n        }\n        break;\n\n      case \"listening_start\":\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.isSpeaking = true;\n        }\n        this.userIsSpeaking = true;\n        await this.wavStreamPlayer?.interrupt();\n        this.wavStreamPlayer = new WavStreamPlayer({ sampleRate: 24000 });\n\n        await this.wavStreamPlayer?.connect();\n        break;\n\n      case \"listening_stop\":\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.isSpeaking = false;\n        }\n        this.userIsSpeaking = false;\n        break;\n\n      case \"ai_speaking_start\":\n        this.aiIsSpeaking = true;\n        break;\n\n      case \"ai_speaking_stop\":\n        this.aiIsSpeaking = false;\n        break;\n\n      default:\n        await super.onMessage(event);\n    }\n  }\n\n  base64ToArrayBuffer(base64: string): ArrayBuffer {\n    const binaryString = window.atob(base64);\n    const length = binaryString.length;\n    const bytes = new Uint8Array(length);\n\n    for (let i = 0; i < length; i++) {\n      bytes[i] = binaryString.charCodeAt(i);\n    }\n\n    return bytes.buffer;\n  }\n\n  async toggleVoiceMode() {\n    this.voiceEnabled = !this.voiceEnabled;\n\n    if (!this.voiceEnabled && this.isRecording) {\n      this.stopRecording();\n    } else if (this.voiceEnabled && !this.isRecording) {\n      await this.startRecording();\n    }\n\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(\n        JSON.stringify({\n          type: \"voice_mode\",\n          enabled: this.voiceEnabled,\n          clientId: this.wsClientId,\n        })\n      );\n    }\n\n    if (this.voiceEnabled) {\n      this.setupCanvasRendering();\n    } else {\n      this.stopCanvasRendering();\n    }\n  }\n\n  async reallyClearHistory() {\n    const serverApi = new YpAssistantServerApi();\n    await serverApi.clearChatLogFromServer(this.domainId);\n    this.chatLog = [];\n    this.requestUpdate();\n  }\n\n  async clearHistory() {\n    window.appDialogs.getDialogAsync(\n      \"confirmationDialog\",\n      (dialog: YpConfirmationDialog) => {\n        dialog.open(\n          this.t(\"confirmClearHistory\"),\n          this.reallyClearHistory.bind(this)\n        );\n      }\n    );\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        .currentMode {\n          font-size: 17px;\n          font-weight: 700;\n          color: var(--md-sys-color-on-surface);\n          margin-bottom: 16px;\n          font-family: var(--md-ref-typeface-brand);\n        }\n\n        .voice-header {\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          position: relative;\n          margin-top: -134px;\n          margin-right: -16px;\n        }\n\n        .voice-header[voice-not-enabled] {\n          filter: grayscale(100%);\n          opacity: 0.75;\n        }\n\n        .talking-head-image {\n          width: 128px;\n          height: 128px;\n        }\n\n        .waveform-canvas {\n          width: 100%;\n          height: 60px;\n          margin-top: 8px;\n          background: rgba(0, 0, 0, 0.05);\n          border-radius: 8px;\n        }\n\n        .voice-controls {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n        }\n\n        md-filled-tonal-button {\n          border-radius: 4px;\n        }\n\n        .voice-button {\n          --md-icon-button-icon-size: 24px;\n          margin-right: 24px;\n        }\n\n        .voice-button[recording] {\n          --md-icon-button-container-color: var(--md-sys-color-error);\n          --md-icon-button-icon-color: var(--md-sys-color-on-error);\n          /* animation: pulse 2s infinite; */\n        }\n\n        @keyframes pulse {\n          0% {\n            transform: scale(1);\n            opacity: 1;\n          }\n          50% {\n            transform: scale(1.1);\n            opacity: 0.8;\n          }\n          100% {\n            transform: scale(1);\n            opacity: 1;\n          }\n        }\n      `,\n    ];\n  }\n\n  override renderChatInput() {\n    return html`\n      <div class=\"voice-controls\">\n        <md-icon-button class=\"voice-mode-toggle\" @click=\"${this.clearHistory}\">\n          <md-icon>delete_history</md-icon>\n        </md-icon-button>\n\n        ${super.renderChatInput()}\n        ${this.voiceEnabled\n          ? html`\n              <md-icon-button\n                hidden\n                id=\"voiceButton\"\n                class=\"voice-button\"\n                ?recording=\"${this.isRecording}\"\n                @click=\"${this.toggleRecording}\"\n              >\n                <md-icon>${this.isRecording ? \"stop\" : \"mic\"}</md-icon>\n              </md-icon-button>\n            `\n          : nothing}\n        ${!this.voiceEnabled\n          ? html` <md-filled-tonal-button\n              class=\"voice-mode-toggle\"\n              @click=\"${this.toggleVoiceMode}\"\n              .label=\"${!this.voiceEnabled\n                ? this.t(\"voiceAssistant\")\n                : this.t(\"closeAssistant\")}\"\n            >\n              ${!this.voiceEnabled\n                ? this.t(\"voiceAssistant\")\n                : this.t(\"closeAssistant\")}\n              <md-icon slot=\"icon\"\n                >${this.voiceEnabled ? \"cancel\" : \"mic_none\"}</md-icon\n              >\n            </md-filled-tonal-button>`\n          : html` <md-text-button\n              class=\"voice-mode-toggle\"\n              @click=\"${this.toggleVoiceMode}\"\n              .label=\"${!this.voiceEnabled\n                ? this.t(\"voiceAssistant\")\n                : this.t(\"closeAssistant\")}\"\n            >\n              ${!this.voiceEnabled\n                ? this.t(\"voiceAssistant\")\n                : this.t(\"closeAssistant\")}\n              <md-icon slot=\"icon\"\n                >${this.voiceEnabled ? \"cancel\" : \"mic_none\"}</md-icon\n              >\n            </md-text-button>`}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"yp-assistant-base\": YpAssistantBase;\n  }\n}\n"]}