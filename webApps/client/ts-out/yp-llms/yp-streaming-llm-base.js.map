{"version":3,"file":"yp-streaming-llm-base.js","sourceRoot":"","sources":["../../src/yp-llms/yp-streaming-llm-base.ts"],"names":[],"mappings":"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","sourcesContent":["import { property } from \"lit/decorators.js\";\nimport { YpBaseElement } from \"../common/yp-base-element.js\";\n\nexport abstract class YpStreamingLlmBase extends YpBaseElement {\n  @property({ type: Array })\n  chatLog: PsAiChatWsMessage[] = [];\n\n  @property({ type: String })\n  wsClientId!: string;\n\n  @property({ type: Number })\n  webSocketsErrorCount = 0;\n\n  @property({ type: String })\n  wsEndpoint!: string;\n\n  @property({ type: Object })\n  ws!: WebSocket;\n\n  @property({ type: String })\n  scrollElementSelector = \"#chat-messages\";\n\n  @property({ type: Boolean })\n  userScrolled = false;\n\n  @property({ type: String })\n  currentFollowUpQuestions: string = \"\";\n\n  @property({ type: Boolean })\n  programmaticScroll = false;\n\n  @property({ type: Number })\n  scrollStart: number = 0;\n\n  @property({ type: String })\n  serverMemoryId: string | undefined;\n\n  @property({ type: Number })\n  defaultDevWsPort = 4242;\n\n  heartbeatInterval: number | undefined;\n\n  disableWebsockets = false;\n  wsManuallyClosed = false;\n\n  heartBeatRate = 55000;\n\n  constructor() {\n    super();\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (!this.disableWebsockets) {\n      this.initWebSockets();\n    }\n  }\n\n  initWebSockets() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = undefined;\n    }\n\n    let wsEndpoint;\n\n    if (\n      window.location.hostname === \"localhost\" ||\n      window.location.hostname === \"192.1.168\"\n    ) {\n      wsEndpoint = `ws://${window.location.hostname}:${this.defaultDevWsPort}`;\n    } else {\n      wsEndpoint = `wss://${window.location.hostname}:443`;\n    }\n\n    try {\n      this.ws = new WebSocket(wsEndpoint);\n      console.error(\"WebSocket Opened\");\n      this.ws.onmessage = this.onMessage.bind(this);\n      this.ws.onopen = this.onWsOpen.bind(this);\n      this.ws.onerror = (error) => {\n        //TODO: Try to resend the last message\n        this.webSocketsErrorCount++;\n        console.error(\"WebSocket Error \" + error);\n        setTimeout(\n          () => this.initWebSockets(),\n          this.webSocketsErrorCount > 1\n            ? this.webSocketsErrorCount * 1000\n            : 2000\n        );\n        this.fire(\"yp-ws-error\", { error: error });\n      };\n      this.ws.onclose = (error) => {\n        console.error(\"WebSocket Close \" + error);\n        this.webSocketsErrorCount++;\n        if (!this.wsManuallyClosed) {\n          setTimeout(\n            () => this.initWebSockets(),\n            this.webSocketsErrorCount > 1\n              ? this.webSocketsErrorCount * 1000\n              : 2000\n          );\n        }\n        this.fire(\"yp-ws-closed\");\n      };\n    } catch (error) {\n      console.error(\"WebSocket Error \" + error);\n      this.webSocketsErrorCount++;\n      setTimeout(\n        () => this.initWebSockets(),\n        this.webSocketsErrorCount > 1 ? this.webSocketsErrorCount * 1000 : 1500\n      );\n      this.fire(\"yp-ws-error\", { error: error });\n    }\n  }\n\n  sendHeartbeat() {\n    if (this.ws.readyState === WebSocket.OPEN) {\n      console.error(\"Sending heartbeath\");\n      this.ws.send(JSON.stringify({ type: \"heartbeat\" }));\n    } else {\n      console.error(\"WebSocket not open\");\n    }\n  }\n\n  onWsOpen() {\n    console.error(\"WebSocket onWsOpen\");\n    this.sendHeartbeat();\n\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n\n    //@ts-ignore\n    this.heartbeatInterval = setInterval(() => this.sendHeartbeat(), this.heartBeatRate);\n    this.ws.onmessage = (messageEvent) => {\n      const data = JSON.parse(messageEvent.data);\n      if (data.clientId) {\n        this.wsClientId = data.clientId;\n        this.ws.onmessage = this.onMessage.bind(this);\n        console.error(`WebSocket clientId: ${this.wsClientId}`);\n        this.fire(\"yp-ws-opened\", { clientId: this.wsClientId });\n      } else {\n        console.error(\"Error: No clientId received from server!\");\n      }\n    };\n  }\n\n  handleScroll() {\n    if (this.programmaticScroll || !this.$$(this.scrollElementSelector)) {\n      return;\n    }\n\n    const currentScrollTop = this.$$(this.scrollElementSelector)!.scrollTop;\n    if (this.scrollStart === 0) {\n      // Initial scroll\n      this.scrollStart = currentScrollTop;\n    }\n\n    const threshold = 10;\n    const atBottom =\n      this.$$(this.scrollElementSelector)!.scrollHeight -\n        currentScrollTop -\n        this.$$(this.scrollElementSelector)!.clientHeight <=\n      threshold;\n\n    if (atBottom) {\n      this.userScrolled = false;\n      this.scrollStart = 0; // Reset scroll start\n    } else if (Math.abs(this.scrollStart - currentScrollTop) > threshold) {\n      this.userScrolled = true;\n      // Optionally reset scrollStart here if you want to continuously check for threshold scroll\n      // this.scrollStart = currentScrollTop;\n    }\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = undefined;\n    }\n\n    if (this.ws) {\n      this.wsManuallyClosed = true;\n      this.ws.close();\n    }\n  }\n\n  async onMessage(event: MessageEvent) {\n    const data: PsAiChatWsMessage = JSON.parse(event.data);\n\n    switch (data.sender) {\n      case \"bot\":\n        this.addChatBotElement(data);\n        break;\n      case \"you\":\n        this.addChatUserElement(data);\n        break;\n    }\n\n    if (data.type !== \"stream_followup\") {\n      this.scrollDown();\n    }\n  }\n\n  scrollDown() {\n    if (!this.userScrolled && this.$$(this.scrollElementSelector)) {\n      this.programmaticScroll = true;\n      const element = this.$$(this.scrollElementSelector)!;\n\n      if (\n        element.tagName === \"INPUT\" ||\n        element.tagName === \"TEXTAREA\" ||\n        element.tagName === \"MD-OUTLINED-TEXT-FIELD\"\n      ) {\n        // Move the cursor to the end of the text\n        (element as HTMLInputElement).selectionStart = (\n          element as HTMLInputElement\n        ).selectionEnd = (element as HTMLInputElement).value.length;\n        element.scrollTop = element.scrollHeight - 100;\n      } else {\n        // For non-text field elements, use scrollTop and scrollHeight to scroll\n        element.scrollTop = element.scrollHeight;\n      }\n\n      setTimeout(() => {\n        this.programmaticScroll = false;\n      }, 100);\n    } else {\n      console.error(\"User scrolled, not scrolling down\");\n    }\n  }\n\n  addUserChatBotMessage(userMessage: string) {\n    this.addChatBotElement({\n      sender: \"you\",\n      type: \"start\",\n      message: userMessage,\n    });\n  }\n\n  addThinkingChatBotMessage() {\n    this.addChatBotElement({\n      sender: \"bot\",\n      type: \"thinking\",\n      message: \"\",\n    });\n  }\n\n  abstract addChatBotElement(wsMessage: PsAiChatWsMessage): Promise<void>;\n\n  addChatUserElement(data: PsAiChatWsMessage) {\n    this.chatLog = [...this.chatLog, data];\n  }\n\n  get simplifiedChatLog() {\n    let chatLog = this.chatLog.filter(\n      (chatMessage) =>\n        chatMessage.type != \"thinking\" &&\n        chatMessage.type != \"noStreaming\" &&\n        chatMessage.message\n    );\n    return chatLog.map((chatMessage) => {\n      return {\n        sender: chatMessage.sender == \"bot\" ? \"assistant\" : \"user\",\n        message: chatMessage.rawMessage\n          ? chatMessage.rawMessage\n          : chatMessage.message,\n      };\n    }) as PsSimpleChatLog[];\n  }\n\n  reset() {\n    this.chatLog = [];\n    if (this.ws) {\n      this.ws.close();\n      this.initWebSockets();\n    }\n    this.serverMemoryId = undefined;\n    this.requestUpdate();\n  }\n}\n"]}