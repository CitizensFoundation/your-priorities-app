<div hidden=""by-polymer-bundler=""><dom-module id="yp-create-report"assetpath="../yp-app-globals/"><template><style include="iron-flex iron-flex-alignment">.additionalSettings{padding-top:16px;}paper-textarea{padding-top:16px;}.error{padding:16px;color:red;}[hidden]{display:none !important;}paper-button{margin:24px;color:var(--accent-color);margin-bottom:0;}a{text-decoration:none;}.infoText{padding:8px;}.reportText{margin-top:8px;}.expiredText{color:red;}.fraudItemSelection{color:#000;width:200px;}paper-dialog-scrollable{height:350px;width:420px;}.auditContainer{margin-bottom:32px;}</style><lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal><lite-signal on-lite-signal-yp-auto-translate="_autoTranslateEvent"></lite-signal><yp-edit-dialog id="editDialog"title="[[editHeaderText]]"icon="language"confirmation-text="[[t('close')]]"action="[[action]]"method="[[method]]"cancel-text="[[t('close')]]"params="[[params]]"save-text="[[saveText]]"toast-text="[[toastText]]"><div class="layout vertical center-center"><template is="dom-if"if="[[fraudAuditSelectionActive]]"><template is="dom-if"if="[[waitingOnFraudAudits]]"><paper-progress id="progressFraudAudits"indeterminate=""></paper-progress></template><paper-dialog-scrollable><template is="dom-if"if="[[!waitingOnFraudAudits]]"><div class="auditContainer layout vertical center-center"><template is="dom-repeat"items="[[fraudAuditsAvailable]]"as="fraudItem"><paper-button raised=""class="layout horizontal fraudItemSelection"data-args$="[[fraudItem.logId]]"on-tap="_fraudItemSelection">[[fraudItem.date]]<br>[[fraudItem.userName]]</paper-button></template></div></template></paper-dialog-scrollable></template><template is="dom-if"if="[[!fraudAuditSelectionActive]]"><paper-progress id="progress"value="[[progress]]"></paper-progress><div class="error"hidden$="[[!error]]">[[error]]</div><div hidden$="[[!reportUrl]]"><a href="[[reportUrl]]"target="_blank"hidden$="[[downloadDisabled]]"><paper-button id="downloadReportButton"disabled$="[[downloadDisabled]]"raised="">[[t('downloadReport')]]</paper-button></a></div><div class="infoText reportText"hidden$="[[!reportUrl]]">[[t('reportLinkInfo')]]</div><div class="infoText expiredText"hidden$="[[!downloadDisabled]]">[[t('downloadHasExpired')]]</div></template></div><div class="layout horizontal center-center"hidden=""><yp-ajax hidden=""method="PUT"id="startReportCreationAjax"on-response="_startReportCreationResponse"></yp-ajax><yp-ajax hidden=""method="GET"id="reportCreationProgressAjax"on-response="_reportCreationProgressResponse"></yp-ajax><yp-ajax hidden=""method="GET"id="getFraudAuditsAjax"on-response="_fraudAuditsAjaxResponse"></yp-ajax></div></yp-edit-dialog></template></dom-module><script>Polymer({is:"yp-create-report",behaviors:[Polymer.ypLanguageBehavior,Polymer.ypEditDialogBehavior,Polymer.AccessHelpers],properties:{action:{type:String,value:"/api/communities"},type:String,community:{type:Object},group:{type:Object},progress:{type:Number,value:0},error:{type:String,value:null},jobId:{type:Number,value:null},reportUrl:{type:String,value:null},downloadDisabled:{type:Boolean,value:!1},autoTranslateActive:{type:Boolean,value:!1},selectedFraudAuditId:{type:Number,value:null},fraudAuditSelectionActive:{type:Boolean,computed:"_fraudAuditSelectionActive(type,selectedFraudAuditId)"},fraudAuditsAvailable:{type:Array,value:null},waitingOnFraudAudits:{type:Boolean,value:!1}},_fraudItemSelection:function(t){this.set("selectedFraudAuditId",t.target.getAttribute("data-args")),this.$.startReportCreationAjax.body={selectedFraudAuditId:this.selectedFraudAuditId},this.$.startReportCreationAjax.generateRequest()},_fraudAuditSelectionActive:function(t,e){return"fraudAuditReport"===t&&!e},_autoTranslateEvent:function(t,e){this.set("autoTranslateActive",e)},_startReportCreationResponse:function(t,e){this.jobId=e.response.jobId,this.group?this.$.reportCreationProgressAjax.url="/api/groups/"+this.group.id+"/"+this.jobId+"/report_creation_progress":this.community&&(this.$.reportCreationProgressAjax.url="/api/communities/"+this.community.id+"/"+this.jobId+"/report_creation_progress"),this._pollLaterForProgress()},_pollLaterForProgress:function(){this.async(function(){this.$.reportCreationProgressAjax.generateRequest()},1e3)},_formatAuditReportDates:function(t){for(var e=0;e<t.length;e++)t[e].date&&(t[e].date=moment(t[e].date).format("DD/MM/YYYY hh:mm:ss"));return t},_fraudAuditsAjaxResponse:function(t,e){this.set("waitingOnFraudAudits",!1),this.set("fraudAuditsAvailable",this._formatAuditReportDates(e.response))},_reportCreationProgressResponse:function(t,e){!e.response.error&&null!==e.response.progress&&e.response.progress<100&&this._pollLaterForProgress(),this.set("progress",e.response.progress),e.response.error&&this.set("error",this.t(e.response.error)),e.response.data&&(this.set("reportUrl",e.response.data.reportUrl),this.async(function(){this.set("downloadDisabled",!0)},354e4))},_clear:function(){this.set("community",null),this.set("group",null),this.set("jobId",null),this.set("error",null),this.set("reportUrl",null),this.set("downloadDisabled",!1),this.set("progress",0),this.set("selectedFraudAuditId",null),this.set("fraudAuditsAvailable",null),this.set("waitingOnFraudAudits",!1)},setupAndOpen:function(t,e,s,r){var i;window.autoTranslate?this.set("autoTranslateActive",!0):this.set("autoTranslateActive",!1),this._clear(),this.set("type",t),e?(this.set("group",e),i="/api/groups/"+this.group.id+"/"+this.type+"/start_report_creation"):s&&(this.set("community",s),i="/api/communities/"+this.community.id+"/"+this.type+"/start_report_creation"),this.autoTranslateActive&&(i+="?translateLanguage="+this.language),this.$.startReportCreationAjax.url=i,this.$.startReportCreationAjax.body={},-1===["fraudAuditReport"].indexOf(t)&&this.$.startReportCreationAjax.generateRequest(),"fraudAuditReport"===t&&s&&(this.$.getFraudAuditsAjax.url="/api/communities/".concat(s.id,"/getFraudAudits"),this.$.getFraudAuditsAjax.generateRequest(),this.set("waitingOnFraudAudits",!0)),this.set("refreshFunction",r),this._setupTranslation(),this.open()},_setupTranslation:function(){"docx"===this.type?(this.set("editHeaderText",this.t("createDocxReport")),this.set("toastText",this.t("haveCreatedDocxReport"))):"xls"===this.type?(this.set("editHeaderText",this.t("createXlsReport")),this.set("toastText",this.t("haveCreatedXLsReport"))):"usersxls"===this.type?(this.set("editHeaderText",this.t("createXlsUsersReport")),this.set("toastText",this.t("haveCreatedXLsReport"))):"fraudAuditReport"===this.type&&(this.set("editHeaderText",this.t("downloadFraudAuditReport")),this.set("toastText",this.t("haveCreatedFraudAuditReport"))),this.set("saveText",null)}})</script></div>