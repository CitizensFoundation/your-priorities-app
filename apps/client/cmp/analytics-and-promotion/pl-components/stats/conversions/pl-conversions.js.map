{"version":3,"file":"pl-conversions.js","sourceRoot":"","sources":["../../../../../src/analytics-and-promotion/pl-components/stats/conversions/pl-conversions.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, css, html, nothing } from 'lit';\nimport { property, customElement } from 'lit/decorators.js';\n\nimport numberFormatter from '../../util/number-formatter';\nimport * as api from '../../api.js';\nimport * as url from '../../util/url.js';\nimport { suppressDeprecationWarnings } from 'moment';\n\nimport '../../pl-link.js';\nimport '../pl-bar.js';\nimport './pl-prop-breakdown.js';\nimport { PlausibleBaseElement } from '../../pl-base-element.js';\nimport { PlausibleBaseElementWithState } from '../../pl-base-element-with-state';\n\nconst MOBILE_UPPER_WIDTH = 767;\nconst DEFAULT_WIDTH = 1080;\n\n@customElement('pl-conversions')\nexport class PlausibleConversions extends PlausibleBaseElementWithState {\n  @property({ type: Object })\n  onClickFunction!: any;\n\n  @property({ type: Boolean })\n  loading = false;\n\n  @property({ type: Number })\n  viewport = DEFAULT_WIDTH;\n\n  @property({ type: Number })\n  prevHeight: number | undefined;\n\n  @property({ type: Array })\n  goals?: PlausibleGoalData[];\n\n  @property({ type: Array })\n  highlightedGoals?: string[];\n\n  constructor() {\n    super();\n    this.handleResize = this.handleResize.bind(this);\n  }\n\n override connectedCallback() {\n    super.connectedCallback();\n    window.addEventListener('resize', this.handleResize, false);\n    this.handleResize();\n    if (this.timer) this.timer.onTick(this.fetchConversions.bind(this));\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    window.removeEventListener('resize', this.handleResize, false);\n  }\n\n  override updated(changedProperties: Map<string | number | symbol, unknown>): void {\n    super.updated(changedProperties);\n    if (changedProperties.get('query')) {\n      const height = this.offsetHeight;\n      this.loading = true;\n      this.prevHeight = height;\n      this.fetchConversions();\n    }\n  }\n\n  static override get styles() {\n    return [\n      ...super.styles,\n      css`\n        @media (max-width: 767px) {\n          .mainContainer {\n            max-width: calc(100vw - 32px);\n          }\n\n          .w-20 {\n            width: 2.6rem;\n          }\n\n          pl-bar {\n            max-width: 70%;\n          }\n\n          .padOnMobile {\n            margin-right: 16px;\n          }\n        }\n\n        pl-bar {\n            max-width: 70%;\n        }\n      `\n    ];\n  }\n\n  handleResize() {\n    this.viewport = window.innerWidth;\n  }\n\n  override firstUpdated() {\n    this.fetchConversions();\n  }\n\n  getBarMaxWidth() {\n    return this.viewport! > MOBILE_UPPER_WIDTH ? '16rem' : '10rem';\n  }\n\n  fetchConversions() {\n    api\n      .get(\n        this.proxyUrl,\n        `/api/stats/${encodeURIComponent(this.site.domain!)}/conversions`,\n        this.query\n      )\n      .then(res =>\n        { this.loading=false; this.goals= res; this.prevHeight = undefined }\n      );\n  }\n\n  getPlBackground(goalName: string) {\n    if (this.highlightedGoals && this.highlightedGoals.includes(goalName)) {\n      return 'bg-red-60';\n    } else if (this.highlightedGoals) {\n      return 'bg-red-40';\n    } else {\n      return 'bg-red-50';\n    }\n  }\n\n  renderGoal(goal: PlausibleGoalData) {\n    const renderProps =\n      this.query.filters!['goal'] == goal.name && goal.prop_names;\n\n    return html`\n      <div class=\"my-2 text-sm\" key=${goal.name}>\n        <div class=\"flex items-center justify-between my-2\">\n          <pl-bar\n            .count=\"${goal.unique_conversions}\"\n            .all=\"${this.goals!}\"\n            bg=\"${this.getPlBackground(goal.name)} dark:bg-gray-500 dark:bg-opacity-15\"\n            .maxWidthDeduction=\"${this.getBarMaxWidth()}\"\n            plot=\"unique_conversions\"\n          >\n            <pl-link\n              .to=\"${{search: url.setQuerySearch('goal', goal.name)}}\"\n              class=\"block px-2 py-1.5 hover:underline relative z-2 break-all lg:truncate dark:text-gray-200\"\n              >${this.t(goal.name)}</pl-link\n            >\n          </pl-bar>\n          <div class=\"dark:text-gray-200\">\n            <span class=\"inline-block w-20 font-medium text-right\"\n              >${numberFormatter(goal.unique_conversions)}</span\n            >\n            ${this.viewport && this.viewport > MOBILE_UPPER_WIDTH\n              ? html`<span class=\"inline-block w-20 font-medium text-right\"\n                  >${numberFormatter(goal.total_conversions)}</span\n                >`\n              : nothing}\n            <span class=\"inline-block w-20 font-medium text-right\"\n              >${goal.conversion_rate}%</span\n            >\n          </div>\n        </div>\n        ${renderProps\n          ? html`<pl-prop-breakdown\n              .site=${this.site}\n              .query=${this.query}\n              .goal=${goal}\n              .proxyUrl=${this.proxyUrl}\n            ></pl-prop-breakdown>`\n          : nothing}\n      </div>\n    `;\n  }\n\n  renderInner() {\n    if (!this.goals) {\n      return html`<div class=\"mx-auto my-2 loading\"><div></div></div>`;\n    } else {\n      return html`\n        <h3 class=\"font-bold dark:text-gray-100\">\n          ${this.title || this.t(\"Goal Conversions\")}\n        </h3>\n        <div\n          class=\"flex items-center justify-between mt-3 mb-2 text-xs font-bold tracking-wide text-gray-500 dark:text-gray-400\"\n        >\n          <span>${this.t(\"Goal\")}</span>\n          <div class=\"text-right\">\n            <span class=\"inline-block w-20 padOnMobile\">${this.t(\"Uniques\")}</span>\n            ${this.viewport && this.viewport > MOBILE_UPPER_WIDTH\n              ? html`<span class=\"inline-block w-20\">${this.t(\"Total\")}</span>`\n              : nothing}\n            <span class=\"inline-block w-20\">CR</span>\n          </div>\n        </div>\n\n        ${this.goals.map(this.renderGoal.bind(this))}\n      `;\n    }\n  }\n\n  override render() {\n    return html`\n      <div\n        class=\"w-full p-4 bg-white rounded shadow-xl dark:bg-gray-825 mainContainer\"\n        .style=\"${{\n          minHeight: '132px',\n          height: this.prevHeight ?? 'auto',\n        }}\"\n        .ref=${this}\n      >\n        ${this.renderInner()}\n      </div>\n    `;\n  }\n}\n"]}