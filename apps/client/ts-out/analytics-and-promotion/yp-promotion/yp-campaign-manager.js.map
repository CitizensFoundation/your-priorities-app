{"version":3,"file":"yp-campaign-manager.js","sourceRoot":"","sources":["../../../src/analytics-and-promotion/yp-promotion/yp-campaign-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, css, html } from 'lit';\nimport { property, customElement, query } from 'lit/decorators.js';\nimport { YpBaseElementWithLogin } from '../../common/yp-base-element-with-login';\n\nimport '@material/web/fab/fab.js';\nimport './yp-new-campaign.js';\nimport './yp-campaign.js';\nimport { YpNewCampaign } from './yp-new-campaign.js';\nimport { YpCampaignApi } from './YpCampaignApi';\nimport { Dialog } from '@material/web/dialog/internal/dialog';\n\n@customElement('yp-campaign-manager')\nexport class YpCampaignManager extends YpBaseElementWithLogin {\n  @property({ type: String })\n  collectionType!: string;\n\n  @property({ type: Number })\n  collectionId!: number;\n\n  @property({ type: Object })\n  collection: YpCollectionData | undefined;\n\n  @property({ type: Array })\n  campaigns: YpCampaignData[] | undefined;\n\n  @query('yp-new-campaign')\n  private newCampaignElement!: YpNewCampaign;\n\n  campaignApi: YpCampaignApi = new YpCampaignApi();\n\n  campaignToDelete: number | undefined;\n\n  override firstUpdated() {\n    this.getCampaigns();\n  }\n\n  newCampaign() {\n    this.newCampaignElement.open();\n  }\n\n  getTrackingUrl(campaign: YpCampaignData, medium: string) {\n    const fullHost = location.protocol + '//' + location.host;\n    const url = `${fullHost}/${this.collectionType}/${this.collectionId}?utm_source=${campaign.configuration.utm_source}&utm_medium=${medium}&utm_campaign=${campaign.configuration.utm_campaign}&utm_content=${campaign.id}`;\n    const encodedUrl = encodeURI(url);\n    return encodedUrl;\n  }\n\n  async createCampaign(event: CustomEvent) {\n    const data = event.detail as YpNewCampaignData;\n\n    const configuration = {\n      utm_campaign: data.name,\n      utm_source: this.collection!.name,\n      audience: data.targetAudience,\n      promotionText: data.promotionText,\n      shareImageUrl: data.shareImageUrl,\n      mediums: [] as YpCampaignMediumData[],\n    } as YpCampaignConfigurationData;\n\n    const campaign = (await this.campaignApi.createCampaign(\n      this.collectionType,\n      this.collectionId,\n      {\n        configuration,\n      }\n    )) as YpCampaignData;\n\n    campaign.configuration.utm_content = `${campaign.id}`;\n\n    const mediums: YpCampaignMediumData[] = [];\n\n    for (let i = 0; i < data.mediums.length; i++) {\n      const medium = data.mediums[i];\n      mediums.push({\n        utm_medium: medium,\n        finaUrl: this.getTrackingUrl(campaign, medium),\n        active: false,\n      });\n    }\n\n    campaign.configuration.mediums = mediums;\n\n    await this.campaignApi.updateCampaign(\n      this.collectionType,\n      this.collectionId,\n      campaign.id!,\n      {\n        configuration: campaign.configuration,\n      }\n    );\n\n    this.getCampaigns();\n  }\n\n  async campaignConfigurationUpdated(event: CustomEvent) {\n    await this.campaignApi.updateCampaign(\n      this.collectionType,\n      this.collectionId,\n      event.detail.campaignId,\n      {\n        configuration: event.detail.configuration,\n      }\n    );\n  }\n\n  async getCampaigns() {\n    this.campaignToDelete = undefined;\n    this.campaigns = await this.campaignApi.getCampaigns(\n      this.collectionType,\n      this.collectionId\n    );\n  }\n\n  async reallyDeleteCampaign() {\n    try {\n      await this.campaignApi.deleteCampaign(\n        this.collectionType,\n        this.collectionId,\n        this.campaignToDelete!\n      );\n    } catch (error) {\n      this.campaignToDelete = undefined;\n      console.error(error);\n    }\n\n    this.getCampaigns();\n  }\n\n  deleteCampaign(event: CustomEvent) {\n    this.campaignToDelete = event.detail;\n    (this.$$('#deleteConfirmationDialog') as Dialog).show();\n  }\n\n  cancelDeleteCampaign() {\n    this.campaignToDelete = undefined;\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        .mainContainer {\n          width: 100%;\n          margin-top: 32px;\n        }\n\n        @media (max-width: 1100px) {\n          .mainContainer {\n            width: 100%;\n            max-width: calc(100vw - 80px);\n          }\n        }\n\n        md-fab {\n          margin-top: 32px;\n          margin-bottom: 0;\n        }\n\n        .fabContainer {\n          width: 1000px;\n        }\n\n        @media (max-width: 1100px) {\n          .fabContainer {\n            width: 100%;\n          }\n        }\n      `,\n    ];\n  }\n\n  renderDeleteConfirmationDialog() {\n    return html`\n      <md-dialog id=\"deleteConfirmationDialog\" crimClickAction escapeKeyAction>\n        <div class=\"layout horizontal center-center\">\n          <div class=\"headerText\" slot=\"headline\">${this.t('reallyDeletePromotion')}</div>\n        </div>\n        <md-text-button\n          .label=\"${this.t('cancel')}\"\n          class=\"button\"\n          dialogAction=\"cancel\"\n          @click=\"${this.cancelDeleteCampaign}\"\n          slot=\"actions\"\n        >\n        </md-text-button>\n        <md-tonal-button\n          dialogAction=\"ok\"\n          class=\"button okButton\"\n          .label=\"${this.t('delete')}\"\n          @click=\"${this.reallyDeleteCampaign}\"\n          slot=\"actions\"\n        >\n        </md-tonal-button>\n      </md-dialog>\n    `;\n  }\n\n  renderCampaign(campaign: YpCampaignData) {\n    return html`<yp-campaign\n      @configurationUpdated=\"${this.campaignConfigurationUpdated}\"\n      .campaignApi=\"${this.campaignApi}\"\n      @deleteCampaign=\"${this.deleteCampaign}\"\n      .collectionType=\"${this.collectionType}\"\n      .collection=\"${this.collection}\"\n      .collectionId=\"${this.collectionId}\"\n      .campaign=\"${campaign}\"\n    ></yp-campaign>`;\n  }\n\n  override render() {\n    return html`\n      <yp-new-campaign\n        .collectionType=\"${this.collectionType}\"\n        .collection=\"${this.collection}\"\n        .collectionId=\"${this.collectionId}\"\n        @save=\"${this.createCampaign}\"\n      ></yp-new-campaign>\n      <div class=\"layout horizontal center-center fabContainer\">\n        <md-fab\n          .label=\"${this.t('newTrackingPromotion')}\"\n          @click=\"${this.newCampaign}\"\n        ><md-icon slot=\"icon\">add</md-icon></md-fab>\n      </div>\n      <div class=\"layout vertical start mainContainer\">\n        <div class=\"layout vertical\">\n          ${this.campaigns?.map(campaign => this.renderCampaign(campaign))}\n        </div>\n      </div>\n      ${this.renderDeleteConfirmationDialog()}\n    `;\n  }\n}\n"]}