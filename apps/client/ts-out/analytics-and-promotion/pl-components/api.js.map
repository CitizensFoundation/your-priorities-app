{"version":3,"file":"api.js","sourceRoot":"","sources":["../../../src/analytics-and-promotion/pl-components/api.ts"],"names":[],"mappings":"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","sourcesContent":["import { formatISO } from './util/date.js';\n\nlet abortController = new AbortController();\nlet SHARED_LINK_AUTH: string | undefined = undefined;\n\nclass ApiError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ApiError';\n  }\n}\n\nfunction serialize(obj: any) {\n  var str = [];\n  /* eslint-disable-next-line no-prototype-builtins */\n  for (var p in obj)\n    if (obj.hasOwnProperty(p)) {\n      str.push(encodeURIComponent(p) + '=' + encodeURIComponent(obj[p]));\n    }\n  return str.join('&');\n}\n\nexport function setSharedLinkAuth(auth: string) {\n  SHARED_LINK_AUTH = auth;\n}\n\nexport function cancelAll() {\n  abortController.abort();\n  abortController = new AbortController();\n}\n\nfunction serializeFilters(filters: any) {\n  const cleaned = {};\n  //@ts-ignore\n  Object.entries(filters).forEach(([key, val]) =>\n    //@ts-ignore\n    val ? (cleaned[key] = val) : null\n  );\n  return JSON.stringify(cleaned);\n}\n\nexport function serializeQuery(\n  query: PlausibleQueryData,\n  extraQuery: any = []\n) {\n  const queryObj: PlausibleQueryStringsData = { period: 'realtime' };\n  if (query.period) {\n    queryObj.period = query.period;\n  }\n  if (query.date && query.date instanceof Date) {\n    queryObj.date = formatISO(query.date);\n  } else {\n    queryObj.date = query.date;\n  }\n  if (query.from) {\n    queryObj.from = formatISO(query.from);\n  }\n  if (query.to) {\n    queryObj.to = formatISO(query.to);\n  }\n  //@ts-ignore\n  if (query.filters) {\n    //@ts-ignore\n    queryObj.filters = serializeFilters(query.filters);\n  }\n  if (query.with_imported) {\n    queryObj.with_imported = query.with_imported;\n  }\n  if (SHARED_LINK_AUTH) {\n    queryObj.auth = SHARED_LINK_AUTH;\n  }\n  Object.assign(queryObj, ...extraQuery);\n\n  return '?' + serialize(queryObj);\n}\n\nexport function get(\n  proxyUrl: string | undefined,\n  url: string | Request,\n  query: PlausibleQueryData,\n  ...extraQuery: any[]\n) {\n  if (proxyUrl) {\n    return getWithProxy(proxyUrl, url, query, ...extraQuery);\n  } else {\n    return getDirect(url, query, ...extraQuery);\n  }\n}\n\nexport function getWithProxy(\n  proxyUrl: string,\n  url: string | Request,\n  query: PlausibleQueryData,\n  ...extraQuery: any[]\n) {\n  const headers = SHARED_LINK_AUTH\n    ? {\n        'X-Shared-Link-Auth': SHARED_LINK_AUTH,\n        Accept: 'application/json',\n        'Content-Type': 'application/json',\n      }\n    : { Accept: 'application/json', 'Content-Type': 'application/json' };\n  url = url + serializeQuery(query, extraQuery);\n  return fetch(proxyUrl, {\n    method: 'PUT',\n    body: JSON.stringify({\n      plausibleUrl: url,\n    }),\n    signal: abortController.signal,\n    headers: headers as any,\n  }).then(response => {\n    if (!response.ok) {\n      //@ts-ignore\n      return response.json();\n      /*return response.json().then(msg => {\n        throw new ApiError(msg.error);\n      });*/\n    }\n    return response.json();\n  });\n}\n\nexport function getDirect(\n  url: string | Request,\n  query: PlausibleQueryData,\n  ...extraQuery: any[]\n) {\n  const headers = SHARED_LINK_AUTH\n    ? {\n        'X-Shared-Link-Auth': SHARED_LINK_AUTH,\n        Accept: 'application/json',\n        'Content-Type': 'application/json',\n      }\n    : { Accept: 'application/json', 'Content-Type': 'application/json' };\n\n  url = url + serializeQuery(query, extraQuery);\n  return fetch(url, {\n    signal: abortController.signal,\n    headers: headers as any,\n  }).then(response => {\n    if (!response.ok) {\n      //@ts-ignore\n      return response.json().then(msg => {\n        throw new ApiError(msg.error);\n      });\n    }\n    return response.json();\n  });\n}\n"]}