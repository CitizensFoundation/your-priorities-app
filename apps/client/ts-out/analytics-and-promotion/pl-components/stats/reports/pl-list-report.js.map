{"version":3,"file":"pl-list-report.js","sourceRoot":"","sources":["../../../../../src/analytics-and-promotion/pl-components/stats/reports/pl-list-report.ts"],"names":[],"mappings":"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","sourcesContent":["import * as storage from '../../util/storage.js';\nimport * as url from '../../util/url.js';\nimport * as api from '../../api.js';\nimport { customElement, property } from 'lit/decorators.js';\nimport { PlausibleBaseElement } from '../../pl-base-element.js';\nimport { css, html, nothing } from 'lit';\n\nimport '../../pl-more-link.js';\nimport '../pl-bar.js';\nimport numberFormatter from '../../util/number-formatter.js';\nimport { PlausibleBaseElementWithState } from '../../pl-base-element-with-state.js';\n\n@customElement('pl-list-report')\nexport class PlausableListReport extends PlausibleBaseElementWithState {\n  @property({ type: Object })\n  prevQuery!: PlausibleQueryData;\n\n  @property({ type: String })\n  tabKey!: string;\n\n  @property({ type: String })\n  valueKey!: string;\n\n  @property({ type: String })\n  keyLabel!: string;\n\n  @property({ type: String })\n  color: string | undefined;\n\n  @property({ type: String })\n  valueLabel: string | undefined;\n\n  @property({ type: String })\n  storedTab: string | undefined;\n\n  @property({ type: Object })\n  externalLinkDest: Function | undefined;\n\n  @property({ type: Boolean })\n  showConversionRate: boolean | undefined;\n\n  @property({ type: String })\n  detailsLink: string | undefined;\n\n  @property({ type: Object })\n  onClick: Function | undefined;\n\n  @property({ type: Object })\n  fetchDataFunction!: Function;\n\n  @property({ type: Object })\n  filter: Record<any, any> | undefined = undefined;\n\n  @property({ type: Array })\n  list?: PlausibleListItemData[];\n\n  @property({ type: Boolean })\n  loading = false;\n\n override connectedCallback() {\n    super.connectedCallback();\n    if (this.timer) this.timer.onTick(this.fetchData.bind(this));\n    this.valueKey = this.valueKey || 'visitors';\n    this.showConversionRate = !!this.query.filters!.goal;\n  }\n\n  static override get styles() {\n    return [\n      ...super.styles,\n      css`\n        .externalLinkSvg {\n          margin-top: 8px;\n          margin-left: 6px;\n        }\n      `,\n    ];\n  }\n\n  getExternalLink(item: PlausibleListItemData) {\n    if (this.externalLinkDest) {\n      const dest = this.externalLinkDest(item);\n      return html`\n        <a\n          target=\"_blank\"\n          rel=\"noreferrer\"\n          href=${dest}\n          class=\"group-hover:block\"\n        >\n          <svg\n            class=\"inline w-4 h-4 ml-1 -mt-1 text-gray-600 dark:text-gray-400 externalLinkSvg\"\n            fill=\"currentColor\"\n            viewBox=\"0 0 20 20\"\n          >\n            <path\n              d=\"M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z\"\n            ></path>\n            <path\n              d=\"M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z\"\n            ></path>\n          </svg>\n        </a>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n\n  protected override firstUpdated(\n    _changedProperties: Map<string | number | symbol, unknown>\n  ): void {\n    this.fetchData();\n  }\n\n  override updated(changedProperties: Map<string | number | symbol, unknown>): void {\n    super.updated(changedProperties);\n\n    if (changedProperties.get('query')) {\n      this.fetchData();\n    }\n  }\n\n  fetchData() {\n    if (this.prevQuery !== this.query) {\n      this.prevQuery = this.query;\n      this.loading = true;\n      this.list = undefined;\n      try {\n        this.fetchDataFunction().then((res: any) => {\n          this.loading = false;\n          this.list = res;\n        });\n      } catch (error) {\n        console.error(error);\n      }\n    }\n  }\n\n  get label() {\n    if (this.query.period === 'realtime') {\n      return this.t('Current visitors');\n    }\n\n    if (this.showConversionRate) {\n      return this.t('Conversions');\n    }\n\n    return this.valueLabel || this.t('Visitors');\n  }\n\n  renderListItem(listItem: PlausibleListItemData) {\n    const query = new URLSearchParams(window.location.search);\n\n    Object.entries(this.filter!).forEach(([key, valueKey]) => {\n      // @ts-ignore\n      query.set(key, listItem[valueKey]);\n    });\n\n    const maxWidthDeduction = this.showConversionRate ? '10rem' : '5rem';\n    const lightBackground = this.color || 'bg-green-50';\n    const noop = () => {};\n\n    return html`\n      <div\n        class=\"flex items-center justify-between my-1 text-sm\"\n        key=\"${listItem.name}\"\n      >\n        <pl-bar\n          .count=${\n            // @ts-ignore\n            listItem[this.valueKey]\n          }\n          .all=${this.list}\n          .bg=${`${lightBackground} dark:bg-gray-500 dark:bg-opacity-15`}\n          maxWidthDeduction=\"${maxWidthDeduction}\"\n          .plot=\"${this.valueKey}\"\n        >\n          <span\n            class=\"flex px-2 py-1.5 group dark:text-gray-300 relative z-2 break-all\"\n            tooltip=${this.getTooltipText(listItem)}\n          >\n            <pl-link\n              @click=\"${this.onClick || noop}\"\n              class=\"md:truncate block hover:underline\"\n              .to=${{ search: query.toString() }}\n            >\n              ${this.renderIcon(listItem)} ${listItem.name}\n            </pl-link>\n            ${this.getExternalLink(listItem)}\n          </span>\n        </pl-bar>\n        <span\n          class=\"font-medium dark:text-gray-200 w-20 text-right\"\n          tooltip=${\n            // @ts-ignore\n            listItem[this.valueKey]\n          }\n        >\n          ${\n            // @ts-ignore\n            numberFormatter(listItem[this.valueKey])\n          }\n          ${listItem.percentage >= 0\n            ? html`<span class=\"inline-block w-8 pl-1 text-xs text-right\"\n                >(${listItem.percentage}%)</span\n              >`\n            : nothing}\n        </span>\n        ${this.showConversionRate\n          ? html`<span class=\"font-medium dark:text-gray-200 w-20 text-right\"\n              >${listItem.conversion_rate}%</span\n            >`\n          : nothing}\n      </div>\n    `;\n  }\n\n  renderList() {\n    if (this.list && this.list.length > 0) {\n      return html`\n        <div\n          class=\"flex items-center justify-between mt-3 mb-2 text-xs font-bold tracking-wide text-gray-500 dark:text-gray-400\"\n        >\n          <span>${this.keyLabel}</span>\n          <span class=\"text-right\">\n            <span class=\"inline-block w-30\">${this.label}</span>\n            ${this.showConversionRate\n              ? html`<span class=\"inline-block w-20\">CR</span>`\n              : nothing}\n          </span>\n        </div>\n        ${this.list.map((i: PlausibleListItemData) => this.renderListItem(i)) }\n      `;\n    } else {\n      return nothing;\n    }\n  }\n\n  override render() {\n    return html`\n      <div class=\"flex flex-col flex-grow\">\n        ${this.loading\n          ? html`<div class=\"mx-auto loading mt-44\"><div></div></div>`\n          : nothing}\n        <div class=\"flex-grow\">${this.renderList()}</div>\n        ${this.detailsLink && this.list\n          ? html`<pl-more-link\n              .url=${this.detailsLink}\n              .list=${this.list}\n            ></pl-more-link>`\n          : nothing}\n      </div>\n    `;\n  }\n}\n"]}