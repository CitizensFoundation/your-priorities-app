{"version":3,"file":"pl-current-visitors.js","sourceRoot":"","sources":["../../../../src/analytics-and-promotion/pl-components/stats/pl-current-visitors.ts"],"names":[],"mappings":";;;;;;AAAA,OAAO,KAAK,GAAG,MAAM,QAAQ,CAAC;AAC9B,OAAO,KAAK,GAAG,MAAM,aAAa,CAAC;AACnC,OAAO,EAAE,cAAc,EAAE,MAAM,UAAU,CAAC;AAC1C,OAAO,EAAc,GAAG,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,KAAK,CAAC;AACrD,OAAO,EAAE,QAAQ,EAAE,aAAa,EAAE,MAAM,mBAAmB,CAAC;AAC5D,OAAO,EAAE,6BAA6B,EAAE,MAAM,+BAA+B,CAAC;AAE9E,OAAO,eAAe,MAAM,yBAAyB,CAAC;AAG/C,IAAM,wBAAwB,GAA9B,MAAM,wBAAyB,SAAQ,6BAA6B;IAApE;;QAIL,qFAAqF;QAErF,kCAA6B,GAAG,KAAK,CAAC;IAuFxC,CAAC;IArFU,iBAAiB;QACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;QAC1B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC/C,IAAI,CAAC,WAAW,EAAE,CAAC;IACrB,CAAC;IAED,MAAM,KAAc,MAAM;QACxB,OAAO;YACL,GAAG,KAAK,CAAC,MAAM;YACf,GAAG,CAAA;;;;;;;;OAQF;SACF,CAAC;IACJ,CAAC;IAED,WAAW;QACT,IAAI,IAAI,CAAC,6BAA6B,EAAE,CAAC;YACvC,MAAM,KAAK,GAAG,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAC1C,KAAK,CAAC,QAAQ,CAAC,GAAG,UAAU,CAAC;YAC7B,OAAO,GAAG;iBACP,GAAG,CACF,IAAI,CAAC,QAAQ,EACb,cAAc,kBAAkB,CAAC,IAAI,CAAC,IAAK,CAAC,MAAO,CAAC,YAAY,EAChE,KAAK,CACN;iBACA,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE;gBACZ,IAAI,CAAC,eAAe,GAAG,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;YAChD,CAAC,CAAC;iBACD,KAAK,CAAC,CAAC,CAAM,EAAE,EAAE;gBAChB,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;gBACjB,OAAO,IAAI,CAAC;YACd,CAAC,CAAC,CAAC;QACP,CAAC;aAAM,CAAC;YACN,OAAO,GAAG;iBACP,GAAG,CACF,IAAI,CAAC,QAAQ,EACb,cAAc,kBAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,mBAAmB,EACrE,EAAS,CACV;iBACA,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE;gBACZ,IAAI,CAAC,eAAe,GAAG,GAAG,CAAC;YAC7B,CAAC,CAAC;iBACD,KAAK,CAAC,CAAC,CAAM,EAAE,EAAE;gBAChB,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;gBACjB,OAAO,IAAI,CAAC;YACd,CAAC,CAAC,CAAC;QACP,CAAC;IACH,CAAC;IAEQ,MAAM;QACb,IAAI,cAAc,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,MAAM,IAAI,CAAC,EAAE,CAAC;YAC3C,OAAO,IAAI,CAAC;QACd,CAAC;QAED,IAAI,IAAI,CAAC,eAAe,KAAK,IAAI,EAAE,CAAC;YAClC,OAAO,IAAI,CAAA;;gBAED,EAAE,MAAM,EAAE,GAAG,CAAC,cAAc,CAAC,QAAQ,EAAE,UAAU,CAAC,EAAE;;;;;;;;;;YAUxD,IAAI,CAAC,eAAe;2BACL,CAAC,IAAI,CAAC,IAAI;eACtB,IAAI,CAAC,eAAe,KAAK,CAAC;gBAC3B,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,iBAAiB,CAAC;gBAC3B,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,kBAAkB,CAAC;;;OAGnC,CAAC;QACJ,CAAC;aAAM,CAAC;YACN,OAAO,OAAO,CAAC;QACjB,CAAC;IACH,CAAC;CACF,CAAA;AA3FC;IADC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;iEACS;AAIpC;IADC,QAAQ,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC;+EACU;AAN3B,wBAAwB;IADpC,aAAa,CAAC,qBAAqB,CAAC;GACxB,wBAAwB,CA6FpC","sourcesContent":["import * as api from \"../api\";\nimport * as url from \"../util/url\";\nimport { appliedFilters } from \"../query\";\nimport { LitElement, css, html, nothing } from \"lit\";\nimport { property, customElement } from \"lit/decorators.js\";\nimport { PlausibleBaseElementWithState } from \"../pl-base-element-with-state\";\nimport { isThisMonth } from \"../util/date\";\nimport structuredClone from \"@ungap/structured-clone\";\n\n@customElement(\"pl-current-visitors\")\nexport class PlausibleCurrentVisitors extends PlausibleBaseElementWithState {\n  @property({ type: Number })\n  currentVisitors: number | undefined;\n\n  //TODO: This is a workaround to until current-visitors API supports custom properties\n  @property({ type: Boolean })\n  useTopStatsForCurrentVisitors = false;\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.timer.onTick(this.updateCount.bind(this));\n    this.updateCount();\n  }\n\n  static override get styles() {\n    return [\n      ...super.styles,\n      css`\n        pl-link {\n          width: 100%;\n        }\n\n        [hidden] {\n          display: none !important;\n        }\n      `,\n    ];\n  }\n\n  updateCount() {\n    if (this.useTopStatsForCurrentVisitors) {\n      const query = structuredClone(this.query);\n      query[\"period\"] = \"realtime\";\n      return api\n        .get(\n          this.proxyUrl,\n          `/api/stats/${encodeURIComponent(this.site!.domain!)}/top-stats`,\n          query\n        )\n        .then((res) => {\n          this.currentVisitors = res.top_stats[1].value;\n        })\n        .catch((e: any) => {\n          console.error(e);\n          return null;\n        });\n    } else {\n      return api\n        .get(\n          this.proxyUrl,\n          `/api/stats/${encodeURIComponent(this.site.domain)}/current-visitors`,\n          {} as any\n        )\n        .then((res) => {\n          this.currentVisitors = res;\n        })\n        .catch((e: any) => {\n          console.error(e);\n          return null;\n        });\n    }\n  }\n\n  override render() {\n    if (appliedFilters(this.query).length >= 1) {\n      return null;\n    }\n\n    if (this.currentVisitors !== null) {\n      return html`\n        <pl-link\n          .to=${{ search: url.setQuerySearch(\"period\", \"realtime\") }}\n          class=\"block ml-1 md:ml-2 mr-auto text-xs md:text-sm font-bold text-gray-500 dark:text-gray-300\"\n        >\n          <svg\n            class=\"inline w-2 mr-1 md:mr-2 text-green-500 fill-current\"\n            viewBox=\"0 0 16 16\"\n            xmlns=\"http://www.w3.org/2000/svg\"\n          >\n            <circle cx=\"8\" cy=\"8\" r=\"8\" />\n          </svg>\n          ${this.currentVisitors}\n          <span ?hidden=\"${!this.wide}\" class=\" sm:inline-block\"\n            >${this.currentVisitors === 1\n              ? this.t(\"current visitor\")\n              : this.t(\"current visitors\")}</span\n          >\n        </pl-link>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n}\n"]}