{"version":3,"file":"pl-line-graph.js","sourceRoot":"","sources":["../../../../../src/analytics-and-promotion/pl-components/stats/graph/pl-line-graph.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement, css, html, nothing } from 'lit';\nimport { property, customElement, query } from 'lit/decorators.js';\nimport Chart from 'chart.js/auto';\nimport { navigateToQuery } from '../../query.js';\nimport numberFormatter, {\n  durationFormatter,\n} from '../../util/number-formatter.js';\nimport * as api from '../../api';\nimport * as storage from '../../util/storage.js';\n//import LazyLoader from '../../components/lazy-loader'\nimport { GraphTooltip, buildDataSet, dateFormatter } from './graph-util.js';\nimport './pl-top-stats.js';\nimport * as url from '../../util/url.js';\nimport { PlausibleBaseElement } from '../../pl-base-element.js';\n\nimport {\n  METRIC_MAPPING,\n  METRIC_FORMATTER,\n  METRIC_LABELS,\n} from './pl-visitors-graph.js';\nimport { PlausibleBaseElementWithState } from '../../pl-base-element-with-state.js';\n\n@customElement('pl-line-graph')\nexport class PlausibleLineGraph extends PlausibleBaseElementWithState {\n  @property({ type: Object })\n  graphData: any;\n\n  @property({ type: String })\n  metric!: string;\n\n  @property({ type: Object })\n  ctx!: CanvasRenderingContext2D | null;\n\n  @property({ type: Boolean })\n  darkTheme = false;\n\n  @property({ type: Object })\n  chart: Chart | undefined;\n\n  @property({ type: Object })\n  updateMetric: Function | undefined;\n\n  @property({ type: Object })\n  history!: any;\n\n  @property({ type: Object })\n  topStatData: PlausibleTopStatsData | undefined;\n\n  @query('canvas')\n  canvasElement!: HTMLCanvasElement;\n\n  @property({ type: Boolean })\n  exported = false;\n\n  constructor() {\n    super();\n    this.repositionTooltip = this.repositionTooltip.bind(this);\n  }\n\n  static override get styles() {\n    return [...super.styles];\n  }\n\n  override updated(changedProperties: Map<string | number | symbol, unknown>): void {\n    super.updated(changedProperties);\n\n    const tooltip = this.$$('#chartjs-tooltip');\n\n    if (\n      this.metric &&\n      this.graphData &&\n      (changedProperties.has('graphData') || changedProperties.has('darkTheme'))\n    ) {\n      if (this.chart) {\n        this.chart.destroy();\n      }\n      this.chart = this.regenerateChart();\n      this.chart.update();\n\n      if (tooltip) {\n        tooltip.style.display = 'none';\n      }\n    }\n\n    if (!this.graphData || !this.metric) {\n      if (this.chart) {\n        this.chart.destroy();\n      }\n\n      if (tooltip) {\n        tooltip.style.display = 'none';\n      }\n    }\n  }\n\n  regenerateChart() {\n    let graphEl = this.$$('canvas') as HTMLCanvasElement;\n    if (!graphEl) {\n      graphEl = this.canvasElement as HTMLCanvasElement;\n    }\n    this.ctx = graphEl!.getContext('2d');\n    const dataSet = buildDataSet(\n      this.graphData.plot,\n      this.graphData.present_index,\n      this.ctx!,\n      METRIC_LABELS[this.metric]\n      ,false\n    );\n    // const prev_dataSet = graphData.prev_plot && buildDataSet(graphData.prev_plot, false, this.ctx, METRIC_LABELS[this.metric], true)\n    // const combinedDataSets = comparison.enabled && prev_dataSet ? [...dataSet, ...prev_dataSet] : dataSet;\n\n    const graphData = this.graphData;\n\n    return new Chart(this.ctx!, {\n      type: 'line',\n      data: {\n        labels: this.graphData.labels,\n        datasets: dataSet,\n      },\n      options: {\n        animation: false,\n        plugins: {\n          legend: { display: false },\n          tooltip: {\n            enabled: false,\n            mode: 'index',\n            intersect: false,\n            position: 'average',\n            external: GraphTooltip(\n              this.graphData,\n              this.metric,\n              graphEl,\n              this.$$('#chartjs-tooltip')!\n            ),\n          },\n        },\n        responsive: true,\n        onResize: this.updateWindowDimensions,\n        elements: { line: { tension: 0 }, point: { radius: 0 } },\n        //@ts-ignore\n        onClick: this.onClick.bind(this),\n        scales: {\n          y: {\n            beginAtZero: true,\n            ticks: {\n              callback: METRIC_FORMATTER[this.metric],\n              maxTicksLimit: 8,\n              color: this.darkTheme ? 'rgb(243, 244, 246)' : undefined,\n            },\n            grid: {\n              //@ts-ignore\n              zeroLineColor: 'transparent',\n              drawBorder: false,\n            },\n          },\n          x: {\n            grid: { display: false },\n            ticks: {\n              maxTicksLimit: 8,\n              callback: function (val, _index, _ticks) {\n                return dateFormatter(graphData.interval)(\n                  this.getLabelForValue(val as number)\n                );\n              },\n\n              color: this.darkTheme ? 'rgb(243, 244, 246)' : undefined,\n            },\n          },\n        },\n        interaction: {\n          mode: 'index',\n          intersect: false,\n        },\n      },\n    });\n  }\n\n  repositionTooltip(e: MouseEvent) {\n    const tooltipEl = this.$$('#chartjs-tooltip');\n    if (tooltipEl && window.innerWidth >= 768) {\n      if (e.clientX > 0.66 * window.innerWidth) {\n        tooltipEl.style.right =\n          window.innerWidth - e.clientX + window.pageXOffset + 'px';\n        tooltipEl.style.left = '';\n      } else {\n        tooltipEl.style.right = '';\n        tooltipEl.style.left = e.clientX + window.pageXOffset + 'px';\n      }\n      tooltipEl.style.top = e.clientY + window.pageYOffset + 'px';\n      tooltipEl.style.opacity = '1';\n    }\n  }\n\n override connectedCallback() {\n    super.connectedCallback();\n    window.addEventListener('mousemove', this.repositionTooltip);\n  }\n\n  protected override firstUpdated(\n    _changedProperties: Map<string | number | symbol, unknown>\n  ): void {\n    if (this.metric && this.graphData) {\n      this.chart = this.regenerateChart();\n    }\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    // Ensure that the tooltip doesn't hang around when we are loading more data\n    const tooltip = document.getElementById('chartjs-tooltip');\n    if (tooltip) {\n      tooltip.style.opacity = '0';\n      tooltip.style.display = 'none';\n    }\n    window.removeEventListener('mousemove', this.repositionTooltip);\n  }\n\n  /**\n   * The current ticks' limits are set to treat iPad (regular/Mini/Pro) as a regular screen.\n   * @param {*} chart - The chart instance.\n   * @param {*} dimensions - An object containing the new dimensions *of the chart.*\n   */\n  updateWindowDimensions(chart: Chart, dimensions: any) {\n    //@ts-ignore\n    chart.options.scales.x.ticks.maxTicksLimit = dimensions.width < 720 ? 5 : 8;\n    //@ts-ignore\n    chart.options.scales.y.ticks.maxTicksLimit =\n      dimensions.height < 233 ? 3 : 8;\n  }\n\n  onClick(e: CustomEvent) {\n    const element = this.chart!.getElementsAtEventForMode(\n      e,\n      'index',\n      {\n        intersect: false,\n      },\n      false\n    )[0];\n    const date = this.chart!.data!.labels![element.index] as string;\n\n    if (this.graphData.interval === 'month') {\n      navigateToQuery(this.history, this.query, {\n        period: 'month',\n        date,\n      });\n    } else if (this.graphData.interval === 'date') {\n      navigateToQuery(this.history, this.query, {\n        period: 'day',\n        date,\n      });\n    }\n  }\n\n  pollExportReady() {\n    if (document.cookie.includes('exporting')) {\n      setTimeout(this.pollExportReady.bind(this), 1000);\n    } else {\n      this.exported = false;\n    }\n  }\n\n  downloadSpinner() {\n    this.exported = true;\n    document.cookie = 'exporting=';\n    setTimeout(this.pollExportReady.bind(this), 1000);\n  }\n\n  downloadLink() {\n    if (this.query.period !== 'realtime') {\n      if (this.exported) {\n        return html`\n          <div class=\"w-4 h-4 mx-2\">\n            <svg\n              class=\"animate-spin h-4 w-4 text-indigo-500\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n            >\n              <circle\n                class=\"opacity-25\"\n                cx=\"12\"\n                cy=\"12\"\n                r=\"10\"\n                stroke=\"currentColor\"\n                strokeWidth=\"4\"\n              ></circle>\n              <path\n                class=\"opacity-75\"\n                fill=\"currentColor\"\n                d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"\n              ></path>\n            </svg>\n          </div>\n        `;\n      } else {\n        const endpoint = `/${encodeURIComponent(\n          this.site.domain!\n        )}/export${api.serializeQuery(this.query)}`;\n        //TODO: Get export working\n        return html`\n          <a\n            hidden\n            class=\"w-4 h-4 mx-2\"\n            href=\"${endpoint}\"\n            download\n            onClick=\"{this.downloadSpinner.bind(this)}\"\n          >\n            <svg\n              style=\"max-width: 50px;max-height: 50px;\"\n              class=\"absolute text-gray-700 feather dark:text-gray-300\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n              viewBox=\"0 0 24 24\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              strokeWidth=\"2\"\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n            >\n              <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"></path>\n              <polyline points=\"7 10 12 15 17 10\"></polyline>\n              <line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"></line>\n            </svg>\n          </a>\n        `;\n      }\n    } else {\n      return nothing;\n    }\n  }\n\n  samplingNotice() {\n    const samplePercent = this.topStatData && this.topStatData.sample_percent;\n\n    if (samplePercent && samplePercent < 100) {\n      return html`\n        <div\n          tooltip=${`Stats based on a ${samplePercent}% sample of all visitors`}\n          class=\"cursor-pointer w-4 h-4 mx-2\"\n        >\n          <svg\n            class=\"absolute w-4 h-4 dark:text-gray-300 text-gray-700\"\n            xmlns=\"http://www.w3.org/2000/svg\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth=\"2\"\n              d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n            />\n          </svg>\n        </div>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n\n  importedNotice() {\n    const source = this.topStatData!.imported_source;\n\n    if (source) {\n      const withImported = this.topStatData!.with_imported;\n      const strike = withImported ? '' : ' line-through';\n      const target = url.setQuery('with_imported', (!withImported).toString());\n      const tip = withImported ? '' : 'do not ';\n\n      return html`\n        <pl-link .to=${target} class=\"w-4 h-4 mx-2\">\n          <div\n            tooltip=${`Stats ${tip}include data imported from ${source}.`}\n            class=\"cursor-pointer w-4 h-4\"\n          >\n            <svg\n              class=\"absolute dark:text-gray-300 text-gray-700\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n            >\n              <text\n                x=\"4\"\n                y=\"18\"\n                fontSize=\"24\"\n                fill=\"currentColor\"\n                class={'text-gray-700 dark:text-gray-300' + strike}\n              >\n                ${source[0].toUpperCase()}\n              </text>\n            </svg>\n          </div>\n    </pl-link>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n\n  override render() {\n    const extraClass =\n      this.graphData && this.graphData.interval === 'hour'\n        ? ''\n        : 'cursor-pointer';\n\n    return html`\n      <div class=\"w-full p-4 bg-white rounded shadow-xl dark:bg-gray-825\">\n        <div class=\"flex flex-wrap\">\n          <pl-top-stats\n            .query=${this.query}\n            .metric=${this.metric}\n            .updateMetric=${this.updateMetric!}\n            .topStatData=${this.topStatData}\n            useTopStatsFor\n            class=\"flex flex-wrap\"\n          ></pl-top-stats>\n        </div>\n        <div class=\"relative px-2\">\n          <div class=\"absolute right-4 -top-10 flex\">\n            ${this.downloadLink()}\n            ${this.samplingNotice()}\n            ${this.importedNotice()}\n          </div>\n          <canvas\n            id=\"main-graph-canvas\"\n            class=${'mt-4 select-none ' + extraClass}\n            width=\"1054\"\n            height=\"342\"\n          ></canvas>\n        </div>\n      </div>\n    `;\n  }\n}\n"]}