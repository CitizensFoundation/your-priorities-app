{"version":3,"file":"pl-prop-breakdown.js","sourceRoot":"","sources":["../../../../../src/analytics-and-promotion/pl-components/stats/conversions/pl-prop-breakdown.ts"],"names":[],"mappings":"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","sourcesContent":["import * as storage from '../../util/storage.js';\nimport '../pl-bar.js';\n\nimport { LitElement, css, html, nothing } from 'lit';\nimport { property, customElement } from 'lit/decorators.js';\n\nimport numberFormatter from '../../util/number-formatter.js';\nimport * as api from '../../api.js';\nimport * as url from '../../util/url.js';\nimport { suppressDeprecationWarnings } from 'moment';\n\nimport '../../pl-link.js';\nimport '../pl-bar.js';\nimport { PlausibleBaseElement } from '../../pl-base-element.js';\nimport { PlausibleBaseElementWithState } from '../../pl-base-element-with-state.js';\n\nconst MOBILE_UPPER_WIDTH = 767;\nconst DEFAULT_WIDTH = 1080;\n\n// https://stackoverflow.com/a/43467144\nfunction isValidHttpUrl(string: string) {\n  let url;\n\n  try {\n    url = new URL(string);\n  } catch (_) {\n    return false;\n  }\n\n  return url.protocol === 'http:' || url.protocol === 'https:';\n}\n\n@customElement('pl-prop-breakdown')\nexport class PlausiblePropBreakdown extends PlausibleBaseElementWithState {\n  @property({ type: Object })\n  onClickFunction!: any;\n\n  @property({ type: Object })\n  goal!: PlausibleGoalData;\n\n  @property({ type: String })\n  propKey!: string;\n\n  @property({ type: String })\n  storageKey!: string;\n\n  @property({ type: Boolean })\n  loading = true;\n\n  @property({ type: Number })\n  viewport = DEFAULT_WIDTH;\n\n  @property({ type: Array })\n  breakdown?: PlausiblePropValueData[] = [];\n\n  @property({ type: Number })\n  page = 1;\n\n  @property({ type: Boolean })\n  moreResultsAvailable = true;\n\n  constructor() {\n    super();\n  }\n\n  override async connectedCallback() {\n    super.connectedCallback();\n    this.propKey = this.goal.prop_names[0];\n    this.storageKey = 'goalPropTab__' + this.site.domain + this.goal.name;\n    const storedKey = storage.getItem(this.storageKey);\n    if (this.goal.prop_names.includes(storedKey!)) {\n      this.propKey = storedKey!;\n    }\n    if (this.query.filters!['props']) {\n      this.propKey = Object.keys(this.query.filters!['props'])[0];\n    }\n\n    this.handleResize = this.handleResize.bind(this);\n    window.addEventListener('resize', this.handleResize, false);\n\n    this.handleResize();\n    await this.updateComplete;\n    this.fetchPropBreakdown();\n  }\n\n  override disconnectedCallback(): void {\n    window.removeEventListener('resize', this.handleResize, false);\n  }\n\n  static override get styles() {\n    return [...super.styles];\n  }\n\n  handleResize() {\n    this.viewport = window.innerWidth;\n  }\n\n  getBarMaxWidth() {\n    return this.viewport! > MOBILE_UPPER_WIDTH ? '16rem' : '10rem';\n  }\n\n  fetchPropBreakdown() {\n    if (this.query.filters!['goal']) {\n      api\n        .get(\n          this.proxyUrl,\n          `/api/stats/${encodeURIComponent(\n            this.site.domain!\n          )}/property/${encodeURIComponent(this.propKey!)}`,\n          this.query,\n          { limit: 100, page: this.page }\n        )\n        .then(res => {\n          this.loading = false;\n          this.breakdown = this.breakdown!.concat(res);\n          this.moreResultsAvailable = res.length === 100;\n        });\n    }\n  }\n\n  loadMore() {\n    this.loading = true;\n    this.page = this.page! + 1;\n    this.fetchPropBreakdown();\n  }\n\n  renderUrl(value: PlausiblePropValueData) {\n    if (isValidHttpUrl(value.name)) {\n      return html`\n        <a\n          target=\"_blank\"\n          href=\"{value.name}\"\n          rel=\"noreferrer\"\n          class=\"hidden group-hover:block\"\n        >\n          <svg\n            class=\"inline h-4 w-4 ml-1 -mt-1 text-gray-600 dark:text-gray-400\"\n            fill=\"currentColor\"\n            viewBox=\"0 0 20 20\"\n          >\n            <path\n              d=\"M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z\"\n            ></path>\n            <path\n              d=\"M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z\"\n            ></path>\n          </svg>\n        </a>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n\n  renderPropContent(value: PlausiblePropValueData, query: URLSearchParams) {\n    return html`\n      <span\n        class=\"flex px-2 py-1.5 group dark:text-gray-300 relative z-2 break-all\"\n      >\n        <pl-link\n          .to=${{\n            pathname: window.location.pathname,\n            search: query.toString(),\n          }}\n          class=\"md:truncate hover:underline block\"\n        >\n          ${value.name}\n        </pl-link>\n        ${this.renderUrl(value)}\n      </span>\n    `;\n  }\n\n  renderPropValue(value: PlausiblePropValueData) {\n    const query = new URLSearchParams(window.location.search);\n    query.set('props', JSON.stringify({ [this.propKey!]: value.name }));\n\n    return html`\n      <div class=\"flex items-center justify-between my-2\" key=\"{value.name}\">\n        <pl-bar\n          .count=${value.unique_conversions}\n          plot=\"unique_conversions\"\n          .all=${this.breakdown}\n          bg=\"bg-red-50 dark:bg-gray-500 dark:bg-opacity-15\"\n          maxWidthDeduction=${this.getBarMaxWidth()}\n        >\n          ${this.renderPropContent(value, query)}\n        </pl-bar>\n        <div class=\"dark:text-gray-200\">\n          <span class=\"font-medium inline-block w-20 text-right\"\n            >${numberFormatter(value.unique_conversions)}</span\n          >\n          ${this.viewport && this.viewport > MOBILE_UPPER_WIDTH\n            ? html`\n                <span class=\"font-medium inline-block w-20 text-right\"\n                  >${numberFormatter(value.total_conversions)}\n                </span>\n              `\n            : null}\n          <span class=\"font-medium inline-block w-20 text-right\"\n            >${numberFormatter(value.conversion_rate)}%</span\n          >\n        </div>\n      </div>\n    `;\n  }\n\n  changePropKey(newKey: string) {\n    storage.setItem(this.storageKey, newKey);\n    this.propKey = newKey;\n    this.loading = true;\n    this.breakdown = [];\n    this.page = 1;\n    this.moreResultsAvailable = false;\n    this.fetchPropBreakdown();\n  }\n\n  renderLoading() {\n    if (this.loading) {\n      return html` <div class=\"px-4 py-2\">\n        <div class=\"loading sm mx-auto\"><div></div></div>\n      </div>`;\n    } else if (this.moreResultsAvailable) {\n      return html`\n        <div class=\"w-full text-center my-4\">\n          <button\n            @click=${this.loadMore.bind(this)}\n            type=\"button\"\n            class=\"button\"\n          >\n            Load more\n          </button>\n        </div>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n\n  renderBody() {\n    return this.breakdown!.map(propValue => this.renderPropValue(propValue));\n  }\n\n  renderPill(key: string) {\n    const isActive = this.propKey === key;\n\n    if (isActive) {\n      return html`<li\n        key=\"${key}\"\n        class=\"inline-block h-5 text-indigo-700 dark:text-indigo-500 font-bold mr-2 active-prop-heading\"\n      >\n        ${key}\n      </li>`;\n    } else {\n      return html`<li\n        key=\"${key}\"\n        class=\"hover:text-indigo-600 cursor-pointer mr-2\"\n        @click=${this.changePropKey.bind(this, key)}\n      >\n        ${key}\n      </li>`;\n    }\n  }\n\n  override render() {\n    if (this.goal && this.propKey) {\n      return html`\n        <div class=\"w-full pl-3 sm:pl-6 mt-4\">\n          <div class=\"flex-col sm:flex-row flex items-center pb-1\">\n            <span\n              class=\"text-xs font-bold text-gray-600 dark:text-gray-300 self-start sm:self-auto mb-1 sm:mb-0\"\n              >Breakdown by:</span\n            >\n            <ul\n              class=\"flex flex-wrap font-medium text-xs text-gray-500 dark:text-gray-400 leading-5 pl-1 sm:pl-2\"\n            >\n              ${this.goal.prop_names.map(this.renderPill.bind(this))}\n            </ul>\n          </div>\n          ${this.renderBody()} ${this.renderLoading()}\n        </div>\n      `;\n    } else {\n      return nothing;\n    }\n  }\n}\n"]}