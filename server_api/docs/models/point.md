# Model: Point

Represents a "Point" entity in the application, which can be a debate point, news story, or comment. Points are associated with posts, groups, communities, domains, users, and can have related media (videos, images), revisions, and quality metrics. The model includes business logic for creating comments and news stories, managing moderation, and handling associations with other entities.

---

## Properties

| Name                   | Type                | Description                                                                 |
|------------------------|---------------------|-----------------------------------------------------------------------------|
| id                     | number              | Primary key (auto-generated by Sequelize).                                  |
| name                   | string \| null      | Optional name/title of the point.                                           |
| content_type           | number              | Type of content (debate, news story, comment). See constants below.         |
| content                | string              | Main textual content of the point.                                          |
| status                 | string              | Status of the point (e.g., 'published').                                    |
| value                  | number              | Value or score associated with the point.                                   |
| website                | string \| null      | Optional website URL.                                                       |
| deleted                | boolean             | Whether the point is deleted.                                               |
| deleted_at             | Date \| null        | Timestamp when the point was deleted.                                       |
| ip_address             | string              | IP address of the creator.                                                  |
| user_agent             | string              | User agent string of the creator.                                           |
| counter_revisions      | number              | Number of revisions.                                                        |
| counter_quality_up     | number              | Number of quality upvotes.                                                  |
| counter_quality_down   | number              | Number of quality downvotes.                                                |
| counter_flags          | number              | Number of times the point has been flagged.                                 |
| embed_data             | object (JSONB)      | Embedded data (e.g., for news stories).                                     |
| data                   | object (JSONB)      | Arbitrary internal data (e.g., moderation, browser info).                   |
| public_data            | object (JSONB)      | Publicly visible data.                                                      |
| language               | string \| null      | Language code.                                                              |
| created_at             | Date                | Creation timestamp.                                                         |
| updated_at             | Date                | Last update timestamp.                                                      |

---

## Indexes

- Various indexes on `post_id`, `data`, `public_data`, `image_id`, `post_status_change_id`, `parent_point_id`, `user_id`, `group_id`, `deleted`, `status`, and combinations thereof for performance.

---

## Associations

- `belongsTo(PostStatusChange, { foreignKey: 'post_status_change_id' })`
- `belongsTo(Post, { foreignKey: 'post_id' })`
- `belongsTo(Community, { foreignKey: 'community_id' })`
- `belongsTo(Domain, { foreignKey: 'domain_id' })`
- `belongsTo(User, { foreignKey: 'user_id' })`
- `belongsTo(Image, { foreignKey: 'image_id' })`
- `belongsTo(Point, { as: 'ParentPoint', foreignKey: 'parent_point_id' })`
- `belongsTo(Group, { foreignKey: 'group_id' })`
- `hasMany(PointRevision)`
- `hasMany(PointQuality)`
- `belongsToMany(Video, { as: 'PointVideos', through: 'PointVideo' })`
- `belongsToMany(Audio, { as: 'PointAudios', through: 'PointAudio' })`

---

## Constants

| Name                  | Value | Description                |
|-----------------------|-------|----------------------------|
| CONTENT_DEBATE        | 0     | Debate point               |
| CONTENT_NEWS_STORY    | 1     | News story                 |
| CONTENT_COMMENT       | 2     | Comment                    |

---

## Static Methods

### Point.createComment

Creates a new comment point, associates it with the correct group, community, domain, and post, and triggers moderation and activity creation.

#### Parameters

| Name    | Type     | Description                                 |
|---------|----------|---------------------------------------------|
| req     | Request  | Express request object (with user info)     |
| options | object   | Comment creation options and data           |
| callback| function | Callback function (error-first)             |

#### options object

- `comment.content`: string (required) - The comment text.
- `parent_point_id`: number (optional) - If replying to another point.
- `image_id`: number (optional) - If attaching an image.
- Other grouping and context fields as needed.

#### Side Effects

- Saves the new Point and a PointRevision.
- Triggers moderation queue for toxicity estimation.
- Creates an activity log entry.

---

### Point.createNewsStory

Creates a new news story point, associates it with the correct group, community, domain, and post, and triggers moderation and activity creation.

#### Parameters

| Name    | Type     | Description                                 |
|---------|----------|---------------------------------------------|
| req     | Request  | Express request object (with user info)     |
| options | object   | News story creation options and data        |
| callback| function | Callback function (error-first, point)      |

#### options object

- `point.content`: string (required) - The news story text.
- `point.embed_data`: object (optional) - Embedded data.
- Other grouping and context fields as needed.

#### Side Effects

- Saves the new Point and a PointRevision.
- Triggers moderation queue for toxicity estimation.
- Creates an activity log entry.

---

### Point.setOrganizationUsersForPoints

Populates the `OrganizationUsers` association for the users of the given points.

#### Parameters

| Name   | Type     | Description                                 |
|--------|----------|---------------------------------------------|
| points | array    | Array of Point instances                    |
| done   | function | Callback function (error-first)             |

---

### Point.setVideosForPoints

Populates the `PointVideos` association for the given points.

#### Parameters

| Name   | Type     | Description                                 |
|--------|----------|---------------------------------------------|
| points | array    | Array of Point instances                    |
| done   | function | Callback function (error-first)             |

---

### Point.getVideosForPoints

Fetches videos associated with the given point IDs.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| pointIds | array    | Array of point IDs                          |
| done     | function | Callback function (error, videos)           |

---

### Point.addVideosToAllActivityPoints

Adds video data to the `PointVideos` property of points in a list of activities.

#### Parameters

| Name      | Type   | Description                                 |
|-----------|--------|---------------------------------------------|
| activities| array  | Array of activity objects with Point        |
| videos    | array  | Array of video objects                      |

---

## Instance Methods

### Point.prototype.setupModerationData

Initializes the moderation data structure in the `data` property if not already present.

#### Parameters

None

---

### Point.prototype.report

Reports the point for moderation, logs the report, and triggers moderation queue if needed.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| req      | Request  | Express request object (with user info)     |
| source   | string   | Source of the report (e.g., 'user')         |
| post     | object   | Associated post object                      |
| callback | function | Callback function (error-first)             |

---

## Utility Functions (Internal, Not Exported)

### findCommunityAndDomainForPointFromGroup

Finds the community and domain for a point given a group ID.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| sequelize| object   | Sequelize instance                          |
| options  | object   | Must include `group_id`                     |
| callback | function | Callback (error, options)                   |

---

### attachEmptyGroupIfNeeded

Attaches a hidden public group to the options if needed for domain/community-level points.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| sequelize| object   | Sequelize instance                          |
| options  | object   | Options object                              |
| callback | function | Callback (error, options)                   |

---

### findGroupAndCommunityAndDomainForPointFromPost

Finds group, community, and domain for a point given a post ID.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| sequelize| object   | Sequelize instance                          |
| options  | object   | Must include `post_id`                      |
| callback | function | Callback (error, options)                   |

---

### findDomainFromCommunity

Finds the domain for a given community ID.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| sequelize| object   | Sequelize instance                          |
| options  | object   | Must include `community_id`                 |
| callback | function | Callback (error, options)                   |

---

### setAllActivityGroupingIds

Populates all grouping IDs (group, community, domain) in the options object, using the above helper functions.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| sequelize| object   | Sequelize instance                          |
| options  | object   | Options object (may include post_id, group_id, community_id) |
| callback | function | Callback (error)                            |

---

## Export

This module exports a function `(sequelize, DataTypes) => Point`, which defines and returns the Point model for use with Sequelize.

---

## Example Usage

```javascript
const Point = require('./models/point.cjs')(sequelize, DataTypes);

// Creating a comment
Point.createComment(req, {
  comment: { content: "This is a comment" },
  parent_point_id: 123
}, (err) => {
  if (err) { /* handle error */ }
});

// Reporting a point
pointInstance.report(req, 'user', postInstance, (err) => {
  if (err) { /* handle error */ }
});
```

---

## See Also

- [Group](./Group.md)
- [Community](./Community.md)
- [Domain](./Domain.md)
- [User](./User.md)
- [Image](./Image.md)
- [Post](./Post.md)
- [PointRevision](./PointRevision.md)
- [PointQuality](./PointQuality.md)
- [Video](./Video.md)
- [Audio](./Audio.md)
- [AcActivity](./AcActivity.md)
- [Organization](./Organization.md)
- [Logger Utility](../utils/logger.md)
- [Queue Service](../services/workers/queue.md)

---

## Notes

- The model uses Sequelize's `defaultScope` to only return non-deleted, published points by default.
- Moderation and activity logging are tightly integrated with point creation and reporting.
- Several methods are marked as TODO for refactoring due to code duplication with the Post model.
- The model is designed for extensibility and integration with a rich set of related entities.