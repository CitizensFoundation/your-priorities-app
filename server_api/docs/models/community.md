# Model: Community

Represents a community within the application, including its configuration, access level, counters, and relationships to other entities such as users, groups, images, and videos. This model is defined using Sequelize and includes both static and instance methods for business logic and utility operations.

---

## Properties

| Name                           | Type                | Description                                                                                 |
|--------------------------------|---------------------|---------------------------------------------------------------------------------------------|
| id                             | number              | Primary key (auto-generated by Sequelize).                                                  |
| name                           | string              | Name of the community.                                                                      |
| hostname                       | string              | Hostname associated with the community.                                                     |
| access                         | number              | Access level: 0 (public), 1 (closed), 2 (secret).                                           |
| deleted                        | boolean             | Whether the community is deleted. Default: `false`.                                         |
| default_locale                 | string              | Default locale for the community.                                                           |
| google_analytics_code          | string              | Google Analytics code. Optional.                                                            |
| description                    | string (TEXT)       | Description of the community.                                                               |
| website                        | string (TEXT)       | Website URL of the community.                                                               |
| is_community_folder            | boolean             | Whether this is a community folder. Default: `false`.                                       |
| in_community_folder_id         | number              | ID of the parent community folder, if any.                                                  |
| ip_address                     | string              | IP address at creation.                                                                     |
| user_agent                     | string (TEXT)       | User agent at creation.                                                                     |
| weight                         | number              | Weight for ordering or ranking. Default: `0`.                                               |
| status                         | string              | Status of the community. Default: `'active'`.                                               |
| counter_posts                  | number              | Number of posts in the community. Default: `0`.                                             |
| counter_points                 | number              | Number of points in the community. Default: `0`.                                            |
| counter_groups                 | number              | Number of groups in the community. Default: `0`.                                            |
| counter_users                  | number              | Number of users in the community. Default: `0`.                                             |
| counter_organizations          | number              | Number of organizations in the community. Default: `0`.                                     |
| counter_flags                  | number              | Number of flags (reports) in the community. Default: `0`.                                   |
| only_admins_can_create_groups  | boolean             | If true, only admins can create groups. Default: `false`.                                   |
| theme_id                       | number              | ID of the theme used by the community.                                                      |
| other_social_media_info        | object (JSONB)      | Additional social media information.                                                        |
| configuration                  | object (JSONB)      | Arbitrary configuration for the community.                                                  |
| language                       | string              | Language code. Optional.                                                                    |
| data                           | object (JSONB)      | Arbitrary data, including moderation info.                                                  |
| created_at                     | Date                | Timestamp of creation.                                                                      |
| updated_at                     | Date                | Timestamp of last update.                                                                   |

---

## Indexes

Multiple indexes are defined for performance on queries involving `deleted`, `domain_id`, `in_community_folder_id`, `status`, `access`, and `hostname`.

---

## Associations

| Association Type         | Target Model         | Alias/Through                | Description                                               |
|-------------------------|----------------------|------------------------------|-----------------------------------------------------------|
| hasMany                 | Group                |                              | Community has many groups.                                |
| hasMany                 | Community            | as: 'CommunityFolders'       | Community has many sub-communities (folders).             |
| belongsTo               | Community            | as: 'CommunityFolder'        | Community belongs to a parent community folder.           |
| belongsTo               | Domain               |                              | Community belongs to a domain.                            |
| belongsTo               | User                 |                              | Community belongs to a user (creator/owner).              |
| belongsToMany           | Video                | as: 'CommunityLogoVideos', through: 'CommunityLogoVideo' | Community has many logo videos.                           |
| belongsToMany           | Image                | as: 'CommunityLogoImages', through: 'CommunityLogoImage' | Community has many logo images.                           |
| belongsToMany           | Image                | as: 'CommunityHeaderImages', through: 'CommunityHeaderImage' | Community has many header images.                     |
| belongsToMany           | User                 | as: 'CommunityUsers', through: 'CommunityUser'           | Community has many users.                                 |
| belongsToMany           | User                 | as: 'CommunityAdmins', through: 'CommunityAdmin'         | Community has many admins.                                |
| belongsToMany           | User                 | as: 'CommunityPromoters', through: 'CommunityPromoter'   | Community has many promoters.                             |
| hasMany                 | Campaign             |                              | Community has many campaigns.                             |

---

## Exported Constants

| Name                  | Type   | Value | Description                                 |
|-----------------------|--------|-------|---------------------------------------------|
| ACCESS_PUBLIC         | number | 0     | Public access level.                        |
| ACCESS_CLOSED         | number | 1     | Closed access level.                        |
| ACCESS_SECRET         | number | 2     | Secret access level.                        |
| defaultAttributesPublic | string[] | See code | Default attributes for public API responses. |

---

## Static Methods

### Community.setYpCommunity

Middleware to set `req.ypCommunity` based on the request's hostname or `communityHostname` param.

#### Parameters

| Name | Type     | Description                        |
|------|----------|------------------------------------|
| req  | Request  | Express request object             |
| res  | Response | Express response object            |
| next | Function | Express next middleware function   |

#### Description

- Parses the hostname from the request.
- Looks up the community by hostname.
- Sets `req.ypCommunity` to the found community or a placeholder if not found.
- Calls `next()`.

---

### Community.convertAccessFromRadioButtons

Converts form radio button values to the numeric access level.

#### Parameters

| Name | Type   | Description                |
|------|--------|----------------------------|
| body | object | Request body (form data)   |

#### Returns

| Type   | Description                |
|--------|----------------------------|
| number | Access level (0, 1, or 2)  |

---

### Community.addVideosToCommunity

Adds logo videos to the community's data values.

#### Parameters

| Name      | Type     | Description                        |
|-----------|----------|------------------------------------|
| community | Community| The community instance             |
| done      | Function | Callback function (err?)           |

#### Description

- Finds all videos associated with the community as logo videos.
- Orders them by creation date.
- Attaches them to `community.dataValues.CommunityLogoVideos`.

---

## Instance Methods

### community.simple()

Returns a simplified object with only id, name, and hostname.

#### Returns

| Type   | Description                |
|--------|----------------------------|
| object | `{ id, name, hostname }`   |

---

### community.updateAllExternalCounters(req, direction, column, done)

Updates a counter column on the associated domain.

#### Parameters

| Name      | Type     | Description                        |
|-----------|----------|------------------------------------|
| req       | Request  | Express request object             |
| direction | string   | 'up' or 'down'                     |
| column    | string   | Column name to increment/decrement  |
| done      | Function | Callback function                  |

---

### community.setupLogoImage(body, done)

Associates a logo image with the community if `uploadedLogoImageId` is present in the body.

#### Parameters

| Name | Type   | Description                |
|------|--------|----------------------------|
| body | object | Request body               |
| done | Function | Callback function        |

---

### community.setupHeaderImage(body, done)

Associates a header image with the community if `uploadedHeaderImageId` is present in the body.

#### Parameters

| Name | Type   | Description                |
|------|--------|----------------------------|
| body | object | Request body               |
| done | Function | Callback function        |

---

### community.getImageFormatUrl(formatId)

Returns the URL for a specific image format from the community's logo images.

#### Parameters

| Name     | Type   | Description                |
|----------|--------|----------------------------|
| formatId | number | Index of the format        |

#### Returns

| Type   | Description                |
|--------|----------------------------|
| string | URL or empty string        |

---

### community.setupImages(body, done)

Sets up both logo and header images, and deletes header image if requested.

#### Parameters

| Name | Type   | Description                |
|------|--------|----------------------------|
| body | object | Request body               |
| done | Function | Callback function        |

---

### community.setupModerationData()

Initializes moderation data in the `data` property if not already present.

---

### community.report(req, source, callback)

Handles reporting (flagging) the community for moderation.

#### Parameters

| Name     | Type     | Description                        |
|----------|----------|------------------------------------|
| req      | Request  | Express request object             |
| source   | string   | Source of the report ('user', etc.)|
| callback | Function | Callback function (err?)           |

#### Description

- Initializes moderation data if needed.
- Adds a report entry to `data.moderation.lastReportedBy`.
- Optionally triggers toxicity estimation.
- Increments the `counter_flags` column.

---

## Example Usage

```javascript
const { Community } = require('./models/community.cjs');

// Find a community and use an instance method
Community.findByPk(1).then(community => {
  console.log(community.simple());
});
```

---

## Related Utility Modules

- [logger.cjs](../utils/logger.cjs.md)
- [to_json.cjs](../utils/to_json.cjs.md)
- [parse_domain.cjs](../utils/parse_domain.cjs.md)
- [queue.cjs](../services/workers/queue.cjs.md)

---

## Notes

- The model uses `underscored: true` and custom timestamp fields (`created_at`, `updated_at`).
- The `defaultScope` excludes deleted communities by default.
- The model is designed for extensibility and includes several hooks for image and moderation management.

---

For more details on associated models, see:
- [Group](./Group.md)
- [Domain](./Domain.md)
- [User](./User.md)
- [Video](./Video.md)
- [Image](./Image.md)
- [Campaign](./Campaign.md)
