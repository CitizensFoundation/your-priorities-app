# Model: Video

The `Video` model represents a video entity in the application, including its metadata, associations with other models (such as User, Post, Group, etc.), and a comprehensive set of static and instance methods for handling video upload, transcoding, thumbnail generation, and collection management.

This model is defined using Sequelize and includes both schema definitions and business logic for video processing, storage, and association with other entities.

---

## Properties

| Name         | Type      | Description                                                                 |
|--------------|-----------|-----------------------------------------------------------------------------|
| id           | number    | Primary key (auto-generated by Sequelize).                                  |
| name         | string    | Name/title of the video.                                                    |
| description  | string    | Description of the video.                                                   |
| meta         | object    | JSONB. Internal metadata (e.g., fileKey, bucket info, transcoding info).    |
| public_meta  | object    | JSONB. Public metadata (e.g., aspect, isZiggeo).                            |
| formats      | object    | JSONB. Array of available video format URLs.                                |
| views        | bigint    | Number of times the video has been viewed.                                  |
| long_views   | bigint    | Number of long views (custom metric).                                       |
| user_id      | number    | Foreign key to the User who uploaded the video.                             |
| viewable     | boolean   | Whether the video is viewable by others.                                    |
| ip_address   | string    | IP address of the uploader.                                                 |
| user_agent   | string    | User agent string of the uploader.                                          |
| deleted      | boolean   | Soft-delete flag.                                                           |
| created_at   | Date      | Timestamp when the video was created.                                       |
| updated_at   | Date      | Timestamp when the video was last updated.                                  |

---

## Indexes

- GIN indexes on `meta`, `public_meta`, and `formats` for efficient JSONB querying.
- Indexes on `deleted`, `user_id`, `viewable`, `id`, `updated_at`, and `created_at` for performance.

---

## Associations

- **BelongsTo:** [User](./User.md)
- **BelongsToMany:** [Post](./Post.md) (as `PostVideos`), [Image](./Image.md) (as `VideoImages`), [Point](./Point.md) (as `PointVideos`), [User](./User.md) (as `UserProfileVideos`), [Community](./Community.md) (as `CommunityLogoVideos`), [Group](./Group.md) (as `GroupLogoVideos`, `GroupHtmlVideos`), [Domain](./Domain.md) (as `DomainLogoVideos`)

---

## Static Methods

### Video.defaultAttributesPublic

- **Type:** `string[]`
- **Description:** Default public attributes to expose: `["id", "updated_at", "formats"]`.

---

### Video.getRandomFileKey(id: number): string

Generates a random file key for a video file.

| Name | Type   | Description         |
|------|--------|---------------------|
| id   | number | Video ID            |

**Returns:** `string` (e.g., `abc1234_video42.mp4`)

---

### Video.getFullUrl(meta: object): string

Constructs the full public URL for a video file based on its metadata and environment.

| Name | Type   | Description         |
|------|--------|---------------------|
| meta | object | Video metadata      |

**Returns:** `string` (Full URL to the video file)

---

### Video.getThumbnailUrl(video: Video, number: number): string

Generates the URL for a specific video thumbnail.

| Name   | Type   | Description         |
|--------|--------|---------------------|
| video  | Video  | Video instance      |
| number | number | Thumbnail number    |

**Returns:** `string` (URL to the thumbnail image)

---

### Video.createAndGetSignedUploadUrl(req, res)

Creates a new video record and returns a pre-signed S3 upload URL.

| Name | Type     | Description                |
|------|----------|----------------------------|
| req  | Request  | Express request object     |
| res  | Response | Express response object    |

**Response:**
- `200 OK` with `{ presignedUrl, videoId }`
- `500 Internal Server Error` on failure

---

### Video.addToPost(video, options, callback)

Associates a video with a post and optionally triggers a voice-to-text job.

| Name    | Type     | Description                        |
|---------|----------|------------------------------------|
| video   | Video    | Video instance                     |
| options | object   | `{ postId, browserLanguage, appLanguage }` |
| callback| function | Callback function                  |

---

### Video.addToDomain(video, id, callback)

Associates a video with a domain.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| id       | number   | Domain ID             |
| callback | function | Callback function     |

---

### Video.addToCommunity(video, id, callback)

Associates a video with a community.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| id       | number   | Community ID          |
| callback | function | Callback function     |

---

### Video.addToGroup(video, id, callback)

Associates a video with a group.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| id       | number   | Group ID              |
| callback | function | Callback function     |

---

### Video.addToCollection(video, options, callback)

Adds a video to the appropriate collection (post, group, community, or domain) based on options.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| options  | object   | Collection options    |
| callback | function | Callback function     |

---

### Video.setupThumbnailsAfterTranscoding(video, duration, req, callback)

Creates thumbnail images after video transcoding.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| duration | number   | Video duration (sec)  |
| req      | Request  | Express request object|
| callback | function | Callback function     |

---

### Video.getTranscodingJobStatus(video, req, res)

Checks the status of a video transcoding job (AWS or YRPRI encoder).

| Name | Type     | Description                |
|------|----------|----------------------------|
| video| Video    | Video instance             |
| req  | Request  | Express request object     |
| res  | Response | Express response object    |

---

### Video.startTranscoding(video, options, req, res)

Starts the transcoding process for a video.

| Name    | Type     | Description                |
|---------|----------|----------------------------|
| video   | Video    | Video instance             |
| options | object   | Transcoding options        |
| req     | Request  | Express request object     |
| res     | Response | Express response object    |

---

### Video.completeUploadAndAddToPoint(req, res, options, callback)

Completes the upload process and associates the video with a point.

| Name    | Type     | Description                |
|---------|----------|----------------------------|
| req     | Request  | Express request object     |
| res     | Response | Express response object    |
| options | object   | `{ videoId, pointId }`     |
| callback| function | Callback function          |

---

### Video.addZiggeoVideoToContainer(req, video): Promise<void>

Adds a Ziggeo video to the appropriate container (group, community, domain, post, or point).

| Name  | Type   | Description         |
|-------|--------|---------------------|
| req   | Request| Express request     |
| video | Video  | Video instance      |

**Returns:** `Promise<void>`

---

### Video.addZiggeoVideo(req, res): Promise<void>

Creates a Ziggeo video and adds it to the appropriate container.

| Name | Type     | Description                |
|------|----------|----------------------------|
| req  | Request  | Express request object     |
| res  | Response | Express response object    |

**Returns:** `Promise<void>`

---

### Video.removeVideoFromCollection(req, res, options): Promise<void>

Removes a video from a collection (group, community, domain, post, or point) and deletes associated media.

| Name    | Type     | Description                |
|---------|----------|----------------------------|
| req     | Request  | Express request object     |
| res     | Response | Express response object    |
| options | object   | Removal options            |

**Returns:** `Promise<void>`

---

### Video.completeUploadAndAddToCollection(req, res, options): Promise<void>

Completes the upload and adds the video to the specified collection.

| Name    | Type     | Description                |
|---------|----------|----------------------------|
| req     | Request  | Express request object     |
| res     | Response | Express response object    |
| options | object   | Collection options         |

**Returns:** `Promise<void>`

---

### Video.startTranscodingJob(video, callback)

Starts a transcoding job for the video (AWS or YRPRI encoder).

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| callback | function | Callback function     |

---

### Video.startYrpriEncoderTranscodingJob(video, callback)

Starts a transcoding job using the Your Priorities encoder.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| video    | Video    | Video instance        |
| callback | function | Callback function     |

---

### Video.getYrpriEncoderTranscodingJobStatus(video, req, res)

Checks the status of a YRPRI encoder transcoding job.

| Name | Type     | Description                |
|------|----------|----------------------------|
| video| Video    | Video instance             |
| req  | Request  | Express request object     |
| res  | Response | Express response object    |

---

## Instance Methods

### video.createFormats(video)

Populates the `formats` array with the full URL of the video.

| Name  | Type   | Description         |
|-------|--------|---------------------|
| video | Video  | Video instance      |

---

### video.getPreSignedUploadUrl(options, callback)

Generates a pre-signed S3 upload URL for the video and updates its metadata.

| Name     | Type     | Description           |
|----------|----------|-----------------------|
| options  | object   | Options (e.g., maxDuration) |
| callback | function | Callback function     |

---

## Configuration

- **Table Name:** `videos`
- **Timestamps:** `created_at`, `updated_at`
- **Underscored:** true
- **Default Scope:** Only non-deleted videos, ordered by creation date ascending.

---

## Export

The module exports a function `(sequelize, DataTypes) => Video`, which defines and returns the Video model.

---

## Related Modules

- [logger.cjs](../utils/logger.cjs) - Logging utility.
- [queue.cjs](../services/workers/queue.cjs) - Job queue for background processing.
- [CollectionImageGenerator](../services/llms/imageGeneration/collectionImageGenerator.js) - For deleting media formats.

---

## Example Usage

```javascript
const { Video } = require('./models/video.cjs');

// Creating a new video and getting a signed upload URL
Video.createAndGetSignedUploadUrl(req, res);

// Adding a video to a post
Video.addToPost(videoInstance, { postId: 123 }, callback);

// Starting transcoding
Video.startTranscoding(videoInstance, options, req, res);
```

---

## Notes

- The model supports both AWS Elastic Transcoder and a custom "Your Priorities" encoder for video processing.
- Handles both standard and Ziggeo video uploads.
- Includes robust error handling and logging for all major operations.
- Uses environment variables for configuration of S3, MinIO, Redis, and transcoding services.

---

## See Also

- [User](./User.md)
- [Post](./Post.md)
- [Group](./Group.md)
- [Community](./Community.md)
- [Domain](./Domain.md)
- [Image](./Image.md)
- [Point](./Point.md)
- [queue.cjs](../services/workers/queue.cjs)
- [logger.cjs](../utils/logger.cjs)
- [CollectionImageGenerator](../services/llms/imageGeneration/collectionImageGenerator.js)
