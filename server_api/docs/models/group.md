# Model: Group

Represents a "Group" entity in the application, typically used for organizing users, posts, and related resources within a community. This Sequelize model includes a rich set of attributes, associations, and utility methods for managing group membership, media, counters, and moderation.

---

## Properties

| Name                         | Type                | Description                                                                                 |
|------------------------------|---------------------|---------------------------------------------------------------------------------------------|
| id                           | number              | Primary key (auto-generated by Sequelize).                                                  |
| name                         | string              | Name of the group. Required.                                                                |
| access                       | number              | Access level (see constants below). Required.                                               |
| deleted                      | boolean             | Whether the group is deleted. Default: `false`.                                             |
| google_analytics_code        | string \| null      | Google Analytics code for the group.                                                        |
| objectives                   | string              | Objectives of the group.                                                                    |
| message_for_new_idea         | string              | Message shown when a new idea is created.                                                   |
| message_to_users             | string              | Message to users in the group.                                                              |
| is_group_folder              | boolean             | Whether this group is a folder for other groups. Default: `false`.                          |
| in_group_folder_id           | number \| null      | ID of the parent group folder, if any.                                                      |
| weight                       | number              | Weight for ordering or prioritization. Default: `0`.                                        |
| status                       | string              | Status of the group. Default: `"active"`.                                                   |
| counter_posts                | number              | Number of posts in the group. Default: `0`.                                                 |
| counter_points               | number              | Number of points in the group. Default: `0`.                                                |
| counter_users                | number              | Number of users in the group. Default: `0`.                                                 |
| counter_flags                | number              | Number of flags (e.g., reports) for the group. Default: `0`.                                |
| theme_id                     | number \| null      | Theme ID associated with the group.                                                         |
| configuration                | object (JSONB)      | Arbitrary configuration for the group.                                                      |
| private_access_configuration | object (JSONB)\|null| Private access configuration.                                                               |
| language                     | string \| null      | Language code for the group.                                                                |
| data                         | object (JSONB)      | Additional data, including moderation info.                                                 |
| created_at                   | Date                | Timestamp when the group was created.                                                       |
| updated_at                   | Date                | Timestamp when the group was last updated.                                                  |

---

## Indexes

Multiple indexes are defined for performance, including on `name`, `id`, `deleted`, `counter_users`, and various combinations of `community_id`, `deleted`, `in_group_folder_id`, `status`, `access`, etc. Some indexes use GIN for JSONB fields.

---

## Associations

| Association Type         | Target Model         | Foreign Key / Through Table      | Alias (as)           | Description                                 |
|-------------------------|----------------------|----------------------------------|----------------------|---------------------------------------------|
| hasMany                 | Post                 | group_id                         |                      | Posts belonging to the group                |
| hasMany                 | Point                | group_id                         |                      | Points belonging to the group               |
| hasMany                 | Endorsement          | group_id                         |                      | Endorsements in the group                   |
| hasMany                 | Category             | group_id                         |                      | Categories in the group                     |
| belongsTo               | Community            | community_id                     |                      | The community this group belongs to         |
| belongsTo               | IsoCountry           | iso_country_id                   |                      | The country this group is associated with   |
| belongsTo               | User                 | user_id                          |                      | The user who created/owns the group         |
| hasMany                 | Group                | in_group_folder_id               | GroupFolders         | Groups inside this group folder             |
| belongsTo               | Group                | in_group_folder_id               | GroupFolder          | The parent group folder                     |
| belongsToMany           | Image                | GroupImage                       |                      | Images associated with the group            |
| belongsToMany           | Video                | GroupLogoVideo                   | GroupLogoVideos      | Logo videos for the group                   |
| belongsToMany           | Image                | GroupLogoImage                   | GroupLogoImages      | Logo images for the group                   |
| belongsToMany           | Video                | GroupHtmlVideo                   | GroupHtmlVideos      | HTML videos for the group                   |
| belongsToMany           | Image                | GroupHtmlImage                   | GroupHtmlImages      | HTML images for the group                   |
| belongsToMany           | Image                | GroupHeaderImage                 | GroupHeaderImages    | Header images for the group                 |
| belongsToMany           | User                 | GroupUser                        | GroupUsers           | Users in the group                          |
| belongsToMany           | User                 | GroupAdmin                       | GroupAdmins          | Admin users in the group                    |
| belongsToMany           | User                 | GroupPromoter                    | GroupPromoters       | Promoter users in the group                 |
| hasMany                 | Campaign             |                                  |                      | Campaigns associated with the group         |

---

## Exported Constants

| Name                      | Value | Description                                 |
|---------------------------|-------|---------------------------------------------|
| ACCESS_PUBLIC             | 0     | Public group                                |
| ACCESS_CLOSED             | 1     | Closed group                                |
| ACCESS_SECRET             | 2     | Secret group                                |
| ACCESS_OPEN_TO_COMMUNITY  | 3     | Open to community group                     |
| defaultAttributesPublic   | Array | List of public attributes for serialization |

---

## Static Methods

### Group.masterGroupIncludes(models)
Returns an array of Sequelize include definitions for eager loading related models when querying a "master" group.

#### Parameters

| Name   | Type   | Description                |
|--------|--------|----------------------------|
| models | object | Sequelize models registry  |

#### Returns

- `Array<object>`: Array of include definitions for use in Sequelize queries.

---

### Group.addVideosAndCommunityLinksToGroups(groups, done)
Adds video and community link data to an array of group instances. Used to enrich group data with related videos and linked communities.

#### Parameters

| Name   | Type     | Description                                 |
|--------|----------|---------------------------------------------|
| groups | Array    | Array of group instances                    |
| done   | function | Callback function `(error) => void`         |

---

### Group.addUserToGroupIfNeeded(groupId, req, done)
Ensures the user is a member of the group, its community, and its domain. Increments counters as needed.

#### Parameters

| Name    | Type     | Description                                 |
|---------|----------|---------------------------------------------|
| groupId | number   | ID of the group                             |
| req     | Request  | Express request object (with `user` field)  |
| done    | function | Callback function `(error) => void`         |

---

### Group.convertAccessFromRadioButtons(body)
Converts a request body with radio button fields into a numeric access level.

#### Parameters

| Name | Type   | Description                        |
|------|--------|------------------------------------|
| body | object | Request body with access booleans   |

#### Returns

- `number`: Access level (0-3).

---

## Instance Methods

### group.simple()
Returns a simplified object with just the group's `id` and `name`.

#### Returns

- `{ id: number, name: string }`

---

### group.updateAllExternalCounters(req, direction, column, done)
Updates counters in related Community and Domain models, and triggers a recount job for group folders if needed.

#### Parameters

| Name      | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| req       | Request  | Express request object                      |
| direction | string   | "up" or "down"                              |
| column    | string   | Name of the counter column to update        |
| done      | function | Callback function `(error) => void`         |

---

### group.setupLogoImage(req, done)
Associates a logo image with the group if `uploadedLogoImageId` is present in the request body.

#### Parameters

| Name | Type     | Description                                 |
|------|----------|---------------------------------------------|
| req  | Request  | Express request object                      |
| done | function | Callback function `(error) => void`         |

---

### group.setupHeaderImage(req, done)
Associates a header image with the group if `uploadedHeaderImageId` is present in the request body.

#### Parameters

| Name | Type     | Description                                 |
|------|----------|---------------------------------------------|
| req  | Request  | Express request object                      |
| done | function | Callback function `(error) => void`         |

---

### group.setupHtmlMedia(req, groupId, done)
Associates HTML media (images/videos) with the group based on `staticHtml` in the request body.

#### Parameters

| Name    | Type     | Description                                 |
|---------|----------|---------------------------------------------|
| req     | Request  | Express request object                      |
| groupId | number   | ID of the group                             |
| done    | function | Callback function `(error) => void`         |

---

### group.getImageFormatUrl(formatId)
Returns the URL for a specific image format from the group's logo images.

#### Parameters

| Name     | Type   | Description                                 |
|----------|--------|---------------------------------------------|
| formatId | string | Format identifier (e.g., "thumbnail")       |

#### Returns

- `string`: URL of the image format, or empty string if not found.

---

### group.setupImages(req, groupId, done)
Runs all image setup methods in parallel: logo, header, and HTML media.

#### Parameters

| Name    | Type     | Description                                 |
|---------|----------|---------------------------------------------|
| req     | Request  | Express request object                      |
| groupId | number   | ID of the group                             |
| done    | function | Callback function `(error) => void`         |

---

### group.setupModerationData()
Initializes the moderation data structure in the group's `data` field if not already present.

---

### group.report(req, source, callback)
Handles reporting (flagging) the group for moderation, updates moderation data, and triggers toxicity estimation if needed.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| req      | Request  | Express request object                      |
| source   | string   | Source of the report (e.g., "user")         |
| callback | function | Callback function `(error) => void`         |

---

## Example Usage

```javascript
// Creating a new group
const group = await models.Group.create({
  name: "My Group",
  access: models.Group.ACCESS_PUBLIC,
  // ...other fields
});

// Adding a user to a group if needed
models.Group.addUserToGroupIfNeeded(group.id, req, (err) => {
  if (err) { /* handle error */ }
});

// Setting up images for a group
group.setupImages(req, group.id, (err) => {
  if (err) { /* handle error */ }
});
```

---

## Related Models

- [Community](./Community.md)
- [User](./User.md)
- [Image](./Image.md)
- [Video](./Video.md)
- [Category](./Category.md)
- [Post](./Post.md)
- [Point](./Point.md)
- [Endorsement](./Endorsement.md)
- [Campaign](./Campaign.md)
- [IsoCountry](./IsoCountry.md)

---

## Utility Modules Used

- [async](https://caolan.github.io/async/)
- [lodash](https://lodash.com/)
- [queue](../services/workers/queue.cjs)
- [log](../utils/logger.cjs)

---

## Notes

- The model uses Sequelize's `defaultScope` to exclude deleted groups by default.
- Many-to-many and one-to-many relationships are used extensively for flexible group organization.
- Several utility and helper methods are provided for managing group membership, media, and moderation.
- The model is designed for extensibility and integration with a rich set of related resources.

---