# Model: User

The `User` model defines the schema and business logic for user accounts in the application. It is implemented as a Sequelize model and includes a wide range of fields for user profile, authentication, social media integration, and various settings. The model also provides static and instance methods for authentication, SAML/OIDC/social login serialization, and profile management.

---

## Properties

| Name                        | Type                | Description                                                                 |
|-----------------------------|---------------------|-----------------------------------------------------------------------------|
| id                          | INTEGER (auto)      | Primary key (auto-generated by Sequelize).                                  |
| name                        | string              | User's full name. Required.                                                 |
| email                       | string              | User's email address. Unique.                                               |
| status                      | string              | User's status (e.g., 'active'). Required.                                   |
| ssn                         | string              | Social security number or similar identifier.                               |
| age_group                   | string              | User's age group.                                                           |
| post_code                   | string              | Postal code.                                                                |
| my_gender                   | string              | User's gender.                                                              |
| description                 | string (TEXT)       | User's profile description.                                                 |
| profile_data                | object (JSONB)      | Public profile data (arbitrary JSON).                                       |
| private_profile_data        | object (JSONB)      | Private profile data (arbitrary JSON).                                      |
| deleted                     | boolean             | Soft-delete flag. Default: `false`.                                         |
| facebook_id                 | bigint              | Facebook user ID.                                                           |
| facebook_profile            | object (JSONB)      | Facebook profile data.                                                      |
| twitter_id                  | bigint              | Twitter user ID.                                                            |
| twitter_profile             | object (JSONB)      | Twitter profile data.                                                       |
| google_id                   | bigint              | Google user ID.                                                             |
| google_profile              | object (JSONB)      | Google profile data.                                                        |
| github_id                   | bigint              | GitHub user ID.                                                             |
| github_profile              | object (JSONB)      | GitHub profile data.                                                        |
| buddy_icon_file_name        | string              | File name for user's buddy icon.                                            |
| twitter_profile_image_url   | string              | Twitter profile image URL.                                                  |
| encrypted_password          | string              | Hashed password.                                                            |
| default_locale              | string              | User's preferred locale.                                                    |
| reset_password_token        | string              | Token for password reset.                                                   |
| reset_password_expires      | Date                | Expiry date for password reset token.                                       |
| notifications_settings      | object (JSONB)      | Notification settings.                                                      |
| interaction_profile         | object (JSONB)      | User's interaction profile.                                                 |
| counter_login               | integer             | Number of logins. Default: `0`.                                             |
| last_login_at               | Date                | Timestamp of last login.                                                    |
| social_points               | integer             | Social points (gamification, etc.).                                         |
| legacy_user_id              | integer             | Legacy system user ID.                                                      |
| legacy_new_domain_id        | integer             | Legacy system domain ID.                                                    |
| theme_id                    | integer             | Theme ID. Default: `null`.                                                  |
| legacy_passwords_disabled   | boolean             | If true, disables legacy password support. Default: `false`.                |
| privacy_settings            | object (JSONB)      | Privacy settings.                                                           |
| ignore_list                 | object (JSONB)      | List of ignored users or entities.                                          |
| created_at                  | Date                | Timestamp of creation.                                                      |
| updated_at                  | Date                | Timestamp of last update.                                                   |

---

## Configuration

- **underscored**: `true` (snake_case DB columns)
- **timestamps**: `true` (`created_at`, `updated_at`)
- **tableName**: `'users'`
- **defaultScope**: Only non-deleted, active users
- **indexes**: Several, including unique on `email`, and GIN indexes for JSONB fields

---

## Associations

| Association Type | Target Model         | Alias/Through Table         | Description                                 |
|------------------|---------------------|-----------------------------|---------------------------------------------|
| hasMany          | Post                |                             | User's posts                                |
| hasMany          | Point               |                             | User's points                               |
| hasMany          | Endorsement         |                             | User's endorsements                         |
| hasMany          | PointQuality        |                             | User's point qualities                      |
| hasMany          | UserLegacyPassword  |                             | User's legacy passwords                     |
| belongsToMany    | Group               | GroupUser                   | Membership in groups                        |
| belongsToMany    | Community           | CommunityUser               | Membership in communities                   |
| belongsToMany    | Domain              | DomainUser                  | Membership in domains                       |
| belongsToMany    | Image               | UserProfileImage            | Profile images                              |
| belongsToMany    | Image               | UserHeaderImage             | Header images                               |
| belongsToMany    | Domain              | DomainAdmin                 | Domain admin roles                          |
| belongsToMany    | Community           | CommunityAdmin              | Community admin roles                       |
| belongsToMany    | Community           | CommunityPromoter           | Community promoter roles                    |
| belongsToMany    | Group               | GroupAdmin                  | Group admin roles                           |
| belongsToMany    | Group               | GroupPromoter               | Group promoter roles                        |
| belongsToMany    | Organization        | OrganizationAdmin           | Organization admin roles                    |
| belongsToMany    | Organization        | OrganizationUser            | Organization user roles                     |
| belongsToMany    | Video               | UserProfileVideo            | Profile videos                              |
| hasMany          | Campaign            |                             | User's campaigns                            |

---

## Exported Constants

| Name                                    | Type      | Description                                                      |
|------------------------------------------|-----------|------------------------------------------------------------------|
| defaultAttributesWithSocialMedia         | string[]  | Default attributes for user with social media info (private)      |
| defaultAttributesWithSocialMediaPublic   | string[]  | Default attributes for user with social media info (public)       |
| defaultAttributesWithSocialMediaPublicAndEmail | string[] | Default attributes for user with social media info and email      |

---

## Static Methods

### User.serializeSamlUser(profile, req, callback)
Serializes a SAML user profile into a User instance, delegating to the correct handler based on the SAML profile.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| profile  | object   | SAML profile object                         |
| req      | Request  | Express request object                      |
| callback | function | Callback function (err, user)               |

---

### User.serializeMyNJSamlUser(profile, req, callback)
Handles serialization of MyNJ SAML users, including user lookup and creation.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| profile  | object   | SAML profile object                         |
| req      | Request  | Express request object                      |
| callback | function | Callback function (err, user)               |

---

### User.serializeIslandIsSamlUser(profile, callback)
Handles serialization of Island.is SAML users, including user lookup and creation.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| profile  | object   | SAML profile object                         |
| callback | function | Callback function (err, user)               |

---

### User.serializeOidcUser(profile, req, callback)
Handles serialization of OIDC users, including user lookup and creation.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| profile  | object   | OIDC profile object                         |
| req      | Request  | Express request object                      |
| callback | function | Callback function (err, user)               |

---

### User.serializeFacebookUser(profile, domain, callback)
Handles serialization of Facebook users, including user lookup and creation.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| profile  | object   | Facebook profile object                     |
| domain   | object   | Domain object                               |
| callback | function | Callback function (err, user)               |

---

### User.localCallback(req, email, password, done)
Passport.js local strategy callback for authenticating users with email and password.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| req      | Request  | Express request object                      |
| email    | string   | User's email                                |
| password | string   | User's password                             |
| done     | function | Passport callback (err, user, info)         |

---

### User.getUserWithAll(userId, callback)
Fetches a user and their endorsements and point qualities.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| userId   | number   | User ID                                     |
| callback | function | Callback function (err, user)               |

---

## Instance Methods

### user.simple()
Returns a simplified user object with only id, name, and email.

#### Returns

| Type   | Description                |
|--------|----------------------------|
| object | `{ id, name, email }`      |

---

### user.setLocale(i18n, domain, community, done)
Sets the language/locale for the user, falling back to community or domain defaults.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| i18n     | object   | i18n instance                               |
| domain   | object   | Domain object                               |
| community| object   | Community object                            |
| done     | function | Callback function                           |

---

### user.setupProfileImage(body, done)
Associates a profile image with the user if `uploadedProfileImageId` is present in the request body.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| body     | object   | Request body                                |
| done     | function | Callback function                           |

---

### user.setupHeaderImage(body, done)
Associates a header image with the user if `uploadedHeaderImageId` is present in the request body.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| body     | object   | Request body                                |
| done     | function | Callback function                           |

---

### user.setupImages(body, done)
Sets up both profile and header images for the user.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| body     | object   | Request body                                |
| done     | function | Callback function                           |

---

### user.createPasswordHash(password)
Hashes the given password and stores it in `encrypted_password`.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| password | string   | Plaintext password                          |

---

### user.validatePassword(password, done)
Validates the given password against the stored hash. If legacy passwords are enabled, checks those as well.

#### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| password | string   | Plaintext password                          |
| done     | function | Callback function (err, user, info)         |

---

## Example Usage

```javascript
const { User } = require('./models/user.cjs');

// Creating a new user
const user = await User.create({
  name: 'Alice',
  email: 'alice@example.com',
  status: 'active',
  encrypted_password: '...'
});

// Authenticating a user
User.localCallback(req, 'alice@example.com', 'password123', (err, user, info) => {
  if (user) {
    // Authenticated
  } else {
    // Failed
  }
});
```

---

## Related Files

- [logger.cjs](./../utils/logger.md)
- [to_json.cjs](./../utils/to_json.md)

---

## Notes

- This model is designed for use with Sequelize and expects a PostgreSQL database (due to use of JSONB and GIN indexes).
- Social login serialization methods are tightly coupled to the application's authentication flow.
- The model supports soft deletion and status-based filtering by default.
- Passwords are hashed using bcrypt.
- The model supports legacy password migration for users imported from older systems.

---

For more information on Sequelize models, see the [Sequelize documentation](https://sequelize.org/master/manual/model-basics.html).