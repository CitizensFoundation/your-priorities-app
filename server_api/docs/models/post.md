# Model: Post

The `Post` model represents a content item (such as an idea, story, newsfeed item, person, blog, question, or survey) in the application. It is defined using Sequelize ORM and includes a wide range of properties, associations, scopes, and utility methods for managing posts, their relationships, and related business logic.

---

## Properties

| Name                        | Type                | Description                                                                                 |
|-----------------------------|---------------------|---------------------------------------------------------------------------------------------|
| id                          | INTEGER             | Primary key (auto-generated by Sequelize).                                                  |
| content_type                | INTEGER             | Type of content (see constants below).                                                      |
| name                        | STRING              | Name/title of the post.                                                                     |
| description                 | TEXT                | Description or body of the post.                                                            |
| status                      | STRING              | Status of the post (e.g., 'published').                                                     |
| official_status             | INTEGER             | Official status (e.g., open, finished, successful, etc.).                                   |
| ip_address                  | STRING              | IP address of the creator.                                                                  |
| user_agent                  | TEXT                | User agent string of the creator.                                                           |
| deleted                     | BOOLEAN             | Whether the post is deleted.                                                                |
| deleted_at                  | DATE                | Timestamp when the post was deleted.                                                        |
| status_changed_at           | DATE                | Timestamp when the status was last changed.                                                 |
| official_status_changed_at  | DATE                | Timestamp when the official status was last changed.                                        |
| counter_endorsements_up     | INTEGER             | Number of up endorsements.                                                                  |
| counter_endorsements_down   | INTEGER             | Number of down endorsements.                                                                |
| counter_points              | INTEGER             | Number of points associated with the post.                                                  |
| counter_all_activities      | INTEGER             | Number of all activities related to the post.                                               |
| counter_main_activities     | INTEGER             | Number of main activities related to the post.                                              |
| counter_impressions         | INTEGER             | Number of impressions/views.                                                                |
| counter_flags               | INTEGER             | Number of times the post has been flagged/reported.                                         |
| data                        | JSONB               | Arbitrary internal data (may include moderation info, etc.).                                |
| public_data                 | JSONB               | Arbitrary public data.                                                                      |
| position                    | INTEGER             | Position/order of the post.                                                                 |
| location                    | JSONB               | Location data (if applicable).                                                              |
| cover_media_type            | STRING              | Type of cover media (e.g., image, video).                                                   |
| legacy_post_id              | INTEGER             | Legacy ID for migration/compatibility.                                                      |
| user_interaction_profile    | JSONB               | Data about user interactions.                                                               |
| language                    | STRING              | Language code (optional).                                                                   |
| created_at                  | DATE                | Timestamp when the post was created.                                                        |
| updated_at                  | DATE                | Timestamp when the post was last updated.                                                   |

---

## Indexes

Multiple indexes are defined for performance, including GIN indexes for JSONB fields and compound indexes for common query patterns (e.g., by group, status, category, etc.).

---

## Scopes

| Name         | Description                                                                                  |
|--------------|----------------------------------------------------------------------------------------------|
| open         | Posts with `official_status: 0`, not deleted, and status 'published'.                        |
| not_open     | Posts with `official_status` in `[-2, -1, 1, 2]`, not deleted, and status 'published'.       |
| finished     | Posts with `official_status` in `[-2, -1, 2]`, not deleted, and status 'published'.          |
| successful   | Posts with `official_status: 2`, not deleted, and status 'published'.                        |
| compromised  | Posts with `official_status: -991`, not deleted, and status 'published'.                     |
| failed       | Posts with `official_status: -2`, not deleted, and status 'published'.                       |
| in_progress  | Posts with `official_status` in `[-1, 1]`, not deleted, and status 'published'.              |

---

## Associations

| Association Type         | Target Model         | Foreign Key / Through Table         | Alias (as)         |
|-------------------------|----------------------|-------------------------------------|--------------------|
| hasMany                 | Point                |                                     |                    |
| hasMany                 | Endorsement          |                                     |                    |
| hasMany                 | PostRevision         |                                     |                    |
| hasMany                 | Rating               |                                     |                    |
| belongsTo               | Category             | category_id                         |                    |
| belongsTo               | User                 | user_id                             |                    |
| belongsTo               | Group                | group_id                            |                    |
| belongsToMany           | Image                | PostImage                           | PostImages         |
| belongsToMany           | Image                | PostHeaderImage                     | PostHeaderImages   |
| belongsToMany           | Image                | PostUserImage                       | PostUserImages     |
| belongsToMany           | Video                | PostVideo                           | PostVideos         |
| belongsToMany           | Audio                | PostAudio                           | PostAudios         |

---

## Exported Constants

| Name                  | Value | Description                        |
|-----------------------|-------|------------------------------------|
| CONTENT_IDEA          | 0     | Content type: Idea                 |
| CONTENT_STORY         | 1     | Content type: Story                |
| CONTENT_NEWSFEED      | 2     | Content type: Newsfeed             |
| CONTENT_PERSON        | 3     | Content type: Person               |
| CONTENT_BLOG          | 4     | Content type: Blog                 |
| CONTENT_QUESTION      | 5     | Content type: Question             |
| CONTENT_SURVEY        | 6     | Content type: Survey               |
| defaultAttributesPublic | Array of strings | Default public attributes for serialization. |

---

## Static Methods

### Post.getSearchVector()

Returns the name of the full-text search vector column.

**Returns:** `string`  
**Example:**  
```js
const vectorName = Post.getSearchVector(); // 'PostText'
```

---

### Post.addFullTextIndex()

Adds a PostgreSQL full-text search index to the posts table if not already present. Only works if the database dialect is PostgreSQL.

**Returns:** `void`  
**Side Effects:** Alters the database schema, creates index and trigger.

---

### Post.search(query: string, groupId: number, modelCategory: any)

Performs a full-text search on posts using PostgreSQL's `to_tsquery`. Returns matching posts with related data.

| Parameter    | Type     | Description                                 |
|--------------|----------|---------------------------------------------|
| query        | string   | The search query string.                    |
| groupId      | number   | The group ID to filter posts by group.      |
| modelCategory| any      | The category model (not directly used).     |

**Returns:** `Promise<Array<Post>>` (if query is provided and dialect is postgres), otherwise `[]`.

---

### Post.setVideosForPosts(posts: Array<Post>, done: Function)

Fetches videos for the given posts and attaches them to each post.

| Parameter | Type         | Description                |
|-----------|--------------|----------------------------|
| posts     | Array<Post>  | Array of post instances.   |
| done      | Function     | Callback function.         |

---

### Post.getVideosForPosts(postIds: Array<number>, done: Function)

Fetches all videos associated with the given post IDs.

| Parameter | Type             | Description                |
|-----------|------------------|----------------------------|
| postIds   | Array<number>    | Array of post IDs.         |
| done      | Function         | Callback function.         |

---

### Post.addVideosToAllActivityPosts(activities: Array<any>, videos: Array<any>)

Attaches videos to posts within a list of activity objects.

| Parameter | Type         | Description                |
|-----------|--------------|----------------------------|
| activities| Array<any>   | Array of activity objects. |
| videos    | Array<any>   | Array of video objects.    |

---

### Post.setOrganizationUsersForPosts(posts: Array<Post>, done: Function)

Fetches and attaches organization users to the user of each post.

| Parameter | Type         | Description                |
|-----------|--------------|----------------------------|
| posts     | Array<Post>  | Array of post instances.   |
| done      | Function     | Callback function.         |

---

### Post.addVideosToAllPosts(posts: Array<Post>, videos: Array<any>)

Attaches videos to the corresponding posts.

| Parameter | Type         | Description                |
|-----------|--------------|----------------------------|
| posts     | Array<Post>  | Array of post instances.   |
| videos    | Array<any>   | Array of video objects.    |

---

## Instance Methods

### post.setupModerationData()

Initializes the moderation data structure in the post's `data` property if not already present.

**Returns:** `void`

---

### post.report(req: Request, source: string, callback: Function)

Handles reporting (flagging) a post, updates moderation data, triggers toxicity estimation, and logs an activity.

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| req       | Request  | Express request object (may be null).       |
| source    | string   | Source of the report (e.g., 'user').        |
| callback  | Function | Callback function(error).                   |

---

### post.simple()

Returns a simplified object representation of the post.

**Returns:** `{ id: number, name: string }`

---

### post.updateAllExternalCounters(req: Request, direction: 'up' | 'down', column: string, done: Function)

Updates external counters (e.g., in the associated group) when a post's counter changes.

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| req       | Request  | Express request object.                     |
| direction | string   | 'up' or 'down'.                             |
| column    | string   | Name of the counter column to update.       |
| done      | Function | Callback function(error).                   |

---

### post.updateAllExternalCountersBy(req: Request, direction: 'up' | 'down', column: string, updateBy: number, done: Function)

Updates external counters by a specific amount.

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| req       | Request  | Express request object.                     |
| direction | string   | 'up' or 'down'.                             |
| column    | string   | Name of the counter column to update.       |
| updateBy  | number   | Amount to increment/decrement by.           |
| done      | Function | Callback function(error).                   |

---

### post.setupHeaderImage(body: any, done: Function)

Associates a header image with the post if `uploadedHeaderImageId` is present in the request body.

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| body      | any      | Request body object.                        |
| done      | Function | Callback function.                          |

---

### post.getImageFormatUrl(formatId: string)

Returns the URL for a specific image format from the post's header images.

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| formatId  | string   | Format identifier.                          |

**Returns:** `string` (URL or empty string)

---

### post.setupImages(body: any, done: Function)

Sets up images for the post (currently only header image).

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| body      | any      | Request body object.                        |
| done      | Function | Callback function.                          |

---

### post.setupAfterSave(req: Request, res: Response, done: Function)

Handles post-save logic: creates a post revision, optionally creates a point and its revision, triggers moderation and similarity jobs, and updates counters.

| Parameter | Type     | Description                                 |
|-----------|----------|---------------------------------------------|
| req       | Request  | Express request object.                     |
| res       | Response | Express response object.                     |
| done      | Function | Callback function.                          |

---

## Example Usage

```javascript
// Creating a new post
const post = await Post.create({
  content_type: Post.CONTENT_IDEA,
  name: "My Idea",
  description: "A description of my idea.",
  status: "published",
  ip_address: "127.0.0.1",
  user_agent: "Mozilla/5.0"
});

// Reporting a post
post.report(req, 'user', (err) => {
  if (err) {
    // handle error
  }
});

// Searching for posts
const results = await Post.search("climate change", 1, null);
```

---

## See Also

- [Point](./Point.md)
- [Endorsement](./Endorsement.md)
- [PostRevision](./PostRevision.md)
- [Rating](./Rating.md)
- [Category](./Category.md)
- [User](./User.md)
- [Group](./Group.md)
- [Image](./Image.md)
- [Video](./Video.md)
- [Audio](./Audio.md)
- [Organization](./Organization.md)
- [AcActivity](./AcActivity.md)
- [logger](../utils/logger.md)
- [queue](../services/workers/queue.md)

---

**Note:**  
- This model is tightly coupled with the rest of the Sequelize models in the application.  
- Many methods assume the presence of related models and certain request properties (e.g., `req.user`, `req.useragent`, `req.clientIp`).  
- Full-text search and some features are only available when using PostgreSQL as the database backend.  
- The model includes both static and instance methods for advanced business logic and data manipulation.