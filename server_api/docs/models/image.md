# Model: Image

The `Image` model represents an image entity in the application, including metadata, storage information, and associations with other models such as User, Group, Community, Domain, Post, and Category. It provides utility methods for image format management, image removal from collections, and image versioning for different use cases.

## Properties

| Name                | Type      | Description                                                                 |
|---------------------|-----------|-----------------------------------------------------------------------------|
| id                  | number    | Primary key (auto-generated by Sequelize).                                  |
| name                | string    | Name of the image.                                                          |
| description         | string    | Description of the image.                                                   |
| license             | string    | License type of the image.                                                  |
| cc_url              | string    | Creative Commons URL for the image.                                         |
| original_url        | string    | Original source URL of the image.                                           |
| photographer_name   | string    | Name of the photographer.                                                   |
| formats             | string    | JSON string representing available image formats/versions.                  |
| original_filename   | string    | Original filename of the uploaded image.                                    |
| s3_bucket_name      | string    | Name of the S3 bucket where the image is stored.                            |
| ip_address          | string    | IP address of the uploader. (Required)                                      |
| user_agent          | string    | User agent string of the uploader. (Required)                               |
| location            | object    | JSONB object containing location metadata.                                  |
| deleted             | boolean   | Soft-delete flag. If true, the image is considered deleted. (Default: false)|
| created_at          | Date      | Timestamp when the image was created.                                       |
| updated_at          | Date      | Timestamp when the image was last updated.                                  |

## Configuration

- **Table Name:** `images`
- **Timestamps:** `created_at`, `updated_at`
- **Default Scope:** Only non-deleted images, ordered by `created_at` ascending.
- **Indexes:** Multiple indexes for performance on `id`, `created_at`, `updated_at`, and `deleted`.

## Associations

- **Belongs to:** [User](./User.md)
- **Belongs to many:** 
  - [Video](./Video.md) (as `VideoImages` through `VideoImage`)
  - [Post](./Post.md) (as `PostImages` through `PostImage`, `PostHeaderImages` through `PostHeaderImage`, `PostUserImages` through `PostUserImage`)
  - [Group](./Group.md) (through `GroupImage`, as `GroupLogoImages` through `GroupLogoImage`, `GroupHtmlImages` through `GroupHtmlImage`, `GroupHeaderImages` through `GroupHeaderImage`)
  - [Community](./Community.md) (as `CommunityLogoImages` through `CommunityLogoImage`, `CommunityHeaderImages` through `CommunityHeaderImage`)
  - [User](./User.md) (as `UserProfileImages` through `UserProfileImage`, `UserHeaderImages` through `UserHeaderImage`)
  - [Category](./Category.md) (as `CategoryIconImages` through `CategoryIconImage`, `CategoryHeaderImages` through `CategoryHeaderImage`)
  - [Domain](./Domain.md) (as `DomainLogoImages` through `DomainLogoImage`, `DomainHeaderImages` through `DomainHeaderImage`)

---

# Exported Constants

## `Image.defaultAttributesPublic`

- **Type:** `string[]`
- **Value:** `["id", "updated_at", "formats"]`
- **Description:** Default attributes to expose publicly for the Image model.

---

# Static Methods

## Image.createFormatsFromSharpFile

Creates an array of image format URLs from a Sharp file object, optionally rewriting URLs for Cloudflare proxying.

### Parameters

| Name      | Type    | Description                        |
|-----------|---------|------------------------------------|
| sharpFile | object  | Object containing Sharp file data. |

### Returns

- **Type:** `string[]`
- **Description:** Array of image format URLs.

---

## Image.createFormatsFromVersions

Generates an array of image format URLs from an array of version objects, handling different storage providers and environments.

### Parameters

| Name     | Type     | Description                                 |
|----------|----------|---------------------------------------------|
| versions | object[] | Array of version objects with `url` fields. |

### Returns

- **Type:** `string[]`
- **Description:** Array of image format URLs.

---

## Image.removeImageFromCollection

Removes an image from a collection (group, community, domain, post, or by user), soft-deletes it, and triggers deletion of associated media formats.

### Parameters

| Name | Type     | Description                    |
|------|----------|--------------------------------|
| req  | Request  | Express request object         |
| res  | Response | Express response object        |

### Behavior

- Checks for image existence and collection context (group, community, domain, post, or user).
- Removes the image from the specified collection.
- Soft-deletes the image (`deleted = true`).
- Calls the `CollectionImageGenerator.deleteMediaFormatsUrls` service to remove media files.
- Returns appropriate HTTP status and message.

### Response

#### Success (200)
```json
{
  "message": "Image removed from collection"
}
```

#### Error (404)
```json
{
  "message": "Image not found"
}
```

#### Error (500)
```json
{
  "error": "Could not delete image"
}
```

---

## Image.getSharpGalleryVersions

Returns a list of Sharp image versions for gallery display.

### Parameters

| Name     | Type   | Description                |
|----------|--------|----------------------------|
| itemType | string | Type of item (unused).     |

### Returns

- **Type:** `object[]`
- **Description:** Array of version objects with `height`, `width`, `suffix`, and `directory`.

---

## Image.getSharpVersions

Returns a list of Sharp image versions for a given item type, supporting various use cases (user profile, domain logo, group logo, etc.).

### Parameters

| Name     | Type   | Description                |
|----------|--------|----------------------------|
| itemType | string | Type of item (e.g., "user-profile", "domain-logo", etc.). |

### Returns

- **Type:** `object[]`
- **Description:** Array of version objects with properties such as `width`, `height`, `suffix`, `directory`, and optionally `format`.

---

# Example Usage

```javascript
const { Image } = require('./models/image');

// Creating formats from a Sharp file object
const formats = Image.createFormatsFromSharpFile(sharpFile);

// Creating formats from version objects
const formats = Image.createFormatsFromVersions(versions);

// Getting Sharp versions for a user profile image
const versions = Image.getSharpVersions('user-profile');
```

---

# See Also

- [User](./User.md)
- [Group](./Group.md)
- [Community](./Community.md)
- [Domain](./Domain.md)
- [Post](./Post.md)
- [Category](./Category.md)
- [CollectionImageGenerator](../services/llms/imageGeneration/collectionImageGenerator.js)
- [logger](../utils/logger.cjs)
- [toJson](../utils/to_json.cjs)
