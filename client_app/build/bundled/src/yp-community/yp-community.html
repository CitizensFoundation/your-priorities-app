<body><dom-module id="yp-community"><template><style include="iron-flex iron-flex-alignment">.card-container{@apply --layout-horizontal;@apply --layout-wrap;}.card{padding:16px;}yp-ajax{background-color:var(--primary-background-color) !important;}paper-tab{--paper-tabs:{font-family:var(--app-normal-font-family, Roboto);};font-family:var(--app-normal-font-family, Roboto);}.archivedText{font-size:26px;color:#333;}.minHeightSection{min-height:450px;}#paper_tabs[apple]{margin-top:42px;margin-bottom:8px;}[hidden]{display:none !important;}</style><yp-page id="page"create-fab-icon="[[createFabIcon]]"create-fab-title="[[t('group.add')]]"on-yp-create-fab-tap="_newGroup"hide-all-tabs="[[community.configuration.hideAllTabs]]"role="main"aria-label$="[[t('groups')]]"><template is="dom-if"if="[[useAlternativeHeader]]"><yp-community-header id="communityCard"slot="largeCard"class="largeCard card"community="[[community]]"on-update-community="_refreshAjax"></yp-community-header></template><template is="dom-if"if="[[useNormalHeader]]"><yp-community-large-card id="communityCard"slot="largeCard"class="largeCard card"community="[[community]]"on-update-community="_refreshAjax"></yp-community-large-card></template><paper-tabs id="paper_tabs"apple$="[[isOldiOs]]"slot="tabs"class="tabs"selected="{{selectedTab}}"attr-for-selected="name"focused=""hidden$="[[community.configuration.hideAllTabs]]"><paper-tab name="groups"class="tab"><span>[[t('groups')]]</span> &nbsp; (<span>[[groupsLength]]</span>)</paper-tab><paper-tab name="news"class="tab">[[t('news')]]</paper-tab><paper-tab name="map"class="tab"hidden$="[[locationHidden]]">[[t('posts.map')]]</paper-tab></paper-tabs><iron-pages class="tabPages"slot="tabPages"selected="{{selectedTab}}"attr-for-selected="name"entry-animation="fade-in-animation"exit-animation="fade-out-animation"><section name="groups"role="main"aria-label$="[[t('groups')]]"><div class="layout horizontal center-center"><yp-group-grid id="groupGrid"featured-groups="[[featuredGroups]]"active-groups="[[activeGroups]]"archived-groups="[[archivedGroups]]"hide-add$="[[!createFabIcon]]"on-add-new-group="_newGroup"></yp-group-grid></div></section><section class="minHeightSection"name="news"><template is="dom-if"if="[[newsTabSelected]]"><ac-activities id="communityNews"selected-tab="[[selectedTab]]"community-id="[[community.id]]"></ac-activities></template></section><section class="minHeightSection"name="map"hidden$="[[locationHidden]]"><template is="dom-if"if="[[mapActive]]"restamp=""><yp-post-map community-id="[[community.id]]"></yp-post-map></template></section></iron-pages></yp-page><lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal><lite-signal on-lite-signal-logged-in="_userLoggedIn"></lite-signal><lite-signal on-lite-signal-got-admin-rights="_gotAdminRights"></lite-signal><app-route route="{{idRoute}}"pattern="/:id"data="{{idRouteData}}"tail="{{tabRoute}}"></app-route><app-route route="{{tabRoute}}"pattern="/:tabName"data="{{tabRouteData}}"></app-route><yp-ajax id="ajax"url="/api/communities"on-response="_response"></yp-ajax><yp-ajax id="pagesAjax"on-response="_pagesResponse"></yp-ajax></template><script>Polymer({is:"yp-community",behaviors:[Polymer.ypLanguageBehavior,Polymer.GroupCollectionBehaviors,Polymer.ypThemeBehavior,Polymer.CollectionHelpers,Polymer.AccessHelpers,Polymer.YpNewsTabSelected,Polymer.ypLoggedInUserBehavior,Polymer.ypDetectOldiOs,Polymer.ypGotoBehavior,Polymer.ypMediaFormatsBehavior],properties:{idRoute:Object,tabRoute:Object,idRouteData:Object,tabRouteData:Object,createFabIcon:{type:String,value:null,notify:!0},communityId:{type:Number,value:null,observer:"_communityIdChanged"},community:{type:Object},selectedTab:{type:String,value:"groups",observer:"_selectedTabChanged"},mapActive:{type:Boolean,value:!1},locationHidden:{type:Boolean,value:!1},useAlternativeHeader:{type:Boolean,value:!1},isOldiOs:{type:Boolean,computed:"_isOldiOs(communityId)"},useNormalHeader:{type:Boolean,value:!0}},observers:["_routeIdChanged(idRouteData.id)","_routeTabChanged(tabRouteData.tabName)"],listeners:{"yp-new-group":"_newGroup","yp-new-group-folder":"_newGroupFolder"},_userLoggedIn:function(i){i&&this.community&&-1<window.location.href.indexOf("/community/")&&this.$$("#ajax").generateRequest()},_newPostForGroup:function(t){window.appGlobals.activity("open","newPost"),Polymer.dom(document).querySelector("yp-app").getDialogAsync("postEdit",function(i){i.setup(null,!0,null),i.open("new",{groupId:t.id,group:t})}.bind(this))},_refreshTabsAndPages:function(){this.async(function(){var i=this.$$("#tabPages");i&&i.forceSynchronousItemUpdate();var t=this.$$("#paper_tabs");t&&(t.forceSynchronousItemUpdate(),t.notifyResize())},10)},scrollToGroupItem:function(){if("news"===this.selectedTab&&null!==window.appGlobals.cachedActivityItem){var i=this.$$("#communityNews");i?(i.scrollToItem(window.appGlobals.cachedActivityItem),window.appGlobals.cachedActivityItem=null):console.warn("No community activities for scroll to item")}else"groups"===this.selectedTab&&window.appGlobals.backToCommunityGroupItems&&window.appGlobals.backToCommunityGroupItems[this.community.id]&&(this.$.groupGrid.scrollToItem(window.appGlobals.backToCommunityGroupItems[this.community.id]),window.appGlobals.backToCommunityGroupItems[this.community.id]=null)},_routeIdChanged:function(i){i&&this.set("communityId",i)},_routeTabChanged:function(i){i&&this.set("selectedTab",i)},_selectedTabChanged:function(i){this.community&&this.redirectTo("/community/"+this.community.id+"/"+i),"map"==i?this.set("mapActive",!0):this.set("mapActive",!1),i&&window.appGlobals&&window.appGlobals.activity("open","community_tab","",{id:this.communityId}),this.async(function(){var i=this.$$("#communityNews");i&&i.fireResize()},300)},_hideEdit:function(){return!this.community||(!window.appUser.loggedIn()||window.appUser.user.id!=this.community.user_id)},_communityHeaderUrl:function(i){return this.getImageFormatUrl(i.CommunityHeaderImages,2)},_communityIdChanged:function(i){i&&(this.set("community",null),this.set("featuredGroups",null),this.set("activeGroups",null),this.set("archivedGroups",null),this.set("selectedTab","groups"),this._getCommunity())},_getCommunity:function(){this.$$("#ajax").url="/api/communities/"+this.communityId,this.$$("#ajax").retryMethodAfter401Login=this._getCommunity.bind(this),this.$$("#ajax").generateRequest()},_newGroup:function(){window.appGlobals.activity("open","newGroup"),Polymer.dom(document).querySelector("yp-app").getDialogAsync("groupEdit",function(i){i.setup(null,!0,this._refreshAjax.bind(this)),i.open("new",{communityId:this.communityId,community:this.community})}.bind(this))},_newGroupFolder:function(){window.appGlobals.activity("open","newGroupFolder"),Polymer.dom(document).querySelector("yp-app").getDialogAsync("groupEdit",function(i){i.setup(null,!0,this._refreshAjax.bind(this)),i.open("new",{communityId:this.communityId,community:this.community,isGroupFolder:!0})}.bind(this))},_pagesResponse:function(i,t){this.fire("yp-set-pages",t.response)},_response:function(i,t){if(this.set("community",t.response),this.community.is_community_folder)this.redirectTo("/community_folder/"+this.community.id);else{this.refresh(),this.community.is_community_folder||this.community.only_admins_can_create_groups&&!this.checkCommunityAccess(this.community)||this.set("createFabIcon","add");this._communityHeaderUrl(this.community);this.setupGroups(this.community.Groups,this.community.configuration),this._setLocationHidden(this.community.Groups),this.community.Groups&&0<this.community.Groups.length&&(window.appGlobals.setAnonymousGroupStatus(this.community.Groups[0]),window.appGlobals.setRegistrationQuestionGroup(this.community.Groups[0])),this.async(function(){var i=this.$$("#communityCard");i&&(i.setElevation(5),i.lowerCardLater())},20)}},_gotAdminRights:function(i,t){t&&0<t&&this.checkCommunityAccess(this.community)&&this.set("createFabIcon","add")},_setLocationHidden:function(i){var t=!0;i.forEach(function(i){i.configuration&&i.configuration.locationHidden?1!=i.configuration.locationHidden&&(t=!1):t=!1}.bind(this)),this.set("locationHidden",t),this._refreshTabsAndPages()},_openHelpPageIfNeeded:function(){sessionStorage.getItem("yp-welcome-for-community-"+this.community.id)||this.community&&this.community.configuration&&this.community.configuration.welcomePageId&&this.async(function(){this.fire("yp-open-page",{pageId:this.community.configuration.welcomePageId}),sessionStorage.setItem("yp-welcome-for-community-"+this.community.id,!0)},1200)},_useHardBack:function(i){if(i&&i.customBackURL){var t=i.customBackURL;return!(t.startsWith("/community/")||t.startsWith("/group/")||t.startsWith("/domain/")||t.startsWith("/post/"))}return!1},refresh:function(){var i=this.checkCommunityAccess(this.community);if(this.community&&this.community.configuration&&this.community.configuration.redirectToGroupId&&!i)this.redirectTo("/group/"+this.community.configuration.redirectToGroupId);else if(this.community){var t,o,e;if(this._openHelpPageIfNeeded(),this.fire("yp-set-home-link",{type:"community",id:this.community.id,name:this.community.name}),window.appGlobals.setCommunityAnalyticsTracker(this.community.google_analytics_code),this.community.configuration&&(window.appGlobals.setCommunityPixelTracker(this.community.configuration.facebookPixelId),this.community.configuration.useZiggeo?window.appGlobals.useZiggeo=!0:window.appGlobals.useZiggeo=!1),null!=this.community.theme_id||this.community.configuration&&null!=this.community.configuration.themeOverrideColorPrimary?this.setTheme(this.community.theme_id,this.community.configuration):null!=this.community.Domain.theme_id&&this.setTheme(this.community.Domain.theme_id),null!=this.community.default_locale&&window.appGlobals.changeLocaleIfNeeded(this.community.default_locale),this.community.configuration&&this.community.configuration.alternativeHeader&&""!=this.community.configuration.alternativeHeader?(this.set("useAlternativeHeader",!0),this.set("useNormalHeader",!1)):(this.set("useAlternativeHeader",!1),this.set("useNormalHeader",!0)),this.community.CommunityHeaderImages&&0<this.community.CommunityHeaderImages.length?this.$.page.setupTopHeaderImage(this.community.CommunityHeaderImages):this.$.page.setupTopHeaderImage(null),-1<window.location.href.indexOf("/community"))e=this.community.CommunityFolder?(t="/community_folder/"+this.community.CommunityFolder.id,o=this.community.CommunityFolder.name,this.community.CommunityFolder.description):(t="/domain/"+this.community.domain_id,o=this.community.Domain.name,this.community.Domain.description),this.fire("change-header",{headerTitle:this.community.configuration&&this.community.configuration.customBackName?this.community.configuration.customBackName:o,headerDescription:e,headerIcon:"group-work",useHardBack:this._useHardBack(this.community.configuration),disableDomainUpLink:this.community.configuration&&!0===this.community.configuration.disableDomainUpLink,documentTitle:this.community.name,backPath:this.community.configuration&&this.community.configuration.customBackURL?this.community.configuration.customBackURL:t});this.$.pagesAjax.url="/api/communities/"+this.community.id+"/pages",this.$.pagesAjax.generateRequest(),window.appGlobals.disableFacebookLoginForGroup=!1,window.appGlobals.externalGoalTriggerGroupId=null,window.appGlobals.currentGroup=null,this.community.configuration&&this.community.configuration.forceSecureSamlLogin&&!this.checkCommunityAccess(this.community)?window.appGlobals.currentForceSaml=!0:window.appGlobals.currentForceSaml=!1,this.community.configuration&&this.community.configuration.customSamlDeniedMessage?window.appGlobals.currentSamlDeniedMessage=this.community.configuration.customSamlDeniedMessage:window.appGlobals.currentSamlDeniedMessage=null,this.community.configuration&&this.community.configuration.customSamlLoginMessage?window.appGlobals.currentSamlLoginMessage=this.community.configuration.customSamlLoginMessage:window.appGlobals.currentSamlLoginMessage=null,this.community.configuration&&this.community.configuration.signupTermsPageId&&-1!=this.community.configuration.signupTermsPageId?window.appGlobals.signupTermsPageId=this.community.configuration.signupTermsPageId:window.appGlobals.signupTermsPageId=null,this.community.configuration&&this.community.configuration.highlightedLanguages?window.appGlobals.setHighlightedLanguages(this.community.configuration.highlightedLanguages):window.appGlobals.setHighlightedLanguages(null)}},defaultGroupFirst:function(i){for(var t,o=[],e=null,n=0;n<i.length;n++)"default"!=(t=i[n]).short_name?o.push(t):e=t;return o.unshift(e),o},noTestGroup:function(i){for(var t,o=[],e=0;e<i.length;e++)"test"!=(t=i[e]).short_name&&"ac-posts"!=t.short_name&&"development"!=t.short_name&&-1==t.short_name.indexOf("2012")&&-1==t.short_name.indexOf("2013")&&o.push(t);return o},_refreshAjax:function(){this.async(function(){this.$$("#ajax").generateRequest()},100)},ready:function(){}})</script></dom-module>