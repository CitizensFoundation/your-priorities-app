<div hidden=""by-polymer-bundler=""><dom-module id="yp-fraud-management"assetpath="../yp-moderation/"><template><style include="iron-flex iron-flex-alignment">#dialog{width:100%;height:100%;margin:0;top:unset !important;left:unset !important;background-color:#FFF;}.itemItem{padding-right:16px;}.id{width:40px;}.name{width:200px;}.email{width:190px;overflow-wrap:break-word;}.addDeletedButtons{width:150px;}[hidden]{display:none !important;}paper-listbox{margin-right:8px !important;}.headerBox{background-color:var(--accent-color);color:#FFF;margin:0;padding:0 0;padding-top:12px;padding-bottom:10px;}paper-button{margin-left:8px;}#grid{margin-top:0;}.headerText{padding:0 0 !important;}.collectionName{font-size:22px;margin-bottom:1px;margin-top:4px;}.innerHeader{font-size:17px;color:#F5F5F5;}.closeButton{width:50px;height:50px;margin-left:4px;margin-right:4px;}paper-checkbox{color:#FFF !important;margin-top:14px;margin-right:24px;--primary-color:#FFF;--primary-text-color:#FFF;--paper-checkbox-checked-ink-color:#FFF;--paper-checkbox-unchecked-ink-color:#FFF;}paper-progress{--paper-progress-active-color:#444;--paper-progress-secondary-color:#444;--paper-progress-container-color:#FFF;margin-top:22px;margin-left:82px;}@media (max-width: 600px){.closeButton{width:45px;height:45px;}paper-listbox{margin-right:8px;}#dialog{width:100%;height:100%;margin:0;padding:0;}.headerText{font-size:20px;line-height:1.2em;text-align:center;}}.details{display:flex;margin:8px;}yp-point{min-height:100px;max-width:500px;margin-bottom:8px;}yp-post-header{margin-bottom:8px;}paper-button{font-size:18px;margin-top:16px;}.analysis{margin-top:12px;color:#656565;}.leftColumn{padding-right:16px;}.mainScore{color:#000;}.linkIcon{color:#000;}vaadin-grid{font-size:14px;}.fraudPostsAndPointsInfo{color:#F00;}.detailArea{padding-top:2px;}.detailAreas{padding-bottom:12px;padding-left:16px;}paper-radio-group{margin-right:16px;}paper-radio-button{color:#FFF;margin-top:4px;--primary-color:#FFF;--primary-text-color:#FFF;margin-right:0;}.reloadPlaceholder{width:64px;}</style><lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal><paper-dialog id="dialog"modal=""><div class="layout horizontal headerBox wrap"><div><paper-icon-button aria-label$="[[t('close')]]"id="dismissBtn"icon="close"class="closeButton"dialog-dismiss=""></paper-icon-button></div><div class="headerText layout vertical"><div class="layout horizontal"><div class="collectionName">[[collectionName]]</div></div><div class="innerHeader">[[headerText]] <span hidden$="[[!totalItemsCount]]">([[totalItemsCount]] [[itemsCountText]])</span></div></div><paper-progress id="progress"indeterminate$="[[indeterminateProgress]]"value="[[progress]]"hidden$="[[!inProgress]]"></paper-progress><div class="flex"></div><div class="layout horizontal"><paper-radio-group selected="{{selectedCollectionType}}"class="radioButtons"><paper-radio-button name="endorsements">Endorsements</paper-radio-button><paper-radio-button name="ratings">Ratings</paper-radio-button><paper-radio-button name="pointQualities">PointQualities</paper-radio-button><paper-radio-button name="points">Points</paper-radio-button><paper-radio-button name="posts">Posts</paper-radio-button></paper-radio-group></div><div class="checkBox"hidden$="[[narrow]]"><paper-checkbox checked="{{multiSortEnabled}}">[[t('multiSortEnabled')]]</paper-checkbox></div><div hidden$="[[!showReload]]"><paper-icon-button aria-label$="[[t('reload')]]"icon="autorenew"class="closeButton"on-tap="_reload"></paper-icon-button></div><div class="reloadPlaceholder"hidden$="[[showReload]]">&nbsp;</div></div><paper-tabs selected="{{selectedMethod}}"attr-for-selected="name"><paper-tab name="byIpFingerprintPostId"hidden$="[[hidePost]]">IP &amp; FINGERPRINT &amp; POST</paper-tab><paper-tab name="byIpUserAgentPostId"hidden$="[[hidePost]]">IP &amp; USER AGENT &amp; POST</paper-tab><paper-tab name="byIpFingerprintPointId"hidden$="[[hidePoint]]">IP &amp; FINGERPRINT &amp; POINT</paper-tab><paper-tab name="byIpUserAgentPointId"hidden$="[[hidePoint]]">IP &amp; USER AGENT &amp; POINT</paper-tab><paper-tab name="byIpFingerprint">IP &amp; FINGERPRINT</paper-tab><paper-tab name="byMissingBrowserFingerprint">NO FINGERPRINT</paper-tab><paper-tab name="byIpAddress">IP ADDRESS</paper-tab></paper-tabs><template is="dom-if"if="[[items]]"></template><vaadin-grid id="grid"multi-sort="[[multiSortEnabled]]"active-item="{{activeItem}}"aria-label$="[[headerText]]"items="[[items]]"selected-items="{{selectedItems}}"><vaadin-grid-selection-column></vaadin-grid-selection-column><template class="row-details"><div class="details layout vertical center-center detailArea"><div class="layout vertical"><div class="layout horizontal"><div class="layout vertical detailAreas"><div class="detailArea"><b>Group:</b> [[item.key]]</div><div class="detailArea"><b>Count:</b> [[item.groupCount]]</div><div class="detailArea"><b>IP Address:</b> [[item.ip_address]]</div><div class="detailArea"><b>Browser Id:</b> [[item.data.browserId]]</div><div class="detailArea"><b>Fingerprint:</b> [[item.data.browserFingerprint]]</div></div><div class="layout vertical detailAreas"><div class="detailArea"><b>User Id:</b> [[item.User.id]]</div><div class="detailArea"><b>Email:</b> [[item.User.email]]</div><div class="detailArea"hidden$="[[hidePost]]"><b>Post Id:</b> [[item.Post.id]]</div><div class="detailArea"hidden$="[[hidePost]]"><b>Post Name:</b> [[item.Post.name]]</div><div class="detailArea"hidden$="[[hidePoint]]"><b>Post Id:</b> [[item.Point.id]]</div><div class="detailArea"hidden$="[[hidePoint]]"><b>Point Id:</b> [[item.Point.Post.id]]</div><div class="detailArea"hidden$="[[hidePoint]]"><b>Post Name:</b> [[item.Point.Post.name]]</div><div class="detailArea"hidden$="[[!postsCollectionActive]]"><b>Post Name:</b> [[item.name]]</div><div class="detailArea"><b>Confidence:</b> [[item.confidenceScore]]</div></div></div><div class="layout vertical detailAreas"><div><b>User Agent:</b> [[item.user_agent]]</div></div></div></div></template><vaadin-grid-sort-column id="keyCol"style="background-color: #F00;"width="80px"flex-grow="0"path="key"header="<G>"></vaadin-grid-sort-column><vaadin-grid-sort-column width="75px"flex-grow="0"path="groupCount"header="#"><template>[[item.groupCount]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="140px"flex-grow="0"path="ip_address"header="IP Address"><template>[[item.ip_address]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"flex-grow="0"path="confidenceScoreSort"header="%"><template>[[item.confidenceScore]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="150px"flex-grow="0"path="createAtValue"header="[[t('date')]]"><template>[[item.created_at]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="120px"flex-grow="0"path="data.browserId"header="BrowserId"><template>[[item.data.browserId]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="120px"flex-grow="0"path="data.browserFingerprint"header="Fingerprint"><template>[[item.data.browserFingerprint]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"flex-grow="0"path="User.id"header="UserId"><template>[[item.User.id]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column flex-grow="0"path="User.email"width="210px"header="[[t('email')]]"><template>[[item.User.email]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column hidden$="[[hidePost]]"width="100px"flex-grow="0"path="Post.id"header="PostId"><template>[[item.Post.id]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column hidden$="[[hidePoint]]"width="100px"flex-grow="0"path="Point.id"header="Point"><template>[[item.Point.id]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column hidden$="[[hideValue]]"width="80px"flex-grow="0"path="value"header="Val"><template>[[item.value]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="150px"flex-grow="1"path="user_agent"header="User Agent"><template>[[item.user_agent]]</template></vaadin-grid-sort-column><vaadin-grid-column width="70px"flex-grow="0"><template class="header"><paper-menu-button horizontal-align="right"on-opened-changed="_refreshGridAsyncDelay"class="helpButton"disabled$="[[selectedItemsEmpty]]"><paper-icon-button aria-label$="[[t('openSelectedItemsMenu')]]"icon="more-vert"slot="dropdown-trigger"on-tap="_menuOpened"></paper-icon-button><paper-listbox slot="dropdown-content"on-iron-select="_menuSelection"><template is="dom-if"if="[[!selectedItemsEmpty]]"restamp=""><paper-item data-args$="[[item.id]]"on-tap="_deleteSelected">[[deleteItemsMenuText]] [[selectedItemsCount]]</paper-item></template></paper-listbox></paper-menu-button></template><template><paper-menu-button horizontal-align="right"class="helpButton"on-opened-changed="_refreshGridAsyncDelay"><paper-icon-button aria-label$="[[t('openOneItemMenu')]]"icon="more-vert"data-args$="[[item.id]]"on-tap="_setSelected"slot="dropdown-trigger"></paper-icon-button><paper-listbox slot="dropdown-content"on-iron-select="_menuSelection"><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"on-tap="_delete">[[t('deleteContent')]]</paper-item></paper-listbox></paper-menu-button></template></vaadin-grid-column></vaadin-grid></paper-dialog><div class="layout horizontal center-center"hidden=""><yp-ajax hidden=""method="PUT"id="startAjax"on-response="_startResponse"></yp-ajax><yp-ajax hidden=""method="GET"id="progressAjax"on-response="_progressResponse"></yp-ajax></div><iron-media-query query="(max-width: 600px)"query-matches="{{narrow}}"></iron-media-query></template><script>Polymer({is:"yp-fraud-management",behaviors:[Polymer.ypLanguageBehavior,Polymer.ypNumberFormatBehavior],properties:{multiSortEnabled:{type:Boolean,value:!1},jobId:{type:Number,value:null},items:{type:Array,notify:!0,value:null},headerText:{type:String},groupId:{type:Number,observer:"_groupIdChanged"},domainId:{type:Number,observer:"_domainIdChanged"},communityId:{type:Number,observer:"_communityIdChanged"},selected:{type:Object},modelType:{type:String},opened:{type:Boolean,value:!1},selectedItems:{type:Array,notify:!0},selectedItemsCount:{type:Number,value:0},selectedItemsEmpty:{type:Boolean,value:!0},selectedItemIds:{type:Array},selectedItemId:{type:String},selectedModelClass:{type:String},totalItemsCount:{type:String,computed:"_totalItemsCount(items)"},collectionName:String,itemsCountText:String,resizeTimeout:{type:Object,value:null},activeItem:{type:Object,observer:"_activeItemChanged"},selectedMethod:{type:String,observer:"_selectedMethodChanged",value:"byIpFingerprintPostId"},selectedCollectionType:{type:String,observer:"_selectedCollectionTypeChanged",value:"endorsements"},allSelected:{type:Boolean,computed:"_allSelected(selectedMethod, selectedCollectionType, modelType)"},typeOfModeration:{type:String,value:"/flagged_content"},showReload:{type:Boolean,value:!1},inProgress:{type:Boolean,observer:"_inProgressChanged",value:!1},progress:{type:Number,value:0},indeterminateProgress:{type:Boolean,value:!1},deleteItemsMenuText:{type:String,computed:"_deleteItemsMenuText(selectedMethod)"},currentType:{type:String,value:null},hidePost:{type:Boolean,computed:"_hidePost(selectedCollectionType)"},hidePoint:{type:Boolean,computed:"_hidePoint(selectedCollectionType)"},hideValue:{type:Boolean,computed:"_hideValue(selectedCollectionType)"},postsCollectionActive:{type:Boolean,computed:"_postsCollectionActive(selectedCollectionType)"}},_postsCollectionActive:function(e){return-1<["posts"].indexOf(e)},_hideValue:function(e){return-1<["posts","points"].indexOf(e)},_hidePost:function(e){return!("endorsements"===e||"ratings"===e||"points"===e)},_hidePoint:function(e){return!("pointQualities"===e)},_deleteItemsMenuText:function(e){return["byIpAddress","byMissingBrowserFingerprint","byIpFingerprint"].indexOf(e),this.t("deleteAllButOne")},_inProgressChanged:function(e){!1===e&&this.set("progress",10)},_allSelected:function(e,t,s){return!!s&&(("byIpFingerprintPostId"!==e&&"byIpUserAgentPostId"!==e||"endorsements"===t||"ratings"===t||"points"===t)&&("byIpFingerprintPointId"!==e&&"byIpFingerprintPointId"!==e||"pointQualities"===t)&&(this._reset(),this._masterAjax("get-items")),!0)},_selectedMethodChanged:function(e){e&&this.selectedCollectionType&&this.inProgress},_selectedCollectionTypeChanged:function(e){"pointQualities"===e&&this.set("selectedMethod","byIpFingerprintPointId"),"posts"!==e&&"points"!==e||this.set("selectedMethod","byIpFingerprint"),"endorsements"!==e&&"ratings"!==e&&"points"!==e||this.set("selectedMethod","byIpFingerprintPostId")},observers:["_selectedItemsChanged(selectedItems.splices)"],_ajaxError:function(){this.set("forceSpinner",!1)},_reload:function(){this._reset(),this._masterAjax("get-items")},_getType:function(e){return"post"===e?this.t("posts.post"):"point"===e?this.t("point.point"):void 0},_activeItemChanged:function(e,t){e&&this.$.grid.openItemDetails(e),t&&this.$.grid.closeItemDetails(t),this._refreshGridAsync()},_refreshGridAsync:function(){this._refreshGridAsyncBase(10)},_refreshGridAsyncDelay:function(){this.allowGridEventsAfterMenuOpen&&this._refreshGridAsyncBase(250)},_refreshGridAsyncBase:function(e){this.async(function(){this.$.grid.fire("iron-resize"),this.$.grid.notifyResize()},e)},_pollLaterForProgress:function(){this.groupId?this.$.progressAjax.url="/api/groups/"+this.groupId+"/"+this.jobId+"/endorsement_fraud_action_status":this.communityId?this.$.progressAjax.url="/api/communities/"+this.communityId+"/"+this.jobId+"/endorsement_fraud_action_status":this.domainId&&(this.$.progressAjax.url="/api/communities/"+this.domainId+"/"+this.jobId+"/endorsement_fraud_action_status"),this.async(function(){this.$.progressAjax.generateRequest()},1e3)},_menuSelection:function(){this.$.grid.querySelectorAll("paper-listbox").forEach(function(e){e.select(null)}),this._refreshGridAsync()},ready:function(){this._setGridSize(),window.addEventListener("resize",this._resizeThrottler.bind(this),!1)},_toPercent:function(e){return e?Math.round(100*e)+"%":null},_resizeThrottler:function(){this.resizeTimeout||(this.resizeTimeout=setTimeout(function(){this.resizeTimeout=null,this._setGridSize()}.bind(this),66))},_setGridSize:function(){window.innerWidth<=600?(this.$.grid.style.width=window.innerWidth.toFixed()+"px",this.$.grid.style.height=window.innerHeight.toFixed()+"px"):(this.$.grid.style.width=(window.innerWidth-16).toFixed()+"px",this.$.grid.style.height=(window.innerHeight-155).toFixed()+"px")},_totalItemsCount:function(e){return e?this.formatNumber(e.length):null},_selectedItemsChanged:function(){this.selectedItems&&0<this.selectedItems.length?(this.set("selectedItemsEmpty",!1),this.set("selectedItemsCount",this.selectedItems.length)):(this.set("selectedItemsEmpty",!0),this.set("selectedItemsCount",0)),this.selectedItemIds=this.selectedItems.map(function(e){return e.id}),this._refreshGridAsyncDelay()},_setupItemIdFromEvent:function(e){var t=e.target.parentElement.getAttribute("data-args");t=t||e.target.getAttribute("data-args"),this.set("selectedItemId",t);var s=e.target.parentElement.getAttribute("data-model-class");s=s||e.target.getAttribute("data-model-class"),this.set("selectedModelClass",s),this._refreshGridAsync()},_deleteSelected:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureDeleteSelectedContent"),this._reallyDeleteSelected.bind(this),!0,!0)}.bind(this))},_reallyDeleteSelected:function(){this._masterAjax("delete-items",this.selectedItemIds)},_delete:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureDeleteContent"),this._reallyDelete.bind(this),!0,!1)}.bind(this))},_reallyDelete:function(){this._masterAjax("delete-one-item")},_masterAjax:function(e){var t,s;if(this.set("jobId",null),"groups"===this.modelType&&this.groupId)s=this.groupId;else if("communities"===this.modelType&&this.communityId)s=this.communityId;else{if("domains"!==this.modelType||!this.domainId)return void console.error("Can't find model type or ids");s=this.domainId}if("delete-items"===e||"delete-one-item"===e?this.set("indeterminateProgress",!1):this.set("indeterminateProgress",!0),t="/api/"+this.modelType+"/"+s+"/"+e+"/"+this.selectedMethod+"/"+this.selectedCollectionType+"/start_endorsement_fraud_action","delete-one-item"===e||"delete-items"===e)if(this.selectedItemIds&&0<this.selectedItemIds.length)this.$.startAjax.body={idsToDelete:this.selectedItemIds};else{if(!this.selectedItemId)return void console.error("No item ids to process");this.$.startAjax.body={idsToDelete:[this.selectedItemId]}}else this.$.startAjax.body={};if(this.currentType=e,this.$.startAjax.url=t,this.$.startAjax.generateRequest(),this.set("inProgress",!0),this.selectedItemId){var i=this._findItemFromId(this.selectedItemId);i&&this.$.grid.deselectItem(i),this.selectedItemId=null,this.selectedModelClass=null}},_menuOpened:function(){this.allowGridEventsAfterMenuOpen=!0},_setSelected:function(e){var t=this._findItemFromId(e.target.getAttribute("data-args"));t&&this.$.grid.selectItem(t),this.allowGridEventsAfterMenuOpen=!0,this._refreshGridAsync()},_findItemFromId:function(t){var s;return this.items.forEach(function(e){e.id==t&&(s=e)}.bind(this)),s},_domainIdChanged:function(e){e&&this.set("modelType","domains")},_groupIdChanged:function(e){e&&this.set("modelType","groups")},_communityIdChanged:function(e){e&&this.set("modelType","communities")},_uncompressItems:function(e){for(var t=[],s=0;s<e.items.length;s++)e.items[s].backgroundColor=e.cBackgroundColors[e.items[s].backgroundColor],e.items[s].ip_address=e.cIpAddresses[e.items[s].ip_address],e.items[s].user_agent=e.cUserAgents[e.items[s].user_agent],e.items[s].User.email=e.cEmails[e.items[s].User.email],e.items[s].User.name=e.cNames[e.items[s].User.name],"endorsements"!==this.selectedCollectionType&&"ratings"!==this.selectedCollectionType&&"points"!==this.selectedCollectionType||(e.items[s].Post.name=e.cPostNames[e.items[s].Post.name]),"pointQualities"===this.selectedCollectionType&&(e.items[s].Point.Post.name=e.cPostNames[e.items[s].Point.Post.name]),"posts"===this.selectedCollectionType&&(e.items[s].name=e.cPostNames[e.items[s].name]),t.push(e.items[s]);return t},_startResponse:function(e,t){this.jobId=t.response.jobId,this.set("progress",25),this._pollLaterForProgress()},_progressResponse:function(e,t){!t.response.error&&null!==t.response.progress&&this.jobId&&t.response.progress<100&&this._pollLaterForProgress(),this.set("progress",t.response.progress),t.response.error&&(this.set("inProgress",!1),this.set("error",this.t(t.response.error))),100===t.response.progress&&(this.set("reload",!0),this._setupRenderers(),this.set("inProgress",!1),"delete-one-item"===this.currentType||"delete-items"===this.currentType?(this._reset(),this._masterAjax("get-items")):this.set("items",this._uncompressItems(t.response.data)))},_setupRenderers:function(){this.$$("#keyCol").renderer=function(e,t,s){e.innerHTML='\n            <div style="text-align: center;background-color: '.concat(s.item.backgroundColor,'">\n              ').concat(s.item.key,"\n            </div>\n          ")}.bind(this)},setup:function(e,t,s){this.set("groupId",null),this.set("communityId",null),this.set("domainId",null),e&&this.set("groupId",e),t&&this.set("communityId",t),s&&this.set("domainId",s),this._setupHeaderText()},open:function(e){this.set("collectionName",e),this.set("opened",!0),this.items&&this.selectedMethod&&this.selectedCollectionType&&this.modelType&&(this._reset(),this._masterAjax("get-items")),this.$.dialog.open()},_reset:function(){this.set("items",null),this._resetSelectedAndClearCache()},_resetSelectedAndClearCache:function(){this.set("selectedItemsCount",0),this.set("selectedItemsEmpty",!0),this.set("selectedItemIds",[]),this.set("selectedItems",[]),this.set("activeItem",null),this.set("reload",!1),this.$.grid.clearCache()},_setupHeaderText:function(){this.onlyFlaggedItems?this.set("itemsCountText",this.t("contentItemsFlagged")):this.set("itemsCountText",this.t("items")),this.groupId?this.set("headerText",this.t("groupFraudManagement")):this.communityId?this.set("headerText",this.t("communityFraudManagement")):this.domainId&&this.set("headerText",this.t("domainFraudManagement"))}})</script></dom-module><dom-module id="yp-content-moderation"assetpath="../yp-moderation/"><template><style include="iron-flex iron-flex-alignment">#dialog{width:100%;height:100%;margin:0;top:unset !important;left:unset !important;background-color:#FFF;}.itemItem{padding-right:16px;}.id{width:40px;}.name{width:200px;}.email{width:190px;overflow-wrap:break-word;}.addDeletedButtons{width:150px;}[hidden]{display:none !important;}paper-listbox{margin-right:8px !important;}.headerBox{background-color:var(--accent-color);color:#FFF;margin:0;padding:0 0;padding-top:12px;padding-bottom:10px;}paper-button{margin-left:8px;}#grid{margin-top:0;}.headerText{padding:0 0 !important;}.collectionName{font-size:22px;margin-bottom:1px;margin-top:4px;}.innerHeader{font-size:17px;color:#F5F5F5;}.closeButton{width:50px;height:50px;margin-left:4px;margin-right:4px;}paper-checkbox{color:#FFF !important;margin-top:16px;margin-right:24px;--primary-color:#FFF;--primary-text-color:#FFF;--paper-checkbox-checked-ink-color:#FFF;--paper-checkbox-unchecked-ink-color:#FFF;}@media (max-width: 600px){.closeButton{width:45px;height:45px;}paper-listbox{margin-right:8px;}#dialog{width:100%;height:100%;margin:0;padding:0;}.headerText{font-size:20px;line-height:1.2em;text-align:center;}}.details{display:flex;margin:8px;}yp-point{min-height:100px;max-width:500px;margin-bottom:8px;}yp-post-header{margin-bottom:8px;}paper-button{font-size:18px;margin-top:16px;}.analysis{margin-top:12px;color:#656565;}.leftColumn{padding-right:16px;}.mainScore{color:#000;}paper-spinner{margin-left:20px;margin-top:8px;--paper-spinner-layer-1-color:#FFF;--paper-spinner-layer-2-color:#FFF;--paper-spinner-layer-3-color:#FFF;--paper-spinner-layer-4-color:#FFF;}.linkIcon{color:#000;}vaadin-grid{font-size:14px;}</style><lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal><paper-dialog id="dialog"modal=""><div class="layout horizontal headerBox wrap"><div><paper-icon-button aria-label$="[[t('close')]]"id="dismissBtn"icon="close"class="closeButton"dialog-dismiss=""></paper-icon-button></div><div class="headerText layout vertical"><div class="layout horizontal"><div class="collectionName">[[collectionName]]</div></div><div class="innerHeader">[[headerText]] <span hidden$="[[!totalItemsCount]]">([[totalItemsCount]] [[itemsCountText]])</span></div></div><div hidden$="[[!spinnerActive]]"><paper-spinner active=""></paper-spinner></div><div class="flex"></div><div class="checkBox"hidden$="[[narrow]]"><paper-checkbox checked="{{multiSortEnabled}}">[[t('multiSortEnabled')]]</paper-checkbox></div><div hidden$="[[!showReload]]"><paper-icon-button aria-label$="[[t('reload')]]"icon="autorenew"class="closeButton"on-tap="_reload"></paper-icon-button></div></div><vaadin-grid id="grid"multi-sort="[[multiSortEnabled]]"active-item="{{activeItem}}"aria-label$="[[headerText]]"items="[[items]]"selected-items="{{selectedItems}}"><vaadin-grid-selection-column></vaadin-grid-selection-column><template class="row-details"><div class="details layout vertical center-center detailArea"><div class="layout horizontal"><template is="dom-if"if="[[item.is_post]]"><div class="layout vertical center-center"><yp-post-header hide-actions=""post="[[item]]"post-name="[[item.name]]"header-mode=""></yp-post-header><a href="/post/[[item.id]]"target="_blank"><paper-icon-button aria-label$="[[t('linkToContentItem')]]"class="linkIcon"icon="link"></paper-icon-button></a></div></template><template is="dom-if"if="[[item.is_point]]"><div class="layout vertical center-center"><yp-point hide-actions=""point="[[item]]"post="[[item.Post]]"></yp-point><a hidden$="[[!item.post_id]]"href="/post/[[item.post_id]]/[[item.id]]"target="_blank"><paper-icon-button aria-label$="[[t('linkToContentItem')]]"class="linkIcon"icon="link"></paper-icon-button></a></div></template></div><div hidden$="[[!item.toxicityScore]]"class="layout horizontal analysis"><div class="layout vertical leftColumn"hidden$="[[userId]]"><div class="mainScore"hidden$="[[!item.moderation_data.moderation.toxicityScore]]">Toxicity Score: [[_toPercent(item.moderation_data.moderation.toxicityScore)]]</div><div hidden$="[[!item.moderation_data.moderation.identityAttackScore]]">Identity Attack Score: [[_toPercent(item.moderation_data.moderation.identityAttackScore)]]</div><div hidden$="[[!item.moderation_data.moderation.identityAttachScore]]">Identity Attack Score: [[_toPercent(item.moderation_data.moderation.identityAttachScore)]]</div><div hidden$="[[!item.moderation_data.moderation.threatScore]]">Threat Score: [[_toPercent(item.moderation_data.moderation.threatScore)]]</div><div hidden$="[[!item.moderation_data.moderation.insultScore]]">Insult Score: [[_toPercent(item.moderation_data.moderation.insultScore)]]</div></div><div class="layout vertical"hidden$="[[userId]]"><div class="mainScore"hidden$="[[!item.moderation_data.moderation.severeToxicityScore]]">Severe Toxicity Score: [[_toPercent(item.moderation_data.moderation.severeToxicityScore)]]</div><div hidden$="[[!item.moderation_data.moderation.profanityScore]]">Profanity Score: [[_toPercent(item.moderation_data.moderation.profanityScore)]]</div><div hidden$="[[!item.moderation_data.moderation.sexuallyExplicitScore]]">Sexually Excplicit Score: [[_toPercent(item.moderation_data.moderation.sexuallyExplicitScore)]]</div><div hidden$="[[!item.moderation_data.moderation.flirtationScore]]">Flirtation Score: [[_toPercent(item.moderation_data.moderation.flirtationScore)]]</div></div></div></div></template><vaadin-grid-sort-column width="130px"flex-grow="0"path="firstReportedDate"header="[[t('firstReported')]]"hidden$="[[onlyFlaggedItems]]"><template>[[item.firstReportedDateFormatted]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="130px"flex-grow="0"path="lastReportedAtDate"header="[[t('lastReported')]]"hidden$="[[userId]]"><template>[[item.lastReportedAtDateFormatted]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"text-align="start"flex-grow="0"path="type"header="[[t('type')]]"><template>[[_getType(item.type)]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"text-align="start"flex-grow="0"path="status"header="[[t('publishStatus')]]"><template>[[item.status]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="100px"text-align="center"flex-grow="0"path="counter_flags"header="[[t('flags')]]"hidden$="[[userId]]"><template>[[item.counter_flags]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="130px"text-align="start"flex-grow="0"path="source"header="[[t('source')]]"hidden$="[[!onlyFlaggedItems]]"><template>[[item.source]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="105px"text-align="center"flex-grow="0"path="toxicityScoreRaw"header="[[t('toxicityScore')]]?"hidden$="[[userId]]"><template>[[item.toxicityScore]]</template></vaadin-grid-sort-column><vaadin-grid-sort-column width="150px"text-align="start"flex-grow="1"path="groupName"header="[[t('groupName')]]"hidden$="[[!userId]]"><template>[[item.groupName]]</template></vaadin-grid-sort-column><vaadin-grid-filter-column width="200px"flex-grow="4"path="content"header="[[t('content')]]"hidden$="[[narrow]]"><template><div class="layout horizontal"><yp-magic-text content-id="[[item.id]]"content="[[item.pointTextContent]]"text-type="pointContent"></yp-magic-text><yp-magic-text content-id="[[item.id]]"content="[[item.postNameContent]]"text-type="postName"></yp-magic-text>&nbsp;<yp-magic-text content-id="[[item.id]]"content="[[item.postTextContent]]"text-type="postContent"></yp-magic-text>&nbsp;<yp-magic-text content-id="[[item.id]]"content="[[item.postTranscriptContent]]"text-type="postTranscriptContent"></yp-magic-text></div></template></vaadin-grid-filter-column><vaadin-grid-filter-column flex-grow="1"path="user_email"width="150px"header="[[t('creator')]]"hidden$="[[userId]]"><template>[[item.user_email]]</template></vaadin-grid-filter-column><vaadin-grid-filter-column flex-grow="0"path="lastReportedByEmail"width="150px"header="[[t('flaggedBy')]]"hidden$="[[!onlyFlaggedItems]]"></vaadin-grid-filter-column><vaadin-grid-column width="70px"flex-grow="0"><template class="header"><paper-menu-button horizontal-align="right"on-opened-changed="_refreshGridAsyncDelay"class="helpButton"disabled$="[[selectedItemsEmpty]]"><paper-icon-button aria-label$="[[t('openSelectedItemsMenu')]]"icon="more-vert"slot="dropdown-trigger"on-tap="_menuOpened"></paper-icon-button><paper-listbox slot="dropdown-content"on-iron-select="_menuSelection"><template is="dom-if"if="[[!selectedItemsEmpty]]"restamp=""><paper-item data-args$="[[item.id]]"hidden$="[[userId]]"on-tap="_approveSelected">[[t('approveSelectedContent')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"hidden$="[[!onlyFlaggedItems]]"on-tap="_clearSelectedFlags">[[t('clearSelectedFlags')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"hidden$="[[userId]]"on-tap="_blockSelected">[[t('blockSelectedContent')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"hidden$="[[!userId]]"on-tap="_anonymizeSelected">[[t('anonymizeSelectedContent')]] [[selectedItemsCount]]</paper-item><paper-item data-args$="[[item.id]]"on-tap="_deleteSelected">[[t('deleteSelectedContent')]] [[selectedItemsCount]]</paper-item></template></paper-listbox></paper-menu-button></template><template><paper-menu-button horizontal-align="right"class="helpButton"on-opened-changed="_refreshGridAsyncDelay"><paper-icon-button aria-label$="[[t('openOneItemMenu')]]"icon="more-vert"data-args$="[[item.id]]"on-tap="_setSelected"slot="dropdown-trigger"></paper-icon-button><paper-listbox slot="dropdown-content"on-iron-select="_menuSelection"><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[userId]]"on-tap="_approve">[[t('approveContent')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[!onlyFlaggedItems]]"on-tap="_clearFlags">[[t('clearFlags')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[userId]]"on-tap="_block">[[t('blockContent')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"hidden$="[[!userId]]"on-tap="_anonymize">[[t('anonymizeContent')]]</paper-item><paper-item data-args$="[[item.id]]"data-model-class$="[[item.type]]"on-tap="_delete">[[t('deleteContent')]]</paper-item></paper-listbox></paper-menu-button></template></vaadin-grid-column></vaadin-grid></paper-dialog><div class="layout horizontal center-center"><yp-ajax id="ajax"on-response="_itemsResponse"on-error="_ajaxError"></yp-ajax><yp-ajax method="DELETE"id="singleItemAjax"on-error="_ajaxError"on-response="_singleItemResponse"></yp-ajax><yp-ajax method="DELETE"id="manyItemsAjax"on-error="_ajaxError"on-response="_manyItemsResponse"></yp-ajax></div><iron-media-query query="(max-width: 600px)"query-matches="{{narrow}}"></iron-media-query></template><script>Polymer({is:"yp-content-moderation",behaviors:[Polymer.ypLanguageBehavior,Polymer.ypNumberFormatBehavior],properties:{multiSortEnabled:{type:Boolean,value:!1},items:{type:Array,notify:!0,value:null},headerText:{type:String},groupId:{type:Number,observer:"_groupIdChanged"},domainId:{type:Number,observer:"_domainIdChanged"},communityId:{type:Number,observer:"_communityIdChanged"},userId:{type:Number,observer:"_userIdChanged"},selected:{type:Object},modelType:{type:String},opened:{type:Boolean,value:!1},selectedItems:{type:Array,notify:!0},selectedItemsCount:{type:Number,value:0},selectedItemsEmpty:{type:Boolean,value:!0},selectedItemIdsAndType:{type:Array},selectedItemId:{type:String},selectedModelClass:{type:String},totalItemsCount:{type:String,computed:"_totalItemsCount(items)"},collectionName:String,itemsCountText:String,resizeTimeout:{type:Object,value:null},activeItem:{type:Object,observer:"_activeItemChanged"},typeOfModeration:{type:String,value:"/flagged_content"},onlyFlaggedItems:{type:Boolean,computed:"_onlyFlaggedItems(typeOfModeration)"},showReload:{type:Boolean,value:!1},forceSpinner:{type:Boolean,value:!1},spinnerActive:{type:Boolean,computed:"_spinnerActive(totalItemsCount, forceSpinner)"}},_spinnerActive:function(e,t){return!e||t},observers:["_selectedItemsChanged(selectedItems.splices)"],_ajaxError:function(){this.set("forceSpinner",!1)},_reload:function(){this.$.ajax.generateRequest(),this.set("forceSpinner",!0)},_onlyFlaggedItems:function(e){return"/flagged_content"===e},_manyItemsResponse:function(){this.set("forceSpinner",!1),this.set("showReload",!0),window.appGlobals.notifyUserViaToast(this.t("operationInProgressTryReloading"))},_singleItemResponse:function(){this._reload()},_getType:function(e){return"post"===e?this.t("posts.post"):"point"===e?this.t("point.point"):void 0},_activeItemChanged:function(e,t){e&&this.$.grid.openItemDetails(e),t&&this.$.grid.closeItemDetails(t),this._refreshGridAsync()},_refreshGridAsync:function(){this._refreshGridAsyncBase(10)},_refreshGridAsyncDelay:function(){this.allowGridEventsAfterMenuOpen&&this._refreshGridAsyncBase(250)},_refreshGridAsyncBase:function(e){this.async(function(){this.$.grid.fire("iron-resize"),this.$.grid.notifyResize()},e)},_menuSelection:function(){this.$.grid.querySelectorAll("paper-listbox").forEach(function(e){e.select(null)}),this._refreshGridAsync()},ready:function(){this._setGridSize(),window.addEventListener("resize",this._resizeThrottler.bind(this),!1)},_toPercent:function(e){return e?Math.round(100*e)+"%":null},_resizeThrottler:function(){this.resizeTimeout||(this.resizeTimeout=setTimeout(function(){this.resizeTimeout=null,this._setGridSize()}.bind(this),66))},_setGridSize:function(){window.innerWidth<=600?(this.$.grid.style.width=window.innerWidth.toFixed()+"px",this.$.grid.style.height=window.innerHeight.toFixed()+"px"):(this.$.grid.style.width=(window.innerWidth-16).toFixed()+"px",this.$.grid.style.height=(window.innerHeight-64).toFixed()+"px")},_totalItemsCount:function(e){return e?this.formatNumber(e.length):null},_selectedItemsChanged:function(){this.selectedItems&&0<this.selectedItems.length?(this.set("selectedItemsEmpty",!1),this.set("selectedItemsCount",this.selectedItems.length)):(this.set("selectedItemsEmpty",!0),this.set("selectedItemsCount",0)),this.selectedItemIdsAndType=this.selectedItems.map(function(e){return{id:e.id,modelType:e.type}}),this._refreshGridAsyncDelay()},_setupItemIdFromEvent:function(e){var t=e.target.parentElement.getAttribute("data-args");t=t||e.target.getAttribute("data-args"),this.set("selectedItemId",t);var s=e.target.parentElement.getAttribute("data-model-class");s=s||e.target.getAttribute("data-model-class"),this.set("selectedModelClass",s),this._refreshGridAsync()},_deleteSelected:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureDeleteSelectedContent"),this._reallyDeleteSelected.bind(this),!0,!0)}.bind(this))},_reallyDeleteSelected:function(){this._ajaxMaster(this.$.manyItemsAjax,"delete",this.selectedItemIdsAndType)},_delete:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureDeleteContent"),this._reallyDelete.bind(this),!0,!1)}.bind(this))},_reallyDelete:function(){this._ajaxMaster(this.$.singleItemAjax,"delete")},_anonymizeSelected:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureAnonymizeSelectedContent"),this._reallyAnonymizeSelected.bind(this),!0,!0)}.bind(this))},_reallyAnonymizeSelected:function(){this._ajaxMaster(this.$.manyItemsAjax,"anonymize",this.selectedItemIdsAndType)},_anonymize:function(e){this._setupItemIdFromEvent(e),Polymer.dom(document).querySelector("yp-app").getDialogAsync("confirmationDialog",function(e){e.open(this.t("areYouSureAnonymizeContent"),this._reallyAnonymize.bind(this),!0,!1)}.bind(this))},_reallyAnonymize:function(){this._ajaxMaster(this.$.singleItemAjax,"anonymize")},_approve:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.singleItemAjax,"approve")},_approveSelected:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.manyItemsAjax,"approve",this.selectedItemIdsAndType)},_block:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.singleItemAjax,"block")},_blockSelected:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.manyItemsAjax,"block",this.selectedItemIdsAndType)},_clearFlags:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.singleItemAjax,"clearFlags")},_clearSelectedFlags:function(e){this._setupItemIdFromEvent(e),this._ajaxMaster(this.$.manyItemsAjax,"clearFlags",this.selectedItemIdsAndType)},_ajaxMaster:function(e,t,s){var i,n;if("groups"===this.modelType&&this.groupId)n=this.groupId;else if("communities"===this.modelType&&this.communityId)n=this.communityId;else if("domains"===this.modelType&&this.domainId)n=this.domainId;else{if("users"!==this.modelType||!this.userId)return void console.error("Can't find model type or ids");n=this.userId}if(s&&0<s.length)i="/api/"+this.modelType+"/"+n+"/"+t+"/process_many_moderation_item",e.body={items:s};else{if(!this.selectedItemId)return void console.error("No item ids to process");i="/api/"+this.modelType+"/"+n+"/"+this.selectedItemId+"/"+this.selectedModelClass+"/"+t+"/process_one_moderation_item",e.body={}}if(e.url=i,e.generateRequest(),this.set("forceSpinner",!0),this.selectedItemId){var o=this._findItemFromId(this.selectedItemId);o&&this.$.grid.deselectItem(o),this.selectedItemId=null,this.selectedModelClass=null}},_menuOpened:function(){this.allowGridEventsAfterMenuOpen=!0},_setSelected:function(e){var t=this._findItemFromId(e.target.getAttribute("data-args"));t&&this.$.grid.selectItem(t),this.allowGridEventsAfterMenuOpen=!0,this._refreshGridAsync()},_findItemFromId:function(t){var s;return this.items.forEach(function(e){e.id==t&&(s=e)}.bind(this)),s},_domainIdChanged:function(e){e&&(this._reset(),this.set("modelType","domains"),this._generateRequest(e))},_groupIdChanged:function(e){e&&(this._reset(),this.set("modelType","groups"),this._generateRequest(e))},_communityIdChanged:function(e){e&&(this._reset(),this.set("modelType","communities"),this._generateRequest(e))},_userIdChanged:function(e){e&&(this._reset(),this.set("modelType","users"),this._generateRequest(e))},_generateRequest:function(e){this.$.ajax.url="/api/"+this.modelType+"/"+e+this.typeOfModeration,this.$.ajax.generateRequest()},_itemsResponse:function(e,t){this.set("forceSpinner",!1),this.set("items",t.response),this._resetSelectedAndClearCache()},setup:function(e,t,s,i,n){i?this.set("typeOfModeration",i):this.set("typeOfModeration","/flagged_content"),this.set("groupId",null),this.set("communityId",null),this.set("domainId",null),this.set("userId",null),this.set("items",null),e&&this.set("groupId",e),t&&this.set("communityId",t),s&&this.set("domainId",s),n&&this.set("userId",n),this._setupHeaderText()},open:function(e){this.set("collectionName",e),this.set("opened",!0),this.$.dialog.open()},_reset:function(){this.set("items",null),this._resetSelectedAndClearCache()},_resetSelectedAndClearCache:function(){this.set("selectedItemsCount",0),this.set("selectedItemsEmpty",!0),this.set("selectedItemIdsAndType",[]),this.set("selectedItems",[]),this.$.grid.clearCache()},_setupHeaderText:function(){this.onlyFlaggedItems?this.set("itemsCountText",this.t("contentItemsFlagged")):this.set("itemsCountText",this.t("items")),this.groupId?this.set("headerText",this.t("groupContentModeration")):this.communityId?this.set("headerText",this.t("communityContentModeration")):this.domainId?this.set("headerText",this.t("domainContentModeration")):this.userId&&this.set("headerText",this.t("userContentModeration"))}})</script></dom-module></div>