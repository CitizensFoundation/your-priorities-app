<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<link rel="import" href="../yp-behaviors/app-helpers.html">
<link rel="import" href="../yp-ajax/yp-ajax.html">
<link rel="import" href="../yp-behaviors/word-wrap.html">

</head><body><dom-module id="yp-pages-grid">
  <template>
    <style>
      #dialog {
        width: 90%;
        max-height: 90%;
        background-color: #FFF;
      }

      iron-list {
        color: #000;
        height: 500px;
        width: 100%;
      }

      .pageItem {
        padding-right: 16px;
      }

      .id {
        width: 60px;
      }

      .title {
        width: 200px;
      }

      .email {
        width: 240px;
      }

      #editPageLocale {
        width: 80%;
        max-height: 80%;
        background-color: #FFF;
      }

      .locale {
        width: 30px;
        cursor: pointer;
      }

      paper-textarea {
        height: 60%;
      }

      .localeInput {
        width: 26px;
      }

      .pageItem {
        padding-top: 8px;
      }
    </style>
    <iron-signals on-iron-signal-yp-language="_languageEvent"></iron-signals>

    <paper-dialog id="editPageLocale" modal="" class="layout vertical">
      <h2>[[t('page.editPageLocale')]]</h2>

      <paper-dialog-scrollable>
        <paper-input id="title" name="title" type="text" label="[[t('pages.title')]]" value="{{currentlyEditingTitle}}" maxlength="60" char-counter="" class="mainInput">
        </paper-input>

        <paper-textarea id="content" name="content" value="{{currentlyEditingContent}}" label="[[t('pages.content')]]" rows="7" max-rows="10">
        </paper-textarea>
      </paper-dialog-scrollable>


      <div class="buttons">
        <paper-button on-tap="_closePageLocale" dialog-dismiss="">[[t('close')]]</paper-button>
        <paper-button on-tap="_updatePageLocale" dialog-dismiss="">[[t('save')]]</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="dialog">
      <h2>[[headerText]]</h2>
      <iron-list items="[[pages]]" as="page">
        <template>
          <div class="layout horizontal">
            <div class="pageItem id">
              [[page.id]]
            </div>
            <div class="pageItem title">
              [[page.title.en]]
            </div>
            <template is="dom-repeat" items="[[_toLocaleArray(page.title)]]" class="pageItem">
              <div class="layout vertical center-center">
                <a class="locale" data-args-page$="[[page]]" data-args-locale$="[[item.locale]]" on-tap="_editPageLocale">[[item.locale]]</a>
              </div>
            </template>
            <paper-input no-label-float="" class="localeInput" length="2" maxlength="2" value="{{newLocaleValue}}"></paper-input>
            <paper-button data-args$="[[page.id]]" on-tap="_addLocale">[[t('pages.addLocale')]]</paper-button>
            <div hidden$="[[page.published]]">
              <paper-button data-args$="[[page.id]]" on-tap="_publishPage">[[t('pages.publish')]]</paper-button>
            </div>
            <div hidden$="[[!page.published]]">
              <paper-button data-args$="[[page.id]]" on-tap="_unPublishPage">[[t('pages.unPublish')]]</paper-button>
            </div>
            <paper-button data-args$="[[page.id]]" on-tap="_deletePage">[[t('pages.deletePage')]]</paper-button>
          </div>
        </template>
      </iron-list>
      <div class="layout horizontal">
        <paper-button id="addPageButton" on-tap="_addPage">[[t('pages.addPage')]]</paper-button>
      </div>

      <div class="buttons">
        <paper-button dialog-dismiss="">[[t('close')]]</paper-button>
      </div>
    </paper-dialog>

    <div class="layout horizontal center-center">
      <yp-ajax id="ajax" on-response="_pagesResponse"></yp-ajax>
      <yp-ajax method="POST" id="newPageAjax" on-response="_newPageResponse"></yp-ajax>
      <yp-ajax method="DELETE" id="deletePageAjax" on-response="_deletePageResponse"></yp-ajax>
      <yp-ajax method="PUT" id="updatePageAjax" on-response="_updatePageResponse"></yp-ajax>
      <yp-ajax method="PUT" id="publishPageAjax" on-response="_publishPageResponse"></yp-ajax>
      <yp-ajax method="PUT" id="unPublishPageAjax" on-response="_unPublishPageResponse"></yp-ajax>
    </div>

  </template>

  <script>Polymer({is:"yp-pages-grid",behaviors:[Polymer.appHelpers,Polymer.WordWrap],properties:{pages:{type:Array,notify:!0},headerText:{type:String},groupId:{type:Number,observer:"_groupIdChanged"},domainId:{type:Number,observer:"_domainIdChanged"},communityId:{type:Number,observer:"_communityIdChanged"},selected:{type:Object},modelType:{type:String},newLocaleValue:{type:String},currentlyEditingLocale:{type:String},currentlyEditingPage:{type:Object},currentlyEditingTitle:{type:String},currentlyEditingContent:{type:String}},_toLocaleArray:function(e){var t=Object.keys(e).map(function(t){return{locale:t,value:e[t]}});return _.sortBy(t,function(e){return e.item})},_editPageLocale:function(e){this.set("currentlyEditingPage",JSON.parse(e.target.getAttribute("data-args-page"))),this.set("currentlyEditingLocale",e.target.getAttribute("data-args-locale")),this.set("currentlyEditingContent",this.wordwrap(120)(this.currentlyEditingPage.content[this.currentlyEditingLocale])),this.set("currentlyEditingTitle",this.currentlyEditingPage.title[this.currentlyEditingLocale]),this.$.editPageLocale.open()},_closePageLocale:function(){this.set("currentlyEditingPage",null),this.set("currentlyEditingLocale",null),this.set("currentlyEditingContent",null),this.set("currentlyEditingTitle",null)},_dispatchAjax:function(e,t,a){var i;i=t?"/"+t+"/"+a:"/"+a,"groups"==this.modelType&&this.groupId?(e.url="/api/"+this.modelType+"/"+this.groupId+i,e.generateRequest()):"communities"==this.modelType&&this.communityId?(e.url="/api/"+this.modelType+"/"+this.communityId+i,e.generateRequest()):"domains"==this.modelType&&this.domainId?(e.url="/api/"+this.modelType+"/"+this.domainId+i,e.generateRequest()):console.warn("Can't find model type or ids")},_updatePageLocale:function(){this.$.updatePageAjax.body={locale:this.currentlyEditingLocale,content:this.currentlyEditingContent,title:this.currentlyEditingTitle},this._dispatchAjax(this.$.updatePageAjax,this.currentlyEditingPage.id,"update_page_locale"),this._closePageLocale()},_publishPage:function(){this.$.updatePageAjax.body={};var e=event.target.getAttribute("data-args");this._dispatchAjax(this.$.updatePageAjax,e,"publish_page")},_publishPageResponse:function(){window.appGlobals.notifyUserViaToast(this.t("pages.pagePublished")),this.$.ajax.generateRequest()},_unPublishPage:function(){this.$.updatePageAjax.body={};var e=event.target.getAttribute("data-args");this._dispatchAjax(this.$.updatePageAjax,e,"un_publish_page")},_unPublishPageResponse:function(){window.appGlobals.notifyUserViaToast(this.t("pages.pageUnPublished")),this.$.ajax.generateRequest()},_deletePage:function(){this.$.deletePageAjax.body={};var e=event.target.getAttribute("data-args");this._dispatchAjax(this.$.deletePageAjax,e,"delete_page")},_deletePageResponse:function(){window.appGlobals.notifyUserViaToast(this.t("pages.pageDeleted")),this.$.ajax.generateRequest()},_addLocale:function(e){if(this.newLocaleValue&&this.newLocaleValue.length>1){var t=e.target.getAttribute("data-args");this.$.updatePageAjax.body={locale:this.newLocaleValue.toLowerCase(),content:"",title:""},this._dispatchAjax(this.$.updatePageAjax,t,"update_page_locale"),this.set("newLocaleValue",null)}},_addPage:function(e){this.$.newPageAjax.body={},this.$.addPageButton.disabled=!0,this._dispatchAjax(this.$.newPageAjax,null,"add_page")},_newPageResponse:function(){window.appGlobals.notifyUserViaToast(this.t("pages.newPageCreated")),this.$.ajax.generateRequest(),this.$.addPageButton.disabled=!1},_updatePageResponse:function(){window.appGlobals.notifyUserViaToast(this.t("posts.updated")),this.$.ajax.generateRequest()},_domainIdChanged:function(e){e&&(this.set("modelType","domains"),this._generateRequest(e))},_groupIdChanged:function(e){e&&(this.set("modelType","groups"),this._generateRequest(e))},_communityIdChanged:function(e){e&&(this.set("modelType","communities"),this._generateRequest(e))},_generateRequest:function(e){this.$.ajax.url="/api/"+this.modelType+"/"+e+"/pages_for_admin",this.$.ajax.generateRequest()},_pagesResponse:function(e,t){this.set("pages",t.response)},setup:function(e,t,a,i){this.set("groupId",null),this.set("communityId",null),this.set("domainId",null),this.set("pages",null),e&&this.set("groupId",e),t&&this.set("communityId",t),a&&this.set("domainId",a),this._setupHeaderText()},open:function(){this.$.dialog.open()},_setupHeaderText:function(){this.groupId?this.set("headerText",this.t("group.pages")):this.communityId?this.set("headerText",this.t("community.pages")):this.domainId&&this.set("headerText",this.t("domain.pages"))}});</script>
</dom-module>
</body></html>