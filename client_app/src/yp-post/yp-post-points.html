<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">

<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../yp-app-globals/paper-textarea-aria.html">
<link rel="import" href="../yp-app-globals/yp-app-icons.html">
<link rel="import" href="../yp-behaviors/yp-iron-list-behavior.html">
<link rel="import" href="../yp-behaviors/yp-language-behavior.html">
<link rel="import" href="../yp-behaviors/emoji-selector.html">
<link rel="import" href="../yp-point/yp-point.html">
<link rel="import" href="../yp-behaviors/yp-truncate-behavior.html">
<link rel="import" href="../yp-file-upload/yp-file-upload.html">

<dom-module id="yp-post-points">
  <template>
    <style include="iron-flex iron-flex-alignment">

      :host {
        display: block;
      }

      .item {
        @apply --layout-horizontal;
      }

      paper-button, paper-textarea-aria {
          font-family: var(--app-normal-font-family, Roboto);
      }

      .main-container {
        @apply --layout-horizontal;
        background-color: var(--primary-background-color);
      }

      .point {
        padding-top: 32px;
        padding-bottom: 32px;
        padding-left: 24px;
        padding-right: 24px;
        @apply --layout-vertical;
        width: 398px;
      }

      .pointInputMaterial {
        padding-top: 24px;
        padding-left: 16px;
        padding-right: 16px;
        padding-bottom: 16px;
        margin-bottom: 16px;
        background-color: #FFF;
      }

      paper-toast {
        z-index: 9999;
      }

      paper-material {
        background-color: #fff;
      }

      yp-point {
        padding-top: 8px;
      }

      .pointMaterial {
        padding-top: 8px;
        background-color: #FFF;
        padding-left: 0;
        padding-right: 0;
        width: 430px;
        margin-bottom: 12px;
      }

      .thumbIcon {
        height: 64px;
        width: 64px;
        padding-bottom: 16px;
        color: var(--primary-color);
      }

      .editIcon {
        height: 28px;
        width: 28px;
        padding-bottom: 16px;
        color: var(--primary-color);
      }

      .addPointFab {
        width: 100%;
        color: #FFF;
        margin-bottom: 18px;
      }

      paper-textarea-aria {
        --paper-input-container-label: {
          font-size: 22px;
          height: 30px;
          overflow: visible;
          color: #AAAAAA;
          font-family: var(--app-normal-font-family, Roboto);
        };
        font-family: var(--app-normal-font-family, Roboto);
      }

      .howToWriteInfoText {
        padding-top: 4px;
        color: var(--primary-color);
      }

      .point .main-container .topContainer {
        background-color: var(--primary-background-color) !important;
      }

      .penContainer {
        margin-top: 42px;
      }

      .upOrDown {
        margin-top: 72px;
      }

      paper-radio-button {
        --paper-radio-button-checked-color: var(--accent-color) !important;
        font-size: 16px;
      }

      #pointUpOrDownMaterial {
        margin-top: 16px;
        width: 100%;
      }

      .mobileFab {
        margin-top: 8px;
      }

      paper-button {
        color: #FFF;
        background-color: var(--accent-color);
      }

      @media (max-width: 985px) {
        .pointInputMaterial {
          width: 100%;
          max-width: 568px;
          font-size: 14px;
          padding-top: 4px;
          margin-top: 0;
        }

        .pointMaterial {
          width: 100%;
          max-width: 600px;
          padding-left: 0;
          padding-right: 0;
        }

        #pointUpOrDownMaterial {
          margin-top: 16px;
        }

        .main-container {
          width: 100%;
        }

        iron-list {
          width: 100vw;
        }

        .pointMaterial {
        }
      }

      @media (max-width: 420px) {
        .pointInputMaterial {
          width: 90%;
          max-width: 90%;
        }
      }

      .mobilePaperTextArea {
        --paper-input-container-label: {
          font-size: 19px;
            font-family: var(--app-normal-font-family, Roboto);
        };
        font-family: var(--app-normal-font-family, Roboto);
      }

      .pointMainHeader {
        font-size: 26px;
        margin-bottom: 16px;
        color: #555;
      }

      #pointUpMaterialNotUsed {
        border-top: solid 2px;
        border-top-color:  var(--master-point-up-color);
      }

      #pointDownMaterialNotUsed {
        border-top: solid 2px;
        border-top-color: var(--master-point-down-color);
      }

      .pointElement {
        margin-bottom: 18px;
      }

      [hidden] {
        display: none !important;
      }

      iron-list {
        height: 80vh;
      }

      iron-list {
        --iron-list-items-container: {
        };
      }

      :focus {

      }

      #ironListMobile[debate-disabled] {
        margin-top: 16px;
      }

      .mainSpinner {
        margin: 32px;
      }

      paper-button[disabled] {
        background-color: #333;
        color: #FFF;
      }

      .uploadNotLoggedIn {
        min-width: 100px;
        background-color: #FFF;
        color: #000;
        margin-bottom: 24px;
      }

      .uploadNotLoggedIn > .icon {
        padding-right: 8px;
      }

      .pointButtons {
        margin-bottom: 4px;
      }

      .bottomDiv {
        margin-bottom: 64px;
      }

      .uploadSection {
        justify-content: space-evenly;
        width: 50%;
        margin-left: 8px;
        margin-right: 8px;
        vertical-align: top;
      }

      .videoUploadDisclamer {
        font-size: 12px;
        padding: 8px;
        margin-bottom: 4px;
      }

      .pointMaterialMobile[is-last-point] {
        margin-bottom: 107px;
      }

      div[rtl] {
        direction: rtl;
      }

      paper-radio-button {
        --paper-radio-button-label: {
          padding-right: 6px;
        }
      }
    </style>
    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>
    <lite-signal on-lite-signal-yp-update-points-for-post="_loadNewPointsIfNeeded"></lite-signal>
    <lite-signal on-lite-signal-logged-in="_userLoggedIn"></lite-signal>

    <iron-media-query query="(min-width: 985px)" query-matches="{{largeMode}}"></iron-media-query>

    <div class="layout horizontal center-center" hidden$="[[ajaxActive]]">
      <yp-ajax id="ajax" large-spinner active$="{{ajaxActive}}" on-response="_response"></yp-ajax>
    </div>

    <div class="layout horizontal center-center" hidden>
      <yp-ajax id="moreAjax" hidden on-response="_morePointsResponse"></yp-ajax>
    </div>

    <template is="dom-if" if="[[largeModeReady]]" restamp>
      <div rtl$="[[rtl]]" class="layout vertical topContainer">
        <div class="main-container">
          <div class="point">
            <template is="dom-if" if="[[!post.Group.configuration.alternativePointForHeader]]">
              <div class="pointMainHeader layout horizontal center-center" role="heading" aria-level="2">
                [[t('pointsFor')]]
              </div>
            </template>

            <template is="dom-if" if="[[post.Group.configuration.alternativePointForHeader]]">
              <div class="pointMainHeader layout horizontal center-center">

                <yp-magic-text content-id="[[post.Group.id]]" text-only content="[[post.Group.configuration.alternativePointForHeader]]"
                               content-language="[[post.Group.language]]" role="heading" aria-level="2"
                               class="ratingName" text-type="alternativePointForHeader"></yp-magic-text>

              </div>
            </template>

            <paper-material id="pointUpMaterial" elevation="1" class="pointInputMaterial layout vertical"
                            animated hidden$="[[disableDebate]]">

              <paper-textarea-aria id="up_point" on-tap="focusUpPoint" on-focus="focusTextArea" on-blur="blurTextArea"
                              value="{{textValueUp}}"
                              label="[[labelUp]]"
                              always-float-label="[[_floatIfValueOrIE()]]"
                              char-counter rows="2" hidden$="[[hideUpText]]"
                              max-rows="3" maxlength="[[pointMaxLength]]">
              </paper-textarea-aria>

              <div class="horizontal end-justified layout" hidden$="[[post.Group.configuration.hideEmoji]]">
                <emoji-selector id="pointUpEmojiSelector" hidden$="[[hideUpText]]"></emoji-selector>
              </div>

              <div class="layout horizontal center-justified">
                <template is="dom-if" if="[[post.Group.configuration.allowPointVideoUploads]]">
                  <div hidden$="[[hideUpVideo]]" class="uploadSection">
                    <div class="layout vertical center-center self-start" hidden$="[[!loggedInUser]]">
                      <yp-file-upload id="videoFileUploadUp" upload-limit-seconds="[[post.Group.configuration.videoPointUploadLimitSec]]"
                                      no-default-cover-image
                                      current-file="{{hasCurrentUpVideo}}" container-type="points" group="[[post.Group]]"
                                      raised="true" multi="false" video-upload method="POST" on-success="_videoUpUploaded">
                        <iron-icon class="icon" icon="videocam"></iron-icon>
                        <span>[[t('uploadVideoPointFor')]]</span>
                      </yp-file-upload>
                    </div>
                    <div hidden$="[[!post.Group.configuration.showVideoUploadDisclaimer]]">
                      <div class="videoUploadDisclamer" hidden$="[[!uploadedVideoUpId]]">
                        [[t('videoUploadDisclaimer')]]
                      </div>
                    </div>
                    <div class="layout horizontal center-center">
                      <paper-button class="uploadNotLoggedIn" raised hidden$="[[loggedInUser]]" on-tap="_openLogin">
                        <iron-icon class="icon" icon="videocam"></iron-icon>
                        [[t('uploadVideoPointFor')]]
                      </paper-button>
                    </div>
                  </div>
                </template>

                <template is="dom-if" if="[[post.Group.configuration.allowPointAudioUploads]]">
                  <div hidden$="[[hideUpAudio]]" class="uploadSection">
                    <div class="layout vertical center-center" hidden$="[[!loggedInUser]]">
                      <yp-file-upload id="audioFileUploadUp" current-file="{{hasCurrentUpAudio}}" container-type="points"
                                      upload-limit-seconds="[[post.Group.configuration.audioPointUploadLimitSec]]"
                                      group="[[post.Group]]" raised="true" multi="false" audio-upload method="POST"
                                      on-success="_audioUpUploaded">
                        <iron-icon class="icon" icon="keyboard-voice"></iron-icon>
                        <span>[[t('uploadAudioPointFor')]]</span>
                      </yp-file-upload>
                    </div>
                    <div class="layout horizontal center-center">
                      <paper-button class="uploadNotLoggedIn" raised hidden$="[[loggedInUser]]" on-tap="_openLogin">
                        <iron-icon class="icon" icon="keyboard-voice"></iron-icon>
                        [[t('uploadAudioPointFor')]]
                      </paper-button>
                    </div>
                  </div>
                </template>
              </div>

              <div hidden="[[!ifLengthUpIsRight]]">
                <div class="addPointFab layout horizontal center-center">
                  <paper-button raised class="submitButton" disabled$="[[addPointDisabled]]" icon="add" mini="" elevation="3" on-tap="addPointUp"
                                title="[[t('postPoint')]]">[[t('postPoint')]]</paper-button>
                </div>
              </div>
            </paper-material>

            <div id="allUpPoints">
              <iron-scroll-threshold id="ironScrollThesholdUp" scroll-target="document"  on-lower-threshold="_loadMorePoints">
                <iron-list id="ironListUp" lower-threshold="200" items="[[upPoints]]" role="list" as="point" scroll-target="document" scroll-offset="550">
                  <template>
                    <div class="item" tabindex$="[[tabIndex]]" role="listitem" aria-level="3">
                      <paper-material id="point[[point.id]]" elevation="1" animated class="pointMaterial">
                        <yp-point post="[[post]]" point="[[point]]"></yp-point>
                      </paper-material>
                    </div>
                  </template>
                </iron-list>
              </iron-scroll-threshold>
            </div>
          </div>

          <div class="point" hidden$="[[post.Group.configuration.hidePointAgainst]]">
            <template is="dom-if" if="[[!post.Group.configuration.alternativePointAgainstHeader]]">
              <div class="pointMainHeader layout horizontal center-center" role="heading" aria-level="2">
                [[t('pointsAgainst')]]
              </div>
            </template>

            <template is="dom-if" if="[[post.Group.configuration.alternativePointAgainstHeader]]">
              <div class="pointMainHeader layout horizontal center-center">
                <yp-magic-text content-id="[[post.Group.id]]" text-only content="[[post.Group.configuration.alternativePointAgainstHeader]]"
                               content-language="[[post.Group.language]]" role="heading" aria-level="2"
                               class="ratingName" text-type="alternativePointAgainstHeader"></yp-magic-text>
              </div>
            </template>

            <template is="dom-if" if="[[post.Group.configuration.alternativePointForLabel]]">
                <yp-magic-text id="alternativePointForLabelId" hidden content-id="[[post.Group.id]]" text-only content="[[post.Group.configuration.alternativePointForLabel]]"
                               content-language="[[post.Group.language]]" on-new-translation="_updatePointLabels" role="heading" aria-level="2"
                               text-type="alternativePointForLabel"></yp-magic-text>
            </template>

            <template is="dom-if" if="[[post.Group.configuration.alternativePointAgainstLabel]]">
              <yp-magic-text id="alternativePointAgainstLabelId" hidden content-id="[[post.Group.id]]" text-only content="[[post.Group.configuration.alternativePointAgainstLabel]]"
                             content-language="[[post.Group.language]]" on-new-translation="_updatePointLabels" role="heading" aria-level="2"
                             text-type="alternativePointAgainstLabel"></yp-magic-text>
            </template>

            <paper-material id="pointDownMaterial" elevation="1" class="pointInputMaterial layout vertical"
                            animated hidden$="[[disableDebate]]">

              <paper-textarea-aria id="down_point" on-tap="focusDownPoint" on-focus="focusTextArea" on-blur="blurTextArea"
                              value="{{textValueDown}}"
                              label="[[labelDown]]"
                              char-counter rows="2" hidden$="[[hideDownText]]"
                              always-float-label="[[_floatIfValueOrIE()]]"
                              max-rows="5" maxlength="[[pointMaxLength]]">
              </paper-textarea-aria>

              <div class="horizontal end-justified layout" hidden$="[[post.Group.configuration.hideEmoji]]">
                <emoji-selector id="pointDownEmojiSelector" hidden$="[[hideDownText]]"></emoji-selector>
              </div>

              <div class="layout horizontal center-justified">
                <template is="dom-if" if="[[post.Group.configuration.allowPointVideoUploads]]">
                  <div hidden$="[[hideDownVideo]]" class="uploadSection">
                    <div class="layout vertical center-center self-start" hidden$="[[!loggedInUser]]">
                      <yp-file-upload id="videoFileUploadDown" current-file="{{hasCurrentDownVideo}}" container-type="points"
                                      upload-limit-seconds="[[post.Group.configuration.videoPointUploadLimitSec]]"
                                      no-default-cover-image
                                      group="[[post.Group]]" raised="true" multi="false" video-upload method="POST"
                                      on-success="_videoDownUploaded">
                        <iron-icon class="icon" icon="videocam"></iron-icon>
                        <span>[[t('uploadVideoPointAgainst')]]</span>
                      </yp-file-upload>
                    </div>
                    <div hidden$="[[!post.Group.configuration.showVideoUploadDisclaimer]]">
                      <div class="videoUploadDisclamer" hidden$="[[!uploadedVideoDownId]]">
                        [[t('videoUploadDisclaimer')]]
                      </div>
                    </div>
                    <div class="layout horizontal center-center">
                      <paper-button class="uploadNotLoggedIn" raised hidden$="[[loggedInUser]]" on-tap="_openLogin">
                        <iron-icon class="icon" icon="videocam"></iron-icon>
                        [[t('uploadVideoPointAgainst')]]
                      </paper-button>
                    </div>
                  </div>
                </template>

                <template is="dom-if" if="[[post.Group.configuration.allowPointAudioUploads]]">
                  <div hidden$="[[hideDownAudio]]" class="uploadSection">
                    <div class="layout vertical center-center" hidden$="[[!loggedInUser]]">
                      <yp-file-upload id="audioFileUploadDown" current-file="{{hasCurrentDownAudio}}" container-type="points"
                                      upload-limit-seconds="[[post.Group.configuration.audioPointUploadLimitSec]]"
                                      group="[[post.Group]]" raised="true" multi="false" audio-upload method="POST"
                                      on-success="_audioDownUploaded">
                        <iron-icon class="icon" icon="keyboard-voice"></iron-icon>
                        <span>[[t('uploadAudioPointAgainst')]]</span>
                      </yp-file-upload>
                    </div>
                    <div class="layout horizontal center-center">
                      <paper-button class="uploadNotLoggedIn" raised hidden$="[[loggedInUser]]" on-tap="_openLogin">
                        <iron-icon class="icon" icon="keyboard-voice"></iron-icon>
                        [[t('uploadAudioPointAgainst')]]
                      </paper-button>
                    </div>
                  </div>
                </template>
              </div>

              <div hidden="[[!ifLengthDownIsRight]]">
                <div class="addPointFab layout horizontal center-center">
                  <paper-button raised disabled$="[[addPointDisabled]]" icon="add" elevation="3" on-tap="addPointDown"
                                title="[[t('postPoint')]]">[[t('postPoint')]]</paper-button>
                </div>
              </div>
            </paper-material>

            <div id="allDownPoints">
              <iron-scroll-threshold id="ironScrollThesholdDown"  scroll-target="document" on-lower-threshold="_loadMorePoints">
                <iron-list id="ironListDown" lower-threshold="200" items="[[downPoints]]" role="list" as="point" scroll-target="document" scroll-offset="550">
                  <template>
                    <div class="item" tabindex$="[[tabIndex]]" role="listitem" aria-level="3">
                      <paper-material id="point[[point.id]]" elevation="1" animated class="pointMaterial">
                        <yp-point post="[[post]]" point="[[point]]"></yp-point>
                      </paper-material>
                    </div>
                  </template>
                </iron-list>
              </iron-scroll-threshold>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[smallModeReady]]" restamp>
      <div rtl$="[[rtl]]" class="layout vertical center-center">
        <paper-material id="pointUpOrDownMaterial" elevation="0" class="pointInputMaterial layout vertical" animated hidden$="[[disableDebate]]">
          <paper-textarea-aria id="mobileUpOrDownPoint" class="mobilePaperTextArea" on-tap="focusDownPoint" on-focus="focusTextArea" on-blur="blurTextArea"
                          value="{{textValueMobileUpOrDown}}" label="[[labelMobileUpOrDown]]"
                          char-counter rows="2" hidden$="[[hideMobileText]]"
                          max-rows="3" maxlength="[[pointMaxLength]]"></paper-textarea-aria>
          <div class="layout vertical end-justified">
            <div class="layout horizontal center-center pointButtons">
              <paper-radio-group hidden$="[[post.Group.configuration.hidePointAgainst]]" id="upOrDown" attribute-for-selected="name" class="layout horizontal" selected="{{pointUpOrDownSelected}}">
                <paper-radio-button name="pointFor">[[t('pointForShort')]]</paper-radio-button>
                <paper-radio-button name="pointAgainst">[[t('pointAgainstShort')]]</paper-radio-button>
              </paper-radio-group>
              <div class="flex"></div>
              <div hidden$="[[hideMobileText]]">
                <emoji-selector id="pointUpDownEmojiSelector" hidden$="[[post.Group.configuration.hideEmoji]]"></emoji-selector>
              </div>
            </div>

            <div class="layout horizontal center-justified">
              <template is="dom-if" if="[[post.Group.configuration.allowPointVideoUploads]]">
                <div hidden$="[[hideMobileVideo]]" class="uploadSection">
                  <div class="layout vertical center-center self-start" hidden$="[[!loggedInUser]]">
                    <yp-file-upload id="videoFileUploadMobile" current-file="{{hasCurrentMobileVideo}}" container-type="points"
                                    upload-limit-seconds="[[post.Group.configuration.videoPointUploadLimitSec]]"
                                    no-default-cover-image
                                    group="[[post.Group]]" raised="true" multi="false" video-upload method="POST"
                                    on-success="_videoMobileUploaded">
                      <iron-icon class="icon" icon="videocam"></iron-icon>

                      <span hidden$="[[!selectedPointForMobile]]">[[t('uploadVideoPointFor')]]</span>
                      <span hidden$="[[selectedPointForMobile]]">[[t('uploadVideoPointAgainst')]]</span>
                    </yp-file-upload>
                  </div>
                  <div hidden$="[[!post.Group.configuration.showVideoUploadDisclaimer]]">
                    <div class="videoUploadDisclamer" hidden$="[[!uploadedVideoMobileId]]">
                      [[t('videoUploadDisclaimer')]]
                    </div>
                  </div>
                  <div class="layout horizontal center-center">
                    <paper-button class="uploadNotLoggedIn" raised hidden$="[[loggedInUser]]" on-tap="_openLogin">
                      <iron-icon class="icon" icon="videocam"></iron-icon>
                      <span hidden$="[[!selectedPointForMobile]]">[[t('uploadVideoPointFor')]]</span>
                      <span hidden$="[[selectedPointForMobile]]">[[t('uploadVideoPointAgainst')]]</span>
                    </paper-button>
                  </div>
                </div>
              </template>
              <template is="dom-if" if="[[post.Group.configuration.allowPointAudioUploads]]">
                <div hidden$="[[hideMobileAudio]]" class="uploadSection">
                  <div class="layout vertical center-center  self-start" hidden$="[[!loggedInUser]]">
                    <yp-file-upload id="audioFileUploadMobile" current-file="{{hasCurrentMobileAudio}}" container-type="points"
                                    upload-limit-seconds="[[post.Group.configuration.audioPointUploadLimitSec]]"
                                    group="[[post.Group]]" raised="true" multi="false" audio-upload method="POST"
                                    on-success="_audioMobileUploaded">
                      <iron-icon class="icon" icon="keyboard-voice"></iron-icon>

                      <span hidden$="[[!selectedPointForMobile]]">[[t('uploadAudioPointFor')]]</span>
                      <span hidden$="[[selectedPointForMobile]]">[[t('uploadAudioPointAgainst')]]</span>
                    </yp-file-upload>
                  </div>
                  <div class="layout horizontal center-center">
                    <paper-button class="uploadNotLoggedIn" raised hidden$="[[loggedInUser]]" on-tap="_openLogin">
                      <iron-icon class="icon" icon="keyboard-voice"></iron-icon>
                      <span hidden$="[[!selectedPointForMobile]]">[[t('uploadAudioPointFor')]]</span>
                      <span hidden$="[[selectedPointForMobile]]">[[t('uploadAudioPointAgainst')]]</span>
                    </paper-button>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div hidden="[[!ifLengthMobileRight]]">
            <div class="addPointFab layout horizontal center-center mobileFab">
              <paper-button raised disabled$="[[addPointDisabled]]" icon="add" elevation="3" on-tap="addMobilePointUpOrDown"
                            title="[[t('postPoint')]]">
                <span hidden$="[[!selectedPointForMobile]]">[[t('postPointFor')]]</span>
                <span hidden$="[[selectedPointForMobile]]">[[t('postPointAgainst')]]</span>
              </paper-button>
            </div>
          </div>
        </paper-material>
      </div>
      <div rtl$="[[rtl]]" class="layout vertical center-center">
        <iron-scroll-threshold id="ironScrollThesholdMobile" scroll-target="[[scrollTarget]]" on-lower-threshold="_loadMorePoints">
          <iron-list id="ironListMobile" lower-threshold="150" debate-disabled$="[[disableDebate]]" role="list" items="[[points]]" as="point" scroll-target="[[scrollTarget]]" scroll-offset="[[mobileScrollOffset]]">
            <template>
              <div class="item layout vertical center-center" tabindex$="[[tabIndex]]" role="listitem" aria-level="3">
                <paper-material
                        id="point[[point.id]]"
                        elevation="0"
                        animated
                        is-last-point$="[[point.isLastPointInList]]"
                        class="pointMaterial pointMaterialMobile"
                >
                  <yp-point post="[[post]]" point="[[point]]"></yp-point>
                </paper-material>
              </div>
            </template>
          </iron-list>
        </iron-scroll-threshold>
      </div>
    </template>

    <div class="layout vertical center-center">
      <yp-ajax id="newPointsAjax" on-response="_newPointsResponse"></yp-ajax>
      <yp-ajax id="newPointAjax" on-error="_newPointError" method="POST" url="/api/points" on-response="_newPointResponse"></yp-ajax>
    </div>

    <paper-toast id="newPointToast" text="[[newPointTextCombined]]"></paper-toast>
  </template>


  <script>
    (function () {
      Polymer({

        is: 'yp-post-points',

        behaviors: [
          Polymer.ypLanguageBehavior,
          Polymer.ypTruncateBehavior,
          Polymer.ypLoggedInUserBehavior
        ],

        properties: {

          host: String,

          isAdmin: {
            type: Boolean,
            value: false,
            observer: '_isAdminChanged'
          },

          disableDebate: {
            type: Boolean,
            value: false
          },

          downPoints: {
            type: Array,
            value: []
          },

          upPoints: {
            type: Array,
            value: []
          },

          textValueUp: {
            type: String,
            notify: true,
            value: ""
          },

          textValueDown: {
            type: String,
            notify: true,
            value: ""
          },

          newPointTextCombined: {
            type: String
          },

          post: {
            type: Object,
            observer: "_postChanged"
          },

          points: {
            type: Array,
            value: null,
            observer: '_pointsChanged'
          },

          rtl: {
            type: Boolean,
            value: false
          },

          largeMode: {
            type: Boolean,
            value: false,
            observer: '_updateEmojiBindings'
          },

          largeModeReady: {
            type: Boolean,
            computed: '_largeModeReady(largeMode, post)'
          },

          smallModeReady: {
            type: Boolean,
            computed: '_smallModeReady(largeMode, post)'
          },

          textValueMobileUpOrDown: String,

          labelMobileUpOrDown: String,

          labelUp: String,

          labelDown: String,

          pointUpOrDownSelected: {
            type: String,
            observer: '_pointUpOrDownSelectedChanged',
            value: 'pointFor'
          },

          latestPointCreatedAt: {
            type: Date,
            value: null
          },

          scrollToId: {
            type: String,
            value: null
          },

          ironListResizeScrollThreshold: {
            type: Number,
            computed: '_ironListResizeScrollThreshold(largeMode)'
          },

          ironListPaddingTop: {
            type: Number,
            computed: '_ironListPaddingTop(wide)'
          },

          ifLengthUpIsRight: {
            type: Boolean,
            value: false,
            computed: 'ifLengthIsRight("up",textValueUp, uploadedVideoUpId, uploadedAudioUpId)'
          },

          ifLengthDownIsRight: {
            type: Boolean,
            value: false,
            computed: 'ifLengthIsRight("down", textValueDown, uploadedVideoDownId, uploadedAudioDownId)'
          },

          ifLengthMobileRight: {
            type: Boolean,
            value: false,
            computed: 'ifLengthIsRight("mobile", textValueMobileUpOrDown, uploadedVideoMobileId, uploadedAudioMobileId)'
          },

          addPointDisabled: {
            type: Boolean,
            value: false
          },

          mobileScrollOffset: {
            type: Number,
            computed: '_mobileScrollOffset(largeMode,post)'
          },

          ajaxActive: {
            type: Boolean,
            value: false
          },

          uploadedVideoUpId: {
            type: String,
            value: null
          },

          uploadedVideoDownId: {
            type: String,
            value: null
          },

          uploadedVideoMobileId: {
            type: String,
            value: null
          },

          currentVideoId:{
            type: String,
            value: null
          },

          hideUpVideo: {
            type: Boolean,
            value: false
          },

          hideDownVideo: {
            type: Boolean,
            value: false
          },

          hideMobileVideo: {
            type: Boolean,
            value: false
          },

          uploadedAudioUpId: {
            type: String,
            value: null
          },

          uploadedAudioDownId: {
            type: String,
            value: null
          },

          uploadedAudioMobileId: {
            type: String,
            value: null
          },

          currentAudioId:{
            type: String,
            value: null
          },

          hideUpAudio: {
            type: Boolean,
            value: false
          },

          hideDownAudio: {
            type: Boolean,
            value: false
          },

          hideMobileAudio: {
            type: Boolean,
            value: false
          },

          hideUpText: {
            type: Boolean,
            value: false
          },

          hideDownText: {
            type: Boolean,
            value: false
          },

          hideMobileText: {
            type: Boolean,
            value: false
          },


          selectedPointForMobile: {
            type: Boolean,
            value: true
          },

          isAndroid: {
            type: Boolean,
            value: false
          },

          hasCurrentUpVideo: {
            type: String,
            observer: '_hasCurrentUpVideo'
          },

          hasCurrentDownVideo: {
            type: String,
            observer: '_hasCurrentDownVideo'
          },

          hasCurrentMobileVideo: {
            type: String,
            observer: '_hasCurrentMobileVideo'
          },

          hasCurrentUpAudio: {
            type: String,
            observer: '_hasCurrentUpAudio'
          },

          hasCurrentDownAudio: {
            type: String,
            observer: '_hasCurrentDownAudio'
          },

          hasCurrentMobileAudio: {
            type: String,
            observer: '_hasCurrentMobileAudio'
          },

          storedPoints: {
            type: Array,
            value: null
          },

          pointMaxLength: {
            type: Number,
            computed: '_pointMaxLength(post, largeMode)'
          },

          isPostPage: {
            type: Boolean,
            value: false
          },

          scrollTarget: {
            type: String,
            computed: '_scrollTarget(isPostPage)'
          }
        },

        _scrollTarget: function (isPostPage) {
          if (isPostPage) {
            return "document";
          } else {
            return undefined;
          }
        },

        _largeModeReady: function (largeMode, post) {
          return largeMode && post;
        },

        _smallModeReady: function (largeMode, post) {
          return !largeMode && post;
        },

        _pointMaxLength: function (post) {
          if (post && post.Group && post.Group.configuration && post.Group.configuration.pointCharLimit) {
            return post.Group.configuration.pointCharLimit;
          } else {
            return 500;
          }
        },

        _openLogin: function () {
          this.fire('yp-open-login');
        },

        _videoUpUploaded: function (event, detail) {
          this.set('uploadedVideoUpId', detail.videoId);
        },

        _videoDownUploaded: function (event, detail) {
          this.set('uploadedVideoDownId', detail.videoId);
        },

        _videoMobileUploaded: function (event, detail) {
          this.set('uploadedVideoMobileId', detail.videoId);
        },


        _audioUpUploaded: function (event, detail) {
          this.set('uploadedAudioUpId', detail.audioId);
        },

        _audioDownUploaded: function (event, detail) {
          this.set('uploadedAudioDownId', detail.audioId);
        },

        _audioMobileUploaded: function (event, detail) {
          this.set('uploadedAudioMobileId', detail.audioId);
        },

        _mobileScrollOffset: function (large, post) {
          if (!large && post) {
            var element = this.$$("#ironListMobile");
            if (element) {
              var top = element.getBoundingClientRect().top;
              if (top<=0) {
                top = 800;
              }
              return top;
            } else {
              console.warn("Can't find mobile list element, returning 800");
              return 800;
            }
          }
        },

        _newPointError: function () {
          this.set('addPointDisabled', false);
        },

        _ironListResizeScrollThreshold: function (largeMode) {
          if (largeMode) {
            return 300;
          } else {
            return 300;
          }
        },

        _ironListPaddingTop: function (largeMode) {
          if (largeMode) {
            return 600;
          } else {
            return 500;
          }
        },

        ready: function () {
          var ua = navigator.userAgent.toLowerCase();
          var isAndroid = ua.indexOf("android") > -1;
          if (isAndroid) {
            this.set('isAndroid', true);
          }
          window.addEventListener("resize", this._processStoredPoints.bind(this));
        },

        detached: function() {
          window.removeEventListener("resize", this._processStoredPoints);
        },

        listeners: {
          'yp-point-deleted': '_pointDeleted',
          'yp-update-point-in-list': '_updatePointInLists',
          'yp-iron-resize': '_ypIronResize'
        },

        observers: [
          '_setupPointTextStartState(pointUpOrDownSelected, post)'
        ],

        _ypIronResize: function () {
          if (this.$$("#ironListUp"))
            this.$$("#ironListUp").fire("iron-resize");
          if (this.$$("#ironListDown"))
            this.$$("#ironListDown").fire("iron-resize");
          if (this.$$("#ironListMobile"))
            this.$$("#ironListMobile").fire("iron-resize");
        },

        _setupPointTextStartState: function(pointUpOrDownSelected, post) {
          if (post) {
            this._pointUpOrDownSelectedChanged(pointUpOrDownSelected)
          }
        },

        _loadNewPointsIfNeeded: function (event, detail) {
          if (this.post && this.post.id == detail.postId) {
            if (this.latestPointCreatedAt) {
              this.$.newPointsAjax.url = '/api/posts/' + this.post.id + '/newPoints';
              this.$.newPointsAjax.params = { latestPointCreatedAt: this.latestPointCreatedAt };
              this.$.newPointsAjax.generateRequest();
            } else {
              console.error("Trying to send point without latestPointCreatedAt");
            }
          }
        },

        _loadMorePoints: function () {
          if (!this.loadMoreInProgress && !this.noMorePoints) {
            this.loadMoreInProgress = true;
            if (this.post && this.storedPoints && this.storedPoints.length>0) {
              if (this.host) {
                this.$.moreAjax.url = this.host+'/api/posts/' + this.post.id + '/points';
              } else {
                this.$.moreAjax.url = '/api/posts/' + this.post.id + '/points';
              }
              this.$.moreAjax.params = {
                 offsetUp: this.storedUpPointsCount ? this.storedUpPointsCount : 0,
                 offsetDown: this.storedDownPointsCount ? this.storedDownPointsCount : 0,
              };
              this.$.moreAjax.generateRequest();
            } else {
              console.warn("Trying to load more points early");
              this.loadMoreInProgress = false;
            }
          }
        },

        _interleaveMorePoints: function (points) {
          var upPoints = [];
          var downPoints = [];

          for (var i = 0; i < points.length; i++) {
            if (points[i].value>0) {
              upPoints.push(points[i]);
            } else if (points[i].value<0) {
              downPoints.push(points[i]);
            }
          }

          return this.interleaveArrays(upPoints, downPoints);
        },

        _morePointsResponse: function (event, detail) {
          this.loadMoreInProgress = false;
          var points = this._preProcessPoints(detail.response.points);
          if (points.length===0) {
            this.noMorePoints = true;
          }

          let haveAddedPoint = false;
          points = this._interleaveMorePoints(points);
          points.forEach(function (point) {
            if (this._addMorePoint(point)) {
              haveAddedPoint = true;
            }
          }.bind(this));
          this.async(function () {
            if (this.$$("#ironListUp"))
              this.$$("#ironListUp").fire("iron-resize");
            if (this.$$("#ironListDown"))
              this.$$("#ironListDown").fire("iron-resize");
            if (this.$$("#ironListMobile"))
              this.$$("#ironListMobile").fire("iron-resize");
          }, 5);

          if (haveAddedPoint) {
            this._clearScrollTrigger();
          }
        },

        _clearScrollTrigger: function () {
          if (this.$$("#ironScrollThesholdUp"))
            this.$$("#ironScrollThesholdUp").clearTriggers();
          if (this.$$("#ironScrollThesholdDown"))
            this.$$("#ironScrollThesholdDown").clearTriggers();
          if (this.$$("#ironScrollThesholdMobile"))
            this.$$("#ironScrollThesholdMobile").clearTriggers();
        },

        _newPointsResponse: function (event, detail) {
          var points = this._preProcessPoints(detail.response);
          points.forEach(function (point) {
            this._insertNewPoint(point);
          }.bind(this));

          this._updateCounterInfo();
        },

        _pointDeleted: function () {
          this.$.ajax.generateRequest();
        },

        _pointsChanged: function (points) {
          if (points) {
            this._updateEmojiBindings();
          }
        },

        _updateEmojiBindings: function () {
          this.async(function () {
            if (this.largeMode) {
              var upPoint = this.$$("#up_point");
              var downPoint = this.$$("#down_point");
              var upEmoji = this.$$("#pointUpEmojiSelector");
              var downEmoji = this.$$("#pointDownEmojiSelector");
              if (upPoint && downPoint && upEmoji && downEmoji) {
                upEmoji.inputTarget = upPoint;
                downEmoji.inputTarget = downPoint;
              } else {
                console.warn("Wide: Can't bind emojis :(");
              }
            } else {
              var upDownPoint = this.$$("#mobileUpOrDownPoint");
              var upDownEmoji = this.$$("#pointUpDownEmojiSelector");
              if (upDownPoint && upDownEmoji) {
                upDownEmoji.inputTarget = upDownPoint;
              } else {
                console.warn("Small: Can't bind emojis :(");
              }
            }
          }.bind(this), 500);
        },

        _pointUpOrDownSelectedChanged: function (newValue) {
          if (newValue=='pointFor') {
            if (this.post && this.post.Group && this.post.Group.configuration && this.post.Group.configuration.alternativePointForLabel) {
              this.set('labelMobileUpOrDown', this.post.Group.configuration.alternativePointForLabel);
            } else {
              this.set('labelMobileUpOrDown', this.t('point.for'));
            }
            this.set('selectedPointForMobile', true);
          } else if (newValue=='pointAgainst') {
            if (this.post && this.post.Group && this.post.Group.configuration && this.post.Group.configuration.alternativePointAgainstLabel) {
              this.set('labelMobileUpOrDown', this.post.Group.configuration.alternativePointAgainstLabel);
            } else {
              this.set('labelMobileUpOrDown', this.t('point.against'));
            }
            this.set('selectedPointForMobile', false);
          }
        },

        _clearVideo: function () {
          this.set('uploadedVideoUpId', null);
          this.set('uploadedVideoDownId', null);
          this.set('uploadedVideoMobileId', null);
          this.set('currentVideoId', null);
          this.set('hideUpVideo', false);
          this.set('hideDownVideo', false);
          this.set('hideMobileVideo', false);
          if (this.$$("#videoFileUploadUp"))
            this.$$("#videoFileUploadUp").clear();
          if (this.$$("#videoFileUploadDown"))
            this.$$("#videoFileUploadDown").clear();
          if (this.$$("#videoFileUploadMobile"))
            this.$$("#videoFileUploadMobile").clear();
        },

        _clearAudio: function () {
          this.set('uploadedAudioUpId', null);
          this.set('uploadedAudioDownId', null);
          this.set('uploadedAudioMobileId', null);
          this.set('currentAudioId', null);
          this.set('hideUpAudio', false);
          this.set('hideDownAudio', false);
          this.set('hideMobileAudio', false);
          if (this.$$("#audioFileUploadUp"))
            this.$$("#audioFileUploadUp").clear();
          if (this.$$("#audioFileUploadDown"))
            this.$$("#audioFileUploadDown").clear();
          if (this.$$("#audioFileUploadMobile"))
            this.$$("#audioFileUploadMobile").clear();
        },

        _isAdminChanged: function (isAdmin) {
          if (this.post && this.post.Group && this.post.Group.configuration && this.post.Group.configuration.disableDebate) {
            if (isAdmin && this.post.Group.configuration.allowAdminsToDebate) {
              this.set('disableDebate', false);
            } else {
              this.set('disableDebate', true);
            }
          } else {
            this.set('disableDebate', false);
          }
        },

        _postChanged: function (newPost) {
          // Remove any manually inserted points when the list is updated
          this.set('points', null);
          this.set('upPoints', null);
          this.set('downPoints', null);
          this.set('latestPointCreatedAt', null);
          this.set('storedPoints', null);
          this._clearVideo();
          this._clearAudio();
          this.loadedPointIds = {};

          this.storedUpPointsCount = null;
          this.storedDownPointsCount = null;


          if (newPost) {
            if (newPost.Group && newPost.Group.configuration && newPost.Group.configuration.disableDebate) {
              this.set('disableDebate', true);
            } else {
              this.set('disableDebate', false);
            }

            if (this.host) {
              this.$.ajax.url = this.host+'/api/posts/' + newPost.id + '/points';
            } else {
              this.$.ajax.url = '/api/posts/' + newPost.id + '/points';
            }
            this.$.ajax.generateRequest();
            if (this.post && this.post.Group && this.post.Group.configuration && this.post.Group.configuration.alternativePointForLabel) {
              this.set('labelUp', this.post.Group.configuration.alternativePointForLabel);
            } else {
              this.set('labelUp', this.t('point.for'));
            }
            if (this.post && this.post.Group && this.post.Group.configuration && this.post.Group.configuration.alternativePointAgainstLabel) {
              this.set('labelDown', this.post.Group.configuration.alternativePointAgainstLabel);
            } else {
              this.set('labelDown', this.t('point.against'));
            }
          }

          this.async(function () {
            this._updatePointLabels();
          });
        },

        removeElementsByClass: function (rootElement, className) {
          var elements = rootElement.getElementsByClassName(className);
          while(elements.length > 0){
            elements[0].parentNode.removeChild(elements[0]);
          }
        },

        _updatePointLabels: function () {
          this.async(function () {
            var forLabel = this.$$("#alternativePointForLabelId");
            var againstLabel = this.$$("#alternativePointAgainstLabelId");
            if (forLabel && forLabel.finalContent) {
              this.set('labelUp', forLabel.finalContent);
            }
            if (againstLabel && againstLabel.finalContent) {
              this.set('labelDown', againstLabel.finalContent);
            }
          });
        },

        _processStoredPoints: function () {
          console.info("_processStoredPoints");
          if (this.storedPoints && this.storedPoints.length > 0) {
            var upPoints = [];
            var downPoints = [];

            for (var i = 0; i < this.storedPoints.length; i++) {
              if (this.storedPoints[i].value>0) {
                upPoints.push(this.storedPoints[i]);
              } else if (this.storedPoints[i].value<0) {
                downPoints.push(this.storedPoints[i]);
              }
            }
            this.set('upPoints', upPoints);
            this.set('downPoints', downPoints);
          } else {
            this.set('upPoints', []);
            this.set('downPoints', []);
            this.set('points', []);
          }

          if (!this.largeMode) {
            this.set('points', this.interleaveArrays(this.upPoints, this.downPoints));
          }

          this._clearScrollTrigger();
        },

        _response: function (event, detail) {
          this.set('storedPoints', this._preProcessPoints(detail.response.points));
          this.totalCount = detail.response.count;
          this.storedUpPointsCount = 0;
          this.storedDownPointsCount = 0;

          for (var i = 0; i < this.storedPoints.length; i++) {
            if (this.storedPoints[i].value>0) {
              this.storedUpPointsCount += 1;
            } else if (this.storedPoints[i].value<0) {
              this.storedDownPointsCount += 1;
            }
            this.loadedPointIds[this.storedPoints[i].id]=true;
          }

          this._processStoredPoints();
          this.removeElementsByClass(this, 'inserted-outside-list');
          this._updateCounterInfo();
          this._scrollPointIntoView();
          this._checkForMultipleLanguages();
        },

        _updatePointInLists: function (event, changedPoint) {
          this.upPoints.forEach(function (point, index) {
            if (point.id===changedPoint.id) {
              this.upPoints[index] = changedPoint;
            }
          }.bind(this));

          this.downPoints.forEach(function (point, index) {
            if (point.id===changedPoint.id) {
              this.downPoints[index] = changedPoint;
            }
          }.bind(this));

          if (this.points && this.points.length>0) {
            this.points.forEach(function (point, index) {
              if (point.id===changedPoint.id) {
                this.points[index] = changedPoint;
              }
            }.bind(this));
          }
        },

        _checkForMultipleLanguages: function () {
          if (!localStorage.getItem("dontPromptForAutoTranslation") &&
              !sessionStorage.getItem("dontPromptForAutoTranslation")) {
            var firstLanguage;
            var multipleLanguages = false;
            this.upPoints.forEach(function (point) {
              if (point.language && !multipleLanguages) {
                if (!firstLanguage && point.language!=='??') {
                  firstLanguage = point.language;
                } else if (firstLanguage && firstLanguage!==point.language && point.language!=='??') {
                  multipleLanguages = true;
                  console.info("Multiple point languages: "+firstLanguage+" and "+point.language);
                }
              }
            });

            if (!multipleLanguages) {
              this.downPoints.forEach(function (point) {
                if (point.language && !multipleLanguages) {
                  if (!firstLanguage && point.language!=='??') {
                    firstLanguage = point.language;
                  } else if (firstLanguage && firstLanguage!=point.language && point.language!=='??') {
                    multipleLanguages = true;
                    console.info("Multiple point languages: "+firstLanguage+" and "+point.language);
                  }
                }
              });
            }

            if (multipleLanguages) {
              Polymer.dom(document).querySelector('yp-app').getDialogAsync("autoTranslateDialog", function (dialog) {
                dialog.openLaterIfAutoTranslationEnabled();
              }.bind(this));
            }
          }
        },

        interleaveArrays: function (arrayA, arrayB) {
          var arrs = [arrayA, arrayB];
          var maxLength = Math.max.apply(Math, arrs.map(function (arr) {
            return arr.length
          }));

          var result = [];

          for (var i = 0; i < maxLength; ++i) {
            arrs.forEach(function (arr) {
              if (arr.length > i) {
                result.push(arr[i])
              }
            })
          }

          if (result.length>0 &&
             (result.length===this.totalCount ||
               (this.points && (this.points.length+result.length)===this.totalCount))) {
            result[result.length-1].isLastPointInList = true;
          }

          return result
        },

        _scrollPointIntoView: function () {
          if (this.scrollToId) {
            this.async(function () {
              var hasFoundIt=false;
              if (!this.largeMode) {
                this.points.forEach(function (point) {
                  if (!hasFoundIt && point.id == this.scrollToId) {
                    this.$$("#ironListMobile").scrollToItem(point);
                    hasFoundIt = true;
                  }
                }.bind(this));
              } else {
                this.upPoints.forEach(function (point) {
                  if (!hasFoundIt && point.id == this.scrollToId) {
                    this.$$("#ironListUp").scrollToItem(point);
                    hasFoundIt = true;
                  }
                }.bind(this));
                if (!hasFoundIt) {
                  this.downPoints.forEach(function (point) {
                    if (!hasFoundIt && point.id == this.scrollToId) {
                      this.$$("#ironListDown").scrollToItem(point);
                      hasFoundIt = true;
                    }
                  }.bind(this));
                }
              }

              if (hasFoundIt) {
                this.async(function () {
                  // Change elevation
                  var point = this.$$("#point"+this.scrollToId);
                  if (point) {
                    point.elevation = 5;
                    point.elevation = 1;
                    point.elevation = 5;
                    this.async(function () {
                      point.elevation = 1;
                    }.bind(this), 7000);
                  } else {
                    console.warn("Can't find point to elevate");
                  }
                  this.set('scrollToId', null);
                }, 50);
              }
            }, 20);
          }
        },

        _floatIfValueOrIE: function (value) {
          var ie11 = /Trident.*rv[ :]*11\./.test(navigator.userAgent);
          return ie11 || value;
        },

        _preProcessPoints: function (points) {
          for (var i = 0; i < points.length; i++) {
            if (!this.latestPointCreatedAt || (!this.latestPointCreatedAt || points[i].created_at > this.latestPointCreatedAt)) {
              this.set('latestPointCreatedAt', points[i].created_at);
            }
            if (points[i].PointRevisions[points[i].PointRevisions.length-1] && points[i].PointRevisions[points[i].PointRevisions.length-1].content) {
              points[i].latestContent = points[i].PointRevisions[points[i].PointRevisions.length-1].content;
            } else if (!this.currentVideoId && !this.currentAudioId) {
              console.warn("No content for point in _preProcessPoints");
            }
          }
          return points;
        },

        _updateCounterInfo: function () {
          if (this.largeMode) {
            this.fire('yp-debate-info', {
              count: this.totalCount,
              firstPoint: this.upPoints[0]
            });
          } else {
            this.fire('yp-debate-info', {
              count: this.totalCount,
              firstPoint: this.points[0]
            });
          }
        },

        _insertNewPoint: function (point) {
          if (!this.loadedPointIds[point.id]) {
            this.loadedPointIds[point.id] = true;
            if (this.largeMode) {
              if (point.value > 0) {
                this.unshift('upPoints', point);
                this.async(function () {
                  this.$$("#ironListUp").fire("iron-resize");
                }, 700);
              } else if (point.value < 0) {
                this.unshift('downPoints', point);
                this.async(function () {
                  this.$$("#ironListDown").fire("iron-resize");
                }, 700);
              }
            } else {
              this.unshift('points', point);
              this.async(function () {
                this.$$("#ironListMobile").fire("iron-resize");
              }, 700);
            }
            this.unshift('storedPoints', point);
          }
        },

        _addMorePoint: function (point) {
          let haveAddedPoints = false;
          if (!this.loadedPointIds[point.id]) {
            this.loadedPointIds[point.id] = true;
            haveAddedPoints = true;
            if (this.largeMode) {
              if (point.value > 0) {
                this.push('upPoints', point);
              } else if (point.value < 0) {
                this.push('downPoints', point);
              }
            } else {
              this.push('points', point);
            }

            this.push('storedPoints', point);

            if (point.value > 0) {
              this.storedUpPointsCount += 1;
            } else if (point.value < 0) {
              this.storedDownPointsCount += 1;
            }
          }

          return haveAddedPoints;
        },

        _newPointResponse: function (inEvent, inDetail) {
          if (inDetail && inDetail.offlineSendLater) {
            this.set('addPointDisabled', false);
            this.set("textValueUp", "");
            this.set("textValueDown", "");
            this.set("textValueMobileUpOrDown", "");
          } else {
            if (this.currentVideoId || this.currentAudioId) {
              window.appGlobals.showSpeechToTextInfoIfNeeded();
            }
            this._completeNewPointResponse(inEvent, inDetail);
          }
        },

        _completeNewPointResponse: function (event, detail) {
          this.set('addPointDisabled', false);
          var point = this._preProcessPoints([detail.response])[0];
          if (this.currentVideoId) {
            point.checkTranscriptFor = "video";
          } else if (this.currentAudioId) {
            point.checkTranscriptFor = "audio";
          }
          if (point.value > 0) {
            this.newPointTextCombined = this.t("point.forAdded") + " " + this.truncate(point.content, 21);
            this.set("textValueUp", "");
          } else {
            this.newPointTextCombined = this.t("point.againstAdded") + " " + this.truncate(point.content, 21);
            this.set("textValueDown", "");
          }
          this.set("textValueMobileUpOrDown", "");
          this._insertNewPoint(point);
          this.set('post.counter_points', this.post.counter_points + 1);
          this.$.newPointToast.show();
          this._updateCounterInfo();
          if (point.value > 0) {
            window.appGlobals.activity('completed', 'newPointFor', {
              pointId:  point.id
            });
          } else {
            window.appGlobals.activity('completed', 'newPointAgainst', {
              pointId:  point.id
            });
          }
          this._clearVideo();
          this._clearAudio();
        },

        addPointUp: function () {
          this.addPoint(this.textValueUp, 1, this.uploadedVideoUpId, this.uploadedAudioUpId);
          window.appGlobals.activity('add', 'pointUp');
        },

        addPointDown: function () {
          this.addPoint(this.textValueDown, -1, this.uploadedVideoDownId, this.uploadedAudioDownId);
          window.appGlobals.activity('add', 'pointDown');
        },

        addMobilePointUpOrDown: function () {
          if (this.pointUpOrDownSelected=='pointFor') {
            this.addPoint(this.textValueMobileUpOrDown, 1, this.uploadedVideoMobileId, this.uploadedAudioMobileId);
            window.appGlobals.activity('add', 'pointUp');
          } else if (this.pointUpOrDownSelected=='pointAgainst') {
            this.addPoint(this.textValueMobileUpOrDown, -1, this.uploadedVideoMobileId, this.uploadedAudioMobileId);
            window.appGlobals.activity('add', 'pointDown');
          }
        },

        addPoint: function (content, value, videoId, audioId) {
          if (window.appUser.loggedIn() === true) {
            this.$.newPointAjax.url = "/api/points/" + this.post.group_id;
            this.$.newPointAjax.body = {
              postId: this.post.id,
              content: content,
              value: value,
              pointBaseId:  window.appUser.getBrowserId(),
              pointValCode: window.appUser.browserFingerprint,
              pointConf: window.appUser.browserFingerprintConfidence,
              originalQueryString: window.appGlobals.getOriginalQueryString(),
              userLocale: window.locale,
              userAutoTranslate: window.autoTranslate,
              referrer: document.referrer,
              url: location.href,
              screen_width: window.screen.width,
              videoId: videoId,
              audioId: audioId,
              appLanguage: this.language,
              isZiggeo: window.appGlobals.useZiggeo
            };

            this.set('addPointDisabled', true);
            this.$.newPointAjax.generateRequest();
            if (videoId)
              this.set('currentVideoId', videoId);
            else if (audioId)
              this.set('currentAudioId', audioId);
          } else {
            window.appUser.loginForNewPoint(this, {content: content, value: value});
          }
        },

        focusUpPoint: function () {
          window.appGlobals.activity('focus', 'pointUp');
        },

        focusDownPoint: function () {
          window.appGlobals.activity('focus', 'pointDown');
        },

        focusTextArea: function (event) {
          if (window.innerWidth>500)
            event.currentTarget.parentElement.elevation = 2;
        },

        blurTextArea: function (event) {
          event.currentTarget.parentElement.elevation = 1;
        },

        _hasCurrentUpVideo: function (value) {
          if (value) {
            this.set('hideUpAudio', true);
            this.set('hideUpText', true);
          } else {
            this.set('hideUpAudio', false);
            this.set('hideUpText', false);
          }
        },

        _hasCurrentDownVideo: function (value) {
          if (value) {
            this.set('hideDownAudio', true);
            this.set('hideDownText', true);
          } else {
            this.set('hideDownAudio', false);
            this.set('hideDownText', false);
          }
        },

        _hasCurrentUpAudio: function (value) {
          if (value) {
            this.set('hideUpVideo', true);
            this.set('hideUpText', true);
          } else {
            this.set('hideUpVideo', false);
            this.set('hideUpText', false);
          }
        },

        _hasCurrentDownAudio: function (value) {
          if (value) {
            this.set('hideDownVideo', true);
            this.set('hideDownText', true);
          } else {
            this.set('hideDownVideo', false);
            this.set('hideDownText', false);
          }
        },

        _hasCurrentMobileVideo: function (value) {
          if (value) {
            this.set('hideMobileAudio', true);
            this.set('hideMobileText', true);
          } else {
            this.set('hideMobileAudio', false);
            this.set('hideMobileText', false);
          }
        },

        _hasCurrentMobileAudio: function (value) {
          if (value) {
            this.set('hideMobileVideo', true);
            this.set('hideMobileText', true);
          } else {
            this.set('hideMobileVideo', false);
            this.set('hideMobileText', false);
          }
        },

        ifLengthIsRight: function (type, textValue, hasVideoId, hasAudioId) {
          if (hasVideoId != null) {
            if (type==="up") {
              this.set("hideUpVideo", false);
              this.set('hideUpAudio', true);
              this.set('hideUpText', true);
            }
            if (type==="down") {
              this.set("hideDownVideo", false);
              this.set("hideDownAudio", true);
              this.set("hideDownText", true);
            }
            if (type==="mobile") {
              this.set("hideMobileVideo", false);
              this.set("hideMobileAudio", true);
              this.set("hideMobileText", true);
            }
            return true;
          } else  if (hasAudioId != null) {
            if (type==="up") {
              this.set("hideUpAudio", false);
              this.set('hideUpVideo', true);
              this.set('hideUpText', true);
            }
            if (type==="down") {
              this.set("hideDownAudio", false);
              this.set("hideDownVideo", true);
              this.set("hideDownText", true);
            }
            if (type==="mobile") {
              this.set("hideMobileAudio", false);
              this.set("hideMobileVideo", true);
              this.set("hideMobileText", true);
            }
            return true;
          } else if (textValue!=null && textValue.length === 0) {
            if (type==="up") {
              this.set("hideUpVideo", false);
              this.set('hideUpAudio', false);
              this.set('hideUpText', false);
            }
            if (type==="down") {
              this.set("hideDownVideo", false);
              this.set("hideDownAudio", false);
              this.set("hideDownText", false);
            }
            if (type==="mobile") {
              this.set("hideMobileVideo", false);
              this.set("hideMobileAudio", false);
              this.set("hideMobileText", false);
            }
            return false;
          } else if (textValue!=null && textValue.length > 0 && textValue.trim().length > 0) {
            if (type==="up") {
              this.set("hideUpVideo", true);
              this.set('hideUpAudio', true);
              this.set('hideUpText', false);
            }
            if (type==="down") {
              this.set("hideDownVideo", true);
              this.set("hideDownAudio", true);
              this.set("hideDownText", false);
            }
            if (type==="mobile") {
              this.set("hideMobileVideo", true);
              this.set("hideMobileAudio", true);
              this.set("hideMobileText", false);
            }
            return true;
          } else if (textValue!=null && textValue.length > 1 && textValue.trim().length > 1) {
            return true;
          } else {
            return false;
          }
        }
      });
    }());
  </script>
</dom-module>
