<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/lite-signal/lite-signal.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../yp-file-upload/yp-file-upload.html">

<link rel="import" href="../yp-behaviors/yp-language-behavior.html">
<link rel="import" href="../yp-behaviors/yp-collection-status-options.html">
<link rel="import" href="../yp-behaviors/emoji-selector.html">
<link rel="import" href="../yp-behaviors/yp-goto-behavior.html">
<link rel="import" href="../yp-behaviors/yp-translated-pages-behavior.html">
<link rel="import" href="../yp-behaviors/yp-media-formats-behavior.html">
<link rel="import" href="../yp-edit-dialog/yp-edit-dialog.html">
<link rel="import" href="../yp-edit-dialog/yp-edit-dialog-behavior.html">
<link rel="import" href="../yp-theme/yp-theme-selector.html">
<link rel="import" href="../yp-app-globals/yp-language-selector.html">

<dom-module id="yp-group-edit">
  <template>

    <style include="iron-flex iron-flex-alignment">
      .access {
        @apply --layout-horizontal;
        @apply --layout-center-justified;
      }

      .subHeaders {
        color: #333;
        font-weight: normal;
        margin-bottom: 8px;
        margin-top: 30px;
        font-size: 22px;
        width: 100%;
        padding-bottom: 8px;
        border-bottom: 2px solid #888;
        text-align: center;
      }

      paper-radio-button {
        display: block;
      }

      .additionalSettings {
        padding-top: 8px;
      }

      yp-file-upload {
      }

      .half {
        width: 50%;
      }

      .config {
        padding: 8px;
        vertical-align: top;
      }

      paper-checkbox {
        padding-top: 8px;
      }

      .icon {
        padding-right: 8px;
      }

      paper-dropdown-menu {
        max-width: 250px;
        width: 250px;
      }

      .categoryName {
        padding-left: 8px;
      }

      [hidden] {
        display: none !important;
      }

      .uploadSection {
        max-width: 300px;
        margin: 8px;
        margin-bottom: 0;
      }

      .useVideoCover {
        margin-left: 16px;
        margin-top: 4px;
      }

      .themeOverrideInfo, .structuredQuestionsInfo {
        color: #555;
        font-style: italic;
        font-size: 14px;
      }

      .themeOverrideInfo {
        margin-bottom: 8px;
      }

      .exteraTopMargin {
        margin-top: 8px;
      }

      .defaultPostImage {
        margin-top: 16px;
      }

      #structuredQuestionsJsonErrorInfo, #registrationQuestionsJsonErrorInfo, #dataForVisualizationJsonError {
        margin-top: 0px;
        margin-bottom: 8px;
        color: #F00;
        font-weight: bold;
      }

      a {
          color: #000;
      }

      .allGroupMenus {
          margin-bottom: 16px;
      }
    </style>
    <lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal>

    <yp-edit-dialog name="groupEdit" id="editDialog" title="[[editHeaderText]]" icon="people" action="[[action]]"
                    method="[[method]]" params="[[params]]" save-text="[[saveText]]" toast-text="[[toastText]]">

      <template is="dom-if" if="[[group.configuration.actAsLinkToCommunityId]]">
        <div class="layout horizontal allGroupMenus" hidden$="[[!group.id]]"><a target="_blank" href="/group/[[group.id]]">[[t('fullGroupLinkMenus')]]</a></div>
      </template>

      <paper-input id="name"
                   name="name"
                   type="text"
                   label="[[t('name')]]"
                   value="{{group.name}}"
                   maxlength="50"
                   char-counter>
      </paper-input>

      <paper-textarea id="objectives"
                      name="objectives"
                      value="{{group.objectives}}"
                      always-float-label="[[group.objectives]]"
                      label="[[t('group.objectives')]]"
                      char-counter
                      rows="2"
                      on-value-changed="_objectivesChanged"
                      max-rows="5"
                      maxlength="[[maxObjectivesLength]]">
      </paper-textarea>

      <div class="horizontal end-justified layout">
        <emoji-selector id="emojiSelectorDescription"></emoji-selector>
      </div>

      <div class="layout vertical">

        <div class="subHeaders">[[t('headerMedia')]]</div>

        <div class="layout horizontal wrap">
          <div class="layout vertical additionalSettings uploadSection">
            <yp-file-upload id="logoImageUpload" raised="true" multi="false" target="/api/images?itemType=group-logo"
                            method="POST" on-success="_logoImageUploaded">
              <iron-icon class="icon" icon="photo-camera"></iron-icon>
              <span>[[t('image.logo.upload')]]</span>
            </yp-file-upload>
          </div>

          <div class="layout horizontal additionalSettings uploadSection">
            <yp-file-upload id="headerImageUpload" raised="true" multi="false" target="/api/images?itemType=group-header"
                            method="POST" on-success="_headerImageUploaded">
              <iron-icon class="icon" icon="photo-camera"></iron-icon>
              <span>[[t('image.header.upload')]]</span>
            </yp-file-upload>
            <paper-icon-button
              aria-label$="[[t('deleteHeaderImage')]]"
              class="removeButton layout self-start"
              icon="delete"
              on-tap="_deleteHeaderImage"
              hidden$="[[!hasHeaderImage]]">
            ></paper-icon-button>
          </div>

          <template is="dom-if" if="[[hasVideoUpload]]">
            <div class="layout horizontal uploadSection">
              <yp-file-upload id="videoFileUpload" raised="true" multi="false" video-upload method="POST"
                              on-success="_videoUploaded">
                <iron-icon class="icon" icon="videocam"></iron-icon>
                <span>[[t('uploadVideo')]]</span>
              </yp-file-upload>
              <template is="dom-if" if="[[hasVideos]]" restamp>
                <paper-checkbox class="useVideoCover" name="useVideoCover"
                  checked$="{{group.configuration.useVideoCover}}">[[t('useVideoCover')]]
                </paper-checkbox>
              </template>
            </div>
          </template>

          <input type="hidden" name="uploadedLogoImageId" value="[[uploadedLogoImageId]]">
          <input type="hidden" name="uploadedHeaderImageId" value="[[uploadedHeaderImageId]]">
          <input type="hidden" name="deleteHeaderImage" value="[[deleteHeaderImage]]">
        </div>

        <div class="subHeaders exteraTopMargin">[[t('access')]]</div>

        <paper-radio-group id="access" name="access" class="access" selected="{{groupAccess}}">
          <paper-radio-button name="open_to_community">[[t('group.openToCommunity')]]</paper-radio-button>
          <paper-radio-button name="public">[[t('group.public')]]</paper-radio-button>
          <paper-radio-button name="closed">[[t('group.closed')]]</paper-radio-button>
          <paper-radio-button name="secret">[[t('group.secret')]]</paper-radio-button>
        </paper-radio-group>

        <paper-dropdown-menu label="[[t('status.select')]]">
          <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{status}}">
            <template is="dom-repeat" items="[[collectionStatusOptions]]" as="statusOption">
              <paper-item name="[[statusOption.name]]">[[statusOption.translatedName]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

        <paper-checkbox name="allowAnonymousUsers" checked$="{{group.configuration.allowAnonymousUsers}}">
          [[t('allowAnonymousUsers')]]
        </paper-checkbox>

        <paper-checkbox name="anonymousAskRegistrationQuestions" checked$="{{group.configuration.anonymousAskRegistrationQuestions}}">
          [[t('anonymousAskRegistrationQuestions')]]
        </paper-checkbox>

        <paper-checkbox name="allowAnonymousAutoLogin" disabled$="[[!group.configuration.allowAnonymousUsers]]"  checked$="{{group.configuration.allowAnonymousAutoLogin}}">
          [[t('allowAnonymousAutoLogin')]]
        </paper-checkbox>
        <paper-checkbox name="allowOneTimeLoginWithName" checked$="{{group.configuration.allowOneTimeLoginWithName}}">
          [[t('allowOneTimeLoginWithName')]]
        </paper-checkbox>

        <paper-checkbox name="disableFacebookLoginForGroup"
                        checked$="{{group.configuration.disableFacebookLoginForGroup}}">
          [[t('disableFacebookLoginForGroup')]]
        </paper-checkbox>
        <paper-checkbox name="forceSecureSamlLogin" disabled$="[[!hasSamlLoginProvider]]"
                        checked$="{{group.configuration.forceSecureSamlLogin}}">[[t('forceSecureSamlLogin')]]
        </paper-checkbox>

        <paper-checkbox name="forceSecureSamlEmployeeLogin" disabled$="[[!hasSamlLoginProvider]]"
                        checked$="{{group.configuration.forceSecureSamlEmployeeLogin}}">[[t('forceSecureSamlEmployeeLogin')]]
        </paper-checkbox>

        <input type="hidden" name="status" value="[[status]]">

        <paper-textarea id="registrationQuestions"
                name="registrationQuestions"
                type="text"
                rows="4"
                always-float-label="[[group.configuration.registrationQuestions]]"
                maxrows="8"
                on-value-changed="_registrationQuestionsChanged"
                max-rows="8"
                label="[[t('registrationQuestions')]]"
                value="{{group.configuration.registrationQuestions}}">
        </paper-textarea>

        <div id="registrationQuestionsJsonErrorInfo" hidden$="[[!registrationQuestionsJsonError]]">[[t('structuredQuestionsJsonFormatNotValid')]]</div>

        <paper-input id="customBackURL"
          name="customBackURL"
          type="text"
          maxlength="256"
          label="[[t('customBackURL')]]"
          value="{{group.configuration.customBackURL}}">
        </paper-input>

        <paper-input id="customBackName"
          name="customBackName"
          type="text"
          maxlength="20"
          label="[[t('customBackName')]]"
          value="{{group.configuration.customBackName}}">
        </paper-input>

        <paper-input id="optionalSortOrder"
          name="optionalSortOrder"
          type="number"
          allowed-pattern="[0-9]"
          label="[[t('optionalSortOrder')]]"
          value="{{group.configuration.optionalSortOrder}}"
          maxlength="4">
        </paper-input>

        <div class="subHeaders">[[t('languageSettings')]]</div>

        <yp-language-selector name="defaultLocale" no-user-events
                              selected-locale="{{group.configuration.defaultLocale}}"></yp-language-selector>
        <paper-checkbox name="disableNameAutoTranslation" checked$="{{group.configuration.disableNameAutoTranslation}}">
          [[t('disableNameAutoTranslation')]]
        </paper-checkbox>

        <div class="subHeaders">[[t('themeSettings')]]</div>

        <paper-checkbox
          name="inheritThemeFromCommunity"
          on-checked-changed="_inheritThemeChanged"
          checked$="{{group.configuration.inheritThemeFromCommunity}}">
          [[t('inheritThemeFromCommunity')]]
        </paper-checkbox>

        <yp-theme-selector
          object="[[group]]"
          disable-selection="[[group.configuration.inheritThemeFromCommunity]]"
          selected-theme="{{themeId}}"
        ></yp-theme-selector>

        <paper-input id="themeOverrideColorPrimary"
                     name="themeOverrideColorPrimary"
                     allowed-pattern="[#-#0-9A-Fa-f]"
                     maxlength="7"
                     char-counter
                     label="[[t('themeOverrideColorPrimary')]]"
                     value="{{group.configuration.themeOverrideColorPrimary}}">
          <div prefix>#</div>
        </paper-input>

        <paper-input id="themeOverrideColorAccent"
                     name="themeOverrideColorAccent"
                     allowed-pattern="[#-#0-9A-Fa-f]"
                     maxlength="7"
                     char-counter
                     label="[[t('themeOverrideColorAccent')]]"
                     value="{{group.configuration.themeOverrideColorAccent}}">
        </paper-input>

        <paper-input id="themeOverrideBackgroundColor"
                     name="themeOverrideBackgroundColor"
                     allowed-pattern="[#-#0-9A-Fa-f]"
                     maxlength="7"
                     char-counter
                     label="[[t('themeOverrideBackgroundColor')]]"
                     value="{{group.configuration.themeOverrideBackgroundColor}}">
        </paper-input>

        <div class="themeOverrideInfo">
          <em>[[t('themeOverrideColorInfo')]]</em>
        </div>

        <div class="layout vertical">
          <paper-checkbox name="hideInfoBoxExceptForAdmins" checked$="{{group.configuration.hideInfoBoxExceptForAdmins}}">[[t('hideInfoBoxExceptForAdmins')]]</paper-checkbox>
          <paper-checkbox name="hideLogoBoxExceptOnMobile" checked$="{{group.configuration.hideLogoBoxExceptOnMobile}}">[[t('hideLogoBoxExceptOnMobile')]]</paper-checkbox>
          <paper-checkbox name="hideLogoBoxShadow" checked$="{{group.configuration.hideLogoBoxShadow}}">[[t('hideLogoBoxShadow')]]</paper-checkbox>
          <paper-checkbox name="galleryMode" checked$="{{group.configuration.galleryMode}}">[[t('galleryMode')]]</paper-checkbox>
          <paper-checkbox name="showNameUnderLogoImage" checked$="{{group.configuration.showNameUnderLogoImage}}">[[t('showNameUnderLogoImage')]]</paper-checkbox>
          <paper-checkbox name="alwaysHideLogoImage" checked$="{{group.configuration.alwaysHideLogoImage}}">[[t('alwaysHideLogoImage')]]</paper-checkbox>
          <paper-checkbox name="hideStatsAndMembership" checked$="{{group.configuration.hideStatsAndMembership}}">[[t('hideStatsAndMembership')]]</paper-checkbox>
          <paper-checkbox name="centerGroupName" checked$="{{group.configuration.centerGroupName}}">[[t('centerGroupName')]]</paper-checkbox>
          <paper-checkbox name="noGroupCardShadow" checked$="{{group.configuration.noGroupCardShadow}}">[[t('noGroupCardShadow')]]</paper-checkbox>
        </div>

        <div hidden$="[[isGroupFolder]]" class="layout vertical">
          <div class="subHeaders">[[t('postSettings')]]</div>

          <paper-checkbox name="canAddNewPosts" checked$="{{canAddNewPosts}}">[[t('group.canAddNewPosts')]]</paper-checkbox>
          <paper-checkbox name="locationHidden" checked$="{{locationHidden}}">[[t('group.locationHidden')]]</paper-checkbox>
          <paper-checkbox name="showWhoPostedPosts" checked$="{{showWhoPostedPosts}}">[[t('group.showWhoPostedPosts')]]</paper-checkbox>
          <paper-checkbox name="askUserIfNameShouldBeDisplayed" checked$="{{group.configuration.askUserIfNameShouldBeDisplayed}}">[[t('askUserIfNameShouldBeDisplayed')]]</paper-checkbox>
          <paper-checkbox name="disableDebate" checked$="{{group.configuration.disableDebate}}">[[t('disableDebate')]]</paper-checkbox>
          <paper-checkbox name="allowAdminsToDebate" checked$="{{group.configuration.allowAdminsToDebate}}">[[t('allowAdminsToDebate')]]</paper-checkbox>

          <paper-input id="postDescriptionLimit"
                       name="postDescriptionLimit"
                       type="text"
                       allowed-pattern="[0-9]"
                       label="[[t('postDescriptionLimit')]]"
                       value="{{group.configuration.postDescriptionLimit}}"
                       maxlength="4"
                       char-counter>
          </paper-input>

          <paper-checkbox name="allowPostVideoUploads" disabled$="[[!hasVideoUpload]]"
                          checked$="{{allowPostVideoUploads}}">[[t('allowPostVideoUploads')]]
          </paper-checkbox>

          <paper-input id="videoPostUploadLimitSec"
                       name="videoPostUploadLimitSec"
                       allowed-pattern="[0-9]"
                       maxlength="3"
                       type="number"
                       disabled$="[[!hasVideoUpload]]"
                       label="[[t('videoPostUploadLimitSec')]]"
                       value="{{group.configuration.videoPostUploadLimitSec}}">
          </paper-input>

          <paper-checkbox name="allowPostAudioUploads" disabled$="[[!hasAudioUpload]]"
                          checked$="{{allowPostAudioUploads}}">[[t('allowPostAudioUploads')]]
          </paper-checkbox>

          <paper-input id="audioPostUploadLimitSec"
                       name="audioPostUploadLimitSec"
                       allowed-pattern="[0-9]"
                       maxlength="3"
                       type="number"
                       disabled$="[[!hasaudioUpload]]"
                       label="[[t('audioPostUploadLimitSec')]]"
                       value="{{group.configuration.audioPostUploadLimitSec}}">
          </paper-input>

          <paper-input id="customTitleQuestionText"
                       name="customTitleQuestionText"
                       maxlength="60"
                       label="[[t('customTitleQuestionText')]]"
                       value="{{group.configuration.customTitleQuestionText}}">
          </paper-input>

          <paper-input id="hideNameInputAndReplaceWith"
                       name="hideNameInputAndReplaceWith"
                       maxlength="60"
                       label="[[t('hideNameInputAndReplaceWith')]]"
                       value="{{group.configuration.hideNameInputAndReplaceWith}}">
          </paper-input>

          <paper-input id="customTabTitleNewLocation"
                       name="customTabTitleNewLocation"
                       maxlength="60"
                       label="[[t('customTabTitleNewLocation')]]"
                       value="{{group.configuration.customTabTitleNewLocation}}">
          </paper-input>

          <paper-input id="customCategoryQuestionText"
                       name="customCategoryQuestionText"
                       type="text"
                       label="[[t('customCategoryQuestionText')]]"
                       value="{{group.configuration.customCategoryQuestionText}}"
                       maxlength="30"
                       char-counter>
          </paper-input>

          <paper-input id="customFilterText"
                       name="customFilterText"
                       type="text"
                       label="[[t('customFilterText')]]"
                       value="{{group.configuration.customFilterText}}"
                       maxlength="17"
                       char-counter>
          </paper-input>

          <paper-checkbox name="makeCategoryRequiredOnNewPost" checked$="{{group.configuration.makeCategoryRequiredOnNewPost}}">[[t('makeCategoryRequiredOnNewPost')]]
          </paper-checkbox>

          <paper-checkbox name="showVideoUploadDisclaimer" checked$="{{group.configuration.showVideoUploadDisclaimer}}">
            [[t('showVideoUploadDisclaimer')]]
          </paper-checkbox>

          <paper-checkbox name="moreContactInformation" checked$="{{group.configuration.moreContactInformation}}">
            [[t('moreContactInformation')]]
          </paper-checkbox>

          <paper-checkbox name="moreContactInformationAddress" checked$="{{group.configuration.moreContactInformationAddress}}">
            [[t('moreContactInformationAddress')]]
          </paper-checkbox>

          <paper-checkbox name="attachmentsEnabled" checked$="{{group.configuration.attachmentsEnabled}}">
            [[t('attachmentsEnabled')]]
          </paper-checkbox>
          <paper-checkbox name="useContainImageMode" checked$="{{group.configuration.useContainImageMode}}">
            [[t('useContainImageMode')]]
          </paper-checkbox>

          <paper-checkbox name="hideNewestFromFilter" checked$="{{group.configuration.hideNewestFromFilter}}">
            [[t('hideNewestFromFilter')]]
          </paper-checkbox>

          <paper-checkbox name="hideNewPost" checked$="{{group.configuration.hideNewPost}}">[[t('hideNewPost')]]</paper-checkbox>
          <paper-checkbox name="hideRecommendationOnNewsFeed" checked$="{{group.configuration.hideRecommendationOnNewsFeed}}">[[t('hideRecommendationOnNewsFeed')]]</paper-checkbox>
          <paper-checkbox name="hideNewPostOnPostPage" checked$="{{hideNewPostOnPostPage}}">
            [[t('hideNewPostOnPostPage')]]
          </paper-checkbox>

          <paper-checkbox name="hidePostCover" checked$="{{group.configuration.hidePostCover}}">[[t('hidePostCover')]]
          </paper-checkbox>

          <paper-checkbox name="hidePostDescription" checked$="{{group.configuration.hidePostDescription}}">
            [[t('hidePostDescription')]]
          </paper-checkbox>
          <paper-checkbox name="hidePostActionsInGrid" checked$="{{group.configuration.hidePostActionsInGrid}}">
            [[t('hidePostActionsInGrid')]]
          </paper-checkbox>
          <paper-checkbox name="hideDebateIcon" checked$="{{group.configuration.hideDebateIcon}}">
            [[t('hideDebateIcon')]]
          </paper-checkbox>
          <paper-checkbox name="hideSharing" checked$="{{group.configuration.hideSharing}}">
            [[t('hideSharing')]]
          </paper-checkbox>
          <paper-checkbox name="hideEmoji" checked$="{{hideEmoji}}">[[t('hideEmoji')]]</paper-checkbox>

          <paper-checkbox name="hidePostFilterAndSearch" checked$="{{group.configuration.hidePostFilterAndSearch}}">
            [[t('hidePostFilterAndSearch')]]
          </paper-checkbox>

          <paper-checkbox name="hideMediaInput" checked$="{{group.configuration.hideMediaInput}}">
            [[t('hideMediaInput')]]
          </paper-checkbox>

          <paper-checkbox name="hidePostImageUploads" disabled$="[[!hasVideoUpload]]"
                          checked$="{{group.configuration.hidePostImageUploads}}">[[t('hidePostImageUploads')]]
          </paper-checkbox>

          <paper-checkbox name="disablePostPageLink" checked$="{{group.configuration.disablePostPageLink}}">
            [[t('disablePostPageLink')]]
          </paper-checkbox>

          <paper-input id="defaultLocationLongLat"
                       name="defaultLocationLongLat"
                       type="text"
                       label="[[t('defaultLocationLongLat')]]"
                       value="{{group.configuration.defaultLocationLongLat}}"
                       maxlength="100" style="width: 300px;">
          </paper-input>

          <paper-input id="forcePostSortMethodAs"
                       name="forcePostSortMethodAs"
                       type="text"
                       label="[[t('forcePostSortMethodAs')]]"
                       value="{{group.configuration.forcePostSortMethodAs}}"
                       maxlength="12">
          </paper-input>

          <paper-input id="descriptionTruncateAmount"
                       name="descriptionTruncateAmount"
                       type="text"
                       allowed-pattern="[0-9]"
                       label="[[t('descriptionTruncateAmount')]]"
                       value="{{group.configuration.descriptionTruncateAmount}}"
                       maxlength="4">
          </paper-input>

          <paper-checkbox name="descriptionSimpleFormat" checked$="{{group.configuration.descriptionSimpleFormat}}">
            [[t('descriptionSimpleFormat')]]
          </paper-checkbox>

          <paper-checkbox name="transcriptSimpleFormat" checked$="{{group.configuration.transcriptSimpleFormat}}">
            [[t('transcriptSimpleFormat')]]
          </paper-checkbox>

          <paper-checkbox name="allPostsBlockedByDefault" checked$="{{group.configuration.allPostsBlockedByDefault}}">
            [[t('allPostsBlockedByDefault')]]
          </paper-checkbox>

          <paper-checkbox name="exportSubCodesForRadiosAndCheckboxes" checked$="{{group.configuration.exportSubCodesForRadiosAndCheckboxes}}">
            [[t('exportSubCodesForRadiosAndCheckboxes')]]
          </paper-checkbox>

          <paper-textarea id="structuredQuestions"
                          name="structuredQuestions"
                          type="text"
                          rows="4"
                          always-float-label="[[group.configuration.structuredQuestions]]"
                          maxrows="8"
                          on-value-changed="_structuredQuestionsChanged"
                          max-rows="8"
                          label="[[t('structuredQuestions')]]"
                          value="{{group.configuration.structuredQuestions}}">
          </paper-textarea>

          <div id="structuredQuestionsJsonErrorInfo" hidden$="[[!structuredQuestionsJsonError]]">[[t('structuredQuestionsJsonFormatNotValid')]]</div>

          <div class="structuredQuestionsInfo">[[t('structuredQuestionsInfo')]]</div>

          <div class="layout vertical additionalSettings uploadSection">
            <yp-file-upload id="docxSurveyUpload" raised="true" multi="false"
                            target="/api/groups/-1/convert_docx_survey_to_json"
                            accept="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                            method="PUT" on-success="_haveUploadedDocxSurvey">
              <iron-icon class="icon" icon="sort"></iron-icon>
              <span>[[t('uploadDocxSurveyFormat')]]</span>
            </yp-file-upload>
          </div>


          <paper-input id="alternativeTextForNewIdeaButton"
                       name="alternativeTextForNewIdeaButton"
                       type="text"
                       label="[[t('alternativeTextForNewIdeaButton')]]"
                       value="{{group.configuration.alternativeTextForNewIdeaButton}}"
                       maxlength="30"
                       char-counter>
          </paper-input>

          <paper-input id="alternativeTextForNewIdeaButtonClosed"
                       name="alternativeTextForNewIdeaButtonClosed"
                       type="text"
                       label="[[t('alternativeTextForNewIdeaButtonClosed')]]"
                       value="{{group.configuration.alternativeTextForNewIdeaButtonClosed}}"
                       maxlength="30"
                       char-counter>
          </paper-input>

          <paper-input id="alternativeTextForNewIdeaButtonHeader"
                       name="alternativeTextForNewIdeaButtonHeader"
                       type="text"
                       label="[[t('alternativeTextForNewIdeaButtonHeader')]]"
                       value="{{group.configuration.alternativeTextForNewIdeaButtonHeader}}"
                       maxlength="30"
                       char-counter>
          </paper-input>

          <paper-input id="alternativeTextForNewIdeaSaveButton"
                       name="alternativeTextForNewIdeaSaveButton"
                       type="text"
                       label="[[t('alternativeTextForNewIdeaSaveButton')]]"
                       value="{{group.configuration.alternativeTextForNewIdeaSaveButton}}"
                       maxlength="20"
                       char-counter>
          </paper-input>

          <paper-input id="customThankYouTextNewPosts"
                       name="customThankYouTextNewPosts"
                       type="text"
                       char-counter
                       label="[[t('customThankYouTextNewPosts')]]"
                       value="{{group.configuration.customThankYouTextNewPosts}}"
                       maxlength="120">
          </paper-input>

          <div class="layout vertical additionalSettings defaultPostImage">
            <yp-file-upload id="defaultPostImageUpload" raised="true" multi="false"
                            target="/api/images?itemType=group-logo" method="POST" on-success="_defaultPostImageUploaded">
              <iron-icon class="icon" icon="photo-camera"></iron-icon>
              <span>[[t('defaultPostImage')]]</span>
            </yp-file-upload>
          </div>

          <div class="layout horizontal">
            <div class="layout vertical additionalSettings">
              <yp-file-upload id="defaultDataImageUpload" raised="true" multi="false"
                              target="/api/images?itemType=group-logo" method="POST" on-success="_defaultDataImageUploaded">
                <iron-icon class="icon" icon="photo-camera"></iron-icon>
                <span>[[t('defaultDataImage')]]</span>
              </yp-file-upload>
            </div>

            <input type="hidden" name="uploadedDefaultDataImageId" value="[[uploadedDefaultDataImageId]]">
          </div>

          <input type="hidden" name="canVote" value$="[[canVote]]">
          <input type="hidden" name="canAddNewPosts" value$="[[canAddNewPosts]]">
          <input type="hidden" name="locationHidden" value$="[[locationHidden]]">
          <input type="hidden" name="showWhoPostedPosts" value$="[[showWhoPostedPosts]]">
          <input type="hidden" name="themeId" value="[[themeId]]">
          <input type="hidden" name="uploadedDefaultPostImageId" value="[[uploadedDefaultPostImageId]]">

          <div class="subHeaders exteraTopMargin">[[t('voteSettings')]]</div>

          <div class="layout horizontal">
            <paper-dropdown-menu label="[[t('endorsementButtons')]]" disabled$="[[endorsementButtonsDisabled]]">
              <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{endorsementButtons}}">
                <template is="dom-repeat" items="[[endorsementButtonsOptions]]" as="buttonsSelection">
                  <paper-item name="[[buttonsSelection.name]]">[[buttonsSelection.translatedName]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <input type="hidden" name="endorsementButtons" value="[[endorsementButtons]]">
          </div>
          <paper-checkbox name="canVote" checked$="{{canVote}}">[[t('group.canVote')]]</paper-checkbox>
          <paper-checkbox name="hideVoteCount" checked$="{{group.configuration.hideVoteCount}}">[[t('hideVoteCount')]]
          </paper-checkbox>
          <paper-checkbox name="hideVoteCountUntilVoteCompleted"
                          checked$="{{group.configuration.hideVoteCountUntilVoteCompleted}}">
            [[t('hideVoteCountUntilVoteCompleted')]]
          </paper-checkbox>
          <paper-checkbox name="hideDownVoteForPost" checked$="{{group.configuration.hideDownVoteForPost}}">
            [[t('hideDownVoteForPost')]]
          </paper-checkbox>

          <paper-input id="maxNumberOfGroupVotes"
                       name="maxNumberOfGroupVotes"
                       type="text"
                       allowed-pattern="[0-9]"
                       label="[[t('maxNumberOfGroupVotes')]]"
                       value="{{group.configuration.maxNumberOfGroupVotes}}"
                       maxlength="4">
          </paper-input>

          <paper-input id="customVoteUpHoverText"
                       name="customVoteUpHoverText"
                       type="text"
                       label="[[t('customVoteUpHoverText')]]"
                       value="{{group.configuration.customVoteUpHoverText}}"
                       maxlength="100"
                       char-counter>
          </paper-input>

          <paper-input id="customVoteDownHoverText"
                       name="customVoteDownHoverText"
                       type="text"
                       label="[[t('customVoteDownHoverText')]]"
                       value="{{group.configuration.customVoteDownHoverText}}"
                       maxlength="100"
                       char-counter>
          </paper-input>
          <paper-textarea id="customRatingsText"
                          name="customRatingsText"
                          type="text"
                          rows="2"
                          on-value-changed="_customRatingsTextChanged"
                          always-float-label="[[group.configuration.customRatingsText]]"
                          maxrows="2"
                          label="[[t('customRatings')]]"
                          value="{{group.configuration.customRatingsText}}">
          </paper-textarea>

          <div class="structuredQuestionsInfo">[[t('customRatingsInfo')]]</div>

          <div class="subHeaders">[[t('pointSettings')]]</div>

          <paper-checkbox name="newPointOptional" checked$="{{newPointOptional}}">[[t('newPointOptional')]]</paper-checkbox>
          <paper-checkbox name="hideNewPointOnNewIdea" checked$="{{group.configuration.hideNewPointOnNewIdea}}">[[t('hideNewPointOnNewIdea')]]</paper-checkbox>
          <paper-checkbox name="hidePointAuthor" checked$="{{group.configuration.hidePointAuthor}}">
            [[t('hidePointAuthor')]]
          </paper-checkbox>

          <paper-checkbox name="hidePointAgainst" checked$="{{group.configuration.hidePointAgainst}}">
            [[t('hidePointAgainst')]]
          </paper-checkbox>

          <paper-input id="pointCharLimit"
                       name="pointCharLimit"
                       type="text"
                       allowed-pattern="[0-9]"
                       label="[[t('pointCharLimit')]]"
                       value="{{group.configuration.pointCharLimit}}"
                       maxlength="4">
          </paper-input>

          <paper-input id="alternativePointForHeader"
                       name="alternativePointForHeader"
                       type="text"
                       label="[[t('alternativePointForHeader')]]"
                       value="{{group.configuration.alternativePointForHeader}}"
                       maxlength="100"
                       char-counter>
          </paper-input>

          <paper-input id="alternativePointAgainstHeader"
                       name="alternativePointAgainstHeader"
                       type="text"
                       label="[[t('alternativePointAgainstHeader')]]"
                       value="{{group.configuration.alternativePointAgainstHeader}}"
                       maxlength="100"
                       char-counter>
          </paper-input>

          <paper-input id="alternativePointForLabel"
                       name="alternativePointForLabel"
                       type="text"
                       label="[[t('alternativePointForLabel')]]"
                       value="{{group.configuration.alternativePointForLabel}}"
                       maxlength="100"
                       char-counter>
          </paper-input>

          <paper-input id="alternativePointAgainstLabel"
                       name="alternativePointAgainstLabel"
                       type="text"
                       label="[[t('alternativePointAgainstLabel')]]"
                       value="{{group.configuration.alternativePointAgainstLabel}}"
                       maxlength="100"
                       char-counter>
          </paper-input>

          <paper-checkbox name="allowPointVideoUploads" disabled$="[[!hasVideoUpload]]"
                          checked$="{{allowPointVideoUploads}}">[[t('allowPointVideoUploads')]]
          </paper-checkbox>
          <paper-input id="videoPointUploadLimitSec"
                       name="videoPointUploadLimitSec"
                       type="text"
                       maxlength="3"
                       allowed-pattern="[0-9]"
                       disabled$="[[!hasVideoUpload]]"
                       label="[[t('videoPointUploadLimitSec')]]"
                       value="{{group.configuration.videoPointUploadLimitSec}}">
          </paper-input>

          <paper-checkbox name="allowPointAudioUploads" disabled$="[[!hasAudioUpload]]"
                          checked$="{{allowPointAudioUploads}}">[[t('allowPointAudioUploads')]]
          </paper-checkbox>
          <paper-input id="audioPointUploadLimitSec"
                       name="audioPointUploadLimitSec"
                       type="text"
                       maxlength="3"
                       allowed-pattern="[0-9]"
                       disabled$="[[!hasaudioUpload]]"
                       label="[[t('audioPointUploadLimitSec')]]"
                       value="{{group.configuration.audioPointUploadLimitSec}}">
          </paper-input>

          <paper-checkbox name="disableMachineTranscripts" checked$="{{group.configuration.disableMachineTranscripts}}">
            [[t('disableMachineTranscripts')]]
          </paper-checkbox>

          <paper-checkbox name="allowAdminAnswersToPoints" checked$="{{group.configuration.allowAdminAnswersToPoints}}">
            [[t('allowAdminAnswersToPoints')]]
          </paper-checkbox>

          <paper-input id="customAdminCommentsTitle"
                       name="customAdminCommentsTitle"
                       type="text"
                       label="[[t('customAdminCommentsTitle')]]"
                       value="{{group.configuration.customAdminCommentsTitle}}"
                       maxlength="50"
                       char-counter>
          </paper-input>

          <div class="subHeaders">[[t('additionalGroupConfig')]]</div>
          <paper-checkbox name="hideAllTabs" checked$="{{hideAllTabs}}">[[t('hideAllTabs')]]</paper-checkbox>
          <paper-checkbox name="hideGroupLevelTabs" checked$="{{group.configuration.hideGroupLevelTabs}}">[[t('hideGroupLevelTabs')]]</paper-checkbox>
          <paper-checkbox name="hideHelpIcon" checked$="{{hideHelpIcon}}">[[t('hideHelpIcon')]]</paper-checkbox>
          <paper-checkbox name="useCommunityTopBanner" checked$="{{group.configuration.useCommunityTopBanner}}">[[t('useCommunityTopBanner')]]</paper-checkbox>
          <paper-checkbox name="makeMapViewDefault" checked$="{{group.configuration.makeMapViewDefault}}">[[t('makeMapViewDefault')]]</paper-checkbox>
          <paper-checkbox name="simpleFormatDescription" checked$="{{group.configuration.simpleFormatDescription}}">[[t('simpleFormatDescription')]]</paper-checkbox>
          <paper-checkbox name="resourceLibraryLinkMode" checked$="{{group.configuration.resourceLibraryLinkMode}}">[[t('resourceLibraryLinkMode')]]</paper-checkbox>
          <paper-checkbox name="collapsableTranscripts" checked$="{{group.configuration.collapsableTranscripts}}">[[t('collapsableTranscripts')]]</paper-checkbox>
          <paper-checkbox name="allowWhatsAppSharing" checked$="{{group.configuration.allowWhatsAppSharing}}">[[t('allowWhatsAppSharing')]]</paper-checkbox>

          <paper-input id="actAsLinkToCommunityId"
                       name="actAsLinkToCommunityId"
                       type="number"
                       allowed-pattern="[0-9]"
                       label="[[t('actAsLinkToCommunityId')]]"
                       value="{{group.configuration.actAsLinkToCommunityId}}"
                       maxlength="8">
          </paper-input>

          <paper-input id="maxDaysBackForRecommendations"
                       name="maxDaysBackForRecommendations"
                       type="text"
                       maxlength="5"
                       allowed-pattern="[0-9]"
                       label="[[t('maxDaysBackForRecommendations')]]"
                       value="{{group.configuration.maxDaysBackForRecommendations}}">
          </paper-input>

          <paper-input id="customUserNamePrompt"
                       name="customUserNamePrompt"
                       type="text"
                       label="[[t('customUserNamePrompt')]]"
                       value="{{group.configuration.customUserNamePrompt}}"
                       maxlength="45"
                       char-counter>
          </paper-input>

          <paper-input id="customTermsIntroText"
                       name="customTermsIntroText"
                       type="text"
                       label="[[t('customTermsIntroText')]]"
                       value="{{group.configuration.customTermsIntroText}}"
                       maxlength="100"
                       char-counter>
          </paper-input>

          <paper-input id="externalGoalTriggerUrl"
                       name="externalGoalTriggerUrl"
                       type="text"
                       label="[[t('externalGoalTriggerUrl')]]"
                       value="{{group.configuration.externalGoalTriggerUrl}}">
          </paper-input>

          <paper-input id="externalId"
                       name="externalId"
                       type="text"
                       label="[[t('externalId')]]"
                       value="{{group.configuration.externalId}}">
          </paper-input>

          <paper-checkbox name="usePostListFormatOnDesktop" checked$="{{group.configuration.usePostListFormatOnDesktop}}">[[t('usePostListFormatOnDesktop')]]</paper-checkbox>
          <paper-checkbox name="usePostTags" checked$="{{group.configuration.usePostTags}}">[[t('usePostTags')]]</paper-checkbox>
          <paper-checkbox name="usePostTagsForPostListItems"  checked$="{{group.configuration.usePostTagsForPostListItems}}">[[t('usePostTagsForPostListItems')]]</paper-checkbox>
          <paper-checkbox name="usePostTagsForPostCards" checked$="{{group.configuration.usePostTagsForPostCards}}">[[t('usePostTagsForPostCards')]]</paper-checkbox>
          <paper-checkbox name="forceShowDebateCountOnPost" checked$="{{group.configuration.forceShowDebateCountOnPost}}">[[t('forceShowDebateCountOnPost')]]</paper-checkbox>
          <paper-checkbox name="closeNewsfeedSubmissions" checked$="{{group.configuration.closeNewsfeedSubmissions}}">[[t('closeNewsfeedSubmissions')]]</paper-checkbox>
          <paper-checkbox name="hideNewsfeeds" checked$="{{group.configuration.hideNewsfeeds}}">[[t('hideNewsfeeds')]]</paper-checkbox>

          <div class="layout horizontal config" hidden$="[[!pages]]">
            <paper-dropdown-menu label="[[t('welcomeSelectPage')]]">
              <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{group.configuration.welcomePageId}}">
                <template is="dom-repeat" items="[[translatedPages]]" as="page">
                  <paper-item name="[[page.id]]" data-args$="[[index]]">[[_getLocalizePageTitle(page)]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <input type="hidden" name="welcomePageId" value="[[group.configuration.welcomePageId]]">
          </div>

          <paper-input id="urlToReview"
              name="urlToReview"
              type="text"
              label="[[t('urlToReview')]]"
              value="{{group.configuration.urlToReview}}"
          >
          </paper-input>

          <paper-input id="urlToReviewActionText"
              name="urlToReviewActionText"
              type="text"
              label="[[t('urlToReviewActionText')]]"
              value="{{group.configuration.urlToReviewActionText}}"
              maxlength="30"
              char-counter>
          </paper-input>

          <paper-checkbox id="isDataVisualizationGroup" name="isDataVisualizationGroup" on-tap="_isDataVisualizationGroupClick" checked$="{{group.configuration.isDataVisualizationGroup}}">[[t('isDataVisualizationGroup')]]</paper-checkbox>

          <paper-textarea id="dataForVisualization"
                          name="dataForVisualization"
                          type="text"
                          hidden$="[[!isDataVisualizationGroup]]"
                          rows="4"
                          always-float-label="[[group.configuration.dataForVisualization]]"
                          maxrows="8"
                          on-value-changed="_dataForVisualizationChanged"
                          max-rows="8"
                          label="[[t('dataForVisualization')]]"
                          value="{{group.configuration.dataForVisualization}}">
          </paper-textarea>

          <div id="dataForVisualizationJsonError" hidden$="[[!dataForVisualizationJsonError]]">[[t('structuredQuestionsJsonFormatNotValid')]]</div>

          <template is="dom-if" if="[[groupMoveToOptions]]" restamp>
            <div class="layout horizontal config">
              <paper-dropdown-menu name="moveGroupTo" label="[[t('moveGroupTo')]]">
                <paper-listbox slot="dropdown-content" attr-for-selected="name">
                  <template is="dom-repeat" items="[[groupMoveToOptions]]" as="option">
                    <paper-item name="[[option.id]]" data-args$="[[index]]">
                      [[option.name]]
                    </paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
          </template>

          <div class="layout vertical config" hidden$="[[!group.Categories]]">
            <div class="subHeaders">[[t('categories.the_all')]]</div>
            <template is="dom-repeat" items="[[group.Categories]]" as="category">
              <paper-item data-category$="[[category]]" data-category-name$="[[category.name]]" on-tap="_openCategoryEdit">
                <img sizing="cover" height="24" width="24" class="filterIcon" src="[[_categoryImageSrc(category)]]">
                <span class="categoryName">[[category.name]] - [[category.id]]</span>
              </paper-item>
            </template>
          </div>
        </div>
      </div>

      <input type="hidden" name="hideAllTabs" value$="[[hideAllTabs]]">
      <input type="hidden" name="hideNewPostOnPostPage" value$="[[hideNewPostOnPostPage]]">
      <input type="hidden" name="newPointOptional" value$="[[newPointOptional]]">
      <input type="hidden" name="hideHelpIcon" value$="[[hideHelpIcon]]">
      <input type="hidden" name="hideEmoji" value$="[[hideEmoji]]">
      <input type="hidden" name="hideGroupHeader" value$="[[hideGroupHeader]]">
      <input type="hidden" name="allowPostVideoUploads" value$="[[allowPostVideoUploads]]">
      <input type="hidden" name="allowPointVideoUploads" value$="[[allowPointVideoUploads]]">
      <input type="hidden" name="allowPostAudioUploads" value$="[[allowPostAudioUploads]]">
      <input type="hidden" name="allowPointAudioUploads" value$="[[allowPointAudioUploads]]">
      <input type="hidden" name="in_group_folder_id" value="[[inGroupFolderId]]">
      <input type="hidden" name="is_group_folder" value="[[isGroupFolder]]">

      <yp-ajax id="pagesAjax" on-response="_pagesResponse"></yp-ajax>
      <yp-ajax id="groupMoveToOptionsAjax" disable-user-error on-response="_groupMoveToOptionsResponse"></yp-ajax>

    </yp-edit-dialog>
  </template>

</dom-module>

<script>

  Polymer({

    //TODO: Try to eliminate configuration boiler-plate
    is: 'yp-group-edit',

    behaviors: [
      Polymer.ypLanguageBehavior,
      Polymer.ypEditDialogBehavior,
      Polymer.ypCollectionStatusOptions,
      Polymer.ypGotoBehavior,
      Polymer.ypMediaFormatsBehavior,
      Polymer.ypTranslatedPagesBehavior
    ],

    properties: {

      canVote: {
        type: Boolean,
        value: true
      },

      canAddNewPosts: {
        type: Boolean,
        value: true
      },

      showWhoPostedPosts: {
        type: Boolean,
        value: false
      },

      hideAllTabs: Boolean,
      hideNewPostOnPostPage: Boolean,
      newPointOptional: Boolean,
      hideHelpIcon: Boolean,
      hideEmoji: Boolean,
      hideGroupHeader: Boolean,

      action: {
        type: String,
        value: "/api/groups"
      },

      group: {
        type: Object,
        observer: "_groupChanged"
      },

      community: {
        type: Object
      },

      groupAccess: {
        type: String,
        value: "public"
      },

      uploadedLogoImageId: {
        type: String
      },

      uploadedHeaderImageId: {
        type: String
      },

      uploadedDefaultDataImageId: {
        type: String
      },

      uploadedDefaultPostImageId: {
        type: String
      },

      allowPostVideoUploads: {
        type: Boolean,
        value: null
      },

      allowPointVideoUploads: {
        type: Boolean,
        value: null
      },

      allowPostAudioUploads: {
        type: Boolean,
        value: null
      },

      allowPointAudioUploads: {
        type: Boolean,
        value: null
      },

      endorsementButtonsDisabled: {
        type: Boolean,
        value: false
      },

      status: String,

      publicCommunity: {
        type: Boolean,
        value: false
      },

      themeId: {
        type: String,
        value: null
      },

      locationHidden: Boolean,

      endorsementButtonsOptions: {
        type: Object,
        computed: '_endorsementButtonsOptions(language)'
      },

      endorsementButtons: String,

      hasSamlLoginProvider: {
        type: Boolean,
        value: false
      },

      hasVideoUpload: {
        type: Boolean,
        value: false
      },

      hasAudioUpload: {
        type: Boolean,
        value: false
      },

      uploadedVideoId: {
        type: Number,
        value: null
      },

      structuredQuestionsJsonError: {
        type: Boolean,
        value: false
      },

      registrationQuestionsJsonError: {
        type: Boolean,
        value: false
      },

      dataForVisualizationJsonError: {
        type: Boolean,
        value: false
      },

      maxObjectivesLength: {
        type: Number,
        value: 300
      },

      isDataVisualizationGroup: {
        type: Boolean,
        value: false
      },

      hasVideos: {
        type: Boolean,
        computed: '_hasVideos(group, uploadedVideoId)'
      },

      hasHeaderImage: {
        type: Boolean,
        computed: '_hasHeaderImage(group, deleteHeaderImage)'
      },

      deleteHeaderImage: {
        type: Boolean,
        value: false
      },

      inGroupFolderId: {
        type: Number,
      },

      isGroupFolder: {
        type: Boolean,
        value: false
      },

      groupMoveToOptions: {
        type: Array,
        value: null
      }
    },

    _hasVideos: function(group, uploadedVideoId) {
      return uploadedVideoId || (group && group.GroupLogoVideos && group.GroupLogoVideos.length > 0);
    },

    _hasHeaderImage: function(group, deleteHeaderImage) {
      return !deleteHeaderImage && (group && group.GroupHeaderImages && group.GroupHeaderImages.length > 0);
    },

    _deleteHeaderImage: function () {
      this.set('deleteHeaderImage', true);
    },

    _isDataVisualizationGroupClick: function () {
      this.set('isDataVisualizationGroup', this.$$("#isDataVisualizationGroup").checked);
    },

    _inheritThemeChanged: function (event, detail) {
      if (detail.value && detail.value===true) {
        this.$$("yp-theme-selector").disableSelection = true;
        this.$$("yp-theme-selector").selectedTheme = null;
      } else if (this.$$("yp-theme-selector")) {
        this.$$("yp-theme-selector").disableSelection = false;
      }
    },

    _objectivesChanged: function (event) {
      var description = event.target.value;
      var urlRegex = new RegExp(/(?:https?|http?):\/\/[\n\S]+/g);
      var urlArray = description.match(urlRegex);

      if (urlArray && urlArray.length>0) {
        var urlsLength = 0;
        for (var i=0;i<Math.min(urlArray.length,10); i++) {
          urlsLength+=urlArray[i].length;
        }
        var maxLength = 300;
        maxLength += urlsLength;
        maxLength -= Math.min(urlsLength, urlArray.length*30);
        this.set('maxObjectivesLength', maxLength);
      }
    },

    _structuredQuestionsChanged: function (event, detail) {
      if (detail && detail.value) {
        var questions = detail.value.trim();
        if (questions.startsWith("[") || questions.startsWith("{")) {
          var jsonError = false;
          try {
            JSON.parse(questions);
          } catch (e) {
            jsonError = true;
          }
          this.set('structuredQuestionsJsonError', jsonError);
        } else {
          this.set('structuredQuestionsJsonError', false);
        }
      } else {
        this.set('structuredQuestionsJsonError', false);
      }
    },

    _registrationQuestionsChanged: function (event, detail) {
      if (detail && detail.value) {
        var questions = detail.value.trim();
        var jsonError = false;
        try {
          JSON.parse(questions);
        } catch (e) {
          jsonError = true;
        }
        this.set('registrationQuestionsJsonError', jsonError);
      } else {
        this.set('registrationQuestionsJsonError', false);
      }
    },

    _dataForVisualizationChanged: function (event, detail) {
      if (detail && detail.value) {
        var data = detail.value.trim();
        var jsonError = false;
        try {
          JSON.parse(data);
        } catch (e) {
          jsonError = true;
        }
      } else {
        this.set('dataForVisualizationJsonError', false);
      }
    },

     _customRatingsTextChanged: function (event, detail) {
       if (detail.value && detail.value!=="") {
         this.set("endorsementButtonsDisabled", true);
       } else {
         this.set("endorsementButtonsDisabled", false);
       }
     },

    _videoUploaded: function (event, detail) {
      if (detail.videoId) {
        this.set('uploadedVideoId', detail.videoId);
        this.set('group.configuration.useVideoCover', true);
      } else {
        console.log("Trying to set video uploaded again")
      }
    },

    observers: [
      '_setupTranslation(language,t)'
    ],

    _openCategoryEdit: function (event) {
      window.appGlobals.activity('open', 'category.new');
      Polymer.dom(document).querySelector('yp-app').getDialogAsync("categoryEdit", function (dialog) {
        dialog.setup(this.group, false, this._refreshCategories.bind(this), this._deleteCategory.bind(this), event.model.category);
        dialog.open("edit", {categoryId: event.model.category.id});
      }.bind(this));
    },

    _deleteCategory: function (deleteCategory) {
      var newCategories = [];
      debugger;
      __.each(this.group.Categories, function (category) {
        if (category.id !== deleteCategory.id) {
          newCategories.push(category)
        }
      });
      this.set('group.Categories', newCategories);
    },

    _refreshCategories: function (newCategory) {
      var newCategories = [];
      __.each(this.group.Categories, function (oldCategory) {
        if (oldCategory.id === newCategory.id) {
          newCategories.push(newCategory)
        } else {
          newCategories.push(oldCategory);
        }
      });
      this.set('group.Categories', newCategories);
    },

    _categoryImageSrc: function (category) {
      return this.getImageFormatUrl(category.CategoryIconImages, 0);
    },

    _endorsementButtonsOptions: function (language) {
      if (this.t) {
        return [
          {name: 'hearts', translatedName: this.t('endorsementButtonsHeart')},
          {name: 'arrows', translatedName: this.t('endorsementArrows')},
          {name: 'thumbs', translatedName: this.t('endorsementThumbs')},
          {name: 'hats', translatedName: this.t('endorsementHats')}
        ]
      } else {
        return [];
      }
    },

    _updateEmojiBindings: function () {
      this.async(function () {
        var description = this.$$("#objectives");
        var emojiSelector = this.$$("#emojiSelectorDescription");
        if (description && emojiSelector) {
          emojiSelector.inputTarget = description;
        } else {
          console.warn("Group edit: Can't bind emojis :(");
        }
      }.bind(this), 500);
    },

    _publicCommunity: function (group) {
      if (group) {
        return group.Community.access === 0
      } else {
        return false;
      }
    },

    _customRedirect: function (group) {
      if (group) {
        window.appUser.recheckAdminRights();
        //TODO: Make this a part of the main POST
        if (this.uploadedVideoId) {
          var ajax = document.createElement('iron-ajax');
          ajax.handleAs = 'json';
          ajax.contentType = 'application/json';
          ajax.url = '/api/videos/' + group.id + '/completeAndAddToGroup';
          ajax.method = 'PUT';
          ajax.body = {
            videoId: this.uploadedVideoId,
            isZiggeo: window.appGlobals.useZiggeo
          };
          ajax.addEventListener('response', function (event) {
            this._finishRedirect(group);
          }.bind(this));
          ajax.generateRequest();
        } else {
          this._finishRedirect(group);
        }
      } else {
        console.warn('No group found on custom redirect');
      }
    },

    _finishRedirect: function (group) {
      if (group && group.configuration.isDataVisualizationGroup) {
        this.redirectTo("/group_data_viz/" + group.id);
      } else if (group && group.is_group_folder) {
        this.redirectTo("/group_folder/" + group.id);
      } else {
        this.redirectTo("/group/" + group.id);
      }
      window.appGlobals.activity('complete', 'editGroup');
    },

    _groupChanged: function (group, oldValue) {
      if (group) {
        if (group.access == 0) {
          this.groupAccess = "public"
        } else if (group.access == 1) {
          this.groupAccess = "closed"
        } else if (group.access == 2) {
          this.groupAccess = "secret"
        } else if (group.access == 3) {
          this.groupAccess = "open_to_community"
        }

        if (group && group.status) {
          this.set('status', group.status);
        }

        if (group.configuration && group.configuration.canVote != undefined) {
          this.set('canVote', group.configuration.canVote);
          this.set('canAddNewPosts', group.configuration.canAddNewPosts);
        } else {
          this.set('canVote', true);
          this.set('canAddNewPosts', true);
        }

        if (group.configuration && group.configuration.endorsementButtons != undefined) {
          this.set('endorsementButtons', group.configuration.endorsementButtons);
        } else {
          this.set('endorsementButtons', "hearts");
        }

        this._setFromConfiguration('locationHidden');
        this._setFromConfiguration('hideAllTabs');
        this._setFromConfiguration('hideNewPostOnPostPage');
        this._setFromConfiguration('newPointOptional');
        this._setFromConfiguration('hideHelpIcon');
        this._setFromConfiguration('hideEmoji');
        this._setFromConfiguration('hideGroupHeader');
        this._setFromConfiguration('showWhoPostedPosts');
        this._setFromConfiguration('allowPostVideoUploads', true);
        this._setFromConfiguration('allowPointVideoUploads', true);
        this._setFromConfiguration('allowPostAudioUploads', true);
        this._setFromConfiguration('allowPointAudioUploads', true);

        if (group.configuration && group.configuration.isDataVisualizationGroup) {
          this.set('isDataVisualizationGroup', true);
        }

        this.async(function () {
          if (this.community) {
            if (this.community.access == 0) {
              this.set('publicCommunity', true);
            } else {
              this.set('publicCommunity', false);
            }
          } else if (group && group.Community) {
            if (group.Community.access == 0) {
              this.set('publicCommunity', true);
            } else {
              this.set('publicCommunity', false);
            }
          }
        });

        if ((!group || !group.id) && window.appGlobals.hasVideoUpload) {
          if (this.allowPostVideoUploads === null) {
            this.set('allowPostVideoUploads', true);
          }
          if (this.allowPointVideoUploads === null) {
            this.set('allowPointVideoUploads', true);
          }
        }

        if (window.appGlobals.hasVideoUpload) {
          this.set('hasVideoUpload', true);
        } else {
          this.set('hasVideoUpload', false);
        }

        if ((!group || !group.id) && window.appGlobals.hasAudioUpload) {
          if (this.allowPostAudioUploads === null) {
            this.set('allowPostAudioUploads', true);
          }
          if (this.allowPointAudioUploads === null) {
            this.set('allowPointAudioUploads', true);
          }
        }

        if (window.appGlobals.hasAudioUpload) {
          this.set('hasAudioUpload', true);
        } else {
          this.set('hasAudioUpload', false);
        }

        if (group.configuration && group.configuration.structuredQuestions) {
          this._structuredQuestionsChanged(null, { value: group.configuration.structuredQuestions })
        }
      }

      this._updateEmojiBindings();

      if (window.appGlobals.domain && window.appGlobals.domain.samlLoginProvided) {
        this.set('hasSamlLoginProvider', true);
      } else {
        this.set('hasSamlLoginProvider', false);
      }
    },

    _setFromConfiguration: function (propertyName, setNullDefault) {
      if (this.group.configuration && this.group.configuration[propertyName] != undefined && this.group.configuration[propertyName] !== "") {
        this.set(propertyName, this.group.configuration[propertyName]);
      } else {
        this.set(propertyName, setNullDefault ? null : false);
      }
    },

    _clear: function () {
      this.set('group', null);
      this.set('uploadedLogoImageId', null);
      this.set('uploadedHeaderImageId', null);
      this.set('uploadedDefaultDataImageId', null);
      this.set('uploadedVideoId', null);

      if (this.$$("#videoFileUpload"))
        this.$$("#videoFileUpload").clear();
      if (this.$$("#headerImageUpload"))
        this.$$("#headerImageUpload").clear();
      if (this.$$("#logoImageUpload"))
        this.$$("#logoImageUpload").clear();
      if (this.$$("#defaultDataImageUpload"))
        this.$$("#defaultDataImageUpload").clear();
    },

    setup: function (group, newNotEdit, refreshFunction) {
      if (!group) {
        this.set('group', {name: '', objectives: '', access: 0, status: 'active', configuration: {
            inheritThemeFromCommunity: true
        }});
      } else {
        if (group.configuration) {
          if (group.configuration.customRatings && !group.configuration.customRatingsText) {
            var customRatingsText = "";
            group.configuration.customRatings.forEach(function (rating) {
              customRatingsText += rating.name+","+rating.numberOf+","+rating.emoji+","
            });
            customRatingsText = customRatingsText.substring(0, customRatingsText.length - 1);
            group.configuration.customRatingsText = customRatingsText;
          }
          if (group.theme_id===undefined || group.theme_id===null) {
            group.configuration.inheritThemeFromCommunity = true;
          }
        }

        if (group.is_group_folder) {
          this.set('isGroupFolder', true);
        } else {
          this.set('isGroupFolder', false);
        }

        if (group.in_group_folder_id) {
          this.set('inGroupFolderId', group.inGroupFolderId);
        } else {
          this.set('inGroupFolderId', undefined);
        }

        this.set('group', group);

        this.$.pagesAjax.url = "/api/groups/"+group.id+"/pages";
        this.$.pagesAjax.generateRequest();

        this.$.groupMoveToOptionsAjax.url = "/api/communities/"+group.community_id+"/group_folders_simple";
        this.$.groupMoveToOptionsAjax.generateRequest();
      }
      this.set('new', newNotEdit);
      this.set('refreshFunction', refreshFunction);


      if (this.group.configuration && this.group.configuration.customRatingsText && this.group.configuration.customRatingsText!=="") {
        this.set("endorsementButtonsDisabled", true);
      } else {
        this.set("endorsementButtonsDisabled", false);
      }

      this._setupTranslation();
    },

    setupAfterOpen: function (params) {
      if (params.community) {
        this.community = params.community;
      }

      if (params.isGroupFolder) {
        this.set('group.is_group_folder', true);
        this.set('isGroupFolder', true);
      } else if (!this.group || !this.group.id) {
        this.set('isGroupFolder', false);
      }

      if (params.inGroupFolderId) {
        this.set('group.in_group_folder_id', params.inGroupFolderId);
        this.set('inGroupFolderId', params.inGroupFolderId);
      } else if (!this.group || !this.group.id) {
        this.set('inGroupFolderId', undefined);
      }

      var defaultAccess = 0;
      if (this.community) {
        if (this.community.access != 0) {
          this.set('groupAccess', 'open_to_community');
          this.set('group.access', 3);
          defaultAccess = 3;
        }
      } else if (this.group.Community) {
        if (this.group.Community.access != 0) {
          this.set('groupAccess', 'open_to_community');
          defaultAccess = 3;
        }
      }
      this.set('group.access', defaultAccess);
      this._setupTranslation();
    },

    _pagesResponse: function (event, detail) {
      var pages = detail.response;
      pages.unshift({id: -1, title: { en: this.t('none') } });
      this._setPages(event, pages);
    },

    _groupMoveToOptionsResponse: function (event, detail) {
      const groupMoveToOptions = detail.response;
      if (groupMoveToOptions && groupMoveToOptions.length>0) {
        for (let i=0; i<groupMoveToOptions.length;i++) {
          groupMoveToOptions[i].name = `${groupMoveToOptions[i].id} - ${groupMoveToOptions[i].name}`;
        }
        if (this.group.in_group_folder_id) {
          groupMoveToOptions.unshift({id: 0, name: `${this.group.Community.id}C - ${this.group.Community.name}` });
        }
        groupMoveToOptions.unshift({id: -1, name: `0 - ${this.t('none')}` });
        this.set('groupMoveToOptions', groupMoveToOptions);
      }
    },

    _setupTranslation: function (language, t) {
      if (this.language && this.t) {
        if (this.isGroupFolder) {
          if (this.new) {
            this.editHeaderText = this.t('newGroupFolder');
            this.toastText = this.t('groupToastCreated');
            this.set('saveText', this.t('create'));
          } else {
            this.set('saveText', this.t('save'));
            this.editHeaderText = this.t('editGroupFolder');
            this.toastText = this.t('groupToastUpdated');
          }
        } else {
          if (this.new) {
            this.editHeaderText = this.t('group.new');
            this.toastText = this.t('groupToastCreated');
            this.set('saveText', this.t('create'));
          } else {
            this.set('saveText', this.t('save'));
            this.editHeaderText = this.t('group.update');
            this.toastText = this.t('groupToastUpdated');
          }
        }
      }
    },

    _haveUploadedDocxSurvey: function (event, detail) {
      if (detail.xhr.response) {
        detail = JSON.parse(detail.xhr.response);
        detail.jsonContent = JSON.stringify(JSON.parse(detail.jsonContent));
        this.$$("#structuredQuestions").value = detail.jsonContent;
        this.$$("#structuredQuestions").alwaysFloatLabel = true;
        if (this.group && this.group.configuration) {
          this.group.configuration.structuredQuestions = detail.jsonContent;
        }
        this.$.editDialog.scrollResize();
        this.fire('iron-resize');
      }
    }
  });
</script>
